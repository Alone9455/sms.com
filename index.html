
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SMS Varanasi</title>
    <link rel="icon" type="image/png" href="https://smsvaranasi.com/img/favicon.png" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <!-- Added for PDF Download Functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            
            --primary-color: #005f73;
            --primary-light: #0a9396;
            --primary-gradient: linear-gradient(45deg, #005f73, #0a9396);
            --secondary-color: #2a3645;
            --background-color: #1f2833;
            --sidebar-bg: #2a3645;
            --text-color: #ecf0f1;
            --text-muted: #bdc3c7;
            --border-color: #455a64;
            --success-color: #27ae60;
            --error-color: #c0392b;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --font-family: 'Roboto', 'Segoe UI', sans-serif;
            --sidebar-width: 260px;
            --glow-color: rgba(10, 147, 150, 0.4); 
            --glow-color-hover: rgba(10, 147, 150, 0.7);
        }

        body.light-theme {
            --secondary-color: #f0f2f5;
            --background-color: #ffffff;
            --sidebar-bg: #ffffff;
            --text-color: #2c3e50;
            --text-muted: #5a6a7a;
            --border-color: #000000;
        }
        
        /* 3D Animation styles */
        body.animations-3d .card,
        body.animations-3d .stat-card,
        body.animations-3d .quick-action-btn,
        body.animations-3d .home-action-card {
            transition: transform 0.4s ease, box-shadow 0.4s ease;
        }

        body.animations-3d .card:hover,
        body.animations-3d .stat-card:hover,
        body.animations-3d .quick-action-btn:hover,
        body.animations-3d .home-action-card:hover {
            transform: perspective(1000px) scale(1.05);
            box-shadow: 0 15px 35px rgba(0,0,0,0.4), 0 0 40px var(--glow-color-hover);
        }


        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: 16px;
            transition: background-color 0.3s, color 0.3s;
            -webkit-tap-highlight-color: transparent; /* Fix for button click issue on mobile */
            overflow-x: hidden; /* Prevent horizontal scroll */
            width: 100%;
        }

        body.font-weight-light { font-weight: 300; }
        body.font-weight-normal { font-weight: 400; }
        body.font-weight-bold { font-weight: 500; }
        body.font-weight-bold h1, body.font-weight-bold h2, body.font-weight-bold h3 { font-weight: 700; }

        .app-container { display: flex; width: 100%; height: 100vh; height: 100dvh; overflow: hidden; }
        #sidebar {
            width: var(--sidebar-width); background-color: var(--sidebar-bg); height: 100%;
            display: flex; flex-direction: column; transition: margin-left 0.3s ease, background-color 0.3s;
            z-index: 200; border-right: 1px solid var(--border-color); flex-shrink: 0;
            box-shadow: 0 0 25px rgba(0,0,0,0.3);
        }

        .sidebar-header {
            padding: 20px; text-align: center; border-bottom: 1px solid var(--border-color);
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .sidebar-header .admin-photo {
            width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
            border: 3px solid var(--primary-light); box-shadow: 0 0 15px var(--glow-color);
        }
        
        .sidebar-logo {
            width: 180px;
            transition: transform 0.3s ease;
            filter: drop-shadow(0 0 10px var(--glow-color));
        }
        .sidebar-logo:hover {
            transform: scale(1.05);
            filter: drop-shadow(0 0 15px var(--glow-color-hover));
        }

        @keyframes glow {
            from { text-shadow: 0 0 5px var(--glow-color); }
            to { text-shadow: 0 0 15px var(--glow-color-hover), 0 0 20px var(--glow-color-hover); }
        }

        .sidebar-header h2 { font-size: 22px; font-weight: 700; color: var(--text-color); }
        .sidebar-nav { flex-grow: 1; list-style: none; padding: 20px 0; overflow-y: auto; -webkit-overflow-scrolling: touch; }

        .sidebar-nav-item a {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 25px; color: var(--text-muted); text-decoration: none;
            font-weight: 500; border-left: 4px solid transparent; transition: all 0.2s ease; cursor: pointer;
        }
        .sidebar-nav-item>a:hover { background-color: var(--background-color); color: var(--primary-light); box-shadow: 0 0 15px var(--glow-color) inset; }
        .sidebar-nav-item>a.active {
            background-color: var(--background-color); color: var(--primary-light);
            border-left-color: var(--primary-light); font-weight: 700;
            box-shadow: inset 5px 0 15px -10px var(--glow-color);
        }
        .sidebar-nav-item .nav-link-content { display: flex; align-items: center; }
        .sidebar-nav-item i { margin-right: 18px; width: 22px; text-align: center; font-size: 1.1rem; }
        .sidebar-nav-item .arrow { transition: transform 0.3s; }
        .sidebar-nav-item.open>a .arrow { transform: rotate(90deg); }
        .sidebar-submenu { list-style: none; padding-left: 0; background-color: rgba(0, 0, 0, 0.1); max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; }
        .sidebar-nav-item.open .sidebar-submenu { max-height: 500px; }
        .sidebar-submenu a { padding-left: 55px !important; font-size: 0.95rem; }

        .sidebar-footer { padding: 15px; border-top: 1px solid var(--border-color); }
        .logout-button {
            width: 100%; background: var(--error-color); color: white; border: none; padding: 12px;
            border-radius: 8px; font-weight: 500; cursor: pointer; transition: opacity 0.2s, box-shadow 0.3s;
        }
        .logout-button:hover { opacity: 0.9; box-shadow: 0 0 15px var(--error-color); }
        .social-media-links { text-align: center; padding-top: 15px; display: flex; justify-content: center; gap: 20px; }
        .social-media-links a { color: var(--text-muted); font-size: 1.2rem; text-decoration: none; transition: color 0.3s, transform 0.3s; }
        .social-media-links a:hover { color: var(--primary-light); transform: translateY(-3px) scale(1.1); }
        .app-container.sidebar-collapsed #sidebar { margin-left: calc(-1 * var(--sidebar-width)); }

        .main-wrapper { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; padding-bottom: 60px; }
        #main-content { flex-grow: 1; padding: 25px; transition: margin-left 0.3s ease; }
        #main-footer { flex-shrink: 0; background-color: var(--sidebar-bg); padding: 20px; border-top: 1px solid var(--border-color); transition: background-color 0.3s, color 0.3s; }
        .footer-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; max-width: 1200px; margin: 0 auto; }
        .footer-contact p { margin: 0 0 5px 0; }
        .footer-contact i { margin-right: 10px; color: var(--primary-light); }
        .footer-map iframe { border-radius: 8px; border: 1px solid var(--border-color); }

        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center;
            z-index: 10001; backdrop-filter: blur(5px);
        }
        .loader {
            border: 8px solid var(--secondary-color); border-top: 8px solid var(--primary-light);
            border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header-left { display: flex; align-items: center; gap: 15px; overflow: hidden; flex-grow: 1;}
        .header-actions { display: flex; align-items: center; gap: 15px; flex-shrink: 0;}
        .header-left .menu-toggle { background: none; border: none; color: var(--text-color); font-size: 24px; cursor: pointer; flex-shrink: 0; }
        .header-title-container { overflow: hidden; white-space: nowrap; flex-grow: 1;}
        .moving-title { font-size: 24px; font-weight: 700; display: inline-block; animation: marquee 25s linear infinite; padding-left: 100%; color: var(--primary-light); text-shadow: 0 0 10px var(--glow-color); text-transform: uppercase; animation: glow 2s ease-in-out infinite alternate; }
        #real-time-clock { font-size: 1rem; font-weight: 500; color: var(--primary-light); background: transparent; border: 1px solid var(--border-color); padding: 8px 15px; border-radius: 6px; text-shadow: 0 0 5px var(--glow-color); }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        .card {
            background-color: var(--sidebar-bg); padding: 25px; border-radius: 12px;
            margin-bottom: 25px; transition: all 0.3s ease; border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2), 0 0 15px -5px var(--glow-color);
        }
        .card:hover { box-shadow: 0 8px 25px rgba(0,0,0,0.3), 0 0 30px var(--glow-color-hover); transform: translateY(-5px); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .card-header h3 { font-size: 20px; font-weight: 600; }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card {
            background-color: var(--sidebar-bg); padding: 20px; border-radius: 12px; text-align: center;
            border: 1px solid var(--border-color); transition: all 0.3s; box-shadow: 0 0 10px -4px var(--glow-color);
        }
        .stat-card:hover { transform: translateY(-5px) scale(1.03); box-shadow: 0 0 20px var(--glow-color-hover); }
        .stat-card h3 { font-size: 2.5rem; color: var(--primary-light); margin: 10px 0; }
        .stat-card p { font-size: 1rem; color: var(--text-muted); }
        .stat-card i { font-size: 2rem; color: var(--text-muted); }
        
        .quick-actions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .quick-action-btn {
            background: var(--secondary-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        .quick-action-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px var(--glow-color);
        }
        .quick-action-btn i { font-size: 1.8rem; display: block; margin-bottom: 10px; }


        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px); z-index: 1000; display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background: var(--sidebar-bg); padding: 30px; border-radius: 12px; width: 90%; max-width: 600px;
            border: 1px solid var(--primary-light); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4), 0 0 25px var(--glow-color);
        }
        .modal-content .modal-body { max-height: 80vh; overflow-y: auto; padding-right: 15px; margin-right: -15px; -webkit-overflow-scrolling: touch; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .close-btn { background: none; border: none; color: var(--text-muted); font-size: 28px; cursor: pointer; }

        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-muted); }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; background: var(--background-color); border: 1px solid var(--border-color);
            color: var(--text-color); padding: 12px; border-radius: 6px; font-size: 1rem;
            transition: box-shadow 0.3s, border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--primary-light); box-shadow: 0 0 12px var(--glow-color);
        }
        
        .form-feedback { margin-bottom: 15px; padding: 10px; border-radius: 6px; font-weight: 500; display: none; text-align: center;}
        .form-feedback.success { background-color: var(--success-color); color: white; display: block; }
        .form-feedback.error { background-color: var(--error-color); color: white; display: block; }

        .action-button {
            background-image: var(--primary-gradient); color: white; border: none; padding: 12px 25px;
            border-radius: 8px; cursor: pointer; transition: all 0.3s; font-weight: 500;
            text-decoration: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .action-button:hover { transform: translateY(-3px) scale(1.03); box-shadow: 0 6px 20px rgba(0,0,0,0.3), 0 0 20px var(--glow-color-hover); }
        .action-button.inline { width: auto; }
        .action-button.secondary {
            background-image: none;
            background-color: var(--secondary-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            box-shadow: none;
        }
        .action-button.secondary:hover {
            background-color: var(--primary-light);
            color: white;
            box-shadow: 0 0 15px var(--glow-color-hover);
        }
        .action-button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
            background-image: none;
            background-color: var(--secondary-color);
        }

        .auth-link { color: var(--primary-light); text-decoration: none; font-size: 0.9rem; margin-top: 15px; display: inline-block; }
        .auth-link:hover { text-decoration: underline; }
        
        .search-box-container { position: relative; width: 100%; margin-bottom: 20px; }
        .search-box-container .search-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 1rem; transition: color 0.3s; }
        .search-box-container .search-input { width: 100%; padding: 14px 20px 14px 50px; border-radius: 30px; background-color: var(--secondary-color); border: 1px solid var(--border-color); color: var(--text-color); font-size: 1rem; transition: all 0.3s ease; }
        .search-box-container .search-input:focus { outline: none; border-color: var(--primary-light); box-shadow: 0 0 10px var(--glow-color); background-color: var(--background-color); }
        .search-box-container:focus-within .search-icon { color: var(--primary-light); }

        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle;}
        thead { background-color: var(--secondary-color); }
        .table-photo { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color); }

        .action-buttons button, .action-buttons a { background: none; border: none; color: var(--text-muted); font-size: 18px; cursor: pointer; margin: 0 8px; transition: color 0.2s, text-shadow 0.3s, transform 0.2s; text-decoration: none; }
        .action-buttons button:hover, .action-buttons a:hover { transform: scale(1.2); }
        .action-buttons .view-btn:hover { color: var(--info-color); text-shadow: 0 0 10px var(--info-color);}
        .action-buttons .edit-btn:hover { color: var(--warning-color); text-shadow: 0 0 10px var(--warning-color); }
        .action-buttons .delete-btn:hover { color: var(--error-color); text-shadow: 0 0 10px var(--error-color); }
        .action-buttons .download-btn:hover, .action-buttons .link-btn:hover, .action-buttons .certificate-btn:hover { color: var(--success-color); text-shadow: 0 0 10px var(--success-color); }
        .action-buttons .schedule-btn:hover { color: var(--purple-light, #9b59b6); text-shadow: 0 0 10px var(--purple-light, #9b59b6); }

        .profile-grid { display: grid; grid-template-columns: 300px 1fr; gap: 30px; }
        .profile-card .profile-photo { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; margin: 0 auto 20px; display: block; border: 4px solid var(--primary-light); box-shadow: 0 0 20px var(--glow-color); }
        .profile-details li { display: flex; align-items: center; margin-bottom: 15px; font-size: 0.95rem; list-style: none; }
        .profile-details i { color: var(--primary-light); margin-right: 15px; width: 20px; text-align: center; }

        .detail-list { list-style: none; padding: 0; }
        .detail-list li { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .detail-list li.clickable { cursor: pointer; transition: background-color 0.2s; }
        .detail-list li.clickable:hover { background-color: var(--background-color); }


        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10002; }
        .toast {
            padding: 15px 25px; border-radius: 8px; color: white; font-weight: 500;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); margin-top: 10px; width: 350px;
            opacity: 0; transform: translateX(100%); animation: slideInToast 0.5s forwards, fadeOutToast 0.5s 4.5s forwards;
            border-left: 5px solid rgba(0,0,0,0.2);
        }
        @keyframes slideInToast { to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOutToast { to { opacity: 0; transform: translateX(100%); } }
        .toast.success { background-color: var(--success-color); box-shadow: 0 0 12px var(--success-color); }
        .toast.error { background-color: var(--error-color); box-shadow: 0 0 12px var(--error-color); }
        .toast.info { background-color: var(--info-color); box-shadow: 0 0 12px var(--info-color); }
        
        .gallery-grid, .videos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .gallery-item, .video-item { border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; text-align: center; background: var(--secondary-color); }
        .gallery-item img, .video-item iframe { width: 100%; height: 200px; object-fit: cover; display: block; border: none; }
        .gallery-item-footer, .video-item-footer { padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        .view-switcher .action-button { background: var(--secondary-color); box-shadow: none; }
        .view-switcher .action-button.active { background-image: var(--primary-gradient); box-shadow: 0 4px 15px rgba(0,0,0,0.2), 0 0 15px var(--glow-color-hover); }

        .attendance-report-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .attendance-card { padding: 20px; text-align: center; }
        .attendance-card .profile-photo-small { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-light); box-shadow: 0 0 15px var(--glow-color); margin-bottom: 10px; }
        .attendance-card h4 { font-size: 1.1rem; font-weight: 600; margin-bottom: 5px; }
        .attendance-card .admission-no { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 15px; }
        .attendance-stats { display: flex; justify-content: space-around; margin-bottom: 15px; }
        .home-attendance-summary .attendance-stats { justify-content: center; gap: 30px; }
        .attendance-stats .stat-item { display: flex; flex-direction: column; align-items: center; }
        .attendance-stats .stat-item .count { font-size: 2rem; font-weight: 700; }
        .attendance-stats .stat-item.present .count { color: var(--success-color); }
        .attendance-stats .stat-item.absent .count { color: var(--error-color); }
        .attendance-bar-container { width: 100%; height: 10px; background-color: var(--secondary-color); border-radius: 5px; overflow: hidden; margin-bottom: 8px; }
        .attendance-bar { height: 100%; background-color: var(--success-color); border-radius: 5px; transition: width 0.5s ease-in-out; }
        
        .notice-board { max-height: 300px; overflow-y: auto; }
        .notice-item { padding: 15px; border-bottom: 1px solid var(--border-color); }
        .notice-item:last-child { border-bottom: none; }
        .notice-item h4 { font-size: 1.1rem; margin-bottom: 5px; color: var(--primary-light); }
        .notice-item p { font-size: 0.95rem; color: var(--text-muted); margin-bottom: 8px; }
        .notice-item .notice-date { font-size: 0.8rem; color: var(--text-muted); opacity: 0.7; }

        .attendance-card .percentage { font-weight: 500; color: var(--primary-light); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .receipt-container { background-color: var(--background-color); color: var(--text-color); padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; }
        .receipt-header { text-align: center; border-bottom: 2px solid var(--primary-light); padding-bottom: 15px; margin-bottom: 20px; }
        .receipt-header h2 { margin-bottom: 5px; color: var(--primary-light); }
        .receipt-student-photo { width: 120px; height: 120px; object-fit: cover; border-radius: 8px; border: 3px solid var(--primary-light); }
        .receipt-details-grid { display: grid; grid-template-columns: auto 1fr; gap: 10px 20px; }
        .receipt-details-grid dt { font-weight: bold; color: var(--text-muted); }
        .receipt-footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); text-align: center; font-size: 0.9rem; color: var(--text-muted); }
        .receipt-signature { margin-top: 50px; text-align: right; padding-right: 20px; }
        .receipt-signature-line { width: 200px; border-bottom: 1px solid var(--text-color); display: inline-block; margin-bottom: 5px; }

        #qr-scanner-container { width: 100%; max-width: 500px; margin: 20px auto; border: 1px solid var(--border-color); border-radius: 8px; }
        #qr-scan-result { text-align: center; margin-top: 20px; padding: 15px; border-radius: 8px; }
        #qr-scan-result.success { background-color: var(--success-color); color: white; }
        #qr-scan-result.error { background-color: var(--error-color); color: white; }
        #student-qr-code { padding: 20px; background: white; display: inline-block; border-radius: 8px; margin-top: 15px; }
        
        .id-card {
            width: 320px; border: 1px solid var(--border-color); border-radius: 15px;
            padding: 20px; font-family: sans-serif; margin: auto;
            background: var(--sidebar-bg);
        }
        .id-card-header { text-align: center; border-bottom: 2px solid var(--primary-light); padding-bottom: 10px; margin-bottom: 15px; }
        .id-card-header h3 { color: var(--primary-light); margin: 0; }
        .id-card-photo { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin: 0 auto; display: block; border: 3px solid var(--primary-light); }
        .id-card-body { text-align: center; }
        .id-card-body h4 { margin-top: 15px; margin-bottom: 5px; font-size: 1.2rem; color: var(--text-color); }
        .id-card-body p { margin: 4px 0; color: var(--text-muted); font-size: 0.9rem; }
        .id-card-qr { margin-top: 15px; }
        .id-card-qr canvas, .id-card-qr img { margin: auto; }
        
        #fingerprint-status, #fingerprint-scan-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-weight: 500;
            text-align: center;
        }
        
        .certificate-container {
            width: 800px;
            padding: 40px;
            border: 10px solid var(--primary-color);
            background: var(--background-color);
            position: relative;
            font-family: 'Times New Roman', serif;
        }
        .certificate-container::before {
            content: ''; position: absolute;
            top: 5px; left: 5px; right: 5px; bottom: 5px;
            border: 2px solid var(--primary-light);
            box-shadow: 0 0 15px var(--glow-color) inset;
        }
        .certificate-header { text-align: center; margin-bottom: 20px; }
        .certificate-header h1 { font-size: 2.8rem; color: var(--primary-light); font-weight: bold; }
        .certificate-header h2 { font-size: 1.5rem; color: var(--text-color); font-weight: normal; margin-top: -10px;}
        .certificate-student-photo {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            border: 4px solid var(--primary-light);
            margin: 0 auto 25px auto;
            display: block;
            box-shadow: 0 0 15px var(--glow-color);
        }
        .certificate-body { text-align: center; }
        .certificate-body p { font-size: 1.2rem; margin: 20px 0; color: var(--text-muted); }
        .certificate-body .student-name { font-size: 2.2rem; font-weight: bold; color: var(--text-color); border-bottom: 2px solid var(--border-color); display: inline-block; padding-bottom: 5px; margin-bottom: 15px; }
        .certificate-body .class-name { font-weight: bold; color: var(--primary-light); }
        .certificate-footer { display: flex; justify-content: space-between; margin-top: 60px; }
        .signature-block { text-align: center; }
        .signature-block .signature-line { border-top: 1px solid var(--text-color); width: 200px; margin-top: 40px; margin-bottom: 5px;}
        
        #student-lookup-results, #topper-lookup-results { max-height: 250px; overflow-y: auto; margin-top: 15px; }
        .lookup-result-item { display: flex; align-items: center; padding: 10px; border-radius: 8px; margin-bottom: 10px; background: var(--secondary-color); border: 1px solid var(--border-color); }
        .lookup-result-item:hover { background: var(--background-color); }
        .lookup-result-item img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 15px; }
        
        .recent-students-scroller {
            height: 300px;
            overflow: hidden;
            position: relative;
        }
        .recent-students-scroller .scroller-inner {
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 0;
            width: 100%;
            animation: scroll-up 20s linear infinite;
        }
        .recent-students-scroller:hover .scroller-inner {
            animation-play-state: paused;
        }
        @keyframes scroll-up {
            from {
                transform: translateY(0);
            }
            to {
                transform: translateY(-50%);
            }
        }
        .recent-students-scroller .lookup-result-item {
            cursor: pointer;
        }


        .monthly-attendance-table th, .monthly-attendance-table td {
            min-width: 40px;
            text-align: center;
            padding: 8px;
        }
        .monthly-attendance-table .sticky-col {
            position: sticky;
            left: 0;
            background-color: var(--sidebar-bg);
            z-index: 10;
            text-align: left;
            min-width: 150px;
        }
        .monthly-attendance-table .present-cell { color: var(--success-color); font-weight: bold; }
        .monthly-attendance-table .absent-cell { color: var(--error-color); font-weight: bold; }
        .monthly-attendance-table .weekend-cell { background-color: rgba(0,0,0,0.2); }
        
        /* UPDATED Grade Sheet Styles */
        .grade-sheet-container {
            width: 210mm; 
            min-height: 297mm;
            border: 1px solid #000;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #fff;
            color: #000;
            margin: auto;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .grade-sheet-header { text-align: center; position: relative; padding-bottom: 10px; }
        .grade-sheet-header .logo { display: block; margin: 0 auto 10px auto; width: 130px; }
        .grade-sheet-header h1 { font-size: 24px; font-weight: bold; margin: 0; text-transform: uppercase; }
        .grade-sheet-header p { margin: 2px 0; font-size: 14px; }
        .grade-sheet-header h2 { font-size: 18px; font-weight: bold; margin: 8px 0;}
        .grade-sheet-header h4 { font-size: 18px; font-weight: bold; margin-top: 5px; border: 1px solid #000; display: inline-block; padding: 3px 10px;}
        
        .grade-sheet-details-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 10px 0;
            margin-bottom: 15px;
        }

        .grade-sheet-student-details { width: 100%; border-collapse: collapse; font-size: 14px; flex-grow: 1; }
        .grade-sheet-student-details td { padding: 4px 8px; }
        .grade-sheet-student-details strong { display: inline-block; width: 120px; font-weight: normal;}

        .grade-sheet-photo-qr-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            margin-left: 20px;
            text-align: center;
        }
        .grade-sheet-student-photo-container {
             width: 100px; height: auto; border: 1px solid #000; padding: 2px; text-align: center;
        }
        .grade-sheet-student-photo-container img { width: 100%; height: 120px; object-fit: cover; }
        .grade-sheet-student-photo-container p { font-size: 12px; margin: 5px 0; font-weight: bold; }
        

        .grade-sheet-marks-table { width: 100%; margin-top: 15px; border-collapse: collapse; font-size: 14px; }
        .grade-sheet-marks-table th, .grade-sheet-marks-table td { border: 1px solid #000; padding: 6px; text-align: center; }
        .grade-sheet-marks-table td:nth-child(2) { text-align: left; }
        .grade-sheet-marks-table .total-row td { font-weight: bold; }

        .grade-sheet-co-curricular-section { margin-top: 15px; }
        .grade-sheet-co-curricular-section h5 { font-size: 16px; font-weight: bold; margin-bottom: 5px; text-align: left; }
        .grade-sheet-co-curricular-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .grade-sheet-co-curricular-table th, .grade-sheet-co-curricular-table td { border: 1px solid #000; padding: 6px; text-align: center; }
        .grade-sheet-co-curricular-table td:nth-child(1) { text-align: left; }

        .grade-sheet-summary { font-weight: bold; text-align: center; padding: 8px; border: 1px solid black; border-top: none; font-size: 15px; }

        .grade-sheet-footer-container { margin-top: 20px; padding-top: 10px; font-size: 14px; }
        .grade-sheet-footer-container .result-line { margin-bottom: 25px; }
        .grade-sheet-footer-container .result-line p { margin: 0; }
        .grade-sheet-footer-container .signatures { display: flex; justify-content: space-between; width: 100%; }
        .grade-sheet-footer-container .sig-block { text-align: center; width: 24%;}

        .grade-sheet-grading-scale-container { 
            width: 210mm; 
            min-height: 297mm;
            padding: 20px; 
            font-family: Arial, sans-serif; 
            color: #000;
            background: #fff;
            page-break-before: always; 
        }
        .grade-sheet-grading-scale-container h3 { text-align:center; font-weight: bold; margin-bottom: 20px;}
        .grade-sheet-grading-scale-table { width: 100%; max-width: 700px; margin: 20px auto; border-collapse: collapse; font-size: 12px;}
        .grade-sheet-grading-scale-table th, .grade-sheet-grading-scale-table td { border: 1px solid #000; padding: 5px; text-align: center;}
        .grade-sheet-grading-scale-table td:first-child, .grade-sheet-grading-scale-table td:last-child { text-align: left; padding-left: 10px;}
        .grade-sheet-grading-scale-formulas { width: 100%; max-width: 700px; margin: 20px auto; font-size: 12px;}
        .grade-sheet-grading-scale-formulas p { margin: 5px 0; }

        .payment-gateway-card {
            text-align: center;
        }
        .payment-gateway-card .upi-info {
            background: var(--background-color);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin: 20px 0;
        }
         .payment-gateway-card .upi-info p {
            margin: 5px 0;
         }
        .payment-gateway-card .upi-id {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-light);
            user-select: all;
        }

        .payment-gateway-card .upi-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
         .payment-gateway-card .upi-button {
            background: var(--secondary-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
            text-decoration: none;
            transition: all 0.2s ease;
         }
         .payment-gateway-card .upi-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
         }
         .payment-gateway-card .upi-button img {
            width: 24px;
            height: 24px;
         }

        .school-photos-container, .placements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        .school-photo-item, .placement-item {
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .school-photo-item img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            display: block;
        }
         .placement-item a {
             text-decoration: none;
             color: inherit;
         }
         .placement-item img {
            width: 100%;
            height: 120px;
            object-fit: contain;
            padding: 10px;
            display: block;
            background: white;
        }
        .school-photo-item .photo-title, .placement-item .item-footer {
            padding: 15px;
            font-weight: 500;
        }
        .placement-item .item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .scrolling-wrapper {
            overflow: hidden;
            padding: 20px 0;
            position: relative;
            width: 100%;
        }
        .scrolling-wrapper::before, .scrolling-wrapper::after {
            content: '';
            position: absolute;
            top: 0;
            width: 100px;
            height: 100%;
            z-index: 2;
        }
        .scrolling-wrapper::before {
            left: 0;
            background: linear-gradient(to right, var(--sidebar-bg) 0%, transparent 100%);
        }
        .scrolling-wrapper::after {
            right: 0;
            background: linear-gradient(to left, var(--sidebar-bg) 0%, transparent 100%);
        }

        .scroller {
            display: flex;
            width: fit-content; /* Changed from max-content */
            animation: scroll-left 40s linear infinite;
        }
        .scroller:hover {
            animation-play-state: paused;
        }
        .scroller .placement-logo-item {
            display: block;
            height: 80px;
            margin: 0 30px;
            filter: grayscale(1);
            transition: filter 0.3s;
            flex-shrink: 0;
        }
        .scroller .placement-logo-item:hover {
            filter: grayscale(0);
        }
        .scroller .placement-logo-item img {
            height: 100%;
            width: auto;
        }
        @keyframes scroll-left {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        #result-upload-marks-table input, #result-upload-marks-table select {
            width: 80px;
            text-align: center;
            padding: 8px;
            background: var(--background-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 4px;
        }
        #result-upload-summary {
            margin-top: 20px;
            padding: 15px;
            background: var(--secondary-color);
            border-radius: 8px;
            text-align: center;
        }
        
        .home-action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }
        .home-action-card {
            padding: 30px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 150px;
            text-decoration: none;
        }
        .home-action-card i {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        .home-action-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 25px var(--glow-color-hover);
        }
        
        .home-action-card.home-action-card-admission {
            background: #c0392b; /* Red */
            color: #ffffff;
        }
        body.light-theme .home-action-card.home-action-card-admission {
             background: #e74c3c;
        }
        
        .home-action-card.home-action-card-enquiry {
            background: #2980b9; /* Blue */
            color: #ffffff;
        }
         body.light-theme .home-action-card.home-action-card-enquiry {
            background: #3498db;
        }

        .home-action-card.home-action-card-admission:hover,
        .home-action-card.home-action-card-enquiry:hover {
            opacity: 0.9;
        }
        
        /* UPDATED SLIDER STYLES */
        .slider-container {
            width: 100%;
            height: 450px;
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            margin-bottom: 25px;
        }
        .slides {
            display: flex;
            width: 1000%; /* 100% * 10 images */
            height: 100%;
            transition: transform 0.8s cubic-bezier(0.77, 0, 0.175, 1);
        }
        .slide {
            width: 10%; /* 100% / 10 images */
            height: 100%;
            background-size: cover;
            background-position: center;
            position: relative;
            animation: kenburns 20s infinite;
        }

        @keyframes kenburns {
            0% { transform: scale(1) translate(0, 0); }
            50% { transform: scale(1.1) translate(-2%, 2%); }
            100% { transform: scale(1) translate(0, 0); }
        }

        .slide-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            opacity: 0;
            transform: translateY(30px);
            animation: slide-up-fade-in 1s forwards;
            animation-delay: 0.5s;
        }

        @keyframes slide-up-fade-in {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-overlay h2 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.7);
        }
        .slide-overlay p {
            font-size: 1.1rem;
            margin-bottom: 20px;
        }
        .slide-overlay .action-button {
            padding: 15px 30px;
            font-size: 1.2rem;
        }

        .slider-nav {
            position: absolute;
            top: 50%;
            width: 100%;
            display: flex;
            justify-content: space-between;
            transform: translateY(-50%);
            padding: 0 20px;
            z-index: 10;
        }
        .slider-nav button {
            background: rgba(0,0,0,0.5);
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            transition: background 0.3s;
        }
        .slider-nav button:hover {
            background: rgba(0,0,0,0.8);
        }

        .slider-dots {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 10;
        }
        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            cursor: pointer;
            transition: background 0.3s;
        }
        .dot.active {
            background: white;
        }
        
        .scrolling-courses-container {
            width: 100%;
            overflow: hidden;
            background: rgba(0,0,0,0.4);
            padding: 10px 0;
            margin-top: 20px;
        }
        .scrolling-courses {
            display: inline-block;
            white-space: nowrap;
            animation: scroll-courses 30s linear infinite;
            padding-left: 100%;
            font-weight: 500;
        }
        @keyframes scroll-courses {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        .important-links-grid {
             display: grid;
             grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
             gap: 15px;
        }
        .important-link-item {
            display: block;
            padding: 15px;
            background-color: var(--secondary-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .important-link-item:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 4px 10px var(--glow-color);
        }


         @media (max-width: 992px) {
            .profile-grid { grid-template-columns: 1fr; }
            #main-content { padding: 15px; }
            .footer-content { flex-direction: column; text-align: center; }
            .slider-container { height: 350px; }
            .slide-overlay h2 { font-size: 2rem; }
         }
        @media (max-width: 768px) {
             #sidebar { position: fixed; height: 100%; left: calc(-1 * var(--sidebar-width)); transition: left 0.3s ease; box-shadow: 5px 0 15px rgba(0,0,0,0.2); }
             .app-container.sidebar-collapsed #sidebar { margin-left: 0; }
             body:not(.sidebar-open) .app-container.sidebar-collapsed #sidebar { left: calc(-1 * var(--sidebar-width)); }
             body.sidebar-open #sidebar { left: 0; }
             .app-container { overflow: visible; } /* Allow main content to scroll */
             .main-wrapper { overflow-y: auto; -webkit-overflow-scrolling: touch; }
             .header-title-container { display: none; }
             .form-grid { grid-template-columns: 1fr; }
             .slider-container { height: 300px; }
             .slide-overlay h2 { font-size: 1.5rem; }
             .slide-overlay p { font-size: 1rem; }
             .slide-overlay .action-button { padding: 10px 20px; font-size: 1rem; }
             .slider-nav button { width: 40px; height: 40px; font-size: 1.5rem; }
        }
        
        body.printing {
            padding: 0;
            margin: 0;
            background: #fff !important;
        }
        body.printing #printable-content-area {
            display: block;
        }
        body.printing > *:not(#printable-content-area) {
            display: none !important;
        }

        @media print {
            body, .printable-area {
                background: #ffffff !important;
                color: #000000 !important;
            }
            body > *:not(#printable-content-area) {
                display: none !important;
            }
            #printable-content-area {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: auto;
            }
            .printable-area {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                box-shadow: none !important;
                border: none !important;
                page-break-inside: avoid !important;
            }
            .printable-area *, .printable-area {
                background: #ffffff !important;
                color: #000000 !important;
                box-shadow: none !important;
                text-shadow: none !important;
            }
             .no-print { display: none !important; }

            .grade-sheet-container {
                border: 1px solid #000 !important;
                width: 100%;
                height: 100%;
            }
            .grade-sheet-marks-table th, .grade-sheet-marks-table td,
            .grade-sheet-co-curricular-table th, .grade-sheet-co-curricular-table td {
                 border: 1px solid #000 !important;
            }
            .grade-sheet-student-photo-container {
                border: 1px solid #000 !important;
            }
             .grade-sheet-grading-scale-container {
                page-break-before: always !important;
             }
             .grade-sheet-grading-scale-table th, .grade-sheet-grading-scale-table td {
                border: 1px solid #000 !important;
             }
             .grade-sheet-header .qr-code canvas { display: none !important; }
             .grade-sheet-header .qr-code img { display: block !important; margin: auto !important; }

            @page {
                size: A4; 
                margin: 0;
            }
        }

        /* NEW STUDENT DASHBOARD STYLES */
        .student-dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
        }
        .student-welcome-card {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            gap: 25px;
            background: var(--primary-gradient);
            color: white;
            padding: 30px;
        }
        .student-welcome-card img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid white;
        }
        .student-welcome-card h2 {
            font-size: 2.2rem;
            margin: 0;
        }
        .student-welcome-card p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        .student-dash-card {
            background-color: var(--sidebar-bg);
            border-radius: 15px;
            padding: 25px;
            text-decoration: none;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: all 0.3s ease;
        }
        .student-dash-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            background: var(--primary-color);
            color: white;
        }
        .student-dash-card i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--primary-light);
            transition: color 0.3s;
        }
        .student-dash-card:hover i {
            color: white;
        }
        .student-dash-card h3 {
            font-size: 1.4rem;
        }
        .student-dash-card .stat-highlight {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-light);
            margin-top: 10px;
        }
        .student-dash-card:hover .stat-highlight {
            color: white;
        }
        .student-dash-card .detail-list li {
            font-size: 0.9rem;
            padding: 8px 0;
        }
        /* END NEW STUDENT DASHBOARD STYLES */

        /* NEW Calculator and Chatbot Styles */
        #chatbot-toggle {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-image: var(--primary-gradient);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 999;
            transition: transform 0.3s;
        }
        #chatbot-toggle:hover {
            transform: scale(1.1);
        }

        #chatbot-window {
            position: fixed;
            bottom: 100px;
            right: 25px;
            width: 350px;
            max-width: 90vw;
            height: 500px;
            background: var(--sidebar-bg);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 998;
            transform: scale(0.5);
            opacity: 0;
            transform-origin: bottom right;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        #chatbot-window.open {
            transform: scale(1);
            opacity: 1;
        }
        .chatbot-header {
            padding: 15px;
            background-image: var(--primary-gradient);
            color: white;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chatbot-body {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .chat-message {
            padding: 10px 15px;
            border-radius: 20px;
            max-width: 80%;
            line-height: 1.4;
        }
        .chat-message.user {
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: 5px;
            align-self: flex-end;
        }
        .chat-message.bot {
            background: var(--secondary-color);
            border-bottom-left-radius: 5px;
            align-self: flex-start;
        }
        .chatbot-footer {
            display: flex;
            padding: 10px;
            border-top: 1px solid var(--border-color);
        }
        #chatbot-input {
            flex-grow: 1;
            border: none;
            background: transparent;
            padding: 10px;
            color: var(--text-color);
            outline: none;
        }
        #chatbot-send {
            background: none;
            border: none;
            color: var(--primary-light);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .calculator {
            width: 100%;
            max-width: 320px;
            margin: auto;
        }
        .calculator-screen {
            width: 100%;
            height: 70px;
            background: var(--background-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            text-align: right;
            padding: 20px;
            font-size: 2rem;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .calculator-keys {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .calculator-keys button {
            height: 60px;
            border-radius: 8px;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            background: var(--secondary-color);
            color: var(--text-color);
            transition: background-color 0.2s;
        }
        .calculator-keys button:hover {
            opacity: 0.9;
        }
        .calculator-keys .operator {
            background: var(--primary-light);
            color: white;
        }
        .calculator-keys .equal-sign {
            grid-column: span 2;
            background: var(--success-color);
            color: white;
        }
        .calculator-keys .all-clear {
             background: var(--warning-color);
             color: white;
        }
        /* END NEW Calculator and Chatbot Styles */
        
        /* NEW Appearance Settings Styles */
        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        .color-swatch {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid var(--border-color);
            transition: transform 0.2s, border-color 0.2s;
        }
        .color-swatch:hover {
            transform: scale(1.1);
        }
        .color-swatch.active {
            border-color: var(--primary-light);
            box-shadow: 0 0 10px var(--primary-light);
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .switch {
          position: relative;
          display: inline-block;
          width: 60px;
          height: 34px;
        }
        .switch input { 
          opacity: 0;
          width: 0;
          height: 0;
        }
        .slider-round {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: var(--secondary-color);
          transition: .4s;
          border-radius: 34px;
        }
        .slider-round:before {
          position: absolute;
          content: "";
          height: 26px;
          width: 26px;
          left: 4px;
          bottom: 4px;
          background-color: white;
          transition: .4s;
          border-radius: 50%;
        }
        input:checked + .slider-round {
          background-color: var(--primary-color);
        }
        input:checked + .slider-round:before {
          transform: translateX(26px);
        }
        /* END NEW Appearance Settings Styles */
         /* OTP Modal styles */
        .otp-inputs { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
        .otp-input { width: 50px !important; height: 60px; font-size: 2rem !important; text-align: center; padding: 5px !important; }

        /* NEW FEATURES STYLES */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }
        .feature-btn {
            background: var(--secondary-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px;
        }
        .feature-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px var(--glow-color);
        }
        .feature-btn i {
            font-size: 1.8rem;
            display: block;
            margin-bottom: 10px;
        }

        /* LIVE TEST STYLES */
        #live-test-question-container {
            font-size: 1.2rem;
        }
        .live-test-option {
            display: block;
            margin: 15px 0;
            padding: 15px;
            background: var(--secondary-color);
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .live-test-option:hover {
            border-color: var(--primary-light);
        }
        .live-test-option input {
            margin-right: 10px;
        }
        #live-test-timer {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--warning-color);
            text-align: center;
            margin-bottom: 20px;
        }

        /* Kanban Board Styles */
        .kanban-board { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 20px; height: calc(100vh - 220px); }
        .kanban-column { flex: 1; min-width: 300px; background: var(--secondary-color); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; border: 1px solid var(--border-color); }
        .kanban-header { font-weight: bold; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; color: var(--primary-light); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }
        .kanban-tasks { flex-grow: 1; overflow-y: auto; padding-right: 5px; min-height: 50px; }
        .kanban-task-card { background: var(--background-color); padding: 15px; border-radius: 6px; margin-bottom: 10px; border: 1px solid var(--border-color); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative; }
        .kanban-task-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); border-color: var(--primary-light); }
        .kanban-task-card h4 { margin-bottom: 5px; font-size: 1rem; }
        .kanban-task-card p { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px; }
        .kanban-task-meta { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted); }
        .kanban-add-btn { width: 100%; padding: 10px; background: transparent; border: 2px dashed var(--border-color); color: var(--text-muted); border-radius: 6px; cursor: pointer; margin-top: 10px; transition: all 0.2s; }
        .kanban-add-btn:hover { border-color: var(--primary-light); color: var(--primary-light); background: rgba(0,0,0,0.1); }
        
        /* Voice Assistant Pulse */
        .voice-active { animation: pulse-red 1.5s infinite; background-color: var(--error-color) !important; color: white !important; border-color: var(--error-color) !important; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }

        /* BIOMETRIC SYSTEM STYLES */
        .biometric-container { display: flex; flex-direction: column; align-items: center; gap: 20px; padding: 20px; }
        .video-feed-container { position: relative; width: 100%; max-width: 480px; border-radius: 12px; overflow: hidden; border: 3px solid var(--primary-light); background: #000; }
        #camera-feed { width: 100%; height: auto; display: block; transform: scaleX(-1); } /* Mirror effect */
        .face-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; border: 2px dashed rgba(255,255,255,0.7); border-radius: 50%; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); pointer-events: none; }
        .scan-line { position: absolute; width: 100%; height: 2px; background: var(--success-color); top: 0; animation: scan 2s linear infinite; box-shadow: 0 0 10px var(--success-color); }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }
        
        .fingerprint-pad {
            width: 120px; height: 160px; border: 2px solid var(--border-color); border-radius: 60px 60px 20px 20px;
            background: var(--secondary-color); display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden;
        }
        .fingerprint-pad:active { transform: scale(0.95); border-color: var(--primary-light); }
        .fingerprint-pad.scanning { border-color: var(--primary-light); box-shadow: 0 0 15px var(--glow-color); }
        .fingerprint-pad i { font-size: 4rem; color: var(--text-muted); transition: color 0.3s; }
        .fingerprint-pad.scanning i { color: var(--primary-light); animation: pulse-finger 1s infinite; }
        .fingerprint-pad.success { border-color: var(--success-color); box-shadow: 0 0 15px var(--success-color); }
        .fingerprint-pad.success i { color: var(--success-color); }
        @keyframes pulse-finger { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        .biometric-status { margin-top: 15px; font-weight: bold; font-size: 1.1rem; min-height: 1.5em; text-align: center; }
        .biometric-status.success { color: var(--success-color); }
        .biometric-status.error { color: var(--error-color); }
        
        .bio-tabs { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .bio-tab-btn { padding: 10px 20px; background: var(--secondary-color); border: 1px solid var(--border-color); color: var(--text-color); cursor: pointer; border-radius: 20px; transition: all 0.3s; }
        .bio-tab-btn.active { background: var(--primary-light); color: white; border-color: var(--primary-light); box-shadow: 0 0 10px var(--glow-color); }

        /* Social Feed Styles */
        .feed-container { max-width: 700px; margin: 0 auto; }
        .create-post-card textarea { width: 100%; border: none; resize: none; font-family: inherit; font-size: 1rem; padding: 10px; outline: none; background: transparent; color: var(--text-color); min-height: 80px; }
        .create-post-actions { display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid var(--border-color); }
        .post-card { margin-bottom: 20px; animation: fadeIn 0.5s ease; }
        .post-header { display: flex; align-items: center; margin-bottom: 15px; }
        .post-header img { width: 45px; height: 45px; border-radius: 50%; margin-right: 15px; object-fit: cover; border: 2px solid var(--primary-light); }
        .post-info h4 { font-size: 1rem; margin-bottom: 2px; }
        .post-info span { font-size: 0.8rem; color: var(--text-muted); }
        .post-content { font-size: 1rem; line-height: 1.5; margin-bottom: 15px; white-space: pre-wrap; }
        .post-image { width: 100%; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border-color); }
        .post-footer { display: flex; gap: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .post-action { background: none; border: none; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; transition: color 0.3s; }
        .post-action:hover, .post-action.active { color: var(--primary-light); }
    </style>
</head>
<body>
    <div id="app-wrapper">
        <div id="loading-overlay" style="display: none;"><div class="loader"></div></div>

        <div class="app-container" id="app-container">
            <aside id="sidebar"></aside>
            <div class="main-wrapper" id="main-wrapper">
                <main id="main-content"></main>
                <footer id="main-footer" class="no-print"></footer>
            </div>
        </div>

        <div id="modal-container"></div>
        <div id="toast-container"></div>

        <!-- NEW Chatbot Elements -->
        <button id="chatbot-toggle" class="no-print"><i class="fas fa-comment-dots"></i></button>
        <div id="chatbot-window" class="no-print">
            <div class="chatbot-header">
                <span>SMS Help Assistant</span>
                <button class="close-btn" style="color: white;" onclick="document.getElementById('chatbot-window').classList.remove('open')"></button>
            </div>
            <div class="chatbot-body" id="chatbot-body">
                <!-- Initial bot message is now set dynamically in JS -->
            </div>
            <div class="chatbot-footer">
                <input type="text" id="chatbot-input" placeholder="Type a message...">
                <button id="chatbot-send"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
    <div id="printable-content-area" style="display: none;"></div>


    <script>
        window.onerror = function(msg, url, line, col, error) {
            console.error("Error: " + msg + "\nLine: " + line); 
        };
        document.addEventListener('DOMContentLoaded', () => {
            const getEl = (id) => document.getElementById(id);
            const { jsPDF } = window.jspdf;
            let html5QrCode = null;
            let feePaymentTimer = null;
            let otpDataStore = {}; // Temporary store for OTP process data
            let liveTestTimer = null; // For Live Test

            const sliderImages = [

                "https://images.shiksha.com/mediadata/images/1537423767phpX9qQyx.jpeg",
                "https://smsvaranasi.com/uploads/page_images/79055Green-Initiative.png",
                
                "https://images.shiksha.com/mediadata/images/1537423767phpX9qQyx.jpeg",
                "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRVz1r1gzwQqBRjGLPygKsH3s-nR1c2cGL_pg&s",
                "https://smsvaranasi.com/uploads/page_images/69974solar.jpg",
                "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSOT8JQVZ5eci2AvlXyhLjc7yUTDjxQCRkI6g&s",
                
        ]


            let state = {
                loggedInUser: null,
                data: {},
                currentPage: 'home',
                currentView: 'list',
                currentItemId: null,
                studentListFilter: null,
            };
            
            const courseDetails = {
                'MBA': { semesters: 4, name: 'Master of Business Administration' },
                'MCA': { semesters: 4, name: 'Master of Computer Applications' },
                'M.Com': { semesters: 4, name: 'Master of Commerce' },
                'BBA': { semesters: 6, name: 'Bachelor of Business Administration' },
                'BCA': { semesters: 6, name: 'Bachelor of Computer Applications' },
                'B.Com': { semesters: 6, name: 'Bachelor of Commerce' },
                'B.Com (Hons)': { semesters: 6, name: 'Bachelor of Commerce (Honours)' },
                'BA (Hons) Mass Communication': { semesters: 6, name: 'Bachelor of Arts (Honours) in Mass Communication' }
            };
            const courseOptionsList = Object.keys(courseDetails);
            const examCategoriesList = ['Odd Semester', 'Even Semester', 'Sessional Test 1', 'Sessional Test 2'];
            
            const config = {
                pages: {
                    home: { title: 'Admin Dashboard', icon: 'fa-home', renderer: renderHomePage, roles: ['admin', 'guest'] },
                    
                    publicProfile: { title: 'Find Profile', icon: 'fa-search', renderer: renderPublicProfileSearchPage, roles: ['guest'] },

                    studentDashboard: { title: 'Dashboard', icon: 'fa-home', renderer: renderStudentDashboardPage, roles: ['student', 'parent'] },
                    studentProfile: { title: 'My Profile', icon: 'fa-user-circle', renderer: renderStudentProfileView, roles: ['student', 'parent'] },
                    studentAttendance: { title: 'My Attendance', icon: 'fa-calendar-check', renderer: renderStudentAttendanceView, roles: ['student', 'parent'] },
                    studentHomework: { title: 'Homework', icon: 'fa-book-open', renderer: renderStudentHomeworkView, roles: ['student', 'parent'] },
                    studentFeePayment: { title: 'Fee Payment', icon: 'fa-rupee-sign', renderer: renderFeePaymentPortalPage, roles: ['student', 'parent'] },

                    teacherDashboard: { title: 'Dashboard', icon: 'fa-home', renderer: renderTeacherDashboardPage, roles: ['teacher'] },

                    admission: { title: 'Admission', icon: 'fa-user-plus', renderer: renderAdmissionPage, roles: ['admin', 'guest'] },
                    students: { title: 'Students', icon: 'fa-user-graduate', renderer: renderStudentPage, roles: ['admin'], subPages: {
                        studentList: { title: 'Student List', icon: 'fa-users', renderer: renderStudentPage, roles: ['admin'] },
                        promoteStudents: { title: 'Promote Students', icon: 'fa-arrow-up', renderer: renderPromoteStudentsPage, roles: ['admin'] },
                    }},
                    teachers: { title: 'Teachers', icon: 'fa-chalkboard-teacher', roles: ['admin'], subPages: {
                        teacherList: { title: 'Teacher List', icon: 'fa-users-cog', renderer: renderTeacherPage, roles: ['admin'] },
                        teacherAttendance: { title: 'Teacher Attendance', icon: 'fa-user-check', renderer: renderTeacherAttendancePage, roles: ['admin'] },
                    }},
                    staff: { title: 'Staff', icon: 'fa-user-friends', roles: ['admin'], subPages: {
                        staffList: { title: 'Staff List', icon: 'fa-users', renderer: renderStaffPage, roles: ['admin'] },
                        staffAttendance: { title: 'Staff Attendance', icon: 'fa-user-check', renderer: renderStaffAttendancePage, roles: ['admin'] },
                    }},
                    academics: { title: 'Academics', icon: 'fa-university', roles: ['admin'], subPages: {
                        homework: { title: 'Homework', icon: 'fa-book-open', renderer: renderHomeworkPage, roles: ['admin'] },
                        timetable: { title: 'Timetable', icon: 'fa-calendar-alt', renderer: renderTimetablePage, roles: ['admin'] },
                        exams: { title: 'Exams', icon: 'fa-file-signature', renderer: renderExamsPage, roles: ['admin'] },
                        marksheetManager: { title: 'Grade Sheet Manager', icon: 'fa-marker', renderer: renderMarksheetManagerPage, roles: ['admin'] },
                        liveTestAdmin: { title: 'Live Tests', icon: 'fa-stopwatch', renderer: renderLiveTestAdminPage, roles: ['admin'] }, // NEW
                        manageNotes: { title: 'Manage Notes', icon: 'fa-sticky-note', renderer: renderManageNotesPage, roles: ['admin'] }, // NEW
                        manageLiveClasses: { title: 'Manage Live Classes', icon: 'fa-video', renderer: renderManageLiveClassesPage, roles: ['admin'] }, // NEW
                    }},
                    adminStudentAttendance: { title: 'Student Attendance', icon: 'fa-calendar-check', renderer: setupAttendancePage, roles: ['admin', 'teacher'] },
                    financials: { title: 'Financials', icon: 'fa-wallet', roles: ['admin'], subPages: {
                        income: { title: 'Income', icon: 'fa-dollar-sign', renderer: renderFinancialsPage, roles: ['admin']},
                        expenses: { title: 'Expenses', icon: 'fa-file-invoice-dollar', renderer: renderExpensesPage, roles: ['admin']},
                    }},
                    feePaymentPortal: { title: 'Fee Payment', icon: 'fa-rupee-sign', renderer: renderFeePaymentPortalPage, roles: ['guest'] },
                    events: { title: 'Events', icon: 'fa-calendar-star', renderer: renderEventsPage, roles: ['admin', 'guest'] },
                    campusFeed: { title: 'Campus Feed', icon: 'fa-rss', renderer: renderCampusFeedPage, roles: ['admin', 'teacher', 'student'] },
                    library: { title: 'Library', icon: 'fa-book', roles: ['admin', 'guest'], subPages: {
                        bookList: { title: 'Book List', icon: 'fa-book-bookmark', renderer: renderBookListPage, roles: ['admin', 'guest'] },
                        issueReturn: { title: 'Issue / Return', icon: 'fa-right-left', renderer: renderIssueReturnPage, roles: ['admin'] }
                    }},
                    facility: { 
                        title: 'Facility', 
                        icon: 'fa-building', 
                        roles: ['guest', 'admin', 'student', 'parent', 'teacher'], 
                        subPages: {
                            placeholder1: { title: 'Our Campus', icon: 'fa-school', renderer: () => renderPlaceholderPage("Our Campus"), roles: ['guest', 'admin', 'student', 'parent', 'teacher'] },
                            placeholder2: { title: 'Library Info', icon: 'fa-book', renderer: () => renderPlaceholderPage("Library Info"), roles: ['guest', 'admin', 'student', 'parent', 'teacher'] }
                        } 
                    },
                    noticeBoard: { title: 'Notice Board', icon: 'fa-bullhorn', renderer: renderNoticeBoardPage, roles: ['admin', 'guest', 'student', 'parent', 'teacher'] },
                    admitCardPortal: { title: 'Admit Card', icon: 'fa-id-card', renderer: renderAdmitCardPortalPage, roles: ['admin', 'guest', 'student', 'parent', 'teacher'] },
                    resultPortal: { title: 'Result Portal', icon: 'fa-award', renderer: renderResultPortalPage, roles: ['admin', 'guest', 'student', 'parent', 'teacher'] },
                    certificates: { title: 'Certificates', icon: 'fa-certificate', renderer: renderCertificatePage, roles: ['admin'] },
                    media: { title: 'Media', icon: 'fa-photo-video', roles: ['admin', 'guest'], subPages: {
                        gallery: { title: 'Photo Gallery', icon: 'fa-images', renderer: renderGalleryPage, roles: ['admin', 'guest'] },
                        videos: { title: 'Video Gallery', icon: 'fa-video', renderer: renderVideosPage, roles: ['admin', 'guest'] },
                    }},
                    inquiries: { title: 'Inquiries', icon: 'fa-question-circle', renderer: renderInquiriesPage, roles: ['admin', 'guest'] },
                    aiTools: { title: 'AI Tools', icon: 'fa-robot', renderer: renderAiToolsPage, roles: ['admin', 'teacher', 'student'] },
                    adminNotes: { title: 'Admin Notes', icon: 'fa-sticky-note', renderer: renderNotesPage, roles: ['admin'] },
                    tasks: { title: 'Task Manager', icon: 'fa-tasks', renderer: renderTasksPage, roles: ['admin', 'teacher'] },
                    settings: {
                        title: 'Settings',
                        icon: 'fa-cog',
                        roles: ['admin'],
                        subPages: {
                            account: { title: 'User Account', icon: 'fa-user-circle', renderer: renderAccountSettingsPage, roles: ['admin'] },
                            appearance: { title: 'Appearance', icon: 'fa-paint-brush', renderer: renderAppearanceSettingsPage, roles: ['admin'] },
                            schoolInfo: { title: 'School Info', icon: 'fa-school', renderer: renderSchoolInfoSettingsPage, roles: ['admin'] },
                            content: { title: 'Site Content', icon: 'fa-file-alt', renderer: renderContentSettingsPage, roles: ['admin'] },
                            schoolPhotos: { title: 'School Photos', icon: 'fa-image', renderer: renderSchoolPhotosSettingsPage, roles: ['admin'] },
                            placements: { title: 'Manage Placements', icon: 'fa-handshake', renderer: renderPlacementSettingsPage, roles: ['admin']},
                            uploadResult: { title: 'Upload Result', icon: 'fa-file-upload', renderer: renderUploadResultPage, roles: ['admin'] }, 
                            setTopper: { title: 'Set Toppers', icon: 'fa-crown', renderer: renderSetTopperPage, roles: ['admin'] }, 
                            manageLinks: { title: 'Manage Links', icon: 'fa-link', renderer: renderManageLinksPage, roles: ['admin'] },
                            data: { title: 'Data Management', icon: 'fa-database', renderer: renderDataSettingsPage, roles: ['admin'] },
                        }
                    },
                },
                 accentColors: {
                    teal: { primary: '#005f73', light: '#0a9396' },
                    blue: { primary: '#2980b9', light: '#3498db' },
                    purple: { primary: '#8e44ad', light: '#9b59b6' },
                    green: { primary: '#27ae60', light: '#2ecc71' },
                    orange: { primary: '#d35400', light: '#e67e22' },
                    red: { primary: '#c0392b', light: '#e74c3c' },
                    indigo: { primary: '#3f51b5', light: '#5c6bc0' },
                    pink: { primary: '#d81b60', light: '#ec407a' },
                    cyan: { primary: '#00838f', light: '#00acc1'},
                    grey: { primary: '#546e7a', light: '#78909c'}
                }
            };
            
            const indianStatesData = { "Andaman and Nicobar Islands": ["Nicobar", "North and Middle Andaman", "South Andaman"], "Andhra Pradesh": ["Anantapur", "Chittoor", "East Godavari", "Guntur", "Krishna", "Kurnool", "Prakasam", "Srikakulam", "Sri Potti Sriramulu Nellore", "Visakhapatnam", "Vizianagaram", "West Godavari", "Y.S.R. Kadapa"], "Arunachal Pradesh": ["Anjaw", "Changlang", "Dibang Valley", "East Kameng", "East Siang", "Kamle", "Kra Daadi", "Kurung Kumey", "Lepa Rada", "Lohit", "Longding", "Lower Dibang Valley", "Lower Siang", "Lower Subansiri", "Namsai", "Pakke Kessang", "Papum Pare", "Shi Yomi", "Siang", "Tawang", "Tirap", "Upper Siang", "Upper Subansiri", "West Kameng", "West Siang"], "Assam": ["Baksa", "Barpeta", "Biswanath", "Bongaigaon", "Cachar", "Charaideo", "Chirang", "Darrang", "Dhemaji", "Dhubri", "Dibrugarh", "Dima Hasao", "Goalpara", "Golaghat", "Hailakandi", "Hojai", "Jorhat", "Kamrup", "Kamrup Metropolitan", "Karbi Anglong", "Karimganj", "Kokrajhar", "Lakhimpur", "Majuli", "Morigaon", "Nagaon", "Nalbari", "Sivasagar", "Sonitpur", "South Salmara-Mankachar", "Tinsukia", "Udalguri", "West Karbi Anglong"], "Bihar": ["Araria", "Arwal", "Aurangabad", "Banka", "Begusarai", "Bhagalpur", "Bhojpur", "Buxar", "Darbhanga", "East Champaran", "Gaya", "Gopalganj", "Jamui", "Jehanabad", "Kaimur", "Katihar", "Khagaria", "Kishanganj", "Lakhisarai", "Madhepura", "Madhubani", "Munger", "Muzaffarpur", "Nalanda", "Nawada", "Patna", "Purnia", "Rohtas", "Saharsa", "Samastipur", "Saran", "Sheikhpura", "Sheohar", "Sitamarhi", "Siwan", "Supaul", "Vaishali", "West Champaran"], "Chandigarh": ["Chandigarh"], "Chhattisgarh": ["Balod", "Baloda Bazar", "Balrampur", "Bastar", "Bemetara", "Bijapur", "Bilaspur", "Dantewada", "Dhamtari", "Durg", "Gariaband", "Gaurela Pendra Marwahi", "Janjgir-Champa", "Jashpur", "Kabirdham", "Kanker", "Kondagaon", "Korba", "Koriya", "Mahasamund", "Mungeli", "Narayanpur", "Raigarh", "Raipur", "Rajnandgaon", "Sukma", "Surajpur", "Surguja"], "Dadra and Nagar Haveli and Daman and Diu": ["Daman", "Diu", "Dadra and Nagar Haveli"], "Delhi": ["Central Delhi", "East Delhi", "New Delhi", "North Delhi", "North East Delhi", "North West Delhi", "Shahdara", "South Delhi", "South East Delhi", "South West Delhi", "West Delhi"], "Goa": ["North Goa", "South Goa"], "Gujarat": ["Ahmedabad", "Amreli", "Anand", "Aravalli", "Banaskantha", "Bharuch", "Bhavnagar", "Botad", "Chhota Udaipur", "Dahod", "Dang", "Devbhoomi Dwarka", "Gandhinagar", "Gir Somnath", "Jamnagar", "Junagadh", "Kheda", "Kutch", "Mahisagar", "Mehsana", "Morbi", "Narmada", "Navsari", "Panchmahal", "Patan", "Porbandar", "Rajkot", "Sabarkantha", "Surat", "Surendranagar", "Tapi", "Vadodara", "Valsad"], "Haryana": ["Ambala", "Bhiwani", "Charkhi Dadri", "Faridabad", "Fatehabad", "Gurugram", "Hisar", "Jhajjar", "Jind", "Kaithal", "Karnal", "Kurukshetra", "Mahendragarh", "Nuh", "Palwal", "Panchkula", "Panipat", "Rewari", "Rohtak", "Sirsa", "Sonipat", "Yamunanagar"], "Himachal Pradesh": ["Bilaspur", "Chamba", "Hamirpur", "Kangra", "Kinnaur", "Kullu", "Lahaul and Spiti", "Mandi", "Shimla", "Sirmaur", "Solan", "Una"], "Jammu and Kashmir": ["Anantnag", "Bandipora", "Baramulla", "Budgam", "Doda", "Ganderbal", "Jammu", "Kathua", "Kishtwar", "Kulgam", "Kupwara", "Poonch", "Pulwama", "Rajouri", "Ramban", "Reasi", "Samba", "Shopian", "Srinagar", "Udhampur"], "Jharkhand": ["Bokaro", "Chatra", "Deoghar", "Dhanbad", "Dumka", "East Singhbhum", "Garhwa", "Giridih", "Godda", "Gumla", "Hazaribagh", "Jamtara", "Khunti", "Koderma", "Latehar", "Lohardaga", "Pakur", "Palamu", "Ramgarh", "Ranchi", "Sahebganj", "Seraikela Kharsawan", "Simdega", "West Singhbhum"], "Karnataka": ["Bagalkot", "Ballari", "Belagavi", "Bengaluru Rural", "Bengaluru Urban", "Bidar", "Chamarajanagar", "Chikkaballapur", "Chikkamagaluru", "Chitradurga", "Dakshina Kannada", "Davanagere", "Dharwad", "Gadag", "Hassan", "Haveri", "Kalaburagi", "Kodagu", "Kolar", "Koppal", "Mandya", "Mysuru", "Raichur", "Ramanagara", "Shivamogga", "Tumakuru", "Udupi", "Uttara Kannada", "Vijayapura", "Yadgir"], "Kerala": ["Alappuzha", "Ernakulam", "Idukki", "Kannur", "Kasaragod", "Kollam", "Kottayam", "Kozhikode", "Malappurham", "Palakkad", "Pathanamthitta", "Thiruvananthapuram", "Thrissur", "Wayanad"], "Ladakh": ["Kargil", "Leh"], "Lakshadweep": ["Lakshadweep"], "Madhya Pradesh": ["Agar Malwa", "Alirajpur", "Anuppur", "Ashoknagar", "Balaghat", "Barwani", "Betul", "Bhind", "Bhopal", "Burhanpur", "Chhatarpur", "Chhindwara", "Damoh", "Datia", "Dewas", "Dhar", "Dindori", "Guna", "Gwalior", "Harda", "Hoshangabad", "Indore", "Jabalpur", "Jhabua", "Katni", "Khandwa", "Khargone", "Mandla", "Mandsaur", "Morena", "Narsinghpur", "Neemuch", "Panna", "Raisen", "Rajgarh", "Ratlam", "Rewa", "Sagar", "Satna", "Sehore", "Seoni", "Shahdol", "Shajapur", "Sheopur", "Shivpuri", "Sidhi", "Singrauli", "Tikamgarh", "Ujjain", "Umaria", "Vidisha"], "Maharashtra": ["Ahmednagar", "Akola", "Amravati", "Aurangabad", "Beed", "Bhandara", "Buldhana", "Chandrapur", "Dhule", "Gadchiroli", "Gondia", "Hingoli", "Jalgaon", "Jalna", "Kolhapur", "Latur", "Mumbai City", "Mumbai Suburban", "Nagpur", "Nanded", "Nandurbar", "Nashik", "Osmanabad", "Palghar", "Parbhani", "Pune", "Raigad", "Ratnagiri", "Sangli", "Satara", "Sindhudurg", "Solapur", "Thane", "Wardha", "Washim", "Yavatmal"], "Manipur": ["Bishnupur", "Chandel", "Churachandpur", "Imphal East", "Imphal West", "Jiribam", "Kakching", "Kamjong", "Kangpokpi", "Noney", "Pherzawl", "Senapati", "Tamenglong", "Tengnoupal", "Thoubal", "Ukhrul"], "Meghalaya": ["East Garo Hills", "East Jaintia Hills", "East Khasi Hills", "North Garo Hills", "Ri Bhoi", "South Garo Hills", "South West Garo Hills", "South West Khasi Hills", "West Garo Hills", "West Jaintia Hills", "West Khasi Hills"], "Mizoram": ["Aizawl", "Champhai", "Hnahthial", "Khawzawl", "Kolasib", "Lawngtlai", "Lunglei", "Mamit", "Saiha", "Saitual", "Serchhip"], "Nagaland": ["Dimapur", "Kiphire", "Kohima", "Longleng", "Mokokchung", "Mon", "Peren", "Phek", "Tuensang", "Wokha", "Zunheboto"], "Odisha": ["Angul", "Balangir", "Balasore", "Bargarh", "Bhadrak", "Boudh", "Cuttack", "Deogarh", "Dhenkanal", "Gajapati", "Ganjam", "Jagatsinghpur", "Jajpur", "Jharsuguda", "Kalahandi", "Kandhamal", "Kendrapara", "Kendujhar", "Khordha", "Koraput", "Malkangiri", "Mayurbhanj", "Nabarangpur", "Nayagarh", "Nuapada", "Puri", "Rayagada", "Sambalpur", "Subarnapur", "Sundargarh"], "Puducherry": ["Karaikal", "Mahe", "Puducherry", "Yanam"], "Punjab": ["Amritsar", "Barnala", "Bathinda", "Faridkot", "Fatehgarh Sahib", "Fazilka", "Ferozepur", "Gurdaspur", "Hoshiarpur", "Jalandhar", "Kapurthala", "Ludhiana", "Mansa", "Moga", "Pathankot", "Patiala", "Rupnagar", "Sahibzada Ajit Singh Nagar", "Sangrur", "Shahid Bhagat Singh Nagar", "Sri Muktsar Sahib", "Tarn Taran"], "Rajasthan": ["Ajmer", "Alwar", "Banswara", "Baran", "Barmer", "Bharatpur", "Bhilwara", "Bikaner", "Bundi", "Chittorgarh", "Churu", "Dausa", "Dholpur", "Dungarpur", "Hanumangarh", "Jaipur", "Jaisalmer", "Jalore", "Jhalawar", "Jhunjhunu", "Jodhpur", "Karauli", "Kota", "Nagaur", "Pali", "Pratapgarh", "Rajsamand", "Sawai Madhopur", "Sikar", "Sirohi", "Sri Ganganagar", "Tonk", "Udaipur"], "Sikkim": ["East Sikkim", "North Sikkim", "South Sikkim", "West Sikkim"], "Tamil Nadu": ["Ariyalur", "Chengalpattu", "Chennai", "Coimbatore", "Cuddalore", "Dharmapuri", "Dindigul", "Erode", "Kallakurichi", "Kanchipuram", "Kanyakumari", "Karur", "Krishnagiri", "Madurai", "Mayiladuthurai", "Nagapattinam", "Namakkal", "Nilgiris", "Perambalur", "Pudukkottai", "Ramanathapuram", "Ranipet", "Salem", "Sivaganga", "Tenkasi", "Thanjavur", "Theni", "Thoothukudi", "Tiruchirappalli", "Tirunelveli", "Tirupathur", "Tiruppur", "Tiruvallur", "Tiruvannamalai", "Tiruvarur", "Vellore", "Viluppuram", "Virudhunagar"], "Telangana": ["Adilabad", "Bhadradri Kothagudem", "Hyderabad", "Jagtial", "Jangaon", "Jayashankar Bhupalpally", "Jogulamba Gadwal", "Kamareddy", "Karimnagar", "Khammam", "Komaram Bheem", "Mahabubabad", "Mahabubnagar", "Mancherial", "Medak", "Medchal-Malkajgiri", "Mulugu", "Nagarkurnool", "Nalgonda", "Narayanpet", "Nirmal", "Nizamabad", "Peddapalli", "Rajanna Sircilla", "Ranga Reddy", "Sangareddy", "Siddipet", "Suryapet", "Vikarabad", "Wanaparthy", "Warangal Rural", "Warangal Urban", "Yadadri Bhuvanagiri"], "Tripura": ["Dhalai", "Gomati", "Khowai", "North Tripura", "Sepahijala", "South Tripura", "Unakoti", "West Tripura"], "Uttar Pradesh": ["Agra", "Aligarh", "Ambedkar Nagar", "Amethi", "Amroha", "Auraiya", "Ayodhya", "Azamgarh", "Baghpat", "Bahraich", "Ballia", "Balrampur", "Banda", "Barabanki", "Bareilly", "Basti", "Bhadohi", "Bijnor", "Budaun", "Bulandshahr", "Chandauli", "Chitrakoot", "Deoria", "Etah", "Etawah", "Farrukhabad", "Fatehpur", "Firozabad", "Gautam Buddha Nagar", "Ghaziabad", "Ghazipur", "Gonda", "Gorakhpur", "Hamirpur", "Hapur", "Hardoi", "Hathras", "Jalaun", "Jaunpur", "Jhansi", "Kannauj", "Kanpur Dehat", "Kanpur Nagar", "Kasganj", "Kaushambi", "Kheri", "Kushinagar", "Lalitpur", "Lucknow", "Maharajganj", "Mahoba", "Mainpuri", "Mathura", "Mau", "Meerut", "Mirzapur", "Moradabad", "Muzaffarnagar", "Pilibhit", "Pratapgarh", "Prayagraj", "Raebareli", "Rampur", "Saharanpur", "Sambhal", "Sant Kabir Nagar", "Shahjahanpur", "Shamli", "Shravasti", "Siddharthnagar", "Sitapur", "Sonbhadra", "Sultanpur", "Unnao", "Varanasi"], "Uttarakhand": ["Almora", "Bageshwar", "Chamoli", "Champawat", "Dehradun", "Haridwar", "Nainital", "Pauri Garhwal", "Pithoragrah", "Rudraprayag", "Tehri Garhwal", "Udham Singh Nagar", "Uttarkashi"], "West Bengal": ["Alipurduar", "Bankura", "Birbhum", "Cooch Behar", "Dakshin Dinajpur", "Darjeeling", "Hooghly", "Howrah", "Jalpaiguri", "Jhargram", "Kalimpong", "Kolkata", "Malda", "Murshidabad", "Nadia", "North 24 Parganas", "Paschim Bardhaman", "Paschim Medinipur", "Purba Bardhaman", "Purba Medinipur", "Purulia", "South 24 Parganas", "Uttar Dinajpur"] };

            function findPageConfig(pageKey) {
                if (config.pages[pageKey]) return config.pages[pageKey];
                for (const key in config.pages) {
                    if (config.pages[key].subPages && config.pages[key].subPages[pageKey]) {
                        return config.pages[key].subPages[pageKey];
                    }
                }
                return null;
            }

            const saveData = () => {
                try {
                    localStorage.setItem('schoolData', JSON.stringify(state.data));
                } catch (e) {
                    console.error("Error saving data:", e);
                    showToast("Error saving data. Storage might be full.", "error");
                }
            };

            const loadData = () => {
                try {
                    const savedData = localStorage.getItem('schoolData');
                    state.data = savedData ? JSON.parse(savedData) : {};
                } catch (e) {
                    console.error("Data corrupted, resetting.", e);
                    localStorage.removeItem('schoolData');
                    state.data = {};
                }
                
                // NEW: Added new keys for new features
                ['students', 'transactions', 'adminNotes', 'gallery', 'videos', 'inquiries', 'expenses', 'notices', 'teachers', 'timetables', 'staff', 'examMasters', 'examSchedules', 'homework', 'events', 'books', 'issuedBooks', 'schoolPhotos', 'externalLinks', 'placements', 'linkedNotes', 'liveClasses', 'liveTests', 'tasks', 'posts'].forEach(key => {
                    if (!state.data[key]) state.data[key] = [];
                });
                
                if(!state.data.studentAttendance) state.data.studentAttendance = {};
                if(!state.data.teacherAttendance) state.data.teacherAttendance = {};
                if(!state.data.staffAttendance) state.data.staffAttendance = {};
                if(!state.data.marks) state.data.marks = {};
                
                if (!state.data.siteContent) {
                    state.data.siteContent = {};
                }
                
                if (!state.data.coCurricular) {
                    state.data.coCurricular = [];
                }
                
                 if (!state.data.liveTestResults) { // NEW: To store student test results
                    state.data.liveTestResults = {};
                }

                if (!state.data.placements || state.data.placements.length === 0) {
                    state.data.placements = [
                        {id: "pl1", name: "TCS", logo: "https://upload.wikimedia.org/wikipedia/commons/b/b1/TCS_Logo.svg", url: "https://www.tcs.com"},
                        {id: "pl2", name: "Infosys", logo: "https://upload.wikimedia.org/wikipedia/commons/9/95/Infosys_logo.svg", url: "https://www.infosys.com"},
                        {id: "pl3", name: "Wipro", logo: "https://upload.wikimedia.org/wikipedia/commons/a/a0/Wipro_Primary_Logo_Color_RGB.svg", url: "https://www.wipro.com"},
                        {id: "pl4", name: "HCL", logo: "https://upload.wikimedia.org/wikipedia/commons/4/4c/HCL_Technologies_logo.svg", url: "https://www.hcltech.com"},
                        {id: "pl5", name: "ICICI Bank", logo: "https://upload.wikimedia.org/wikipedia/commons/1/12/ICICI_Bank_Logo.svg", url: "https://www.icicibank.com"},
                        {id: "pl6", name: "Genpact", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a9/Genpact_logo.svg/2560px-Genpact_logo.svg.png", url: "https://www.genpact.com"},
                        {id: "pl7", name: "Aditya Birla Group", logo: "https://upload.wikimedia.org/wikipedia/en/thumb/5/5b/Aditya_Birla_Group_Logo.svg/1200px-Aditya_Birla_Group_Logo.svg.png", url: "https://www.adityabirla.com"}
                    ];
                }

                if (!state.data.externalLinks || state.data.externalLinks.length === 0) {
                    state.data.externalLinks = [
                        { id: 'el1', title: 'CONTACT US', url: 'https://smsvaranasi.com/contact-us.php', specialAction: null },
                        { id: 'el2', title: 'APPLY ONLINE', url: 'https://smsvaranasi.com/admission/online-admission.php', specialAction: 'admission' },
                        { id: 'el3', title: 'ONLINE FEE DEPOSIT', url: 'https://smsvaranasi.com/fee-deposit.php', specialAction: 'feePaymentPortal' },
                        { id: 'el4', title: 'JOBS@SMS', url: 'https://smsvaranasi.com/jobs-at-sms.php', specialAction: null },
                        { id: 'el5', title: 'BLOG', url: 'https://smsvaranasi.com/blog/', specialAction: null },
                        { id: 'el6', title: 'IQAC', url: 'https://smsvaranasi.com/iqac.php', specialAction: null },
                        { id: 'el7', title: 'NIRF', url: 'https://www.nirfindia.org/Home', specialAction: null },
                        { id: 'el9', title: 'CUET(UG)', url: 'https://exams.nta.ac.in/CUET-UG/', specialAction: null },
                        { id: 'el10', title: 'CUET(PG)', url: 'https://pgcuet.samarth.ac.in/', specialAction: null },
                        { id: 'el11', title: 'Sarkari Result', url: 'https://www.sarkariresult.com/', specialAction: null },
                    ];
                }
                
                state.data.siteContent.schoolName = "School of Management Sciences";
                state.data.siteContent.schoolAddress = "Khushipur, P.O-Bachhaon, Varanasi-221011, Uttar Pradesh (India)";
                state.data.siteContent.schoolContact = "07052055555";
                state.data.siteContent.schoolEmail = "info@smsvaranasi.com";
                state.data.siteContent.schoolFounded = "1995";
                state.data.siteContent.schoolUpiId = "9455597760-2@ybl";
                state.data.siteContent.schoolState = "Uttar Pradesh";
                state.data.siteContent.schoolDistrict = "Varanasi";

                 if (typeof state.data.siteContent.manualTopperStudentId !== 'undefined') {
                    if(state.data.siteContent.manualTopperStudentId) {
                       state.data.siteContent.manualTopperStudentIds = [state.data.siteContent.manualTopperStudentId];
                    }
                    delete state.data.siteContent.manualTopperStudentId;
                }
                 if (!state.data.siteContent.manualTopperStudentIds) {
                     state.data.siteContent.manualTopperStudentIds = [];
                 }
            };

            const navigate = (page, view = 'list', id = null, filter = null) => {
                closeModal();
                if (window.innerWidth <= 768 && document.body.classList.contains('sidebar-open')) {
                     document.body.classList.remove('sidebar-open');
                }

                const userRole = state.loggedInUser?.role || 'guest';
                const pageConfig = findPageConfig(page);
                
                let fallbackPage = 'home';
                if(userRole === 'student' || userRole === 'parent') fallbackPage = 'studentDashboard';
                if(userRole === 'teacher') fallbackPage = 'teacherDashboard';

                if (!pageConfig || !pageConfig.roles.includes(userRole)) {
                    showToast("Access Denied.", "error");
                    if (state.currentPage !== fallbackPage) {
                        page = fallbackPage;
                    } else {
                        return;
                    }
                }
                
                const historyState = { page, view, id, filter };
                let hash = page;
                if(view !== 'list') hash += `/${view}`;
                if(id) hash += `/${id}`;

                if (window.location.hash !== `#${hash}`) {
                     history.pushState(historyState, '', `#${hash}`);
                }
                
                applyState(historyState);
            };
            
            const applyState = (newState) => {
                state.currentPage = newState.page;
                state.currentView = newState.view || 'list';
                state.currentItemId = newState.id || null;
                state.studentListFilter = (newState.page === 'students' && newState.view === 'list') ? (newState.filter || null) : null;
                
                renderUI();
                getEl('main-wrapper').scrollTop = 0;
            }

            const renderUI = () => {
                const userRole = state.loggedInUser?.role || 'guest';
                const pageConfig = findPageConfig(state.currentPage);
                
                if (!pageConfig || !pageConfig.roles.includes(userRole)) {
                    let fallbackPage = 'home';
                    if(userRole === 'student' || userRole === 'parent') fallbackPage = 'studentDashboard';
                    if(userRole === 'teacher') fallbackPage = 'teacherDashboard';
                    navigate(fallbackPage);
                    return;
                }

                getEl('app-container').style.display = 'flex';
                
                renderSidebar();
                renderMainFooter();

                if (pageConfig && typeof pageConfig.renderer === 'function') {
                    getEl('main-content').innerHTML = '';
                    pageConfig.renderer();
                    
                    const menuToggle = document.querySelector('.menu-toggle');
                    if (menuToggle) menuToggle.onclick = toggleSidebar;
                    
                    const calcBtn = getEl('calculator-btn');
                    if(calcBtn) calcBtn.onclick = showCalculatorModal;
                    
                    const themeModeBtn = getEl('theme-mode-btn');
                    if(themeModeBtn) {
                       themeModeBtn.onclick = toggleThemeMode;
                       themeModeBtn.innerHTML = `<i class="fas ${document.body.classList.contains('light-theme') ? 'fa-moon' : 'fa-sun'}"></i>`;
                    }
                    
                    const voiceBtn = getEl('voice-assist-btn');
                    if(voiceBtn) voiceBtn.onclick = toggleVoiceRecognition;

                } else {
                    let fallbackPage = 'home';
                    if(userRole === 'student' || userRole === 'parent') fallbackPage = 'studentDashboard';
                    if(userRole === 'teacher') fallbackPage = 'teacherDashboard';
                    navigate(fallbackPage);
                }
            };
            
            const checkAuth = () => {
                initTheme();
                initAccentColor();
                initFontWeight(); 
                initAnimations();
                initSidebarState();
                
                const loggedInUserData = localStorage.getItem('loggedInUser');
                state.loggedInUser = loggedInUserData ? JSON.parse(loggedInUserData) : null;
                
                loadData();
                
                handleRouteChange();
                startClock();
                initChatbot();
            };

            const handleRouteChange = () => {
                let path = window.location.hash.substring(1);
                let page, view, id, filter;
                let newState = {};

                if (path) {
                    const parts = path.split('/');
                    page = parts[0] || 'home';
                    view = parts[1] || 'list';
                    id = parts[2] || null;
                } else {
                    page = 'home';
                    view = 'list';
                    id = null;
                }
                
                const urlParams = new URLSearchParams(window.location.search);
                filter = urlParams.get('filter');

                const userRole = state.loggedInUser?.role || 'guest';
                const pageConfig = findPageConfig(page);
                
                let fallbackPage = 'home';
                if(userRole === 'student' || userRole === 'parent') fallbackPage = 'studentDashboard';
                if(userRole === 'teacher') fallbackPage = 'teacherDashboard';
                
                if(!pageConfig || !pageConfig.roles.includes(userRole)){
                    newState = { page: fallbackPage, view: 'list', id: null, filter: null };
                } else {
                    newState = { page, view, id, filter: filter };
                }
                
                applyState(newState);
            }

            window.onpopstate = (event) => {
                 if (event.state) {
                    applyState(event.state);
                } else {
                    handleRouteChange();
                }
            };

            const showRegisterModal = () => {
                if (localStorage.getItem('adminAccount')) {
                    showToast("An admin account already exists.", "info");
                    showLoginModal('admin');
                    return;
                }
                const formContent = `
                    <form id="register-form">
                        <div class="form-feedback" id="register-feedback"></div>
                        <div class="form-group"><label for="admin-name">Full Name</label><input type="text" id="admin-name" required></div>
                        <div class="form-group"><label for="admin-email">Email</label><input type="email" id="admin-email" required></div>
                        <div class="form-group"><label for="admin-mobile">Mobile Number</label><input type="tel" id="admin-mobile" required></div>
                        <div class="form-group"><label for="admin-photo">Your Photo</label><input type="file" id="admin-photo" accept="image/*" required></div>
                        <div class="form-group"><label for="new-password">Password (min. 4 characters)</label><input type="password" id="new-password" required minlength="4"></div>
                        <div class="form-group"><label for="confirm-password">Confirm Password</label><input type="password" id="confirm-password" required></div>
                        <button type="submit" class="action-button" style="width: 100%;">Register</button>
                         <p style="text-align: center; margin-top: 15px;">Already have an account? <a href="#" class="auth-link" onclick="event.preventDefault(); showLoginModal('admin');">Login here</a></p>
                    </form>
                `;
                showModal('Admin Registration', formContent, '500px');
                getEl('register-form').onsubmit = handleRegistration;
            }

            async function handleRegistration(e) {
                e.preventDefault();
                const feedbackEl = getEl('register-feedback');
                const newPass = getEl('new-password').value;
                const confirmPass = getEl('confirm-password').value;
                const adminPhotoFile = getEl('admin-photo').files[0];

                if (newPass !== confirmPass) {
                    feedbackEl.textContent = 'Passwords do not match.';
                    feedbackEl.className = 'form-feedback error';
                    return;
                }
                if (newPass.length < 4 || !getEl('admin-name').value || !getEl('admin-email').value || !getEl('admin-mobile').value || !adminPhotoFile) {
                    feedbackEl.textContent = 'Please fill all required fields.';
                    feedbackEl.className = 'form-feedback error';
                    return;
                }
                
                const photo = await fileToBase64(adminPhotoFile);
                const adminAccount = {
                    name: getEl('admin-name').value,
                    email: getEl('admin-email').value,
                    mobile: getEl('admin-mobile').value,
                    photo: photo,
                    password: btoa(newPass)
                };
                
                // Store data temporarily and move to OTP verification
                otpDataStore = { action: 'register', data: adminAccount };
                showOtpVerificationModal(adminAccount.mobile);
            };

            const showLoginModal = (role) => {
                 let modalTitle = 'Login';
                 let usernameLabel = "ID (Email, Mobile, Admission/Employee No.)";

                 if(role === 'admin') {
                     modalTitle = 'Admin Login';
                     usernameLabel = "Email or Mobile Number";
                 } else if (role === 'teacher') {
                     modalTitle = 'Teacher Login';
                     usernameLabel = "Employee ID, Email, or Mobile";
                 } else if (role === 'student_parent') {
                     modalTitle = 'Student / Parent Login';
                      usernameLabel = "Admission No, Email, or Mobile";
                 }

                const formContent = `
                    <form id="login-form">
                        <div class="form-feedback" id="login-feedback"></div>
                        <div class="form-group">
                            <label for="username">${usernameLabel}</label>
                            <input type="text" id="username" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" id="password" required>
                        </div>
                        <button type="submit" class="action-button" style="width: 100%;">Login</button>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                            <a href="#" class="auth-link" onclick="event.preventDefault(); showForgotPasswordModal();">Forgot Password?</a>
                            ${role === 'admin' ? `<a href="#" class="auth-link" onclick="event.preventDefault(); showRegisterModal();">Register Admin</a>` : ''}
                        </div>
                    </form>
                `;
                showModal(modalTitle, formContent, '500px');
                getEl('login-form').onsubmit = (e) => handleLogin(e, role);
            };

            const handleLogin = (e, role) => {
                e.preventDefault();
                const feedbackEl = getEl('login-feedback');
                const enteredUsername = getEl('username').value.trim();
                const enteredPassword = getEl('password').value;
                
                let foundUser = null;
                let userMobile = '';

                if (role === 'admin') {
                    const adminAccount = JSON.parse(localStorage.getItem('adminAccount'));
                    if(adminAccount && (enteredUsername === adminAccount.email || enteredUsername === adminAccount.mobile) && btoa(enteredPassword) === adminAccount.password) {
                        foundUser = {role: 'admin', ...adminAccount};
                        userMobile = adminAccount.mobile;
                    }
                } else if (role === 'teacher') {
                    const teacher = (state.data.teachers || []).find(t => 
                        (t.email && t.email.toLowerCase() === enteredUsername.toLowerCase()) || (t.contact && t.contact === enteredUsername) || (t.employeeId && t.employeeId.toLowerCase() === enteredUsername.toLowerCase())
                    );
                     if(teacher && teacher.password && btoa(enteredPassword) === teacher.password){
                        foundUser = {role: 'teacher', ...teacher};
                        userMobile = teacher.contact;
                    }
                } else if (role === 'student_parent') {
                    const student = (state.data.students || []).find(s => 
                        (s.email && s.email.toLowerCase() === enteredUsername.toLowerCase()) || (s.contact && s.contact === enteredUsername) || (s.admissionNumber && s.admissionNumber.toLowerCase() === enteredUsername.toLowerCase())
                    );
                    if(student && student.password && btoa(enteredPassword) === student.password){
                        foundUser = {role: 'student', ...student};
                        userMobile = student.contact || student.guardianContact;
                    } else {
                        const parentStudent = (state.data.students || []).find(s => (s.guardianContact && s.guardianContact === enteredUsername));
                        if(parentStudent && parentStudent.password && btoa(enteredPassword) === parentStudent.password){
                            foundUser = { role: 'parent', name: `Parent of ${parentStudent.name}`, photo: parentStudent.photo, studentId: parentStudent.id };
                            userMobile = parentStudent.guardianContact;
                        }
                    }
                }

                if(foundUser){
                    otpDataStore = { action: 'login', data: foundUser };
                    showOtpVerificationModal(userMobile);
                } else {
                    feedbackEl.textContent = 'Incorrect username or password.';
                    feedbackEl.className = 'form-feedback error';
                }
            };
            
            // NEW/UPDATED OTP Functions
            function showOtpVerificationModal(destination) {
                const otp = Math.floor(100000 + Math.random() * 900000); // Generate a 6-digit OTP
                otpDataStore.otp = otp; // Store it for verification
                
                // In a real application, you would send this OTP via an API call here.
                // For this simulation, we'll display it to the user.
                console.log(`SIMULATED OTP SENT to ${destination}: ${otp}`);
                
                const formContent = `
                    <p style="text-align:center;">An OTP has been sent to <strong>${destination}</strong>.</p>
                    <p style="text-align:center; font-weight: bold; color: var(--warning-color); margin: 10px 0;">(For Demo: Check the browser console or use OTP: ${otp})</p>
                    <div class="form-feedback" id="otp-feedback"></div>
                    <form id="otp-form">
                        <div class="otp-inputs">
                            <input type="tel" class="otp-input" maxlength="1" required>
                            <input type="tel" class="otp-input" maxlength="1" required>
                            <input type="tel" class="otp-input" maxlength="1" required>
                            <input type="tel" class="otp-input" maxlength="1" required>
                            <input type="tel" class="otp-input" maxlength="1" required>
                            <input type="tel" class="otp-input" maxlength="1" required>
                        </div>
                        <button type="submit" class="action-button" style="width: 100%;">Verify & Proceed</button>
                    </form>
                    <p style="text-align:center; margin-top: 15px;"><a href="#" class="auth-link" onclick="event.preventDefault(); resendOtp('${destination}')">Resend OTP</a></p>
                `;
                showModal('OTP Verification', formContent, '500px');
                
                // Add event listeners for auto-tabbing in OTP inputs
                const inputs = document.querySelectorAll('.otp-input');
                inputs.forEach((input, index) => {
                    input.addEventListener('keyup', (e) => {
                        if (e.key >= 0 && e.key <= 9 && index < inputs.length - 1) {
                            inputs[index + 1].focus();
                        } else if (e.key === 'Backspace' && index > 0) {
                            inputs[index - 1].focus();
                        }
                    });
                });

                getEl('otp-form').onsubmit = handleOtpVerification;
            }
            
            window.resendOtp = (destination) => {
                const otp = Math.floor(100000 + Math.random() * 900000);
                otpDataStore.otp = otp;
                console.log(`SIMULATED OTP RESENT to ${destination}: ${otp}`);
                showToast(`(Demo) New OTP is ${otp}. Check console.`, 'info');
            };

            function handleOtpVerification(e) {
                e.preventDefault();
                const feedbackEl = getEl('otp-feedback');
                let enteredOtp = '';
                document.querySelectorAll('.otp-input').forEach(input => {
                    enteredOtp += input.value;
                });

                // In a real app, you'd send 'enteredOtp' to your server for verification.
                // Here, we compare with the stored OTP.
                if (enteredOtp == otpDataStore.otp) {
                    if (otpDataStore.action === 'register') {
                        localStorage.setItem('adminAccount', JSON.stringify(otpDataStore.data));
                        showToast('Registration successful! Please login.', 'success');
                        setTimeout(() => showLoginModal('admin'), 1500);
                    } else if (otpDataStore.action === 'login') {
                        loginSuccess(otpDataStore.data);
                    }
                    otpDataStore = {}; // Clear the temp store
                } else {
                    feedbackEl.textContent = 'Invalid OTP. Please try again.';
                    feedbackEl.className = 'form-feedback error';
                }
            }


            function showForgotPasswordModal() {
                const formContent = `
                    <form id="forgot-password-form">
                        <p>Please enter your username (Email, Mobile, or Admission No.) to start the recovery process.</p>
                        <div class="form-feedback" id="forgot-password-feedback"></div>
                        <div class="form-group">
                            <label for="recovery-username">Username</label>
                            <input type="text" id="recovery-username" required>
                        </div>
                        <button type="submit" class="action-button" style="width: 100%;">Find Account</button>
                    </form>
                `;
                showModal('Forgot Password', formContent);
                getEl('forgot-password-form').onsubmit = handleFindAccount;
            }

            function handleFindAccount(e) {
                e.preventDefault();
                const feedbackEl = getEl('forgot-password-feedback');
                const username = getEl('recovery-username').value.trim();

                const adminAccount = JSON.parse(localStorage.getItem('adminAccount'));
                if (adminAccount && (username === adminAccount.email || username === adminAccount.mobile)) {
                    showAdminPasswordResetVerification(adminAccount);
                    return;
                }

                const teacher = (state.data.teachers || []).find(t => 
                    (t.email && t.email === username) || 
                    (t.contact && t.contact === username) ||
                    (t.employeeId && t.employeeId === username)
                );
                 if (teacher) {
                    showTeacherPasswordResetVerification(teacher);
                    return;
                }

                const student = (state.data.students || []).find(s => 
                    (s.email && s.email === username) || 
                    (s.contact && s.contact === username) ||
                    (s.admissionNumber && s.admissionNumber === username) ||
                    (s.guardianContact && s.guardianContact === username)
                );

                if (student) {
                    showStudentPasswordResetVerification(student);
                    return;
                }

                feedbackEl.textContent = 'No account found with that username.';
                feedbackEl.className = 'form-feedback error';
            }

            function showAdminPasswordResetVerification(adminAccount) {
                const formContent = `
                    <form id="admin-verify-form">
                        <p>For security, please verify your identity.</p>
                        <div class="form-feedback" id="admin-verify-feedback"></div>
                        <div class="form-group">
                            <label for="admin-recovery-email">Your Registered Email</label>
                            <input type="email" id="admin-recovery-email" required>
                        </div>
                        <div class="form-group">
                            <label for="admin-recovery-mobile">Your Registered Mobile</label>
                            <input type="tel" id="admin-recovery-mobile" required>
                        </div>
                        <button type="submit" class="action-button" style="width: 100%;">Verify & Reset</button>
                    </form>
                `;
                showModal('Verify Admin Account', formContent);
                getEl('admin-verify-form').onsubmit = (e) => {
                    e.preventDefault();
                    const email = getEl('admin-recovery-email').value;
                    const mobile = getEl('admin-recovery-mobile').value;
                    if (email === adminAccount.email && mobile === adminAccount.mobile) {
                        showNewPasswordForm('admin', adminAccount);
                    } else {
                        getEl('admin-verify-feedback').textContent = 'Verification failed. Information does not match.';
                        getEl('admin-verify-feedback').className = 'form-feedback error';
                    }
                };
            }
            
            function showTeacherPasswordResetVerification(teacher) {
                const formContent = `
                     <form id="teacher-verify-form">
                        <p>For security, please verify your identity, <strong>${teacher.name}</strong>.</p>
                        <div class="form-feedback" id="teacher-verify-feedback"></div>
                         <div class="form-group">
                            <label for="teacher-recovery-dob">Date of Birth</label>
                            <input type="text" id="teacher-recovery-dob" placeholder="YYYY-MM-DD" required>
                        </div>
                        <button type="submit" class="action-button" style="width: 100%;">Verify & Reset</button>
                    </form>
                `;
                showModal('Verify Teacher Account', formContent);
                getEl('teacher-verify-form').onsubmit = (e) => {
                    e.preventDefault();
                    const dob = getEl('teacher-recovery-dob').value;
                    if (dob === teacher.dob) {
                        showNewPasswordForm('teacher', teacher);
                    } else {
                        getEl('teacher-verify-feedback').textContent = "Verification failed. Information does not match.";
                        getEl('teacher-verify-feedback').className = 'form-feedback error';
                    }
                };
            }

            function showStudentPasswordResetVerification(student) {
                const formContent = `
                     <form id="student-verify-form">
                        <p>For security, please verify your identity, <strong>${student.name}</strong>.</p>
                        <div class="form-feedback" id="student-verify-feedback"></div>
                        <div class="form-group">
                            <label for="student-recovery-father">Father's Name</label>
                            <input type="text" id="student-recovery-father" required>
                        </div>
                         <div class="form-group">
                            <label for="student-recovery-dob">Date of Birth</label>
                            <input type="text" id="student-recovery-dob" placeholder="YYYY-MM-DD" required>
                        </div>
                        <button type="submit" class="action-button" style="width: 100%;">Verify & Reset</button>
                    </form>
                `;
                showModal('Verify Student Account', formContent);
                getEl('student-verify-form').onsubmit = (e) => {
                    e.preventDefault();
                    const fatherName = getEl('student-recovery-father').value.trim();
                    const dob = getEl('student-recovery-dob').value;
                    if (fatherName.toLowerCase() === student.fatherName.toLowerCase() && dob === student.dob) {
                        showNewPasswordForm('student', student);
                    } else {
                        getEl('student-verify-feedback').textContent = "Verification failed. Information does not match.";
                        getEl('student-verify-feedback').className = 'form-feedback error';
                    }
                };
            }
            
            function showNewPasswordForm(userType, userData) {
                const formContent = `
                    <form id="new-password-form">
                        <p>Create a new password for ${userData.name}.</p>
                        <div class="form-feedback" id="new-password-feedback"></div>
                        <div class="form-group"><label for="reset-new-password">New Password (min. 4 characters)</label><input type="password" id="reset-new-password" required minlength="4"></div>
                        <div class="form-group"><label for="reset-confirm-password">Confirm New Password</label><input type="password" id="reset-confirm-password" required></div>
                        <button type="submit" class="action-button" style="width: 100%;">Set New Password</button>
                    </form>
                `;
                showModal('Set New Password', formContent);
                getEl('new-password-form').onsubmit = (e) => {
                    e.preventDefault();
                    const newPass = getEl('reset-new-password').value;
                    const confirmPass = getEl('reset-confirm-password').value;
                    const feedbackEl = getEl('new-password-feedback');

                    if (newPass !== confirmPass) {
                        feedbackEl.textContent = 'Passwords do not match.';
                        feedbackEl.className = 'form-feedback error';
                        return;
                    }
                    if (newPass.length < 4) {
                        feedbackEl.textContent = 'Password must be at least 4 characters long.';
                        feedbackEl.className = 'form-feedback error';
                        return;
                    }

                    userData.password = btoa(newPass);

                    if (userType === 'admin') {
                        localStorage.setItem('adminAccount', JSON.stringify(userData));
                    } else if (userType === 'student') {
                        updateOrAddItem('students', userData);
                    } else if (userType === 'teacher') {
                        updateOrAddItem('teachers', userData);
                    }

                    showToast('Password has been reset successfully!', 'success');
                    setTimeout(() => showLoginModal(userType === 'student' ? 'student_parent' : userType), 1500);
                };
            }
            
            const loginSuccess = (userData) => {
                state.loggedInUser = userData;
                localStorage.setItem('loggedInUser', JSON.stringify(userData));
                closeModal();
                
                const overlay = getEl('loading-overlay');
                overlay.style.display = 'flex';

                setTimeout(() => {
                    overlay.style.display = 'none';
                    let landingPage = 'home';
                    if(userData.role === 'student' || userData.role === 'parent') landingPage = 'studentDashboard';
                    if(userData.role === 'teacher') landingPage = 'teacherDashboard';
                    navigate(landingPage);
                    showToast(`Welcome, ${userData.name}!`, "success");
                }, 2000); // 2 second delay
            };

            const logout = () => {
                if(html5QrCode && html5QrCode.isScanning){
                     html5QrCode.stop().catch(err => console.error("QR scanner stop error", err));
                }
                state.loggedInUser = null;
                localStorage.removeItem('loggedInUser');
                navigate('home');
                showToast("You have been logged out.", "info");
            };

            const renderSidebar = () => {
                let headerHtml = '';
                let navHtml = '';
                const userRole = state.loggedInUser?.role || 'guest';

                if (state.loggedInUser) {
                    const userProfile = state.loggedInUser;
                    headerHtml = `
                        <div class="sidebar-header">
                            <img src="${userProfile.photo || `https://ui-avatars.com/api/?name=${userProfile.name}&background=random`}" alt="User Photo" class="admin-photo">
                            <h2>${userProfile.name || 'User Panel'}</h2>
                            <span style="font-size: 0.9em; color: var(--text-muted); text-transform: capitalize;">(${userProfile.role})</span>
                        </div>`;
                } else {
                    headerHtml = `
                         <div class="sidebar-header">
                            <img src="https://smsvaranasi.com/img/logo.png" alt="SMS Varanasi Logo" class="sidebar-logo">
                            <h2 style="margin-top:10px;">Welcome</h2>
                            <div style="width:100%; margin: 15px 0; display:flex; flex-direction: column; gap: 10px;">
                                <button class="action-button" onclick="showInquiryForm()" style="width:100%;">
                                    <i class="fas fa-question-circle"></i> Enquiry
                                </button>
                                <button class="action-button secondary" onclick="navigate('feePaymentPortal')" style="width:100%;">
                                    <i class="fas fa-rupee-sign"></i> Fee Payment
                                </button>
                                <button class="action-button secondary" onclick="showUnifiedScanner()" style="width:100%;">
                                    <i class="fas fa-qrcode"></i> Scan for Attendance
                                </button>
                            </div>
                            <p style="color: var(--text-muted);">Please login to continue:</p>
                            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px; width:100%;">
                                <button class="action-button secondary" onclick="showLoginModal('admin')"><i class="fas fa-user-shield"></i> Admin Login</button>
                                <button class="action-button secondary" onclick="showLoginModal('teacher')"><i class="fas fa-chalkboard-teacher"></i> Teacher Login</button>
                                <button class="action-button secondary" onclick="showLoginModal('student_parent')"><i class="fas fa-user-graduate"></i> Student/Parent Login</button>
                            </div>
                        </div>`;
                }

                for (const [key, page] of Object.entries(config.pages)) {
                     if (!page.roles.includes(userRole)) continue;

                    if (page.subPages) {
                        const subPageKeys = Object.keys(page.subPages);
                        const hasVisibleSubpages = subPageKeys.some(subKey => page.subPages[subKey].roles.includes(userRole));
                        if (!hasVisibleSubpages) continue;

                        const isOpen = subPageKeys.includes(state.currentPage);
                        const subMenuHtml = subPageKeys.map(subKey => {
                            if (!page.subPages[subKey].roles.includes(userRole)) return '';
                            return `<li><a class="nav-link ${state.currentPage === subKey ? 'active' : ''}" data-page="${subKey}">
                                <span class="nav-link-content"><i class="fas ${page.subPages[subKey].icon}"></i><span>${page.subPages[subKey].title}</span></span>
                            </a></li>`
                        }).join('');

                        navHtml += `<div class="sidebar-nav-item ${isOpen ? 'open' : ''}"><a class="submenu-toggle">
                                    <span class="nav-link-content"><i class="fas ${page.icon}"></i><span>${page.title}</span></span>
                                    <i class="fas fa-chevron-right arrow"></i></a><ul class="sidebar-submenu">${subMenuHtml}</ul></div>`;
                    } else {
                        navHtml += `<div class="sidebar-nav-item"><a class="nav-link ${state.currentPage === key ? 'active' : ''}" data-page="${key}">
                                    <span class="nav-link-content"><i class="fas ${page.icon}"></i><span>${page.title}</span></span></a></div>`;
                    }
                }
                
                const externalLinksHtml = (state.data.externalLinks || []).map(link => {
                    let actionAttr = '';
                    if (link.specialAction) {
                        actionAttr = `data-page="${link.specialAction}"`;
                    } else {
                        actionAttr = `href="${link.url}" target="_blank"`;
                    }
                    return `<div class="sidebar-nav-item"><a class="nav-link" ${actionAttr}>
                                <span class="nav-link-content"><i class="fas fa-external-link-alt"></i><span>${link.title}</span></span></a></div>`;
                }).join('');


                const footerHtml = `
                    <div class="sidebar-footer">
                        ${state.loggedInUser ? '<button id="logout-btn" class="logout-button"><i class="fas fa-sign-out-alt"></i> Logout</button>' : ''}
                        <div class="social-media-links">
                            <a href="https://wa.me/917052055555" target="_blank" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                            <a href="https://www.instagram.com/smsvaranasi/" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
                            <a href="https://www.facebook.com/smsvns/" target="_blank" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                            <a href="https://www.youtube.com/user/smsvaranasi" target="_blank" title="YouTube"><i class="fab fa-youtube"></i></a>
                            <a href="https://t.me/smsvaranasi" target="_blank" title="Telegram"><i class="fab fa-telegram"></i></a>
                        </div>
                    </div>`;

                getEl('sidebar').innerHTML = headerHtml + `<nav class="sidebar-nav">${navHtml}${externalLinksHtml ? `<hr style="border-color: var(--border-color); margin: 15px 20px;"><div style="padding: 0 25px; color: var(--text-muted); font-weight: 500; margin-bottom: 10px;">Important Links</div>` + externalLinksHtml : ''}</nav>` + footerHtml;

                getEl('sidebar').querySelectorAll('.nav-link').forEach(link => { 
                    if(link.hasAttribute('data-page')) {
                        link.onclick = (e) => {
                            e.preventDefault();
                            if(link.dataset.page === 'admission') {
                                showAdmissionForm();
                            } else {
                                navigate(link.dataset.page);
                            }
                        };
                    }
                });

                getEl('sidebar').querySelectorAll('.submenu-toggle').forEach(link => { link.onclick = () => link.parentElement.classList.toggle('open'); });
                if (state.loggedInUser) {
                    getEl('sidebar').querySelector('#logout-btn').onclick = logout;
                }
            };
            
            const renderHeader = (title, actionsHtml = '') => {
                const schoolName = "SCHOOL OF MANAGEMENT SCIENCES - VARANASI";
                const calcBtn = `<button id="calculator-btn" class="action-button inline no-print" title="Calculator" style="padding: 12px 15px;"><i class="fas fa-calculator"></i></button>`;
                const voiceBtn = `<button id="voice-assist-btn" class="action-button inline no-print" title="Voice Assistant" style="padding: 12px 15px;"><i class="fas fa-microphone"></i></button>`;
                const themeModeBtn = `<button id="theme-mode-btn" class="action-button inline no-print" title="Toggle Dark/Light Mode" style="padding: 12px 15px;"><i class="fas fa-moon"></i></button>`;
                return `<div class="header no-print"><div class="header-left"><button class="menu-toggle"><i class="fas fa-bars"></i></button>
                        <div class="header-title-container"><span class="moving-title">${schoolName}</span></div></div>
                        <div class="header-actions"><div id="real-time-clock"></div> ${voiceBtn} ${calcBtn} ${themeModeBtn} ${actionsHtml}</div></div>`;
            };
            
            const renderMainFooter = () => {
                const schoolInfo = state.data.siteContent;
                getEl('main-footer').innerHTML = `<div class="footer-content"><div class="footer-contact">
                        <p><i class="fas fa-map-marker-alt"></i> ${schoolInfo.schoolAddress}</p>
                        <p><i class="fas fa-phone-alt"></i> <a href="tel:${schoolInfo.schoolContact}" style="color: var(--text-color); text-decoration: none;">${schoolInfo.schoolContact}</a></p>
                         <p><i class="fas fa-envelope"></i> <a href="mailto:${schoolInfo.schoolEmail}" style="color: var(--text-color); text-decoration: none;">${schoolInfo.schoolEmail}</a></p>
                        </div><div class="footer-map"><iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3608.333283944358!2d82.99187317505315!3d25.259461977670737!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x398e268b2fed1e83%3A0x7c73c7c223594828!2sSchool%20of%20Management%20Sciences%20(SMS)%2C%20Varanasi!5e0!3m2!1sen!2sin!4v1663073756241!5m2!1sen!2sin" 
                        width="300" height="120" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe></div></div>`;
            };

            const showModal = (title, content, maxWidth = '600px') => {
                const modalHTML = `<div class="modal-overlay no-print"><div class="modal-content" style="max-width: ${maxWidth};"><div class="modal-header no-print"><h2>${title}</h2>
                        <button class="close-btn" onclick="closeModal()"></button></div><div class="modal-body">${content}</div></div></div>`;
                getEl('modal-container').innerHTML = modalHTML;
            };

            function getFeeDefaulters() {
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                const studentsWithPaymentsThisMonth = new Set();

                (state.data.transactions || []).forEach(t => {
                    const transactionDate = new Date(t.date);
                    if (transactionDate.getMonth() === currentMonth && transactionDate.getFullYear() === currentYear) {
                        studentsWithPaymentsThisMonth.add(t.studentId);
                    }
                });

                return (state.data.students || []).filter(s => !studentsWithPaymentsThisMonth.has(s.id));
            }

            function getTopStudents() {
                const { marks, examMasters, students, siteContent } = state.data;
                const gradePointMap = { 'O': 10, 'A+': 9, 'A': 8, 'B+': 7, 'B': 6, 'C': 5, 'P': 4, 'F': 0, 'Ab': 0 };

                if (siteContent && siteContent.manualTopperStudentIds && siteContent.manualTopperStudentIds.length > 0) {
                    return siteContent.manualTopperStudentIds.map(topperId => {
                        const manualTopper = findById('students', topperId);
                        if (manualTopper) {
                            return {
                                student: manualTopper,
                                sgpa: null,
                                examName: "Honorary Topper",
                                isManual: true
                            };
                        }
                        return null;
                    }).filter(t => t !== null);
                }

                if (!marks || !examMasters || !students || examMasters.length === 0) return [];

                const latestDeclaredExam = examMasters
                    .filter(em => em.declarationDate && new Date(em.declarationDate) <= new Date())
                    .sort((a, b) => new Date(b.declarationDate) - new Date(a.declarationDate))[0];

                if (!latestDeclaredExam) return [];

                const examMarks = marks[latestDeclaredExam.id];
                if (!examMarks) return [];

                let allStudentScores = [];

                for (const studentId in examMarks) {
                    const studentResult = examMarks[studentId];
                    const studentData = findById('students', studentId);

                    if (studentData) {
                        let totalGradePoints = 0;
                        let totalCredits = 0;

                        studentResult.forEach(m => {
                            const gradePoint = gradePointMap[m.grade] || 0;
                            const credits = m.credits || 0;
                            totalGradePoints += gradePoint * credits;
                            totalCredits += credits;
                        });

                        const sgpa = totalCredits > 0 ? (totalGradePoints / totalCredits).toFixed(2) : 0;
                        allStudentScores.push({ student: studentData, sgpa: sgpa, examName: latestDeclaredExam.name, isManual: false });
                    }
                }

                return allStudentScores.sort((a, b) => b.sgpa - a.sgpa).slice(0, 3);
            }
            
            function renderImageSlider() {
                const schoolInfo = state.data.siteContent;
                const coursesHtml = courseOptionsList.map(c => `<span>${c}</span>`).join(' &nbsp;  &nbsp; ');
                
                // Ensure there are images to display
                const slidesHtml = sliderImages.length > 0 ? sliderImages.map(imgUrl => `
                    <div class="slide" style="background-image: url('${imgUrl}');">
                        <div class="slide-overlay">
                            <h2>${schoolInfo.schoolName}</h2>
                            <p>${schoolInfo.schoolAddress}</p>
                            <button class="action-button" onclick="navigate('admission')">ADMISSION OPEN - 2025-26</button>
                            <div class="scrolling-courses-container">
                                <div class="scrolling-courses">${coursesHtml} ${coursesHtml}</div>
                            </div>
                        </div>
                    </div>
                `).join('') : '<div class="slide"><div class="slide-overlay"><h2>Welcome</h2></div></div>';

                return `
                    <div class="slider-container">
                        <div class="slides" style="width: ${sliderImages.length * 100}%;">
                            ${slidesHtml}
                        </div>
                        <div class="slider-nav">
                            <button class="prev-slide">&lt;</button>
                            <button class="next-slide">&gt;</button>
                        </div>
                        <div class="slider-dots"></div>
                    </div>`;
            }

            function initSlider() {
                const slides = document.querySelector('.slides');
                if (!slides || sliderImages.length === 0) return;

                const slideCount = sliderImages.length;
                slides.querySelectorAll('.slide').forEach(s => s.style.width = `${100 / slideCount}%`);
                
                let currentIndex = 0;
                let slideInterval;

                const prevButton = document.querySelector('.prev-slide');
                const nextButton = document.querySelector('.next-slide');
                const dotsContainer = document.querySelector('.slider-dots');

                dotsContainer.innerHTML = ''; // Clear existing dots
                for (let i = 0; i < slideCount; i++) {
                    const dot = document.createElement('div');
                    dot.classList.add('dot');
                    dot.addEventListener('click', () => goToSlide(i));
                    dotsContainer.appendChild(dot);
                }
                const dots = document.querySelectorAll('.dot');

                function updateDots() {
                    dots.forEach((dot, index) => {
                        dot.classList.toggle('active', index === currentIndex);
                    });
                }

                function goToSlide(index) {
                    currentIndex = (index + slideCount) % slideCount;
                    slides.style.transform = `translateX(-${currentIndex * (100 / slideCount)}%)`;
                    updateDots();
                }

                function nextSlide() {
                    goToSlide(currentIndex + 1);
                }

                function prevSlide() {
                    goToSlide(currentIndex - 1);
                }
                
                function startSlider() {
                    stopSlider(); // Ensure no multiple intervals running
                    slideInterval = setInterval(nextSlide, 5000); 
                }

                function stopSlider() {
                    clearInterval(slideInterval);
                }

                prevButton.addEventListener('click', () => {
                    prevSlide();
                    stopSlider();
                    startSlider();
                });
                nextButton.addEventListener('click', () => {
                    nextSlide();
                    stopSlider();
                    startSlider();
                });
                
                document.querySelector('.slider-container').addEventListener('mouseenter', stopSlider);
                document.querySelector('.slider-container').addEventListener('mouseleave', startSlider);

                goToSlide(0);
                startSlider();
            }
            
            function renderPlaceholderPage(title) {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader(title);
                mainContent.innerHTML += `
                    <div class="page active">
                        <div class="card" style="text-align: center;">
                            <h2>${title}</h2>
                            <p style="margin-top: 20px; font-size: 1.2rem; color: var(--text-muted);">This feature is under construction and will be available soon.</p>
                            <i class="fas fa-cogs" style="font-size: 4rem; margin-top: 30px; color: var(--primary-light);"></i>
                        </div>
                    </div>`;
            }


            function renderHomePage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Dashboard');
                const userProfile = state.loggedInUser;
                const userRole = userProfile?.role || 'guest';
                const { students, notices, teachers, examSchedules, staff, events, siteContent, schoolPhotos, externalLinks, videos, books, inquiries, placements } = state.data;
                
                 // NEW: HTML for the new features box
                const newFeaturesHtml = `
                    <div class="card">
                        <div class="card-header"><h3>Features & Tools</h3></div>
                        <div class="features-grid">
                            <button class="feature-btn" onclick="showLiveClassesModal()"><i class="fas fa-video"></i>Live Classes</button>
                            <button class="feature-btn" onclick="showLinkNotesModal()"><i class="fas fa-link"></i>Link Notes</button>
                            <button class="feature-btn" onclick="showLiveTestModal()"><i class="fas fa-stopwatch"></i>Live Test</button>
                            <button class="feature-btn" onclick="showScannerModal('document')"><i class="fas fa-scanner"></i>Scan Document</button>
                            <button class="feature-btn" onclick="showScannerModal('photo')"><i class="fas fa-camera"></i>Click Photo</button>
                            <button class="feature-btn" onclick="showScannerModal('book')"><i class="fas fa-book-open"></i>Upload Book Photo</button>
                            <button class="feature-btn" onclick="showTranslatorModal()"><i class="fas fa-language"></i>Translator</button>
                        </div>
                    </div>
                `;
                
                const recentNoticesHtml = (notices || []).sort((a, b) => b.id - a.id).slice(0, 3).map(n => `
                    <div class="notice-item">
                        <h4>${n.title}</h4>
                        <p>${n.content.substring(0, 80)}...</p>
                        <div class="notice-date">${new Date(n.id).toLocaleString()}</div>
                    </div>`).join('') || '<div class="notice-item"><p>No recent notices.</p></div>';
                
                const latestNewsHtml = (siteContent.latestNews || []).sort((a, b) => b.id - a.id).slice(0, 3).map(n => `
                    <div class="notice-item">
                        <h4>${n.title}</h4>
                        <p>${n.content.substring(0, 80)}...</p>
                        <div class="notice-date">${new Date(n.id).toLocaleString()}</div>
                    </div>`).join('') || '<div class="notice-item"><p>No latest news.</p></div>';

                const upcomingEventsHtml = (events || [])
                    .filter(ev => new Date(ev.date) >= new Date())
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .slice(0, 3)
                    .map(ev => `
                    <div class="notice-item">
                        <h4>${ev.title}</h4>
                        <p>${ev.description.substring(0, 80)}...</p>
                        <div class="notice-date">On: ${new Date(ev.date).toLocaleDateString()}</div>
                    </div>`).join('') || '<div class="notice-item"><p>No upcoming events.</p></div>';
                
                const recentInquiriesHtml = (inquiries || []).sort((a, b) => b.id - a.id).slice(0, 3).map(i => `
                    <div class="notice-item">
                        <h4>${i.name} for ${i.className}</h4>
                        <p>Contact: ${i.contact}</p>
                        <div class="notice-date">Status: ${i.status}</div>
                    </div>`).join('') || '<div class="notice-item"><p>No new inquiries.</p></div>';

                const newBooksHtml = (books || []).sort((a, b) => b.id - a.id).slice(0, 3).map(b => `
                    <div class="notice-item">
                        <h4>${b.title}</h4>
                        <p>By ${b.author}</p>
                    </div>`).join('') || '<div class="notice-item"><p>No new books added recently.</p></div>';

                const upcomingExamsHtml = (examSchedules || [])
                    .filter(ex => new Date(ex.date) >= new Date())
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .slice(0, 5)
                    .map(ex => {
                        const examMaster = findById('examMasters', ex.examMasterId);
                        return `<li class="detail-list-item">
                            <span><i class="fas fa-file-signature" style="color:var(--primary-light); margin-right:10px;"></i><strong>${ex.subject}</strong> (${ex.className})<br><small style="color:var(--text-muted)">${examMaster ? examMaster.name : 'Unknown Exam'}</small></span>
                            <span>${new Date(ex.date).toLocaleDateString()}</span>
                        </li>`;
                    }).join('') || '<li>No upcoming exams scheduled.</li>';
                
                const studentAttendance = getTodaysAttendanceSummary('students');
                
                const studentAttendancePercentage = (students || []).length > 0 ? ((studentAttendance.present / (students || []).length) * 100).toFixed(0) : 0;

                const studentCountsByCourse = (students || []).reduce((acc, student) => {
                    const courseName = student.className;
                    if(courseName) {
                       acc[courseName] = (acc[courseName] || 0) + 1;
                    }
                    return acc;
                }, {});

                const courseStrengthHtml = courseOptionsList.map(courseName => {
                    const count = studentCountsByCourse[courseName] || 0;
                    return `<li class="detail-list-item clickable" onclick="navigate('students', 'list', null, '${courseName}')">
                        <span><i class="fas fa-users" style="color:var(--primary-light); margin-right:10px;"></i>${courseName}</strong></span>
                        <span style="font-weight: bold; font-size: 1.2em;">${count}</span>
                    </li>`;
                }).join('') || '<li>No students enrolled in any course yet.</li>';

                const recentlyAddedStudents = (students || []).sort((a, b) => b.id - a.id).slice(0, 10);
                let recentStudentsHtml = recentlyAddedStudents.length > 0 ? recentlyAddedStudents.map(s => `
                    <div class="lookup-result-item" onclick="navigate('students', 'profile', '${s.id}')">
                        <img src="${s.photo || `https://ui-avatars.com/api/?name=${s.name.replace(/\s/g, "+")}`}" alt="Photo">
                        <div style="flex-grow: 1;">
                            <strong>${s.name}</strong>
                            <p style="font-size: 0.9em; color: var(--text-muted);">Course: ${s.className || 'N/A'}</p>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
                    </div>
                `).join('') : '<p style="text-align:center; color: var(--text-muted); padding: 20px 0;">No new admissions yet.</p>';

                if(recentlyAddedStudents.length > 0) {
                    recentStudentsHtml += recentStudentsHtml;
                }
                
                const ourFacultyHtml = (teachers || []).length > 0 ? teachers.map(teacher => `
                    <div class="card" style="text-align: center; cursor: pointer;" onclick="navigate('teachers', 'profile', '${teacher.id}')">
                        <img src="${teacher.photo || `https://ui-avatars.com/api/?name=${teacher.name.replace(/\s/g, "+")}`}" alt="Teacher Photo" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-light);">
                        <h4 style="margin-top: 15px; font-size: 1.1rem;">${teacher.name}</h4>
                        <p style="color: var(--text-muted);">${teacher.role}</p>
                    </div>
                `).join('') : '<p style="text-align:center; color: var(--text-muted);">No teachers have been added yet.</p>';
                 
                const topStudents = getTopStudents();
                let topperCardsHtml = '';
                const topperPhoto = siteContent.topperPhoto || '';

                if (topStudents.length > 0) {
                    topperCardsHtml = topStudents.map(topStudentInfo => {
                        const displayPhoto = topperPhoto || topStudentInfo.student.photo || `https://ui-avatars.com/api/?name=${topStudentInfo.student.name.replace(/\s/g, "+")}`;
                        
                        return `
                        <div class="card" style="border-left: 5px solid var(--warning-color); text-align: center;">
                            <h3 style="color: var(--warning-color); font-size: 1.5rem; margin-bottom: 15px;"><i class="fas fa-crown"></i> College Topper</h3>
                            <img src="${displayPhoto}" alt="Topper Photo" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid var(--warning-color);">
                            <h4 style="margin-top: 15px; font-size: 1.4rem;">${topStudentInfo.student.name}</h4>
                            <p style="color: var(--text-muted); font-size: 1.1rem;">${topStudentInfo.student.className}</p>
                            ${topStudentInfo.isManual ? 
                                `<p style="color: var(--text-muted); font-size: 0.9rem;">(${topStudentInfo.examName})</p>` :
                                `<p style="font-size: 1.5rem; font-weight: bold; color: var(--success-color); margin-top: 10px;">SGPA: ${topStudentInfo.sgpa}</p>
                                 <p style="color: var(--text-muted); font-size: 0.9rem;">(${topStudentInfo.examName})</p>`
                            }
                        </div>`;
                    }).join('');
                } else {
                    topperCardsHtml = `
                     <div class="card" style="border-left: 5px solid var(--info-color); text-align: center;">
                         <h3 style="color: var(--info-color); font-size: 1.5rem; margin-bottom: 15px;"><i class="fas fa-crown"></i> College Topper</h3>
                         <p style="color: var(--text-muted); padding: 20px 0;">Topper information is not available.</p>
                     </div>`;
                }
                
                const homeVideoGalleryHtml = (videos && videos.length > 0) ? `
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-video"></i> Video Gallery</h3>
                            <button class="action-button inline" onclick="navigate('media', 'list', 'videos')">View All</button>
                        </div>
                         <div class="videos-grid">
                            ${videos.slice(0, 3).map(item => `
                                <div class="video-item">
                                    <iframe src="${getYoutubeEmbedUrl(item.url)}" title="${item.title}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                                    <div class="video-item-footer">
                                        <span>${item.title}</span>
                                    </div>
                                </div>`).join('')}
                        </div>
                    </div>` : '';


                const schoolPhotosHtml = (schoolPhotos && schoolPhotos.length > 0) ? `
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-school"></i> Photo Gallery</h3>
                            ${ userRole === 'admin' ? `<button class="action-button inline" onclick="navigate('settings', 'list', 'schoolPhotos')">Manage</button>` : `<button class="action-button inline" onclick="navigate('media', 'list', 'gallery')">View All</button>`}
                        </div>
                        <div class="school-photos-container">
                            ${schoolPhotos.map(photo => `
                                <div class="school-photo-item">
                                    <img src="${photo.image}" alt="${photo.title}">
                                    <div class="photo-title">${photo.title}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : '';
                
                 const placementsHtml = (placements && placements.length > 0) ? `
                     <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-handshake"></i> Our Recruiters</h3>
                             ${ userRole === 'admin' ? `<button class="action-button inline" onclick="navigate('settings', 'list', 'placements')">Manage</button>` : ''}
                        </div>
                        <div class="scrolling-wrapper">
                            <div class="scroller">
                                ${[...placements, ...placements].map(p => `<a href="${p.url || '#'}" target="_blank" class="placement-logo-item" title="${p.name}"><img src="${p.logo}" alt="${p.name}"></a>`).join('')}
                            </div>
                        </div>
                     </div>
                ` : '';

                const importantLinksHtml = (externalLinks && externalLinks.length > 0) ? `
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-link"></i> Important Links</h3>
                        </div>
                        <div class="important-links-grid">
                            ${externalLinks.map(link => {
                                let actionAttr = `href="${link.url}" target="_blank"`;
                                if (link.specialAction) {
                                    actionAttr = `href="#" onclick="event.preventDefault(); navigate('${link.specialAction}')"`;
                                }
                                return `<a ${actionAttr} class="important-link-item">${link.title}</a>`;
                            }).join('')}
                        </div>
                    </div>
                ` : '';
                
                 const directorDeskHtml = siteContent.principalDesk ? `
                    <div class="card">
                        <div class="card-header"><h3><i class="fas fa-user-tie"></i> From the Director's Desk</h3></div>
                        <p style="white-space: pre-wrap;">${siteContent.principalDesk}</p>
                    </div>` : '';
                
                const aboutSchoolHtml = siteContent.aboutSchool ? `
                    <div class="card">
                        <div class="card-header"><h3><i class="fas fa-school"></i> About Our College</h3></div>
                        <p style="white-space: pre-wrap;">${siteContent.aboutSchool}</p>
                    </div>` : '';

                const welcomeBoxHtml = userProfile ? `
                    <div class="card" style="margin-bottom: 25px; background: var(--primary-gradient); color: white; text-align: center;">
                        <h2 style="font-size: 1.8rem; margin-bottom: 5px;">Welcome back, ${userProfile.name}!</h2>
                        <p>Here's a quick overview of ${siteContent.schoolName}.</p>
                    </div>
                ` : '';

                const aiToolsHtml = (userRole === 'admin' || userRole === 'teacher' || userRole === 'student') ? `
                    <div class="card">
                        <div class="card-header"><h3><i class="fas fa-robot"></i> AI Academic Tools</h3></div>
                         <div class="home-action-grid">
                            <a href="#" onclick="event.preventDefault(); showAiToolModal('summary');" class="home-action-card" style="background: var(--primary-color); color: white;">
                                <i class="fas fa-file-alt"></i>
                                <span>Text Summarizer</span>
                            </a>
                             <a href="#" onclick="event.preventDefault(); showAiToolModal('grammar');" class="home-action-card" style="background: var(--success-color); color: white;">
                                <i class="fas fa-spell-check"></i>
                                <span>Grammar & Plagiarism Check</span>
                            </a>
                             <a href="#" onclick="event.preventDefault(); showAiToolModal('tutor');" class="home-action-card" style="background: var(--warning-color); color: white;">
                                <i class="fas fa-question-circle"></i>
                                <span>AI Doubt Solver</span>
                            </a>
                        </div>
                    </div>
                ` : '';

                const adminActivityHtml = userRole === 'admin' ? `
                    <div class="card">
                        <div class="card-header"><h3><i class="fas fa-history"></i> Recent Admin Activity</h3></div>
                        <div class="notice-board">
                            <div class="notice-item">
                                <p><strong>You</strong> added a new student: <strong>Rajesh Kumar</strong>.</p>
                                <div class="notice-date">5 minutes ago</div>
                            </div>
                             <div class="notice-item">
                                <p><strong>You</strong> updated the notice board.</p>
                                <div class="notice-date">1 hour ago</div>
                            </div>
                             <div class="notice-item">
                                <p><strong>You</strong> marked attendance for BCA.</p>
                                <div class="notice-date">3 hours ago</div>
                            </div>
                            <p style="text-align:center; color: var(--text-muted); padding-top: 15px;">(This is a demonstration)</p>
                        </div>
                    </div>
                `: '';

                mainContent.innerHTML += `<div class="page active">
                    ${welcomeBoxHtml}
                    
                    ${renderImageSlider()}

                    <div class="home-action-grid">
                        <a href="#" onclick="event.preventDefault(); navigate('admission');" class="home-action-card home-action-card-admission">
                            <i class="fas fa-rocket"></i>
                            <span>ADMISSION OPEN<br>2025-26</span>
                        </a>
                        <a href="#" onclick="event.preventDefault(); showInquiryForm();" class="home-action-card home-action-card-enquiry">
                            <i class="fas fa-question-circle"></i>
                            <span>ENQUIRY</span>
                        </a>
                    </div>
                    
                    ${newFeaturesHtml}

                    ${ userRole === 'admin' ? `
                    <div class="card">
                        <div class="card-header" style="border:none; padding-bottom: 0;"><h3><i class="fas fa-bolt"></i> Quick Actions</h3></div>
                        <div class="quick-actions-grid" style="margin-top: 15px;">
                            <button class="quick-action-btn" onclick="navigate('admission')"><i class="fas fa-user-plus"></i> Add Student</button>
                            <button class="quick-action-btn" onclick="navigate('adminStudentAttendance')"><i class="fas fa-calendar-check"></i> Student Attendance</button>
                            <button class="quick-action-btn" onclick="navigate('students', 'list', 'promoteStudents')"><i class="fas fa-arrow-up"></i> Promote Students</button>
                            <button class="quick-action-btn" onclick="showUnifiedScanner()"><i class="fas fa-qrcode"></i> Scan QR</button>
                            <button class="quick-action-btn" onclick="renderBiometricAttendancePage()"><i class="fas fa-fingerprint"></i> Biometric Attendance</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header"><h3><i class="fas fa-search"></i> Quick Student Lookup</h3></div>
                        <div class="search-box-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="student-lookup-input" oninput="lookupStudent(this.value)" placeholder="Search by Name, Roll No, Admission No..." class="search-input">
                        </div>
                        <div id="student-lookup-results"></div>
                    </div>
                    ` : ''}

                    ${aiToolsHtml}
                    ${adminActivityHtml}

                    ${placementsHtml}

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px;">
                        ${topperCardsHtml}
                    </div>
                    
                    <div class="dashboard-grid">
                        <div class="stat-card"><i class="fas fa-user-graduate"></i><h3>${(students || []).length}</h3><p>Total Students</p></div>
                        <div class="stat-card"><i class="fas fa-chalkboard-teacher"></i><h3>${(teachers || []).length}</h3><p>Total Teachers</p></div>
                        <div class="stat-card"><i class="fas fa-user-friends"></i><h3>${(staff || []).length}</h3><p>Total Staff</p></div>
                        <div class="stat-card"><i class="fas fa-dollar-sign"></i><h3>${getMonthlyFinancialData().currentMonthIncome}</h3><p>This Month's Income</p></div>
                    </div>
                    
                     <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px;">
                         <div class="card home-attendance-summary">
                             <div class="card-header" style="border:none; padding-bottom: 0;"><h3><i class="fas fa-user-check"></i> Today's Student Attendance</h3></div>
                             <div class="attendance-stats">
                                <div class="stat-item present"><span class="count">${studentAttendance.present}</span><span>Present</span></div>
                                <div class="stat-item absent"><span class="count">${studentAttendance.absent}</span><span>Absent</span></div>
                            </div>
                            <div class="attendance-bar-container"><div class="attendance-bar" style="width: ${studentAttendancePercentage}%;"></div></div>
                            <p class="percentage">${studentAttendancePercentage}% of total students are present</p>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-bullhorn"></i> Notice Board</h3>
                                <button class="action-button inline" onclick="navigate('noticeBoard')">View All</button>
                            </div>
                            <div class="notice-board">${recentNoticesHtml}</div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-newspaper"></i> Latest News</h3>
                                ${ userRole === 'admin' ? `<button class="action-button inline" onclick="navigate('settings', 'list', 'content')">Manage</button>` : ''}
                            </div>
                            <div class="notice-board">${latestNewsHtml}</div>
                        </div>
                     </div>

                     <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; margin-top: 30px;">
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-calendar-star"></i> Upcoming Events</h3>
                                <button class="action-button inline" onclick="navigate('events')">View All</button>
                            </div>
                            <div class="notice-board">${upcomingEventsHtml}</div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-book"></i> New Library Books</h3>
                                <button class="action-button inline" onclick="navigate('library', 'list', 'bookList')">View All</button>
                            </div>
                            <div class="notice-board">${newBooksHtml}</div>
                        </div>
                        ${ userRole === 'admin' ? `
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-question-circle"></i> Recent Inquiries</h3>
                                <button class="action-button inline" onclick="navigate('inquiries')">View All</button>
                            </div>
                            <div class="notice-board">${recentInquiriesHtml}</div>
                        </div>
                        ` : '' }
                     </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; margin-top: 30px;">
                         <div style="display: flex; flex-direction: column; gap: 30px;">
                            <div class="card">
                                <div class="card-header"><h3><i class="fas fa-chart-pie"></i> Class Strength</h3></div>
                                <ul class="detail-list">${courseStrengthHtml}</ul>
                            </div>
                            <div class="card"><div class="card-header"><h3><i class="fas fa-calendar-day"></i> Upcoming Exams</h3></div><ul class="detail-list">${upcomingExamsHtml}</ul></div>
                            ${ userRole === 'admin' ? `
                            <div class="card">
                                <div class="card-header"><h3><i class="fas fa-user-clock"></i> Recently Added Students</h3></div>
                                <div class="recent-students-scroller">
                                    <div class="scroller-inner">${recentStudentsHtml}</div>
                                </div>
                            </div>
                            ` : '' }
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 30px;">
                            <div class="card"><div class="card-header"><h3><i class="fas fa-chart-line"></i> Monthly Financials</h3></div><canvas id="financials-chart"></canvas></div>
                            <div class="card"><div class="card-header"><h3><i class="fas fa-chart-area"></i> Attendance Trends (7 Days)</h3></div><canvas id="attendance-trend-chart"></canvas></div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-top: 30px;">
                        ${directorDeskHtml}
                        ${aboutSchoolHtml}
                    </div>

                    <div class="card">
                        <div class="card-header"><h3><i class="fas fa-chalkboard-teacher"></i> Our Faculty</h3></div>
                        <div class="dashboard-grid" style="margin-top: 20px;">
                            ${ourFacultyHtml}
                        </div>
                    </div>
                    
                    ${homeVideoGalleryHtml}
                    ${schoolPhotosHtml}
                    ${importantLinksHtml}
                </div>`;
                
                initSlider();


                if (getEl('financials-chart')) {
                    const { income, expense, labels } = getMonthlyFinancialData();
                    new Chart(getEl('financials-chart').getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                { label: 'Income', data: income, backgroundColor: 'var(--success-color)' },
                                { label: 'Expense', data: expense, backgroundColor: 'var(--error-color)' }
                            ]
                        },
                        options: { scales: { y: { beginAtZero: true, ticks: { color: 'var(--text-color)' } }, x: { ticks: { color: 'var(--text-color)' } } } }
                    });
                }

                if (getEl('attendance-trend-chart')) {
                    const labels = [];
                    const presentData = [];
                    const absentData = [];
                    
                    for (let i = 6; i >= 0; i--) {
                        const d = new Date();
                        d.setDate(d.getDate() - i);
                        const dateStr = d.toISOString().slice(0, 10);
                        labels.push(d.toLocaleDateString('en-US', { weekday: 'short' }));
                        
                        const attendance = state.data.studentAttendance[dateStr] || {};
                        let p = 0, a = 0;
                        Object.values(attendance).forEach(status => {
                            if (status === 'present') p++;
                            if (status === 'absent') a++;
                        });
                        presentData.push(p);
                        absentData.push(a);
                    }

                    new Chart(getEl('attendance-trend-chart').getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                { label: 'Present', data: presentData, borderColor: 'var(--success-color)', tension: 0.4, fill: false },
                                { label: 'Absent', data: absentData, borderColor: 'var(--error-color)', tension: 0.4, fill: false }
                            ]
                        },
                        options: { 
                            responsive: true,
                            scales: { y: { beginAtZero: true, ticks: { color: 'var(--text-color)' } }, x: { ticks: { color: 'var(--text-color)' } } },
                            plugins: { legend: { labels: { color: 'var(--text-color)' } } }
                        }
                    });
                }
            }
            
            function lookupStudent(query) {
                const resultsContainer = getEl('student-lookup-results');
                if (!resultsContainer) return;
                query = query.trim().toLowerCase();
                
                if (!query) {
                    resultsContainer.innerHTML = '';
                    return;
                }
                
                const results = (state.data.students || []).filter(s => 
                    (s.name && s.name.toLowerCase().includes(query)) ||
                    (s.rollNumber && s.rollNumber.toLowerCase().includes(query)) ||
                    (s.admissionNumber && s.admissionNumber.toLowerCase().includes(query)) ||
                    (s.contact && s.contact.includes(query))
                ).slice(0, 5);
                
                if (results.length === 0) {
                    resultsContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No students found.</p>';
                    return;
                }
                
                resultsContainer.innerHTML = results.map(s => `
                    <div class="lookup-result-item">
                        <img src="${s.photo || `https://ui-avatars.com/api/?name=${s.name.replace(/\s/g, "+")}`}" alt="Photo">
                        <div style="flex-grow: 1;">
                            <strong>${s.name}</strong>
                            <p style="font-size: 0.9em; color: var(--text-muted);">Course: ${s.className || 'N/A'} (Sem ${s.currentSemester || 1})</p>
                        </div>
                        <button class="action-button inline" onclick="navigate('students', 'profile', '${s.id}')">View Profile</button>
                    </div>
                `).join('');
            }
            
            // NEW RE-DESIGNED STUDENT DASHBOARD
            function renderStudentDashboardPage() {
                const mainContent = getEl('main-content');
                const user = state.loggedInUser;

                const student = user.role === 'parent' ? findById('students', user.studentId) : user;
                if (!student) {
                    mainContent.innerHTML = renderHeader(`Error`);
                    mainContent.innerHTML += `<div class="page active"><p class="form-feedback error">Could not find linked student data.</p></div>`;
                    return;
                }
                
                mainContent.innerHTML = renderHeader(`Dashboard`);
                
                const { present, absent } = calculateAttendance('students', student.id);
                const totalDays = present + absent;
                const attendancePercentage = totalDays > 0 ? ((present / totalDays) * 100).toFixed(1) : 'N/A';

                const upcomingExamsHtml = (state.data.examSchedules || [])
                    .filter(ex => new Date(ex.date) >= new Date() && ex.className === student.className)
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .slice(0, 3)
                    .map(ex => {
                        const examMaster = findById('examMasters', ex.examMasterId);
                        return `
                        <li class="detail-list-item">
                            <span><i class="fas fa-file-signature" style="margin-right:10px;"></i><strong>${ex.subject}</strong></span>
                            <span>${new Date(ex.date).toLocaleDateString()}</span>
                        </li>`;
                    }).join('') || '<li>No upcoming exams.</li>';
                
                const recentHomework = (state.data.homework || [])
                    .filter(h => h.className === student.className && h.semester === student.currentSemester)
                    .sort((a,b) => new Date(b.dueDate) - new Date(a.dueDate))
                    .slice(0, 3)
                    .map(h => `
                        <li class="detail-list-item clickable" onclick="navigate('studentHomework')">
                            <span><i class="fas fa-book-open" style="margin-right:10px;"></i><strong>${h.title}</strong><br><small>${h.subject}</small></span>
                            <span style="color: var(--warning-color);">Due: ${new Date(h.dueDate).toLocaleDateString()}</span>
                        </li>
                    `).join('') || '<li>No recent homework.</li>';
                
                 // NEW: Features Box for Student
                const studentFeaturesHtml = `
                    <div class="card" style="grid-column: 1 / -1;">
                        <div class="card-header"><h3>Features & Tools</h3></div>
                        <div class="features-grid">
                           <button class="feature-btn" onclick="showLiveClassesModal()"><i class="fas fa-video"></i>Live Classes</button>
                            <button class="feature-btn" onclick="showLinkNotesModal()"><i class="fas fa-link"></i>Link Notes</button>
                            <button class="feature-btn" onclick="showLiveTestModal()"><i class="fas fa-stopwatch"></i>Live Test</button>
                            <button class="feature-btn" onclick="showScannerModal('document')"><i class="fas fa-scanner"></i>Scan Document</button>
                            <button class="feature-btn" onclick="showScannerModal('book')"><i class="fas fa-book-open"></i>Upload Book Photo</button>
                            <button class="feature-btn" onclick="showTranslatorModal()"><i class="fas fa-language"></i>Translator</button>
                        </div>
                    </div>
                `;

                mainContent.innerHTML += `<div class="page active">
                    <div class="student-dashboard-grid">
                        <div class="card student-welcome-card">
                            <img src="${student.photo || `https://ui-avatars.com/api/?name=${student.name.replace(/\s/g, "+")}`}" alt="Student Photo">
                            <div>
                                <h2>Welcome, ${student.name.split(' ')[0]}!</h2>
                                <p>${student.className} - Semester ${student.currentSemester || 1}</p>
                            </div>
                        </div>

                        ${studentFeaturesHtml}

                        <a href="#" onclick="event.preventDefault(); navigate('studentProfile');" class="student-dash-card">
                            <i class="fas fa-user-circle"></i>
                            <h3>My Profile</h3>
                        </a>
                        
                        <a href="#" onclick="event.preventDefault(); navigate('studentAttendance');" class="student-dash-card">
                            <i class="fas fa-calendar-check"></i>
                            <h3>Attendance</h3>
                            <span class="stat-highlight">${attendancePercentage}%</span>
                        </a>

                        <a href="#" onclick="event.preventDefault(); navigate('studentHomework');" class="student-dash-card">
                            <i class="fas fa-book-open"></i>
                            <h3>Homework</h3>
                        </a>

                        <a href="#" onclick="event.preventDefault(); navigate('admitCardPortal');" class="student-dash-card">
                            <i class="fas fa-id-card"></i>
                            <h3>Admit Card</h3>
                        </a>

                        <a href="#" onclick="event.preventDefault(); navigate('resultPortal');" class="student-dash-card">
                            <i class="fas fa-award"></i>
                            <h3>Results</h3>
                        </a>

                        <a href="#" onclick="event.preventDefault(); navigate('studentFeePayment');" class="student-dash-card">
                            <i class="fas fa-rupee-sign"></i>
                            <h3>Fee Payment</h3>
                        </a>

                        <div class="card" style="grid-column: 1 / -1; md:grid-column: span 2;">
                            <div class="card-header"><h3><i class="fas fa-bell"></i> Quick Updates</h3></div>
                            <h4>Upcoming Exams</h4>
                            <ul class="detail-list">${upcomingExamsHtml}</ul>
                            <h4 style="margin-top: 20px;">Recent Homework</h4>
                            <ul class="detail-list">${recentHomework}</ul>
                        </div>
                    </div>
                </div>`;
            }

            function renderTeacherDashboardPage() {
                const mainContent = getEl('main-content');
                const user = state.loggedInUser;
                const schoolInfo = state.data.siteContent;

                mainContent.innerHTML = renderHeader(`Welcome, ${user.name}`);
                
                 const schoolPhotosHtml = (state.data.schoolPhotos && state.data.schoolPhotos.length > 0) ? `
                    <div class="card">
                        <div class="card-header"><h3><i class="fas fa-school"></i> Photo Gallery</h3></div>
                        <div class="school-photos-container">
                            ${state.data.schoolPhotos.slice(0, 3).map(photo => `
                                <div class="school-photo-item">
                                    <img src="${photo.image}" alt="${photo.title}">
                                    <div class="photo-title">${photo.title}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : '';
                
                 const aiToolsHtml = `
                    <div class="card">
                        <div class="card-header"><h3><i class="fas fa-robot"></i> AI Academic Tools</h3></div>
                         <div class="home-action-grid">
                            <a href="#" onclick="event.preventDefault(); showAiToolModal('summary');" class="home-action-card" style="background: var(--primary-color); color: white;">
                                <i class="fas fa-file-alt"></i>
                                <span>Text Summarizer</span>
                            </a>
                             <a href="#" onclick="event.preventDefault(); showAiToolModal('grammar');" class="home-action-card" style="background: var(--success-color); color: white;">
                                <i class="fas fa-spell-check"></i>
                                <span>Grammar & Plagiarism Check</span>
                            </a>
                             <a href="#" onclick="event.preventDefault(); showAiToolModal('tutor');" class="home-action-card" style="background: var(--warning-color); color: white;">
                                <i class="fas fa-question-circle"></i>
                                <span>AI Doubt Solver</span>
                            </a>
                        </div>
                    </div>
                `;

                mainContent.innerHTML += `<div class="page active">
                    <div class="card" style="background: var(--primary-gradient); color: white;">
                        <h2 style="font-size: 1.8rem;">Teacher Dashboard</h2>
                        <p>Manage your courses and academic activities from here.</p>
                    </div>
                     <div class="dashboard-grid">
                        <div class="stat-card" style="cursor: pointer;" onclick="navigate('academics', 'list', 'homework')">
                            <i class="fas fa-book-open"></i><h3>Homework</h3><p>Manage Homework</p>
                        </div>
                        <div class="stat-card" style="cursor: pointer;" onclick="navigate('adminStudentAttendance')">
                           <i class="fas fa-calendar-check"></i><h3>Attendance</h3><p>Take Attendance</p>
                        </div>
                         <div class="stat-card" style="cursor: pointer;" onclick="showUnifiedScanner()">
                           <i class="fas fa-qrcode"></i><h3>Scan Student QR</h3><p>For Attendance</p>
                        </div>
                        <div class="stat-card" style="cursor: pointer;" onclick="navigate('resultPortal')">
                            <i class="fas fa-award"></i><h3>Results</h3><p>View Results</p>
                        </div>
                        <div class="stat-card" style="cursor: pointer;" onclick="navigate('noticeBoard')">
                            <i class="fas fa-bullhorn"></i><h3>Notice Board</h3><p>View Notices</p>
                        </div>
                    </div>
                    ${aiToolsHtml}
                    ${schoolPhotosHtml}
                </div>`;
            }

            function getTodaysAttendanceSummary(type = 'students') {
                const today = new Date().toISOString().slice(0, 10);
                let attendanceSource;
                if(type === 'students') attendanceSource = state.data.studentAttendance;
                else if (type === 'teachers') attendanceSource = state.data.teacherAttendance;
                else if (type === 'staff') attendanceSource = state.data.staffAttendance;
                else return { present: 0, absent: 0, totalMarked: 0, absentMembers: [] };

                const todaysRecords = attendanceSource[today] || {};
                const memberList = state.data[type] || [];

                let present = 0;
                let absent = 0;
                
                if (!memberList || memberList.length === 0) {
                    return { present: 0, absent: 0, totalMarked: 0, absentMembers: [] };
                }

                memberList.forEach(member => {
                    if (todaysRecords.hasOwnProperty(member.id)) {
                       if (todaysRecords[member.id] === 'present') {
                           present++;
                       } else if (todaysRecords[member.id] === 'absent') {
                           absent++;
                       }
                    }
                });
                
                const totalMarked = present + absent;
                return { present, absent, totalMarked };
            }

            function renderAdmissionPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('New Admission');
                mainContent.innerHTML += `<div class="page active">
                    <div class="card">
                        <div class="card-header">
                            <h3>Start a New Admission (2025-26)</h3>
                        </div>
                        <p>Click the button below to open the new student admission form.</p>
                        <button class="action-button" style="margin-top:20px; font-size: 1.1rem; padding: 15px 30px;" onclick="showAdmissionForm()"><i class="fas fa-user-plus"></i> Open Admission Form</button>
                    </div>
                </div>`;
            }

            function showAdmissionForm() {
                const courseOptionsHTML = courseOptionsList
                    .map(c => `<option value="${c}">${c}</option>`).join('');
                
                const formContent = `
                    <form id="admission-form">
                        <h3 style="color: var(--primary-light); margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Personal Details</h3>
                        <div class="form-grid">
                            <div class="form-group"><label for="admission-name">Full Name</label><input type="text" id="admission-name" required></div>
                            <div class="form-group"><label for="admission-father-name">Father's Name</label><input type="text" id="admission-father-name" required></div>
                             <div class="form-group"><label for="admission-mother-name">Mother's Name</label><input type="text" id="admission-mother-name" required></div>
                            <div class="form-group"><label for="admission-guardian-name">Guardian's Name</label><input type="text" id="admission-guardian-name" required></div>
                            <div class="form-group"><label for="admission-dob">Date of Birth</label><input type="date" id="admission-dob" placeholder="YYYY-MM-DD" required></div>
                            <div class="form-group"><label for="admission-gender">Gender</label><select id="admission-gender" required><option value="">Select Gender</option><option value="Male">Male</option><option value="Female">Female</option><option value="Other">Other</option></select></div>
                            <div class="form-group"><label for="admission-category">Category</label><select id="admission-category" required><option value="">Select Category</option><option value="General">General</option><option value="OBC">OBC</option><option value="SC">SC</option><option value="ST">ST</option></select></div>
                        </div>
                        
                        <h3 style="color: var(--primary-light); margin-top: 30px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Contact & Login</h3>
                        <div class="form-grid">
                            <div class="form-group"><label for="admission-guardian-contact">Guardian's Contact Number (For Parent Login)</label><input type="tel" id="admission-guardian-contact" pattern="[0-9]{10}" title="Please enter a 10-digit phone number" required></div>
                            <div class="form-group"><label for="admission-contact">Student's Contact (Optional)</label><input type="tel" id="admission-contact" pattern="[0-9]{10}" title="Please enter a 10-digit phone number"></div>
                            <div class="form-group"><label for="admission-email">Email</label><input type="email" id="admission-email" ></div>
                            <div class="form-group"><label for="admission-password">Password</label><input type="password" id="admission-password" required placeholder="Create a password for student & parent"></div>
                        </div>
                        <div class="form-group"><label for="admission-address">Address</label><textarea id="admission-address" rows="3" required></textarea></div>
                        <div class="form-group"><label for="admission-pincode">Pin Code</label><input type="text" id="admission-pincode" value="221011" required></div>

                        <h3 style="color: var(--primary-light); margin-top: 30px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Academic Details</h3>
                        <div class="form-grid">
                             <div class="form-group">
                                <label for="admission-class">Select Course/Program</label>
                                <select id="admission-class" required>
                                    <option value="">Select a Course</option>
                                    ${courseOptionsHTML}
                                </select>
                            </div>
                        </div>

                        <h3 style="color: var(--primary-light); margin-top: 30px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Biometric Registration</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Face ID</label>
                                <button type="button" class="action-button secondary" onclick="registerBiometric('face', 'new_student')"><i class="fas fa-camera"></i> Open Camera</button>
                                <input type="hidden" id="admission-face-data">
                                <span id="admission-face-status" style="margin-left: 10px; font-size: 0.9em;">Not Registered</span>
                            </div>
                            <div class="form-group">
                                <label>Fingerprint</label>
                                <button type="button" class="action-button secondary" onclick="registerBiometric('fingerprint', 'new_student')"><i class="fas fa-fingerprint"></i> Open Scanner</button>
                                <input type="hidden" id="admission-fingerprint-data">
                                <span id="admission-fingerprint-status" style="margin-left: 10px; font-size: 0.9em;">Not Registered</span>
                            </div>
                        </div>

                        <h3 style="color: var(--primary-light); margin-top: 30px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Documents & Photo</h3>
                        <div class="form-grid">
                            <div class="form-group"><label for="admission-photo">Student's Photo</label><input type="file" id="admission-photo" accept="image/*" required></div>
                            <div class="form-group"><label for="admission-doc-aadhar">Aadhar Card (PDF/Image)</label><input type="file" id="admission-doc-aadhar" accept="image/*,application/pdf"></div>
                            <div class="form-group"><label for="admission-doc-signature">Signature</label><input type="file" id="admission-doc-signature" accept="image/*"></div>
                        </div>
                        
                        <button type="submit" class="action-button" style="width: 100%; margin-top: 20px;">Complete Admission</button>
                    </form>
                `;

                showModal('New Student Admission Form', formContent, '900px');
                getEl('admission-form').onsubmit = handleAdmissionSubmit;
            }
            
            async function handleAdmissionSubmit(e) {
                e.preventDefault();
                getEl('loading-overlay').style.display = 'flex';
                
                try {
                    const studentId = Date.now().toString();
                    const admissionNumber = `MGKVP/24SMS-${Date.now().toString().slice(-6)}`;
                    
                    const nextRollNumber = (state.data.students || []).length + 1;
                    const newRollNumber = `SMS${new Date().getFullYear().toString().slice(-2)}${(nextRollNumber).toString().padStart(5, '0')}`;
                    
                    const photoFile = getEl('admission-photo').files[0];
                    if (!photoFile) {
                        showToast("Student photo is required.", "error");
                        getEl('loading-overlay').style.display = 'none';
                        return;
                    }
                    
                    const aadharFile = getEl('admission-doc-aadhar').files[0];
                    const signatureFile = getEl('admission-doc-signature').files[0];

                    const studentPhoto = await fileToBase64(photoFile);
                    let studentDocs = [];
                    if(aadharFile) studentDocs.push({ name: "Aadhar Card", data: await fileToBase64(aadharFile), filename: aadharFile.name });
                    if(signatureFile) studentDocs.push({ name: "Signature", data: await fileToBase64(signatureFile), filename: signatureFile.name });

                    const studentData = {
                        id: studentId,
                        admissionNumber,
                        rollNumber: newRollNumber,
                        name: getEl('admission-name').value.trim(),
                        fatherName: getEl('admission-father-name').value.trim(),
                        motherName: getEl('admission-mother-name').value.trim(),
                        guardianName: getEl('admission-guardian-name').value.trim(),
                        guardianContact: getEl('admission-guardian-contact').value.trim(),
                        category: getEl('admission-category').value,
                        dob: getEl('admission-dob').value,
                        gender: getEl('admission-gender').value,
                        email: getEl('admission-email').value.trim(),
                        contact: getEl('admission-contact').value.trim(),
                        password: btoa(getEl('admission-password').value),
                        address: getEl('admission-address').value.trim(),
                        pincode: getEl('admission-pincode').value.trim(),
                        photo: studentPhoto,
                        board: "MGKVP",
                        className: getEl('admission-class').value,
                        currentSemester: 1, // Semester Integration
                        documents: studentDocs,
                        faceData: getEl('admission-face-data').value || null,
                        fingerprintData: getEl('admission-fingerprint-data').value || null
                    };

                    updateOrAddItem('students', studentData);

                    getEl('loading-overlay').style.display = 'none';
                    closeModal();
                    showAdmissionReceipt(studentData);
                    showToast('Admission Successful!', 'success');

                } catch (err) {
                    console.error("Admission Error:", err);
                    getEl('loading-overlay').style.display = 'none';
                    showToast('Admission failed. Please check all fields and try again.', 'error');
                }
            }
            
            function showAdmissionReceipt(student) {
                const schoolInfo = state.data.siteContent;
                const modalId = `receipt-${student.id}`;

                const receiptContent = `
                    <div class="printable-area" id="${modalId}">
                        <div class="receipt-container">
                             <div class="receipt-header">
                                <h2 style="text-transform: uppercase;">${schoolInfo.schoolName}</h2>
                                <p>${schoolInfo.schoolAddress}</p>
                                <h3>ADMISSION CONFIRMATION</h3>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px;">
                                <div>
                                    <p><strong>Admission No:</strong> ${student.admissionNumber}</p>
                                    <p><strong>Roll No:</strong> ${student.rollNumber}</p>
                                    <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                                </div>
                                <img src="${student.photo}" alt="Student Photo" class="receipt-student-photo">
                            </div>

                            <dl class="receipt-details-grid">
                                <dt>Student Name:</dt><dd>${student.name}</dd>
                                <dt>Father's Name:</dt><dd>${student.fatherName}</dd>
                                <dt>Course:</dt><dd>${student.className}</dd>
                                <dt>Semester:</dt><dd>${student.currentSemester}</dd>
                            </dl>

                            <div class="receipt-footer">
                                <div class="receipt-signature">
                                    <div class="receipt-signature-line"></div>
                                    <p>Authorized Signature</p>
                                </div>
                                <p>Welcome! This is a computer-generated confirmation.</p>
                            </div>
                        </div>
                    </div>
                     <div class="no-print" style="margin-top: 20px; display: flex; gap: 15px;">
                        <button class="action-button" onclick="printContent('#${modalId}')"><i class="fas fa-print"></i> Print Receipt</button>
                        <button class="action-button secondary" onclick="downloadAsPdf('#${modalId}', 'Admission-Receipt-${student.admissionNumber}.pdf')"><i class="fas fa-download"></i> Download PDF</button>
                    </div>
                `;
                showModal('Admission Successful', receiptContent, '800px');
            }


            function showFeeReceipt(studentId, transactionId, autoPrint = false) {
                const schoolInfo = state.data.siteContent;
                const student = findById('students', studentId);
                const transaction = findById('transactions', transactionId);
                if (!student || !transaction) return showToast("Receipt not found", "error");

                const modalId = `receipt-${transactionId}`;
                const receiptContent = `
                    <div class="printable-area" id="${modalId}">
                        <div class="receipt-container">
                             <div class="receipt-header">
                                <h2 style="text-transform: uppercase;">${schoolInfo.schoolName}</h2>
                                <p>${schoolInfo.schoolAddress}</p>
                                <h3>FEE RECEIPT</h3>
                            </div>
                            <div style="margin-bottom: 25px;">
                                <p><strong>Receipt No:</strong> ${transaction.id}</p>
                                <p><strong>Date:</strong> ${new Date(transaction.date).toLocaleDateString()}</p>
                            </div>
                            <dl class="receipt-details-grid">
                                <dt>Admission No:</dt><dd>${student.admissionNumber}</dd>
                                <dt>Roll No:</dt><dd>${student.rollNumber}</dd>
                                <dt>Student Name:</dt><dd>${student.name}</dd>
                                <dt>Amount Paid:</dt><dd style="font-weight: bold; font-size: 1.1rem;">${Number(transaction.amount).toLocaleString()}</dd>
                                <dt>Payment For:</dt><dd>${transaction.type || 'Fee Payment'}</dd>
                            </dl>
                            <div class="receipt-footer">
                                <div class="receipt-signature">
                                    <div class="receipt-signature-line"></div>
                                    <p>Authorized Signature</p>
                                </div>
                                <p>Thank you for your payment.</p>
                            </div>
                        </div>
                    </div>
                    <div class="no-print" style="margin-top: 20px; display: flex; gap: 15px;">
                        <button class="action-button" onclick="printContent('#${modalId}')"><i class="fas fa-print"></i> Print Receipt</button>
                        <button class="action-button secondary" onclick="downloadAsPdf('#${modalId}', 'Fee-Receipt-${transaction.id}.pdf')"><i class="fas fa-download"></i> Download PDF</button>
                    </div>
                `;
                showModal('Fee Payment Receipt', receiptContent, '800px');
                
                if (autoPrint) {
                    setTimeout(() => printContent(`#${modalId}`), 500);
                }
            }


            function renderNoticeBoardPage() {
                const mainContent = getEl('main-content');
                
                const userRole = state.loggedInUser?.role || 'guest';
                const actionsHtml = userRole === 'admin' ? `<button class="action-button inline" onclick="showNoticeForm()"><i class="fas fa-plus"></i> Add Notice</button>` : '';

                mainContent.innerHTML = renderHeader('Notice Board', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="table-container"><table id="notices-table"></table></div></div></div>`;
                renderNoticesTable();
            }

            function renderNoticesTable() {
                const table = getEl('notices-table');
                if(!table) return;
                const userRole = state.loggedInUser?.role || 'guest';
                const { notices } = state.data;
                let html = `<thead><tr><th>Title</th><th>Content</th><th>Date</th>`;
                if(userRole === 'admin') html += `<th>Actions</th>`;
                html += `</tr></thead><tbody>`;

                if (!notices || notices.length === 0) {
                     html += `<tr><td colspan="${userRole === 'admin' ? 4 : 3}" style="text-align:center;">No notices found.</td></tr>`;
                } else { 
                    notices.sort((a,b) => b.id - a.id).forEach(n => { 
                        html += `<tr><td>${n.title}</td><td>${n.content}</td><td>${new Date(n.id).toLocaleString()}</td>`;
                        if(userRole === 'admin') {
                           html += `<td class="action-buttons">
                                        <button class="edit-btn" onclick="showNoticeForm('${n.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                        <button class="delete-btn" onclick="deleteItem('notices', '${n.id}', 'Are you sure you want to delete this notice?', renderNoticesTable)" title="Delete"><i class="fas fa-trash"></i></button>
                                    </td>`;
                        }
                        html += `</tr>`;
                    }); 
                }
                html += '</tbody>'; 
                table.innerHTML = html;
            }

            function showNoticeForm(id = null) {
                const notice = id ? findById('notices', id) : {};
                const title = id ? 'Edit Notice' : 'Add New Notice';
                const formContent = `<form id="notice-form"><input type="hidden" id="notice-id" value="${notice.id || ''}"><div class="form-group"><label for="notice-title">Title</label><input type="text" id="notice-title" value="${notice.title || ''}" required></div><div class="form-group"><label for="notice-content">Content</label><textarea id="notice-content" rows="5" required>${notice.content || ''}</textarea></div><button type="submit" class="action-button">${id ? 'Save Changes' : 'Add Notice'}</button></form>`;
                showModal(title, formContent);
                getEl('notice-form').onsubmit = e => { e.preventDefault(); const noticeData = { id: getEl('notice-id').value || Date.now(), title: getEl('notice-title').value, content: getEl('notice-content').value }; updateOrAddItem('notices', noticeData); showToast(`Notice ${id ? 'updated' : 'added'}!`, 'success'); closeModal(); renderNoticesTable(); if (state.currentPage === 'home') renderHomePage(); };
            }

            function renderEventsPage() {
                const mainContent = getEl('main-content');
                const userRole = state.loggedInUser?.role || 'guest';
                const actionsHtml = userRole === 'admin' ? `<button class="action-button inline" onclick="showEventForm()"><i class="fas fa-plus"></i> Add Event</button>` : '';
                mainContent.innerHTML = renderHeader('College Events', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="table-container"><table id="events-table"></table></div></div></div>`;
                renderEventsTable();
            }

            function renderEventsTable() {
                const table = getEl('events-table');
                if(!table) return;
                const userRole = state.loggedInUser?.role || 'guest';
                const { events } = state.data;
                let html = `<thead><tr><th>Title</th><th>Description</th><th>Event Date</th>`;
                if(userRole === 'admin') html += `<th>Actions</th>`;
                html += `</tr></thead><tbody>`;

                if (!events || events.length === 0) {
                     html += `<tr><td colspan="${userRole === 'admin' ? 4 : 3}" style="text-align:center;">No events found.</td></tr>`;
                } else { 
                    events.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(event => { 
                        html += `<tr>
                                    <td>${event.title}</td>
                                    <td>${event.description}</td>
                                    <td>${new Date(event.date).toLocaleDateString()}</td>
                                    ${userRole === 'admin' ? `
                                    <td class="action-buttons">
                                        <button class="edit-btn" onclick="showEventForm('${event.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                        <button class="delete-btn" onclick="deleteItem('events', '${event.id}', 'Are you sure you want to delete this event?', renderEventsTable)" title="Delete"><i class="fas fa-trash"></i></button>
                                    </td>` : ''}
                                </tr>`;
                    }); 
                }
                html += '</tbody>'; 
                table.innerHTML = html;
            }

            function showEventForm(id = null) {
                const event = id ? findById('events', id) : {};
                const title = id ? 'Edit Event' : 'Add New Event';
                const formContent = `<form id="event-form">
                    <input type="hidden" id="event-id" value="${event.id || ''}">
                    <div class="form-group"><label for="event-title">Title</label><input type="text" id="event-title" value="${event.title || ''}" required></div>
                    <div class="form-group"><label for="event-description">Description</label><textarea id="event-description" rows="5" required>${event.description || ''}</textarea></div>
                    <div class="form-group"><label for="event-date">Event Date</label><input type="date" id="event-date" value="${event.date || ''}" required></div>
                    <button type="submit" class="action-button">${id ? 'Save Changes' : 'Add Event'}</button>
                </form>`;
                showModal(title, formContent);
                getEl('event-form').onsubmit = e => { 
                    e.preventDefault(); 
                    const eventData = { 
                        id: getEl('event-id').value || Date.now(), 
                        title: getEl('event-title').value, 
                        description: getEl('event-description').value,
                        date: getEl('event-date').value
                    }; 
                    updateOrAddItem('events', eventData); 
                    showToast(`Event ${id ? 'updated' : 'added'}!`, 'success'); 
                    closeModal(); 
                    renderEventsTable(); 
                    if (state.currentPage === 'home') renderHomePage();
                };
            }

            function renderBookListPage() {
                const mainContent = getEl('main-content');
                const userRole = state.loggedInUser?.role || 'guest';
                const actionsHtml = userRole === 'admin' ? `<button class="action-button inline" onclick="showBookForm()"><i class="fas fa-plus"></i> Add Book</button>` : '';
                mainContent.innerHTML = renderHeader('Library - Book List', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card">
                    <div class="search-box-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="book-search-input" oninput="renderBookTable(this.value)" placeholder="Search by Title, Author, or Book ID..." class="search-input">
                    </div>
                    <div class="table-container"><table id="books-table"></table></div>
                </div></div>`;
                renderBookTable();
            }

            function renderBookTable(searchTerm = '') {
                const table = getEl('books-table');
                if(!table) return;
                const userRole = state.loggedInUser?.role || 'guest';
                const bookList = (state.data.books || []).filter(b => searchTerm ? 
                    (b.title.toLowerCase().includes(searchTerm.toLowerCase())) ||
                    (b.author.toLowerCase().includes(searchTerm.toLowerCase())) ||
                    (b.bookId.toLowerCase().includes(searchTerm.toLowerCase()))
                    : true);

                let head = `<thead><tr><th>Book ID</th><th>Title</th><th>Author</th><th>Available Copies</th>${userRole === 'admin' ? '<th>Actions</th>': ''}</tr></thead>`;
                let body = `<tbody>`;
                if (bookList.length === 0) {
                     body += `<tr><td colspan="${userRole === 'admin' ? 5 : 4}" style="text-align:center;">No books found.</td></tr>`;
                } else {
                     bookList.sort((a, b) => (a.title > b.title) ? 1 : -1).forEach(b => { 
                        const issuedCount = (state.data.issuedBooks || []).filter(ib => ib.bookId === b.id && !ib.returnDate).length;
                        const availableCopies = b.copies - issuedCount;
                        body += `<tr>
                            <td><strong>${b.bookId}</strong></td>
                            <td>${b.title}</td>
                            <td>${b.author}</td>
                            <td>${availableCopies} / ${b.copies}</td>
                            ${userRole === 'admin' ? `
                            <td class="action-buttons">
                                <button class="edit-btn" onclick="showBookForm('${b.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn" onclick="deleteItem('books', '${b.id}', 'Are you sure you want to delete this book?', renderBookTable)" title="Delete"><i class="fas fa-trash"></i></button>
                            </td>` : ''}
                        </tr>`; 
                    });
                }
                table.innerHTML = head + body + `</tbody>`;
            }
            
            function showBookForm(id = null) {
                const book = id ? findById('books', id) : {};
                const title = id ? 'Edit Book' : 'Add New Book';
                const formContent = `<form id="book-form">
                    <input type="hidden" id="book-id" value="${book.id || ''}">
                    <div class="form-group"><label for="book-title">Title</label><input type="text" id="book-title" value="${book.title || ''}" required></div>
                    <div class="form-group"><label for="book-author">Author</label><input type="text" id="book-author" value="${book.author || ''}" required></div>
                    <div class="form-group"><label for="book-copies">Total Copies</label><input type="number" id="book-copies" value="${book.copies || '1'}" min="1" required></div>
                    <button type="submit" class="action-button">${id ? 'Save Changes' : 'Add Book'}</button>
                </form>`;
                showModal(title, formContent);
                getEl('book-form').onsubmit = e => {
                    e.preventDefault();
                    const bookData = {
                        id: getEl('book-id').value || Date.now().toString(),
                        bookId: book.bookId || `BOOK-${Date.now().toString().slice(-6)}`,
                        title: getEl('book-title').value,
                        author: getEl('book-author').value,
                        copies: parseInt(getEl('book-copies').value),
                    };
                    updateOrAddItem('books', bookData);
                    showToast(`Book ${id ? 'updated' : 'added'}!`, 'success');
                    closeModal();
                    renderBookTable();
                    if (state.currentPage === 'home') renderHomePage();
                };
            }

            function renderIssueReturnPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Library - Issue & Return');
                mainContent.innerHTML += `<div class="page active">
                    <div class="card">
                        <div class="card-header"><h3>Issue a New Book</h3></div>
                        <form id="issue-book-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="issue-student-id">Student Admission No.</label>
                                    <input type="text" id="issue-student-id" required>
                                </div>
                                <div class="form-group">
                                    <label for="issue-book-id">Book ID</label>
                                    <input type="text" id="issue-book-id" required>
                                </div>
                            </div>
                            <button type="submit" class="action-button">Issue Book</button>
                        </form>
                    </div>

                    <div class="card">
                        <div class="card-header"><h3>Currently Issued Books</h3></div>
                        <div class="table-container"><table id="issued-books-table"></table></div>
                    </div>
                </div>`;
                renderIssuedBooksTable();
                getEl('issue-book-form').onsubmit = handleIssueBook;
            }
            
            function handleIssueBook(e) {
                e.preventDefault();
                const studentAdmNo = getEl('issue-student-id').value;
                const bookIdentifier = getEl('issue-book-id').value;

                const student = (state.data.students || []).find(s => s.admissionNumber === studentAdmNo);
                const book = (state.data.books || []).find(b => b.bookId === bookIdentifier);

                if(!student) return showToast('Student not found with this Admission No.', 'error');
                if(!book) return showToast('Book not found with this Book ID.', 'error');
                
                const issuedCount = (state.data.issuedBooks || []).filter(ib => ib.bookId === book.id && !ib.returnDate).length;
                if(issuedCount >= book.copies) return showToast('All copies of this book are currently issued.', 'error');

                const issueData = {
                    id: Date.now().toString(),
                    studentId: student.id,
                    bookId: book.id,
                    issueDate: new Date().toISOString().slice(0, 10),
                    returnDate: null
                };

                updateOrAddItem('issuedBooks', issueData);
                showToast(`Book "${book.title}" issued to ${student.name}.`, 'success');
                e.target.reset();
                renderIssuedBooksTable();
                renderBookTable();
            }
            
            function renderIssuedBooksTable() {
                const table = getEl('issued-books-table');
                if (!table) return;

                const issuedList = (state.data.issuedBooks || []).filter(ib => !ib.returnDate);
                let html = `<thead><tr><th>Book Title</th><th>Student Name</th><th>Issue Date</th><th>Action</th></tr></thead><tbody>`;

                if(issuedList.length === 0) {
                    html += `<tr><td colspan="4" style="text-align:center;">No books are currently issued.</td></tr>`;
                } else {
                    issuedList.sort((a,b) => new Date(b.issueDate) - new Date(a.issueDate)).forEach(ib => {
                        const book = findById('books', ib.bookId);
                        const student = findById('students', ib.studentId);
                        if(book && student) {
                             html += `<tr>
                                <td>${book.title}</td>
                                <td>${student.name}</td>
                                <td>${new Date(ib.issueDate).toLocaleDateString()}</td>
                                <td><button class="action-button secondary" onclick="handleReturnBook('${ib.id}')">Return</button></td>
                            </tr>`;
                        }
                    });
                }
                html += `</tbody>`;
                table.innerHTML = html;
            }

            function handleReturnBook(issueId) {
                if(confirm('Are you sure this book is being returned?')) {
                    const issuedBook = findById('issuedBooks', issueId);
                    if(issuedBook) {
                        issuedBook.returnDate = new Date().toISOString().slice(0, 10);
                        updateOrAddItem('issuedBooks', issuedBook);
                        showToast('Book marked as returned.', 'success');
                        renderIssuedBooksTable();
                        renderBookTable();
                    }
                }
            }


            function renderTeacherPage() {
                if (state.currentView === 'profile' && state.currentItemId) {
                    renderTeacherProfilePage(state.currentItemId);
                } else {
                    renderTeacherListPage();
                }
            }

            function renderTeacherListPage() {
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="showTeacherForm()"><i class="fas fa-plus"></i> Add Teacher</button>`;
                mainContent.innerHTML = renderHeader('Teacher Management', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="card-header"><h3>Teacher List</h3></div>
                             <div class="search-box-container">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" id="teacher-search-input" oninput="renderTeacherTable(this.value)" placeholder="Search by Name, Employee ID..." class="search-input">
                                </div>
                            <div class="table-container"><table id="teachers-table"></table></div></div></div>`;
                renderTeacherTable();
            }

            function renderTeacherTable(searchTerm = '') {
                const table = getEl('teachers-table');
                if (!table) return;
                const teacherList = (state.data.teachers || []).filter(t => searchTerm ? 
                    (t.name && t.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
                    (t.employeeId && t.employeeId.toLowerCase().includes(searchTerm.toLowerCase()))
                    : true);

                let head = `<thead><tr><th>Photo</th><th>Employee ID</th><th>Name</th><th>Role/Subject</th><th>Contact</th><th>Actions</th></tr></thead>`;
                let body = `<tbody>`;
                if (teacherList.length === 0) {
                     body += `<tr><td colspan="6" style="text-align:center;">No teachers found.</td></tr>`;
                } else {
                     teacherList.sort((a, b) => (a.name > b.name) ? 1 : -1).forEach(t => { 
                        body += `<tr>
                            <td><img src="${t.photo || `https://ui-avatars.com/api/?name=${t.name.replace(/\s/g, "+")}`}" alt="Photo" class="table-photo"></td>
                            <td><strong>${t.employeeId || 'N/A'}</strong></td>
                            <td>${t.name}</td>
                            <td>${t.role}</td>
                            <td>${t.contact}</td>
                            <td class="action-buttons">
                                <button class="view-btn" onclick="navigate('teachers', 'profile', '${t.id}')" title="View Profile"><i class="fas fa-eye"></i></button>
                                <button class="edit-btn" onclick="showTeacherForm('${t.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn" onclick="deleteItem('teachers', '${t.id}', 'Are you sure you want to delete this teacher?', renderTeacherTable)" title="Delete"><i class="fas fa-trash"></i></button>


                            </td>
                        </tr>`; 
                    });
                }
                table.innerHTML = head + body + `</tbody>`;
            }

            async function showTeacherForm(id = null) {
                const teacher = id ? findById('teachers', id) : {};
                const title = id ? 'Edit Teacher' : 'Add New Teacher';
                const formContent = `<form id="teacher-form">
                        <input type="hidden" id="teacher-id" value="${teacher.id || ''}">
                        <div class="form-grid">
                            <div class="form-group"><label for="teacher-name">Full Name</label><input type="text" id="teacher-name" value="${teacher.name || ''}" required></div>
                            <div class="form-group"><label for="teacher-role">Role / Subject Taught</label><input type="text" id="teacher-role" value="${teacher.role || ''}" placeholder="e.g., Maths Teacher" required></div>
                            <div class="form-group"><label for="teacher-email">Email</label><input type="email" id="teacher-email" value="${teacher.email || ''}"></div>
                            <div class="form-group"><label for="teacher-contact">Contact Number</label><input type="tel" id="teacher-contact" value="${teacher.contact || ''}" required></div>
                             <div class="form-group"><label for="teacher-dob">Date of Birth</label><input type="date" id="teacher-dob" placeholder="YYYY-MM-DD" value="${teacher.dob || ''}" required></div>
                            <div class="form-group"><label for="teacher-password">Password</label><input type="password" id="teacher-password" ${id && teacher.password ? 'placeholder="Leave blank to keep unchanged"' : 'required'}></div>
                        </div>
                        <div class="form-group"><label for="teacher-photo">Teacher's Photo</label><input type="file" id="teacher-photo" accept="image/*"><input type="hidden" id="teacher-photo-base64" value="${teacher.photo || ''}"></div>
                        
                        <h4 style="margin-top: 20px; color: var(--primary-light);">Biometric Data</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <button type="button" class="action-button secondary" onclick="registerBiometric('face', 'teacher_form')"><i class="fas fa-camera"></i> Open Camera</button>
                                <span id="teacher-face-status" style="margin-left: 10px;">${teacher.faceData ? '<i class="fas fa-check-circle" style="color:var(--success-color)"></i> Registered' : 'Not Registered'}</span>
                                <input type="hidden" id="teacher-face-data" value="${teacher.faceData || ''}">
                            </div>
                            <div class="form-group">
                                <button type="button" class="action-button secondary" onclick="registerBiometric('fingerprint', 'teacher_form')"><i class="fas fa-fingerprint"></i> Open Scanner</button>
                                <span id="teacher-fingerprint-status" style="margin-left: 10px;">${teacher.fingerprintData ? '<i class="fas fa-check-circle" style="color:var(--success-color)"></i> Registered' : 'Not Registered'}</span>
                                <input type="hidden" id="teacher-fingerprint-data" value="${teacher.fingerprintData || ''}">
                            </div>
                        </div>

                        <button type="submit" class="action-button" style="width: 100%; margin-top: 20px;">${id ? 'Save Changes' : 'Add Teacher'}</button>
                    </form>`;
                showModal(title, formContent, '800px');
                getEl('teacher-photo').onchange = async (e) => { if (e.target.files[0]) getEl('teacher-photo-base64').value = await fileToBase64(e.target.files[0]); };
                getEl('teacher-form').onsubmit = (e) => { 
                    e.preventDefault();
                    const newPassword = getEl('teacher-password').value;
                    const teacherData = { 
                        ...teacher,
                        id: getEl('teacher-id').value || Date.now().toString(), 
                        employeeId: teacher.employeeId || `EMP-${Date.now().toString().slice(-6)}`,
                        name: getEl('teacher-name').value, 
                        role: getEl('teacher-role').value,
                        email: getEl('teacher-email').value, 
                        contact: getEl('teacher-contact').value,
                        dob: getEl('teacher-dob').value,
                        photo: getEl('teacher-photo-base64').value,
                        password: newPassword ? btoa(newPassword) : teacher.password,
                        faceData: getEl('teacher-face-data').value,
                        fingerprintData: getEl('teacher-fingerprint-data').value
                    };
                    updateOrAddItem('teachers', teacherData);
                    showToast(`Teacher ${id ? 'updated' : 'added'}!`, 'success');
                    closeModal(); 
                    if(state.currentView === 'profile') {
                       renderTeacherProfilePage(teacherData.id);
                    } else {
                       renderTeacherTable();
                    }
                };
            }
            
            function renderTeacherProfilePage(id) {
                const teacher = findById('teachers', id);
                if (!teacher) {
                    showToast('Teacher not found.', 'error');
                    return navigate('teachers', 'list');
                }
                
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Teacher Profile', `<button class="action-button inline" onclick="navigate('teachers', 'list')"><i class="fas fa-arrow-left"></i> Back to List</button>`);
                
                const { present, absent } = calculateAttendance('teachers', id);
                const totalDays = present + absent;
                const attendancePercentage = totalDays > 0 ? ((present / totalDays) * 100).toFixed(1) : '0';
                const modalId = `teacher-profile-printable-${id}`;

                mainContent.innerHTML += `
                    <div class="page active">
                        <div class="profile-grid" id="${modalId}">
                            <div class="card profile-card">
                                <img class="profile-photo" src="${teacher.photo || `https://ui-avatars.com/api/?name=${teacher.name.replace(/\s/g, "+")}`}" alt="Teacher Photo">
                                <h2 style="text-align: center;">${teacher.name}</h2>
                                <p style="text-align: center; color: var(--text-muted);">${teacher.role}</p>
                                <ul class="profile-details">
                                    <li><i class="fas fa-id-card"></i> ${teacher.employeeId || 'Not Assigned'}</li>
                                    <li><i class="fas fa-envelope"></i> ${teacher.email || 'N/A'}</li>
                                    <li><i class="fas fa-phone"></i> ${teacher.contact}</li>
                                </ul>
                                 <div class="no-print" style="display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-top:20px;">
                                    <button onclick="showTeacherForm('${id}')" class="action-button">Edit</button>
                                    <button onclick="showTeacherIdCard('${id}')" class="action-button"><i class="fas fa-id-card"></i> ID Card</button>
                                    <button onclick="downloadAsPdf('#${modalId}', 'Teacher-Profile-${teacher.name}.pdf')" class="action-button secondary"><i class="fas fa-download"></i> Download</button>
                                </div>
                            </div>
                            <div>
                                <div class="card">
                                    <div class="card-header"><h3>Attendance Summary</h3></div>
                                    <div class="attendance-stats">
                                        <div class="stat-item present"><span class="count">${present}</span><span>Present</span></div>
                                        <div class="stat-item absent"><span class="count">${absent}</span><span>Absent</span></div>
                                    </div>
                                    <div class="attendance-bar-container"><div class="attendance-bar" style="width: ${attendancePercentage}%;"></div></div>
                                    <p class="percentage">${attendancePercentage}% Overall Attendance</p>
                                </div>
                                 <div class="card"><div class="card-header"><h3>Attendance History</h3></div><div id="attendance-history-container" style="max-height: 300px; overflow-y: auto;"></div></div>
                            </div>
                        </div>
                    </div>`;
                renderAttendanceHistory('teachers', id);
            }
            
            function showTeacherIdCard(teacherId) {
                const schoolInfo = state.data.siteContent;
                const teacher = findById('teachers', teacherId);
                if (!teacher) return;
                
                const modalId = `teacher-id-${teacherId}`;
                const modalContent = `
                    <div class="printable-area" id="${modalId}">
                        <div class="id-card">
                            <div class="id-card-header">
                                <h3 style="text-transform: uppercase;">${schoolInfo.schoolName}</h3>
                                <p style="font-size: 0.9em; margin-top: 5px;">TEACHER ID CARD</p>
                            </div>
                            <div class="id-card-body">
                                <img src="${teacher.photo || `https://ui-avatars.com/api/?name=${teacher.name.replace(/\s/g, "+")}`}" alt="Photo" class="id-card-photo">
                                <h4>${teacher.name}</h4>
                                <p><strong>Employee ID:</strong> ${teacher.employeeId || 'N/A'}</p>
                                <p><strong>Role:</strong> ${teacher.role || 'N/A'}</p>
                                <div class="id-card-qr" id="id-card-qr-code"></div>
                            </div>
                        </div>
                    </div>
                     <div class="no-print" style="margin-top: 20px; display: flex; gap: 15px;">
                        <button class="action-button" onclick="printContent('#${modalId}')"><i class="fas fa-print"></i> Print ID Card</button>
                        <button class="action-button secondary" onclick="downloadAsPdf('#${modalId}', 'Teacher-ID-${teacher.name}.pdf')"><i class="fas fa-download"></i> Download PDF</button>
                    </div>
                `;
                showModal('Teacher ID Card', modalContent, '400px');
                if (teacher.employeeId) {
                     setTimeout(() => {
                        const qrContainer = getEl('id-card-qr-code');
                        if(qrContainer){
                           qrContainer.innerHTML = '';
                           new QRCode(qrContainer, { text: teacher.employeeId, width: 120, height: 120, colorDark : "#000000", colorLight : "#ffffff" });
                           convertQrCanvasToImage(qrContainer);
                        }
                    }, 200);
                }
            }

            function renderStaffPage() {
                if (state.currentView === 'profile' && state.currentItemId) {
                    renderStaffProfilePage(state.currentItemId);
                } else {
                    renderStaffListPage();
                }
            }

            function renderStaffListPage() {
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="showStaffForm()"><i class="fas fa-plus"></i> Add Staff</button>`;
                mainContent.innerHTML = renderHeader('Staff Management', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="card-header"><h3>Staff List</h3></div>
                             <div class="search-box-container">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" id="staff-search-input" oninput="renderStaffTable(this.value)" placeholder="Search by Name, Employee ID..." class="search-input">
                                </div>
                            <div class="table-container"><table id="staff-table"></table></div></div></div>`;
                renderStaffTable();
            }

            function renderStaffTable(searchTerm = '') {
                const table = getEl('staff-table');
                if (!table) return;
                const staffList = (state.data.staff || []).filter(s => searchTerm ? 
                    (s.name && s.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
                    (s.employeeId && s.employeeId.toLowerCase().includes(searchTerm.toLowerCase()))
                    : true);

                let head = `<thead><tr><th>Photo</th><th>Employee ID</th><th>Name</th><th>Role</th><th>Contact</th><th>Actions</th></tr></thead>`;
                let body = `<tbody>`;
                if (staffList.length === 0) {
                     body += `<tr><td colspan="6" style="text-align:center;">No staff members found.</td></tr>`;
                } else {
                     staffList.sort((a, b) => (a.name > b.name) ? 1 : -1).forEach(s => { 
                        body += `<tr>
                            <td><img src="${s.photo || `https://ui-avatars.com/api/?name=${s.name.replace(/\s/g, "+")}`}" alt="Photo" class="table-photo"></td>
                            <td><strong>${s.employeeId || 'N/A'}</strong></td>
                            <td>${s.name}</td>
                            <td>${s.role}</td>
                            <td>${s.contact}</td>
                            <td class="action-buttons">
                                <button class="view-btn" onclick="navigate('staff', 'profile', '${s.id}')" title="View Profile"><i class="fas fa-eye"></i></button>
                                <button class="edit-btn" onclick="showStaffForm('${s.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn" onclick="deleteItem('staff', '${s.id}', 'Are you sure you want to delete this staff member?', renderStaffTable)" title="Delete"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`; 
                    });
                }
                table.innerHTML = head + body + `</tbody>`;
            }

            async function showStaffForm(id = null) {
                const staff = id ? findById('staff', id) : {};
                const title = id ? 'Edit Staff Member' : 'Add New Staff Member';
                const formContent = `<form id="staff-form">
                        <input type="hidden" id="staff-id" value="${staff.id || ''}">
                        <div class="form-grid">
                            <div class="form-group"><label for="staff-name">Full Name</label><input type="text" id="staff-name" value="${staff.name || ''}" required></div>
                            <div class="form-group"><label for="staff-role">Role</label><input type="text" id="staff-role" value="${staff.role || ''}" placeholder="e.g., Accountant, Security" required></div>
                            <div class="form-group"><label for="staff-email">Email</label><input type="email" id="staff-email" value="${staff.email || ''}"></div>
                            <div class="form-group"><label for="staff-contact">Contact Number</label><input type="tel" id="staff-contact" value="${staff.contact || ''}" required></div>
                             <div class="form-group"><label for="staff-dob">Date of Birth</label><input type="date" id="staff-dob" placeholder="YYYY-MM-DD" value="${staff.dob || ''}" required></div>
                        </div>
                        <div class="form-group"><label for="staff-photo">Staff Photo</label><input type="file" id="staff-photo" accept="image/*"><input type="hidden" id="staff-photo-base64" value="${staff.photo || ''}"></div>
                        <button type="submit" class="action-button" style="width: 100%; margin-top: 20px;">${id ? 'Save Changes' : 'Add Staff Member'}</button>
                    </form>`;
                showModal(title, formContent, '800px');
                getEl('staff-photo').onchange = async (e) => { if (e.target.files[0]) getEl('staff-photo-base64').value = await fileToBase64(e.target.files[0]); };
                getEl('staff-form').onsubmit = (e) => { 
                    e.preventDefault();
                    const staffData = { 
                        ...staff,
                        id: getEl('staff-id').value || Date.now().toString(), 
                        employeeId: staff.employeeId || `STF-${Date.now().toString().slice(-6)}`,
                        name: getEl('staff-name').value, 
                        role: getEl('staff-role').value,
                        email: getEl('staff-email').value, 
                        contact: getEl('staff-contact').value,
                        dob: getEl('staff-dob').value,
                        photo: getEl('staff-photo-base64').value,
                    };
                    updateOrAddItem('staff', staffData);
                    showToast(`Staff member ${id ? 'updated' : 'added'}!`, 'success');
                    closeModal(); 
                    if(state.currentView === 'profile') {
                       renderStaffProfilePage(staffData.id);
                    } else {
                       renderStaffTable();
                    }
                };
            }
            
            function renderStaffProfilePage(id) {
                const staffMember = findById('staff', id);
                if (!staffMember) {
                    showToast('Staff member not found.', 'error');
                    return navigate('staff', 'list');
                }
                
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Staff Profile', `<button class="action-button inline" onclick="navigate('staff', 'list')"><i class="fas fa-arrow-left"></i> Back to List</button>`);
                
                const { present, absent } = calculateAttendance('staff', id);
                const totalDays = present + absent;
                const attendancePercentage = totalDays > 0 ? ((present / totalDays) * 100).toFixed(1) : '0';
                const modalId = `staff-profile-printable-${id}`;
                mainContent.innerHTML += `
                    <div class="page active">
                        <div class="profile-grid" id="${modalId}">
                            <div class="card profile-card">
                                <img class="profile-photo" src="${staffMember.photo || `https://ui-avatars.com/api/?name=${staffMember.name.replace(/\s/g, "+")}`}" alt="Staff Photo">
                                <h2 style="text-align: center;">${staffMember.name}</h2>
                                <p style="text-align: center; color: var(--text-muted);">${staffMember.role}</p>
                                <ul class="profile-details">
                                    <li><i class="fas fa-id-card"></i> ${staffMember.employeeId || 'Not Assigned'}</li>
                                    <li><i class="fas fa-envelope"></i> ${staffMember.email || 'N/A'}</li>
                                    <li><i class="fas fa-phone"></i> ${staffMember.contact}</li>
                                </ul>
                                 <div class="no-print" style="display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-top:20px;">
                                    <button onclick="showStaffForm('${id}')" class="action-button">Edit</button>
                                    <button onclick="showStaffIdCard('${id}')" class="action-button"><i class="fas fa-id-card"></i> ID Card</button>
                                    <button onclick="downloadAsPdf('#${modalId}', 'Staff-Profile-${staffMember.name}.pdf')" class="action-button secondary"><i class="fas fa-download"></i> Download</button>
                                </div>
                            </div>
                            <div>
                                <div class="card">
                                    <div class="card-header"><h3>Attendance Summary</h3></div>
                                    <div class="attendance-stats">
                                        <div class="stat-item present"><span class="count">${present}</span><span>Present</span></div>
                                        <div class="stat-item absent"><span class="count">${absent}</span><span>Absent</span></div>
                                    </div>
                                    <div class="attendance-bar-container"><div class="attendance-bar" style="width: ${attendancePercentage}%;"></div></div>
                                    <p class="percentage">${attendancePercentage}% Overall Attendance</p>
                                </div>
                                 <div class="card"><div class="card-header"><h3>Attendance History</h3></div><div id="attendance-history-container" style="max-height: 300px; overflow-y: auto;"></div></div>
                            </div>
                        </div>
                    </div>`;
                renderAttendanceHistory('staff', id);
            }
            
            function showStaffIdCard(staffId) {
                const schoolInfo = state.data.siteContent;
                const staffMember = findById('staff', staffId);
                if (!staffMember) return;

                const modalId = `staff-id-${staffId}`;
                const modalContent = `
                    <div class="printable-area" id="${modalId}">
                        <div class="id-card">
                            <div class="id-card-header">
                                <h3 style="text-transform: uppercase;">${schoolInfo.schoolName}</h3>
                                <p style="font-size: 0.9em; margin-top: 5px;">STAFF ID CARD</p>
                            </div>
                            <div class="id-card-body">
                                <img src="${staffMember.photo || `https://ui-avatars.com/api/?name=${staffMember.name.replace(/\s/g, "+")}`}" alt="Photo" class="id-card-photo">
                                <h4>${staffMember.name}</h4>
                                <p><strong>Employee ID:</strong> ${staffMember.employeeId || 'N/A'}</p>
                                <p><strong>Role:</strong> ${staffMember.role || 'N/A'}</p>
                                <div class="id-card-qr" id="id-card-qr-code"></div>
                            </div>
                        </div>
                    </div>
                     <div class="no-print" style="margin-top: 20px; display: flex; gap: 15px;">
                        <button class="action-button" onclick="printContent('#${modalId}')"><i class="fas fa-print"></i> Print ID Card</button>
                        <button class="action-button secondary" onclick="downloadAsPdf('#${modalId}', 'Staff-ID-${staffMember.name}.pdf')"><i class="fas fa-download"></i> Download PDF</button>
                    </div>
                `;
                showModal('Staff ID Card', modalContent, '400px');
                if (staffMember.employeeId) {
                     setTimeout(() => {
                        const qrContainer = getEl('id-card-qr-code');
                        if(qrContainer){
                           qrContainer.innerHTML = '';
                           new QRCode(qrContainer, { text: staffMember.employeeId, width: 120, height: 120, colorDark : "#000000", colorLight : "#ffffff" });
                           convertQrCanvasToImage(qrContainer);
                        }
                    }, 200);
                }
            }

            function renderStudentPage() {
                 if (state.currentView === 'profile' && state.currentItemId) {
                    renderStudentProfilePage(state.currentItemId);
                } else {
                    renderStudentListPage();
                }
            }

            function renderStudentListPage() {
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="navigate('admission')"><i class="fas fa-plus"></i> Add Student</button>`;
                mainContent.innerHTML = renderHeader('Students', actionsHtml);

                const preFilter = state.studentListFilter;
                let filterInfo = '';
                if (preFilter) {
                    filterInfo = `
                        <div class="card" style="border-left: 4px solid var(--info-color);">
                            Showing students from <strong>${preFilter}</strong>. 
                            <a href="#" onclick="event.preventDefault(); navigate('students', 'list', null, null)" style="margin-left: 15px;">Clear Filter</a>
                        </div>`;
                }
                
                mainContent.innerHTML += `<div class="page active">
                            ${filterInfo}
                            <div class="card">
                                <div class="card-header"><h3>Student List</h3></div>
                                <div class="table-controls">
                                    <div class="search-box-container">
                                        <i class="fas fa-search search-icon"></i>
                                        <input type="text" id="student-search-input" oninput="renderStudentTable(this.value)" placeholder="Search by Name, Roll No, Admission No..." class="search-input">
                                    </div>
                                </div>
                                <div class="table-container"><table id="students-table"></table></div>
                            </div>
                        </div>`;

                renderStudentTable();
            }

            function renderStudentTable(searchTerm = '') {
                const table = getEl('students-table');
                if (!table) return;

                let students = state.data.students || [];

                const preFilter = state.studentListFilter;
                if (preFilter) {
                    students = students.filter(s => s.className === preFilter);
                }

                if (searchTerm) {
                    searchTerm = searchTerm.toLowerCase();
                    students = students.filter(s => 
                        (s.name && s.name.toLowerCase().includes(searchTerm)) ||
                        (s.admissionNumber && s.admissionNumber.toLowerCase().includes(searchTerm)) ||
                        (s.rollNumber && s.rollNumber.toLowerCase().includes(searchTerm))
                    );
                }

                let head = `<thead><tr><th>Photo</th><th>Admission No.</th><th>Roll No.</th><th>Name</th><th>Course</th><th>Semester</th><th>Actions</th></tr></thead>`;
                let body = `<tbody>`;
                if (students.length === 0) {
                    body += `<tr><td colspan="7" style="text-align:center;">No students found.</td></tr>`;
                } else {
                    students.sort((a, b) => b.id - a.id).forEach(s => { 
                        body += `<tr>
                                <td><img src="${s.photo || `https://ui-avatars.com/api/?name=${s.name.replace(/\s/g, "+")}`}" alt="Photo" class="table-photo"></td>
                                <td><strong>${s.admissionNumber || 'N/A'}</strong></td>
                                <td><strong>${s.rollNumber || 'N/A'}</strong></td>
                                <td>${s.name}</td><td>${s.className || ''}</td>
                                <td>${s.currentSemester || '1'}</td>
                                <td class="action-buttons">
                                <button class="view-btn" onclick="navigate('students', 'profile', '${s.id}')" title="View Profile"><i class="fas fa-eye"></i></button>
                                <button class="edit-btn" onclick="showStudentForm('${s.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="certificate-btn" onclick="showCertificateGenerationModal('${s.id}')" title="Generate Certificate"><i class="fas fa-certificate"></i></button>
                                <button class="delete-btn" onclick="deleteItem('students', '${s.id}', 'Are you sure you want to delete this student?', () => renderStudentTable(document.getElementById('student-search-input').value))" title="Delete"><i class="fas fa-trash"></i></button>
                                </td></tr>`; 
                    });
                }
                table.innerHTML = head + body + `</tbody>`;
            }

            function showStudentForm(id = null) {
                const student = id ? findById('students', id) : {};
                const title = id ? 'Edit Student' : 'Add New Student';
                const courseOptionsHTML = courseOptionsList
                    .map(c => `<option value="${c}" ${student.className === c ? 'selected' : ''}>${c}</option>`).join('');
                
                let semesterOptionsHTML = '';
                if(student.className && courseDetails[student.className]) {
                    for(let i=1; i<=courseDetails[student.className].semesters; i++) {
                        semesterOptionsHTML += `<option value="${i}" ${student.currentSemester == i ? 'selected' : ''}>Semester ${i}</option>`;
                    }
                }

                const formContent = `<form id="student-form"><input type="hidden" id="student-id" value="${student.id || ''}">
                        <div class="form-grid">
                            <div class="form-group"><label for="student-admission">Admission Number</label><input type="text" id="student-admission" value="${student.admissionNumber || ''}" ${id ? '' : 'placeholder="Will be auto-generated"'} ><small>${id ? 'You can change the admission number.' : 'Leave blank to auto-generate.'}</small></div>
                            <div class="form-group"><label for="student-roll">Roll Number</label><input type="text" id="student-roll" value="${student.rollNumber || ''}" ${id ? '' : 'placeholder="Will be auto-generated"'} ><small>${id ? 'You can change the roll number.' : 'Leave blank to auto-generate.'}</small></div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group"><label for="student-name">Full Name</label><input type="text" id="student-name" value="${student.name || ''}" required></div>
                            <div class="form-group"><label for="student-father-name">Father's Name</label><input type="text" id="student-father-name" value="${student.fatherName || ''}" required></div>
                             <div class="form-group"><label for="student-mother-name">Mother's Name</label><input type="text" id="student-mother-name" value="${student.motherName || ''}" required></div>
                            <div class="form-group"><label for="student-guardian-name">Guardian's Name</label><input type="text" id="student-guardian-name" value="${student.guardianName || ''}" required></div>
                             <div class="form-group"><label for="student-dob">Date of Birth</label><input type="date" placeholder="YYYY-MM-DD" id="student-dob" value="${student.dob || ''}" required></div>
                            <div class="form-group"><label for="student-email">Email</label><input type="email" id="student-email" value="${student.email || ''}"></div>
                            <div class="form-group"><label for="student-guardian-contact">Guardian's Contact</label><input type="tel" id="student-guardian-contact" value="${student.guardianContact || ''}" required></div>
                            <div class="form-group"><label for="student-contact">Student's Contact</label><input type="tel" id="student-contact" value="${student.contact || ''}"></div>
                            <div class="form-group"><label for="student-gender">Gender</label><select id="student-gender" required><option value="Male" ${student.gender === 'Male' ? 'selected' : ''}>Male</option><option value="Female" ${student.gender === 'Female' ? 'selected' : ''}>Female</option><option value="Other" ${student.gender === 'Other' ? 'selected' : ''}>Other</option></select></div>
                            <div class="form-group"><label for="student-category">Category</label><select id="student-category" required><option value="General" ${student.category === 'General' ? 'selected' : ''}>General</option><option value="OBC" ${student.category === 'OBC' ? 'selected' : ''}>OBC</option><option value="SC" ${student.category === 'SC' ? 'selected' : ''}>SC</option><option value="ST" ${student.category === 'ST' ? 'selected' : ''}>ST</option></select></div>
                        </div>
                        <div class="form-group"><label for="student-address">Address</label><textarea id="student-address" rows="3">${student.address || ''}</textarea></div>
                        <div class="form-group"><label for="student-pincode">Pin Code</label><input type="text" id="student-pincode" value="${student.pincode || '221011'}" required></div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label for="student-class">Course/Program</label>
                                <select id="student-class" onchange="updateSemesterDropdown(this.value, 'student-semester', ${student.currentSemester || 1})">${courseOptionsHTML}</select>
                            </div>
                            <div class="form-group">
                                <label for="student-semester">Current Semester</label>
                                <select id="student-semester">${semesterOptionsHTML}</select>
                            </div>
                        </div>
                        <div class="form-group"><label for="student-photo">Student Photo</label><input type="file" id="student-photo" accept="image/*"><input type="hidden" id="student-photo-base64" value="${student.photo || ''}"></div>
                        
                        <h4 style="margin-top: 20px; color: var(--primary-light);">Biometric Data</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <button type="button" class="action-button secondary" onclick="registerBiometric('face', 'student_form')"><i class="fas fa-camera"></i> Open Camera</button>
                                <span id="student-face-status" style="margin-left: 10px;">${student.faceData ? '<i class="fas fa-check-circle" style="color:var(--success-color)"></i> Registered' : 'Not Registered'}</span>
                                <input type="hidden" id="student-face-data" value="${student.faceData || ''}">
                            </div>
                            <div class="form-group">
                                <button type="button" class="action-button secondary" onclick="registerBiometric('fingerprint', 'student_form')"><i class="fas fa-fingerprint"></i> Open Scanner</button>
                                <span id="student-fingerprint-status" style="margin-left: 10px;">${student.fingerprintData ? '<i class="fas fa-check-circle" style="color:var(--success-color)"></i> Registered' : 'Not Registered'}</span>
                                <input type="hidden" id="student-fingerprint-data" value="${student.fingerprintData || ''}">
                            </div>
                        </div>

                        <button type="submit" class="action-button">${id ? 'Save Changes' : 'Add Student'}</button></form>`;
                showModal(title, formContent, '900px');
                getEl('student-photo').onchange = async (e) => { if (e.target.files[0]) getEl('student-photo-base64').value = await fileToBase64(e.target.files[0]); };
                getEl('student-form').onsubmit = (e) => { 
                    e.preventDefault();
                    let admissionNumber = getEl('student-admission').value.trim();
                    let rollNumber = getEl('student-roll').value.trim();
                    if (!getEl('student-id').value) {
                        if (!admissionNumber) admissionNumber = `MGKVP/24SMS-${Date.now().toString().slice(-6)}`;
                        if (!rollNumber) {
                             const nextRollNumber = (state.data.students || []).length + 1;
                             rollNumber = `SMS${new Date().getFullYear().toString().slice(-2)}${(nextRollNumber).toString().padStart(5, '0')}`;
                        }
                    }
                    const studentData = { ...student, id: getEl('student-id').value || Date.now().toString(), admissionNumber, rollNumber, name: getEl('student-name').value, fatherName: getEl('student-father-name').value, motherName: getEl('student-mother-name').value, guardianName: getEl('student-guardian-name').value, guardianContact: getEl('student-guardian-contact').value, dob: getEl('student-dob').value, gender: getEl('student-gender').value, category: getEl('student-category').value, email: getEl('student-email').value, contact: getEl('student-contact').value, address: getEl('student-address').value, pincode: getEl('student-pincode').value, photo: getEl('student-photo-base64').value, className: getEl('student-class').value, currentSemester: parseInt(getEl('student-semester').value), documents: student.documents || [], results: student.results || [], password: student.password || '', faceData: getEl('student-face-data').value, fingerprintData: getEl('student-fingerprint-data').value };
                    updateOrAddItem('students', studentData);
                    showToast(`Student ${id ? 'updated' : 'added'}!`, 'success');
                    closeModal(); 
                    if(state.currentView === 'profile') {
                        renderStudentProfilePage(studentData.id);
                    } else {
                        renderStudentListPage();
                    }
                };
            }
            
            function updateSemesterDropdown(courseName, selectId, selectedValue=1) {
                const semesterSelect = getEl(selectId);
                if (!semesterSelect) return;
                semesterSelect.innerHTML = '';
                 // Add an 'All Semesters' option for filter dropdowns
                if(selectId.includes('filter')){
                    const allOption = document.createElement('option');
                    allOption.value = "all";
                    allOption.textContent = 'All Semesters';
                    if (selectedValue === "all") allOption.selected = true;
                    semesterSelect.appendChild(allOption);
                }
                if(courseName && courseDetails[courseName]) {
                    const maxSemesters = courseDetails[courseName].semesters;
                    for(let i=1; i<=maxSemesters; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `Semester ${i}`;
                        if(i == selectedValue) option.selected = true;
                        semesterSelect.appendChild(option);
                    }
                }
            }

            function renderStudentProfilePage(id) {
                const student = findById('students', id);
                if (!student) {
                    showToast('Student not found.', 'error');
                    return navigate('students', 'list');
                }
                const studentTransactions = (state.data.transactions || []).filter(t => t.studentId === id);
                const paidFee = studentTransactions.reduce((sum, t) => sum + Number(t.amount), 0);
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Student Profile', `<button class="action-button inline" onclick="navigate('students', 'list')"><i class="fas fa-arrow-left"></i> Back to List</button>`);
                
                const signatureDoc = (student.documents || []).find(doc => doc.name && doc.name.toLowerCase().includes('signature'));
                const modalId = `student-profile-printable-${id}`;

                mainContent.innerHTML += `
                    <div class="page active">
                        <div class="profile-grid" id="${modalId}">
                            <div class="card profile-card">
                                <img class="profile-photo" src="${student.photo || `https://ui-avatars.com/api/?name=${student.name.replace(/\s/g, "+")}`}" alt="Student Photo">
                                ${signatureDoc ? `<img src="${signatureDoc.data}" alt="Signature" style="display:block; margin: -10px auto 15px; height: 40px; max-width: 150px; object-fit: contain;">` : ''}
                                <h2 style="text-align: center;">${student.name}</h2>
                                <p style="text-align: center; color: var(--text-muted);">${student.email || 'No email'}</p>
                                <ul class="profile-details">
                                    <li><i class="fas fa-id-card"></i> Adm No: ${student.admissionNumber || 'N/A'}</li>
                                    <li><i class="fas fa-hashtag"></i> Roll No: ${student.rollNumber || 'N/A'}</li>
                                    <li><i class="fas fa-school"></i> ${student.className} (Semester ${student.currentSemester || 1})</li>
                                     <li><i class="fas fa-user-tie"></i> Father: ${student.fatherName || 'N/A'}</li>
                                     <li><i class="fas fa-female"></i> Mother: ${student.motherName || 'N/A'}</li>
                                    <li><i class="fas fa-user-shield"></i> Guardian: ${student.guardianName || 'N/A'} (${student.guardianContact || 'N/A'})</li>
                                    <li><i class="fas fa-phone"></i> Student Contact: ${student.contact || 'N/A'}</li>
                                    <li><i class="fas fa-venus-mars"></i> Gender: ${student.gender || 'N/A'}</li>
                                    <li><i class="fas fa-layer-group"></i> Category: ${student.category || 'N/A'}</li>
                                    <li><i class="fas fa-map-marker-alt"></i> ${student.address || 'Not provided'}, ${student.pincode || ''}</li>
                                </ul>
                                <div style="text-align:center;">
                                    <div id="student-qr-code"></div>
                                </div>
                                <div class="no-print" style="display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-top:20px;">
                                    <button onclick="showStudentForm('${id}')" class="action-button">Edit Profile</button>
                                    <button onclick="showIdCard('${id}')" class="action-button"><i class="fas fa-id-card"></i> ID Card</button>
                                    <button onclick="printContent('#${modalId}')" class="action-button"><i class="fas fa-print"></i> Print</button>
                                    <button class="action-button secondary" onclick="downloadAsPdf('#${modalId}', 'Student-Profile-${student.name}.pdf')"><i class="fas fa-download"></i> Download</button>
                                </div>
                            </div>
                            <div>
                                <div class="card">
                                    <div class="card-header"><h3>Financial Summary</h3></div>
                                    <p>Total Paid: ${paidFee.toLocaleString()}</p>
                                    <button onclick="showPaymentForm('${id}')" class="action-button inline no-print" style="margin-top: 15px; margin-bottom: 20px;">Add Payment</button>
                                    <h3 style="margin-top:20px;">Payment History</h3>
                                    <ul class="detail-list">
                                        ${studentTransactions.length ? studentTransactions.sort((a,b) => new Date(b.date) - new Date(a.date)).map(t => `<li><span>${new Date(t.date).toLocaleDateString()} - ${t.type}</span><div style="display:flex; align-items:center; gap: 10px;"><span>${Number(t.amount).toLocaleString()}</span><button class="action-button no-print secondary" onclick="showFeeReceipt('${student.id}', '${t.id}')" style="padding: 5px 10px;" title="Print Receipt"><i class="fas fa-print"></i></button></div></li>`).join('') : '<li>No payments made.</li>'}
                                    </ul>
                                </div>
                                <div class="card"><div class="card-header"><h3>Attendance History</h3></div>
                                <div id="attendance-history-container" style="max-height: 300px; overflow-y: auto;"></div></div>
                                <div class="card"><div class="card-header"><h3>Student Documents</h3><button class="action-button inline no-print" onclick="showDocumentUploadForm('${id}')"><i class="fas fa-upload"></i> Upload</button></div><ul class="detail-list">${renderDocumentList(student)}</ul></div>
                            </div>
                        </div>
                    </div>`;
                
                if (student.admissionNumber) {
                    const qrContainer = getEl('student-qr-code');
                    qrContainer.innerHTML = '';
                    new QRCode(qrContainer, { text: student.admissionNumber, width: 128, height: 128 });
                }
                renderAttendanceHistory('students', id);
            }

            function renderStudentProfileView() {
                const mainContent = getEl('main-content');
                const user = state.loggedInUser;
                const student = user.role === 'parent' ? findById('students', user.studentId) : user;

                if (!student) {
                    mainContent.innerHTML = renderHeader(`Error`);
                    mainContent.innerHTML += `<div class="page active"><p class="form-feedback error">Could not find linked student data.</p></div>`;
                    return;
                }

                mainContent.innerHTML = renderHeader('My Profile');
                mainContent.innerHTML += `<div class="page active">
                    <div class="card profile-card" style="max-width: 500px; margin: auto;">
                        <img class="profile-photo" src="${student.photo || `https://ui-avatars.com/api/?name=${student.name.replace(/\s/g, "+")}`}" alt="Student Photo">
                        <h2 style="text-align: center;">${student.name}</h2>
                         <ul class="profile-details">
                            <li><i class="fas fa-id-card"></i> Adm No: ${student.admissionNumber || 'N/A'}</li>
                            <li><i class="fas fa-hashtag"></i> Roll No: ${student.rollNumber || 'N/A'}</li>
                            <li><i class="fas fa-school"></i> ${student.className} (Semester ${student.currentSemester || 1})</li>
                             <li><i class="fas fa-user-tie"></i> Father: ${student.fatherName || 'N/A'}</li>
                             <li><i class="fas fa-female"></i> Mother: ${student.motherName || 'N/A'}</li>
                            <li><i class="fas fa-user-shield"></i> Guardian: ${student.guardianName || 'N/A'}</li>
                            <li><i class="fas fa-mobile-alt"></i> Guardian Contact: ${student.guardianContact || 'N/A'}</li>
                            <li><i class="fas fa-phone"></i> Student Contact: ${student.contact || 'N/A'}</li>
                            <li><i class="fas fa-envelope"></i> ${student.email || 'N/A'}</li>
                            <li><i class="fas fa-map-marker-alt"></i> ${student.address || 'Not provided'}, ${student.pincode || ''}</li>
                        </ul>
                    </div>
                </div>`;
            }

            function renderStudentAttendanceView() {
                const user = state.loggedInUser;
                const student = user.role === 'parent' ? findById('students', user.studentId) : user;
                if (!student) return;

                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('My Attendance');
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="card-header"><h3>My Monthly Attendance Report</h3></div>
                    <div id="student-attendance-report-container"></div>
                </div></div>`;
                renderStudentMonthlyAttendanceReport(student.id);
            }
                function renderStudentMonthlyAttendanceReport(studentId) {
                const container = getEl('student-attendance-report-container');
                if(!container) return;
                const now = new Date();
                const currentYear = now.getFullYear();
                const modalId = `student-attendance-printable-${studentId}`;

                const yearOptions = Array.from({ length: 5 }, (_, i) => currentYear - i)
                    .map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');
                
                const monthOptions = Array.from({ length: 12 }, (_, i) => {
                    const monthName = new Date(0, i).toLocaleString('en-US', { month: 'long' });
                    return `<option value="${i}" ${i === now.getMonth() ? 'selected' : ''}>${monthName}</option>`;
                }).join('');

                container.innerHTML = `
                    <div class="no-print" style="display:flex; flex-wrap: wrap; gap: 20px; align-items: flex-end; margin-bottom: 20px;">
                        <div class="form-group" style="margin-bottom: 0; flex-grow: 1;">
                            <label for="student-report-month-filter">Select Month</label>
                            <select id="student-report-month-filter" onchange="displayMonthlyAttendanceReport('students', '${studentId}', true)">${monthOptions}</select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0; flex-grow: 1;">
                            <label for="student-report-year-filter">Select Year</label>
                            <select id="student-report-year-filter" onchange="displayMonthlyAttendanceReport('students', '${studentId}', true)">${yearOptions}</select>
                        </div>
                        <button class="action-button inline" onclick="printContent('#${modalId}')" style="flex-shrink: 0;"><i class="fas fa-print"></i> Print Report</button>
                         <button class="action-button secondary inline" onclick="downloadAsPdf('#${modalId}', 'Attendance-Report.pdf')"><i class="fas fa-download"></i> Download PDF</button>
                    </div>
                    <div id="${modalId}"></div>
                `;
                displayMonthlyAttendanceReport('students', studentId, true);
            }

            function renderAttendanceHistory(type, memberId) {
                const container = getEl('attendance-history-container');
                if (!container) return;

                let attendanceRecords;
                if (type === 'students') attendanceRecords = state.data.studentAttendance || {};
                else if (type === 'teachers') attendanceRecords = state.data.teacherAttendance || {};
                else if (type === 'staff') attendanceRecords = state.data.staffAttendance || {};
                else return;

                let history = [];
                for (const date in attendanceRecords) {
                    if (attendanceRecords[date][memberId]) {
                        history.push({ date: date, status: attendanceRecords[date][memberId] });
                    }
                }
                history.sort((a, b) => new Date(b.date) - new Date(a.date));
                if (history.length === 0) {
                    container.innerHTML = `<p>No attendance records found.</p>`;
                    return;
                }
                let tableHtml = `<table class="table-container"><thead><tr><th>Date</th><th>Status</th></tr></thead><tbody>`;
                history.forEach(rec => {
                    const statusClass = rec.status === 'present' ? 'color: var(--success-color)' : 'color: var(--error-color)';
                    tableHtml += `<tr><td>${new Date(rec.date).toLocaleDateString()}</td><td style="${statusClass}; font-weight: bold;">${rec.status.charAt(0).toUpperCase() + rec.status.slice(1)}</td></tr>`;
                });
                tableHtml += `</tbody></table>`;
                container.innerHTML = tableHtml;
            }
            
            function showIdCard(studentId) {
                const schoolInfo = state.data.siteContent;
                const student = findById('students', studentId);
                if (!student) return;

                const modalId = `student-id-${studentId}`;
                const modalContent = `
                    <div class="printable-area" id="${modalId}">
                        <div class="id-card">
                            <div class="id-card-header">
                                <h3 style="text-transform: uppercase;">${schoolInfo.schoolName}</h3>
                            </div>
                            <div class="id-card-body">
                                <img src="${student.photo || `https://ui-avatars.com/api/?name=${student.name.replace(/\s/g, "+")}`}" alt="Photo" class="id-card-photo">
                                <h4>${student.name}</h4>
                                <p><strong>Admission No:</strong> ${student.admissionNumber || 'N/A'}</p>
                                <p><strong>Roll No:</strong> ${student.rollNumber || 'N/A'}</p>
                                <p><strong>Course:</strong> ${student.className} (Sem ${student.currentSemester || 1})</p>
                                <div class="id-card-qr" id="id-card-qr-code"></div>
                            </div>
                        </div>
                    </div>
                     <div class="no-print" style="margin-top: 20px; display: flex; gap: 15px;">
                        <button class="action-button" onclick="printContent('#${modalId}')"><i class="fas fa-print"></i> Print ID Card</button>
                        <button class="action-button secondary" onclick="downloadAsPdf('#${modalId}', 'Student-ID-${student.name}.pdf')"><i class="fas fa-download"></i> Download PDF</button>
                    </div>
                `;
                showModal('Student ID Card', modalContent, '400px');
                if (student.admissionNumber) {
                     setTimeout(() => {
                        const qrContainer = getEl('id-card-qr-code');
                        if(qrContainer){
                           qrContainer.innerHTML = '';
                           new QRCode(qrContainer, { text: student.admissionNumber, width: 120, height: 120, colorDark : "#000000", colorLight : "#ffffff" });
                           convertQrCanvasToImage(qrContainer);
                        }
                    }, 200);
                }
            }


            function renderDocumentList(student) {
                if (!student.documents || student.documents.length === 0) return '<li>No documents uploaded.</li>';
                return student.documents.map((doc, index) => `<li><span><i class="fas fa-file-alt" style="margin-right: 10px;"></i> ${doc.name}</span>
                        <div class="action-buttons no-print"><a href="${doc.data}" download="${doc.filename}" class="view-btn" title="View/Download"><i class="fas fa-download"></i></a>
                        <button class="delete-btn" onclick="deleteDocument('${student.id}', ${index})" title="Delete"><i class="fas fa-trash"></i></button></div></li>`).join('');
            }

            function showDocumentUploadForm(studentId) {
                const title = "Upload Document";
                const formContent = `<form id="document-upload-form"><div class="form-group"><label for="doc-name">Document Name</label><input type="text" id="doc-name" required></div>
                        <div class="form-group"><label for="doc-file">Select File</label><input type="file" id="doc-file" required></div>
                        <button type="submit" class="action-button">Upload Document</button></form>`;
                showModal(title, formContent);
                getEl('document-upload-form').onsubmit = async (e) => { e.preventDefault(); const student = findById('students', studentId); const file = getEl('doc-file').files[0]; const name = getEl('doc-name').value;
                    if (file && name && student) { try { const base64Data = await fileToBase64(file); if (!student.documents) student.documents = []; student.documents.push({ name, data: base64Data, filename: file.name }); updateOrAddItem('students', student); showToast("Document uploaded successfully!", "success"); closeModal(); renderStudentProfilePage(studentId); } catch (err) { showToast("File upload failed.", "error"); } } };
            }

            function deleteDocument(studentId, docIndex) { if (confirm('Are you sure you want to delete this document?')) { const student = findById('students', studentId); if (student && student.documents) { student.documents.splice(docIndex, 1); updateOrAddItem('students', student); showToast("Document deleted.", "success"); renderStudentProfilePage(studentId); } } }
            
            function renderTimetablePage() {
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="showTimetableForm()"><i class="fas fa-plus"></i> Add Timetable</button>`;
                mainContent.innerHTML = renderHeader('Course Timetables', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="gallery-grid" id="timetable-grid-container"></div></div></div>`;
                renderTimetableGrid();
            }

            function renderTimetableGrid() {
                const container = getEl('timetable-grid-container');
                if(!container) return;
                const { timetables } = state.data;
                if (!timetables || timetables.length === 0) { container.innerHTML = `<p>No timetables uploaded yet.</p>`; return; }
                container.innerHTML = timetables.sort((a,b) => b.id - a.id).map(item => `<div class="gallery-item card"><h4>${item.title}</h4><img src="${item.image}" alt="${item.title}" style="margin-top:15px;"><div class="gallery-item-footer"><button class="delete-btn" onclick="deleteItem('timetables', '${item.id}', 'Are you sure you want to delete this timetable?', renderTimetableGrid)" title="Delete"><i class="fas fa-trash"></i></button></div></div>`).join('');
            }
            function showTimetableForm() {
                const title = 'Add New Timetable';
                const formContent = `<form id="timetable-form">
                        <div class="form-group"><label for="timetable-title">Title</label><input type="text" id="timetable-title" placeholder="e.g., BCA Sem 2 Timetable" required></div>
                        <div class="form-group"><label for="timetable-image">Select Image</label><input type="file" id="timetable-image" accept="image/*" required></div>
                        <button type="submit" class="action-button">Add Timetable</button>
                    </form>`;
                showModal(title, formContent);
                getEl('timetable-form').onsubmit = async e => { 
                    e.preventDefault(); 
                    const imageFile = getEl('timetable-image').files[0]; 
                    if(!imageFile) return; 
                    const timetableData = { id: Date.now(), title: getEl('timetable-title').value, image: await fileToBase64(imageFile) }; 
                    updateOrAddItem('timetables', timetableData); 
                    showToast('Timetable added!', 'success'); 
                    closeModal(); 
                    renderTimetableGrid(); 
                };
            }

            function renderExamsPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Examinations', `<button class="action-button inline" onclick="showExamMasterForm()"><i class="fas fa-plus"></i> Add New Exam</button>`);
                
                mainContent.innerHTML += `<div class="page active">
                    <div class="card">
                        <div class="card-header"><h3>Examinations</h3><p>Create main exams like Odd Semester or Sessional Test.</p></div>
                        <div class="table-container"><table id="exam-masters-table"></table></div>
                    </div>
                    <div id="exam-schedule-section" style="display:none;"></div>
                </div>`;
                renderExamMastersTable();
            }

            function renderExamMastersTable() {
                const table = getEl('exam-masters-table');
                if (!table) return;
                const { examMasters } = state.data;
                let html = `<thead><tr><th>Exam Name</th><th>Category</th><th>Result Declared On</th><th>Actions</th></tr></thead><tbody>`;
                if (!examMasters || examMasters.length === 0) {
                    html += `<tr><td colspan="4" style="text-align:center;">No exams created yet. Click 'Add New Exam'.</td></tr>`;
                } else {
                    examMasters.sort((a,b) => b.id - a.id).forEach(ex => { 
                        html += `<tr>
                            <td><strong>${ex.name}</strong></td>
                            <td>${ex.category || 'N/A'}</td>
                            <td>${ex.declarationDate ? new Date(ex.declarationDate).toLocaleDateString() : 'Not Set'}</td>
                            <td class="action-buttons">
                                <button class="schedule-btn" onclick="renderExamScheduleView('${ex.id}')" title="Manage Schedule"><i class="fas fa-calendar-alt"></i></button>
                                <button class="edit-btn" onclick="showExamMasterForm('${ex.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn" onclick="deleteExamMaster('${ex.id}')" title="Delete"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`; 
                    });
                }
                html += '</tbody>';
                table.innerHTML = html;
            }

            function showExamMasterForm(id = null) {
                const exam = id ? findById('examMasters', id) : {};
                const title = id ? 'Edit Exam' : 'Create New Exam';

                const examCategoryOptions = examCategoriesList.map(cat => 
                    `<option value="${cat}" ${exam.category === cat ? 'selected' : ''}>${cat}</option>`
                ).join('');

                const formContent = `<form id="exam-master-form">
                    <input type="hidden" id="exam-master-id" value="${exam.id || ''}">
                    <div class="form-group"><label for="exam-master-name">Exam Name</label><input type="text" id="exam-master-name" value="${exam.name || ''}" placeholder="e.g., Odd Semester 2025" required></div>
                    <div class="form-group">
                        <label for="exam-master-category">Exam Category</label>
                        <select id="exam-master-category">${examCategoryOptions}</select>
                    </div>
                    <div class="form-group"><label for="exam-declaration-date">Result Declaration Date</label><input type="date" id="exam-declaration-date" value="${exam.declarationDate || ''}"></div>
                    <h4 style="margin-top: 20px; color: var(--primary-light);">Grade Sheet Details</h4>
                    <div class="form-group">
                        <label for="exam-session">Session</label>
                        <input type="text" id="exam-session" value="${exam.session || '2024-2025'}" required>
                    </div>
                    <div class="form-group">
                        <label for="exam-title">Examination Title (for Grade Sheet)</label>
                        <input type="text" id="exam-title" value="${exam.examTitle || 'First Semester Examination'}" required>
                    </div>
                    <div class="form-group">
                        <label for="exam-course-desc">Course Description (for Grade Sheet)</label>
                        <input type="text" id="exam-course-desc" value="${exam.courseDesc || 'Three Year Full Time Bachelor of Computer Application'}" required>
                    </div>
                    <button type="submit" class="action-button">${id ? 'Save Changes' : 'Create Exam'}</button>
                </form>`;
                showModal(title, formContent);
                getEl('exam-master-form').onsubmit = e => { 
                    e.preventDefault(); 
                    const examData = { 
                        id: getEl('exam-master-id').value || Date.now().toString(), 
                        name: getEl('exam-master-name').value.trim(),
                        category: getEl('exam-master-category').value,
                        declarationDate: getEl('exam-declaration-date').value,
                        session: getEl('exam-session').value,
                        examTitle: getEl('exam-title').value,
                        courseDesc: getEl('exam-course-desc').value
                    }; 
                    if (!examData.name) {
                        showToast("Exam name cannot be empty.", "error");
                        return;
                    }
                    updateOrAddItem('examMasters', examData); 
                    showToast(`Exam ${id ? 'updated' : 'added'}!`, 'success'); 
                    closeModal(); 
                    renderExamMastersTable(); 
                };
            }
            
           
            function renderExamScheduleView(examMasterId) {
                const exam = findById('examMasters', examMasterId);
                const scheduleSection = getEl('exam-schedule-section');
                scheduleSection.style.display = 'block';
                scheduleSection.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h3>Schedule for: ${exam.name}</h3>
                            <button class="action-button inline" onclick="showExamScheduleForm('${examMasterId}')"><i class="fas fa-plus"></i> Add Subject to Schedule</button>
                        </div>
                        <div class="table-container"><table id="exam-schedule-table"></table></div>
                    </div>
                `;
                renderExamScheduleTable(examMasterId);
                scheduleSection.scrollIntoView({ behavior: 'smooth' });
            }

            function renderExamScheduleTable(examMasterId) {
                const table = getEl('exam-schedule-table');
                if(!table) return;
                const schedules = state.data.examSchedules.filter(s => s.examMasterId === examMasterId);
                
                let html = `<thead><tr><th>Course</th><th>Semester</th><th>Subject</th><th>Paper Code</th><th>Credits</th><th>Exam Date</th><th>Start Time</th><th>End Time</th><th>Actions</th></tr></thead><tbody>`;
                 if (schedules.length === 0) {
                    html += `<tr><td colspan="9" style="text-align:center;">No schedule added for this exam yet.</td></tr>`;
                } else {
                    schedules.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(sch => {
                        html += `<tr>
                            <td>${sch.className}</td>
                            <td>${sch.semester || '-'}</td>
                            <td>${sch.subject}</td>
                            <td>${sch.paperCode || '-'}</td>
                            <td>${sch.credits || '-'}</td>
                            <td>${new Date(sch.date).toLocaleDateString()}</td>
                            <td>${sch.startTime}</td>
                            <td>${sch.endTime}</td>
                            <td class="action-buttons">
                                <button class="edit-btn" onclick="showExamScheduleForm('${examMasterId}', '${sch.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn" onclick="deleteItem('examSchedules', '${sch.id}', 'Delete this schedule item?', () => renderExamScheduleTable('${examMasterId}'))" title="Delete"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    });
                }
                html += '</tbody>';
                table.innerHTML = html;
            }

            function showExamScheduleForm(examMasterId, scheduleId = null) {
                const schedule = scheduleId ? findById('examSchedules', scheduleId) : {};
                const title = scheduleId ? 'Edit Exam Schedule' : 'Add to Exam Schedule';
                
                const courseOptionsHTML = courseOptionsList.map(c => `<option value="${c}" ${schedule.className === c ? 'selected' : ''}>${c}</option>`).join('');

                let semesterOptionsHTML = '';
                if(schedule.className && courseDetails[schedule.className]) {
                     for(let i=1; i<=courseDetails[schedule.className].semesters; i++) {
                        semesterOptionsHTML += `<option value="${i}" ${schedule.semester == i ? 'selected' : ''}>Semester ${i}</option>`;
                    }
                }

                const formContent = `<form id="exam-schedule-form">
                    <input type="hidden" id="exam-schedule-id" value="${schedule.id || ''}">
                     <div class="form-grid">
                        <div class="form-group"><label for="exam-schedule-class">Course</label><select id="exam-schedule-class" onchange="updateSemesterDropdown(this.value, 'exam-schedule-semester')">${courseOptionsHTML}</select></div>
                        <div class="form-group"><label for="exam-schedule-semester">Semester</label><select id="exam-schedule-semester">${semesterOptionsHTML}</select></div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group"><label for="exam-schedule-subject">Subject</label><input type="text" id="exam-schedule-subject" value="${schedule.subject || ''}" required></div>
                        <div class="form-group"><label for="exam-schedule-code">Paper Code</label><input type="text" id="exam-schedule-code" value="${schedule.paperCode || ''}" placeholder="e.g., BCA-22-201"></div>
                    </div>
                    <div class="form-group"><label for="exam-schedule-credits">Credits</label><input type="number" id="exam-schedule-credits" value="${schedule.credits || '4'}" required></div>
                    <div class="form-group"><label for="exam-schedule-date">Exam Date</label><input type="date" id="exam-schedule-date" value="${schedule.date || new Date().toISOString().slice(0,10)}" required></div>
                    <div class="form-grid">
                        <div class="form-group"><label for="exam-schedule-start">Start Time</label><input type="time" id="exam-schedule-start" value="${schedule.startTime || '09:00'}" required></div>
                        <div class="form-group"><label for="exam-schedule-end">End Time</label><input type="time" id="exam-schedule-end" value="${schedule.endTime || '12:00'}" required></div>
                    </div>
                    <button type="submit" class="action-button">${scheduleId ? 'Save Changes' : 'Add to Schedule'}</button>
                </form>`;
                showModal(title, formContent, '700px');
                getEl('exam-schedule-form').onsubmit = e => {
                    e.preventDefault();
                    const scheduleData = {
                        id: getEl('exam-schedule-id').value || Date.now().toString(),
                        examMasterId: examMasterId,
                        className: getEl('exam-schedule-class').value,
                        semester: parseInt(getEl('exam-schedule-semester').value),
                        subject: getEl('exam-schedule-subject').value,
                        paperCode: getEl('exam-schedule-code').value.trim(),
                        credits: parseInt(getEl('exam-schedule-credits').value),
                        date: getEl('exam-schedule-date').value,
                        startTime: getEl('exam-schedule-start').value,
                        endTime: getEl('exam-schedule-end').value,
                    };
                    updateOrAddItem('examSchedules', scheduleData);
                    showToast('Schedule saved!', 'success');
                    closeModal();
                    renderExamScheduleTable(examMasterId);
                }
            }
            
            function deleteExamMaster(id) {
                if (confirm('DANGER! Deleting this exam will also delete all its schedules and any marks entered for it. This cannot be undone. Are you sure?')) {
                    state.data.examSchedules = (state.data.examSchedules || []).filter(sch => sch.examMasterId !== id);
                    if(state.data.marks[id]) {
                        delete state.data.marks[id];
                    }
                    state.data.examMasters = (state.data.examMasters || []).filter(ex => ex.id !== id);
                    saveData();
                    showToast('Exam and all related data deleted.', 'success');
                    renderExamsPage();
                }
            }


            function renderFinancialsPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Income / All Transactions');
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="card-header"><h3>All Transactions</h3></div><div class="table-container"><table id="transactions-table"></table></div></div></div>`;
                renderTransactionsTable();
            }

            function renderTransactionsTable() {
                const table = getEl('transactions-table');
                if (!table) return;
                const transactions = (state.data.transactions || []).sort((a, b) => new Date(b.date) - new Date(a.date));
                let html = `<thead><tr><th>Student Name</th><th>Type</th><th>Amount ()</th><th>Date</th><th>Actions</th></tr></thead><tbody>`;
                if (transactions.length === 0) html += `<tr><td colspan="5" style="text-align:center;">No transactions found.</td></tr>`;
                else transactions.forEach(t => { const student = findById('students', t.studentId); html += `<tr><td>${student ? `<a href="#" onclick="event.preventDefault(); navigate('students', 'profile', '${student.id}')">${student.name}</a>` : 'Unknown Student'}</td><td>${t.type || 'Fee'}</td><td>${Number(t.amount).toLocaleString()}</td><td>${new Date(t.date).toLocaleDateString()}</td><td class="action-buttons"><button class="view-btn" onclick="showFeeReceipt('${t.studentId}', '${t.id}')" title="Print Receipt"><i class="fas fa-print"></i></button><button class="delete-btn" onclick="deleteItem('transactions', '${t.id}', 'Are you sure you want to delete this transaction?', renderTransactionsTable)" title="Delete"><i class="fas fa-trash"></i></button></td></tr>`; });
                table.innerHTML = html + `</tbody>`;
            }

            function showPaymentForm(studentId) {
                const student = findById('students', studentId);
                const title = `Add Payment for ${student.name}`;
                const formContent = `<form id="payment-form"><input type="hidden" id="payment-student-id" value="${studentId}">
                        <div class="form-group"><label for="payment-type">Payment Type</label><input type="text" id="payment-type" value="Semester Fee" required></div>
                        <div class="form-group"><label for="payment-amount">Amount ()</label><input type="number" id="payment-amount" value="300" required></div>
                        <div class="form-group"><label for="payment-date">Date</label><input type="date" id="payment-date" value="${new Date().toISOString().slice(0,10)}" required></div><button type="submit" class="action-button">Record Payment</button></form>`;
                showModal(title, formContent);
                getEl('payment-form').onsubmit = e => { e.preventDefault(); const transaction = { id: Date.now().toString(), studentId: getEl('payment-student-id').value, amount: getEl('payment-amount').value, date: getEl('payment-date').value, type: getEl('payment-type').value }; updateOrAddItem('transactions', transaction); showToast("Payment recorded!", "success"); closeModal(); if(state.currentPage === 'students' && state.currentView === 'profile') { renderStudentProfilePage(studentId); } };
            }

            function renderExpensesPage() {
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="showExpenseForm()"><i class="fas fa-plus"></i> Add Expense</button>`;
                mainContent.innerHTML = renderHeader('Expenses', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="table-container"><table id="expenses-table"></table></div></div></div>`;
                renderExpensesTable();
            }

            function renderExpensesTable() {
                const table = getEl('expenses-table');
                if (!table) return;
                const expenses = (state.data.expenses || []).sort((a,b) => new Date(b.date) - new Date(a.date));
                let html = `<thead><tr><th>
            Title</th><th>Amount ()</th><th>Category</th><th>Date</th><th>Actions</th></tr></thead><tbody>`;
                if (expenses.length === 0) html += `<tr><td colspan="5" style="text-align:center;">No expenses found.</td></tr>`;
                else expenses.forEach(e => { html += `<tr><td>${e.title}</td><td>${Number(e.amount).toLocaleString()}</td><td>${e.category}</td><td>${new Date(e.date).toLocaleDateString()}</td><td class="action-buttons"><button class="edit-btn" onclick="showExpenseForm('${e.id}')" title="Edit"><i class="fas fa-edit"></i></button><button class="delete-btn" onclick="deleteItem('expenses', '${e.id}', 'Are you sure you want to delete this expense?', renderExpensesTable)" title="Delete"><i class="fas fa-trash"></i></button></td></tr>`; });
                table.innerHTML = html + `</tbody>`;
            }

            function showExpenseForm(id = null) {
                const expense = id ? findById('expenses', id) : {};
                const title = id ? 'Edit Expense' : 'Add New Expense';
                const formContent = `<form id="expense-form"><input type="hidden" id="expense-id" value="${expense.id || ''}">
                        <div class="form-group"><label for="expense-title">Title (e.g., Electricity Bill)</label><input type="text" id="expense-title" value="${expense.title || ''}" required></div>
                        <div class="form-group"><label for="expense-amount">Amount ()</label><input type="number" id="expense-amount" value="${expense.amount || ''}" required></div>
                        <div class="form-group"><label for="expense-category">Category</label><input type="text" id="expense-category" value="${expense.category || ''}" placeholder="e.g., Utilities, Rent, Supplies" required></div>
                        <div class="form-group"><label for="expense-date">Date</label><input type="date" id="expense-date" value="${expense.date || new Date().toISOString().slice(0,10)}" required></div>
                        <button type="submit" class="action-button">${id ? 'Save Changes' : 'Add Expense'}</button></form>`;
                showModal(title, formContent);
                getEl('expense-form').onsubmit = e => { e.preventDefault(); const expenseData = { id: getEl('expense-id').value || Date.now().toString(), title: getEl('expense-title').value, amount: getEl('expense-amount').value, category: getEl('expense-category').value, date: getEl('expense-date').value, }; updateOrAddItem('expenses', expenseData); showToast(`Expense ${id ? 'updated' : 'added'}!`, 'success'); closeModal(); renderExpensesPage(); };
            }
            
            function renderResultPortalPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Result Portal');

                mainContent.innerHTML += `<div class="page active"><div class="card">
                        <div class="card-header"><h3>Find Your Grade Sheet</h3></div>
                        <p>Enter your Roll Number and Date of Birth (or Password) to view your grade sheet.</p>
                        <form id="find-result-form" style="margin-top:20px;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="result-roll-number">Roll Number</label>
                                    <input type="text" id="result-roll-number" placeholder="Enter Roll Number" required>
                                </div>
                                <div class="form-group">
                                    <label for="result-dob">Date of Birth</label>
                                    <input type="date" id="result-dob" placeholder="YYYY-MM-DD">
                                </div>
                            </div>
                             <p style="text-align:center; margin-bottom: 15px;">OR</p>
                             <div class="form-group">
                                <label for="result-password">Password</label>
                                <input type="password" id="result-password" placeholder="Enter Password">
                            </div>
                            <button type="submit" class="action-button inline">Find Result</button>
                        </form>
                        <div id="result-display-area" style="margin-top:30px;"></div>
                    </div></div>`;

                getEl('find-result-form').onsubmit = (e) => { 
                    e.preventDefault(); 
                    handleFindResult();
                };
            }
            
            function handleFindResult() {
                const rollNumber = getEl('result-roll-number').value.trim().toLowerCase();
                const dob = getEl('result-dob').value;
                const password = getEl('result-password').value;
                const resultArea = getEl('result-display-area');
                resultArea.innerHTML = '';

                if (!rollNumber || (!dob && !password)) {
                    resultArea.innerHTML = `<p class="form-feedback error">Please enter a roll number and either a date of birth or a password.</p>`;
                    return;
                }

                const student = (state.data.students || []).find(s => {
                    if (s.rollNumber && s.rollNumber.toLowerCase() === rollNumber) {
                        if (dob && s.dob === dob) return true;
                        if (password && s.password && btoa(password) === s.password) return true;
                    }
                    return false;
                });
                
                if (!student) {
                    resultArea.innerHTML = `<p class="form-feedback error">No student found with these details. Please check your credentials.</p>`;
                    return;
                }
                
                showResultDetailsForm(student.id);
            }
            
            function showResultDetailsForm(studentId) {
                const resultArea = getEl('result-display-area');
                const student = findById('students', studentId);
                 const examOptions = (state.data.examMasters || [])
                    .filter(em => em.declarationDate && new Date(em.declarationDate) <= new Date() && state.data.marks[em.id] && state.data.marks[em.id][student.id])
                    .sort((a,b) => b.id - a.id)
                    .map(ex => `<option value="${ex.id}">${ex.name}</option>`).join('');

                if (!examOptions) {
                    resultArea.innerHTML = `<p class="form-feedback error" style="display:block;">Result for this student has not been declared for any exam yet.</p>`;
                    return;
                }
                
                resultArea.innerHTML = `
                    <div class="card">
                        <h4>Select Exam to View Grade Sheet</h4>
                        <form id="result-details-form">
                            <div class="form-group">
                                <label for="result-exam-select">Select Exam</label>
                                <select id="result-exam-select" required>
                                    <option value="">Select Exam</option>
                                    ${examOptions}
                                </select>
                            </div>
                            <button type="submit" class="action-button">Generate Grade Sheet</button>
                        </form>
                    </div>
                    <div id="marksheet-display-container"></div>
                `;
                
                getEl('result-details-form').onsubmit = (e) => {
                    e.preventDefault();
                    const examMasterId = getEl('result-exam-select').value;
                    const container = getEl('marksheet-display-container');
                    if(examMasterId) {
                        showMarksheet(studentId, examMasterId, container);
                    } else {
                        container.innerHTML = '';
                    }
                };
            }
            
            function showMarksheet(studentId, examMasterId, container) {
                const schoolInfo = state.data.siteContent;
                const student = findById('students', studentId);
                const examMaster = findById('examMasters', examMasterId);
                const marksData = (state.data.marks[examMasterId] || {})[student.id] || [];
                
                const coCurricularData = (state.data.coCurricular || []).find(cc => cc.studentId === studentId && cc.examMasterId === examMasterId);
                
                if (marksData.length === 0) {
                    container.innerHTML = `<p class="form-feedback error">Grade Sheet not available for the selected exam.</p>`;
                    return;
                }

                const gradePointMapNew = { 'O': 10, 'A+': 9, 'A': 8, 'B+': 7, 'B': 6, 'C': 5, 'P': 4, 'F': 0, 'Ab': 0 };

                let totalCredits = 0;
                let totalGradePoints = 0;
                let resultStatus = "PASS";

                const markRows = marksData.map(m => {
                    const gradePoint = gradePointMapNew[m.grade] || 0;
                    const creditValue = parseInt(m.credits || 0);
                    const totalPoints = gradePoint * creditValue;
                    
                    if(m.grade === 'F' || m.grade === 'Ab') resultStatus = "FAIL";

                    totalCredits += creditValue;
                    totalGradePoints += totalPoints;

                    return `<tr>
                        <td>${m.paperCode}</td>
                        <td>${m.subject}</td>
                        <td>${m.grade}</td>
                        <td>${creditValue}</td>
                        <td>${totalPoints}</td>
                    </tr>`;
                }).join('');
                
                const coCurricularRow = coCurricularData ? `
                    <tr>
                        <td>${coCurricularData.paperCode || 'CC-2'}</td>
                        <td>${coCurricularData.subject}</td>
                        <td>${coCurricularData.grade}</td>
                        <td>2</td>
                        <td>Pass</td>
                    </tr>
                ` : '';

                const sgpa = totalCredits > 0 ? (totalGradePoints / totalCredits).toFixed(2) : "0.00";
                const serialNumber = `0000017571`;
                const modalId = `gradesheet-${student.id}-${examMasterId}`;
                const admissionYear = student.admissionNumber ? student.admissionNumber.substring(6, 8) : new Date().getFullYear().toString().slice(-2);
                const batch = `20${admissionYear}-20${parseInt(admissionYear) + 3}`;
                
                const gradeSheetHtml = `
                    <div class="printable-area" id="${modalId}">
                        <div class="grade-sheet-container">
                            <div class="grade-sheet-header">
                                <img src="https://smsvaranasi.com/img/logo.png" alt="Logo" class="logo">
                                <h1>${schoolInfo.schoolName}</h1>
                                <p>(An Autonomous College)</p>
                                <p>Affiliated To Mahatma Gandhi Kashi Vidyapith, Varanasi</p>
                                <h2>${courseDetails[student.className]?.name || student.className}</h2>
                                <p>${examMaster.examTitle || 'Semester Examination'}</p>
                                <p>SESSION: ${examMaster.session || '2024-2025'}</p>
                                <h4>GRADE SHEET</h4>
                            </div>
                            
                            <div class="grade-sheet-details-container">
                                <table class="grade-sheet-student-details">
                                    <tr>
                                        <td><strong>Roll No.:</strong> ${student.rollNumber}</td>
                                        <td><strong>Enrollment No.:</strong> ${student.admissionNumber}</td>
                                    </tr>
                                    <tr>
                                        <td colspan="2"><strong>Name:</strong> ${student.name}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Father's Name:</strong> ${student.fatherName}</td>
                                        <td><strong>Mother's Name:</strong> ${student.motherName}</td>
                                    </tr>
                                     <tr>
                                        <td><strong>Batch:</strong> ${batch}</td>
                                        <td><strong>Sr. No.:</strong> ${serialNumber}</td>
                                    </tr>
                                </table>
                                <div class="grade-sheet-photo-qr-container">
                                    <div class="grade-sheet-student-photo-container">
                                        <img src="${student.photo || `https://ui-avatars.com/api/?name=${student.name.replace(/\s/g, "+")}`}" alt="Student Photo">
                                    </div>
                                    <div id="grade-sheet-qr" class="qr-code"></div>
                                </div>
                            </div>
                            
                             <table class="grade-sheet-marks-table">
                                <thead>
                                    <tr>
                                        <th>Paper No.</th>
                                        <th>Subjects</th>
                                        <th>Grade</th>
                                        <th>Credits</th>
                                        <th>Total Grade Points</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${markRows}
                                    <tr class="total-row">
                                        <td colspan="3" style="text-align:right;">TOTAL</td>
                                        <td>${totalCredits}</td>
                                        <td>${totalGradePoints}</td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <div class="grade-sheet-summary">
                                S.G.P.A. : ${sgpa}
                            </div>

                             ${coCurricularData ? `
                            <div class="grade-sheet-co-curricular-section">
                                <h5>Co-Curricular Course</h5>
                                <table class="grade-sheet-co-curricular-table">
                                    <thead>
                                        <tr>
                                            <th>Paper No.</th>
                                            <th>Subjects</th>
                                            <th>Grade</th>
                                            <th>Credits</th>
                                            <th>Result</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${coCurricularRow}
                                    </tbody>
                                </table>
                            </div>
                            ` : ''}
                            
                            <div class="grade-sheet-footer-container">
                                <div class="result-line">
                                    <p><strong>Result: ${resultStatus}</strong></p>
                                    <p><strong>Dated: ${examMaster.declarationDate ? new Date(examMaster.declarationDate).toLocaleDateString('en-GB').replace(/\//g, '-') : 'N/A'}</strong></p>
                                </div>
                                <div class="signatures" style="margin-top: 50px;">
                                    <div class="sig-block">Prepared By</div>
                                    <div class="sig-block">Checked by</div>
                                    <div class="sig-block">Controller of Examinations</div>
                                    <div class="sig-block">Principal</div>
                                </div>
                                <p style="font-size: 12px; margin-top: 20px;">
                                    <strong>Ab. = Absent  Total Grade Points = Grade Points x Credit Hours.<br>
                                    Minimum Requirement is 40% (i.e. Grade 'C') in each paper to qualify the Examination  See overleaf for GRADING SCALE</strong>
                                </p>
                            </div>
                        </div>
                        <div class="grade-sheet-grading-scale-container">
                           <h3>POINT SCALE FOR GRADING</h3>
                           <table class="grade-sheet-grading-scale-table">
                                <thead>
                                    <tr>
                                        <th>Percentage Distribution of Marks (Out of 100)</th>
                                        <th>Grade Point</th>
                                        <th>Letter Grade</th>
                                        <th>Remarks</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td>=> 90 - < 100</td><td>10</td><td>A++</td><td>Outstanding</td></tr>
                                    <tr><td>=> 80 - < 90</td><td>9</td><td>A+</td><td>Excellent</td></tr>
                                    <tr><td>=> 70 - < 80</td><td>8</td><td>A</td><td>Very Good</td></tr>
                                    <tr><td>=> 60 - < 70</td><td>7</td><td>B+</td><td>Good</td></tr>
                                    <tr><td>=> 50 - < 60</td><td>6</td><td>B</td><td>Average</td></tr>
                                    <tr><td>=> 40 - < 50</td><td>5</td><td>C</td><td>Pass</td></tr>
                                    <tr><td>Below 40</td><td>0</td><td>F</td><td>Fail</td></tr>
                                </tbody>
                           </table>
                           <div class="grade-sheet-grading-scale-formulas">
                               <p><strong>SGPA</strong> = Aggregate of Grade Points (GP x Credit) earned in a Semester / Number of Credit Registered in a Semester</p>
                               <p><strong>CGPA</strong> = Aggregate of Grade Points (GP x Credit) earned in all Semesters / Number of Credits Registered in all Semesters</p>
                               <hr>
                               <p><strong>FIRST Division</strong> = CGPA 6.50 and above</p>
                               <p><strong>SECOND Division</strong> = CGPA 5.00 and above but less that 6.50</p>
                               <p><strong>Percentage of Marks in the Aggregate</strong> = CGPA x 9.50</p>
                               <hr>
                               <p>Co-curricular Grades will not be used to determine SGPA / CGPA. Despite the fact that Passing this paper is required in all Semesters.</p>
                           </div>
                        </div>
                    </div>
                    <div class="no-print" style="margin-top: 20px; display: flex; gap: 15px;">
                        <button class="action-button" onclick="printContent('#${modalId}')"><i class="fas fa-print"></i> Print Grade Sheet</button>
                        <button class="action-button secondary" onclick="downloadAsPdf('#${modalId}', 'Grade-Sheet-${student.name}.pdf')"><i class="fas fa-download"></i> Download PDF</button>
                    </div>
                `;
                container.innerHTML = gradeSheetHtml;
                
                 setTimeout(() => {
                    const qrContainer = getEl('grade-sheet-qr');
                    if(qrContainer) {
                        qrContainer.innerHTML = '';
                        const qrData = `Sr.No: ${serialNumber}\nRoll No: ${student.rollNumber}\nName: ${student.name}\nCourse: ${student.className}\nExam: ${examMaster.name}\nSGPA: ${sgpa}`;
                        new QRCode(qrContainer, { text: qrData, width: 80, height: 80, colorDark: "#000000", colorLight: "#ffffff" });
                        convertQrCanvasToImage(qrContainer);
                    }
                }, 100);
            }
            
            function renderAdmitCardPortalPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Admit Card Portal');

                const courseOptionsHTML = courseOptionsList.map(c => `<option value="${c}">${c}</option>`).join('');

                const examOptions = (state.data.examMasters || [])
                    .sort((a, b) => b.id - a.id)
                    .map(ex => `<option value="${ex.id}">${ex.name}</option>`).join('');

                mainContent.innerHTML += `<div class="page active"><div class="card">
                    <div class="card-header"><h3>Download Your Admit Card</h3></div>
                    <p>Please provide your details below to generate your admit card.</p>
                    <form id="find-admit-card-form" style="margin-top:20px;">
                        <div class="form-group">
                            <label for="admit-card-class-select">1. Select Your Course</label>
                            <select id="admit-card-class-select" required>
                                <option value="">-- Select Course --</option>
                                ${courseOptionsHTML}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="admit-card-exam-select">2. Select Exam</label>
                            <select id="admit-card-exam-select" required>
                                <option value="">-- Select Exam --</option>
                                ${examOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="admit-card-roll-number">3. Enter Your Roll Number</label>
                            <input type="text" id="admit-card-roll-number" placeholder="Enter your roll number" required>
                        </div>
                        <button type="submit" class="action-button inline">Generate Admit Card</button>
                    </form>
                    <div id="admit-card-display-area" style="margin-top:30px;"></div>
                </div></div>`;

                getEl('find-admit-card-form').onsubmit = (e) => {
                    e.preventDefault();
                    handleFindAdmitCard();
                };
            }
            
            function handleFindAdmitCard() {
                const courseName = getEl('admit-card-class-select').value;
                const examMasterId = getEl('admit-card-exam-select').value;
                const rollNumber = getEl('admit-card-roll-number').value.trim();
                const displayArea = getEl('admit-card-display-area');

                if (!courseName || !examMasterId || !rollNumber) {
                    displayArea.innerHTML = `<p class="form-feedback error">Please fill all three fields.</p>`;
                    return;
                }

                const student = (state.data.students || []).find(s => 
                    s.className === courseName && 
                    s.rollNumber && 
                    s.rollNumber.toLowerCase() === rollNumber.toLowerCase()
                );

                if (student) {
                    showAdmitCard(student, examMasterId, displayArea);
                } else {
                    displayArea.innerHTML = `<p class="form-feedback error">No student found with Roll Number <strong>${rollNumber}</strong> in <strong>${courseName}</strong>. Please check your details.</p>`;
                }
            }
            
            function showAdmitCard(student, examMasterId, container) {
                const schoolInfo = state.data.siteContent;
                const examMaster = findById('examMasters', examMasterId);
                if(!examMaster) {
                    showToast("Selected exam could not be found.", "error");
                    return;
                }
                const examSchedulesForCourse = (state.data.examSchedules || [])
                    .filter(ex => ex.examMasterId === examMasterId && ex.className === student.className && ex.semester === student.currentSemester)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));
                
                if(examMaster.category === 'Odd Semester' || examMaster.category === 'Even Semester') {
                    examSchedulesForCourse.push({
                        date: 'N/A',
                        subject: 'FIRST AID AND HEALTH',
                        paperCode: 'CC-2',
                        startTime: 'N/A',
                        endTime: 'N/A'
                    });
                }
                
                const getDayOfWeek = (dateString) => {
                    if(dateString === 'N/A') return 'N/A';
                    const date = new Date(dateString);
                    const userTimezoneOffset = date.getTimezoneOffset() * 60000;
                    const correctedDate = new Date(date.getTime() + userTimezoneOffset);
                    return correctedDate.toLocaleDateString('en-US', { weekday: 'long' });
                };

                const examRows = examSchedulesForCourse.map(ex => `
                    <tr>
                        <td>${ex.date === 'N/A' ? 'TBD' : new Date(ex.date).toLocaleDateString('en-GB')}</td>
                        <td>${getDayOfWeek(ex.date)}</td>
                        <td>${ex.subject}</td>
                        <td>${ex.paperCode || '-'}</td>
                        <td>${ex.startTime} - ${ex.endTime}</td>
                    </tr>
                `).join('') || '<tr><td colspan="5" style="text-align:center;">No exams scheduled for your course in this examination.</td></tr>';
                
                const signatureDoc = (student.documents || []).find(doc => doc.name && doc.name.toLowerCase().includes('signature'));
                const modalId = `admit-card-${student.id}`;
            
                const admitCardHtml = `
                    <div class="printable-area" id="${modalId}">
                        <div class="admit-card-container" style="width: 100%; max-width: 800px; border: 2px solid var(--primary-color); padding: 25px; margin: auto; background: var(--background-color);">
                            <div class="id-card-header" style="border-bottom-width: 3px;">
                                <h3 style="text-transform: uppercase;">${schoolInfo.schoolName}</h3>
                                <p style="font-size: 1.2em; margin-top: 8px; color: var(--primary-light); font-weight: 600;">ADMIT CARD - ${examMaster.name}</p>
                            </div>
                             <div style="display: flex; justify-content: space-between; align-items: flex-start; margin: 25px 0; padding: 0 10px;">
                                <div style="text-align: left; font-size: 1rem; line-height: 1.6;">
                                    <p><strong>Student Name:</strong> ${student.name}</p>
                                    <p><strong>Father's Name:</strong> ${student.fatherName}</p>
                                    <p><strong>Roll No:</strong> ${student.rollNumber}</p>
                                    <p><strong>Course:</strong> ${student.className} (Semester ${student.currentSemester || 1})</p>
                                </div>
                                <div style="text-align:center;">
                                    <img src="${student.photo || `https://ui-avatars.com/api/?name=${student.name.replace(/\s/g, "+")}`}" alt="Photo" class="id-card-photo" style="margin:0; width: 120px; height: 140px; border-radius: 8px; object-fit: cover;">
                                    ${signatureDoc ? `<img src="${signatureDoc.data}" alt="Signature" style="height: 40px; max-width: 120px; object-fit: contain; margin-top: 5px;">` : ''}
                                </div>
                            </div>
                            <h4 style="margin: 25px 0 15px 0; text-align:center; font-size: 1.2rem;">Exam Schedule</h4>
                            <div class="table-container" style="padding: 0 10px;">
                                <table style="font-size: 0.95em; width:100%;">
                                    <thead style="background-color: var(--secondary-color);">
                                        <tr>
                                            <th style="text-align: left;">Date</th>
                                            <th style="text-align: left;">Day</th>
                                            <th style="text-align: left;">Subject</th>
                                            <th style="text-align: left;">Paper Code</th>
                                            <th style="text-align: left;">Time</th>
                                        </tr>
                                    </thead>
                                    <tbody>${examRows}</tbody>
                                </table>
                            </div>
                            <div class="receipt-footer" style="margin-top: 30px; padding: 0 10px;">
                                <div class="receipt-signature" style="margin-top: 60px;">
                                    <div class="receipt-signature-line"></div>
                                    <p>Controller of Examinations</p>
                                </div>
                                <p style="text-align:left; font-size: 0.85rem;"><strong>Instructions:</strong><br>1. Bring this admit card to the examination hall for every exam.<br>
                                 2. No electronic devices (mobiles, smart watches, etc.) are allowed inside the examination hall.<br>3. Reach the examination center at least 15 minutes before the scheduled time.</p>
                            </div>
                        </div>
                    </div>
                    <div class="no-print" style="margin-top: 20px; display: flex; gap: 15px;">
                        <button class="action-button" onclick="printContent('#${modalId}')"><i class="fas fa-print"></i> Print Admit Card</button>
                        <button class="action-button secondary" onclick="downloadAsPdf('#${modalId}', 'Admit-Card-${student.name}.pdf')"><i class="fas fa-download"></i> Download PDF</button>
                    </div>
                `;
                
                if (container) {
                    container.innerHTML = admitCardHtml;
                } else {
                    showModal("Admit Card", admitCardHtml, "900px");
                }
            }
            
            function renderCertificatePage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Certificate Generation');
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="card-header"><h3>Generate Certificate</h3></div><p>Select a student to generate a certificate.</p>
                        <div class="search-box-container" style="margin-top: 20px;">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" oninput="renderCertificateStudentList(this.value)" placeholder="Search Student..." class="search-input">
                        </div>
                        <div class="table-container"><table id="certificate-student-table"></table></div>
                        </div></div>`;
                renderCertificateStudentList();
            }
            
            function renderCertificateStudentList(searchTerm = '') {
                const table = getEl('certificate-student-table');
                if (!table) return;
                let students = (state.data.students || []).filter(s => searchTerm ? 
                    (s.name && s.name.toLowerCase().includes(searchTerm.toLowerCase())) : true);
                let head = `<thead><tr><th>Admission No.</th><th>Name</th><th>Action</th></tr></thead>`;
                let body = `<tbody>`;
                if (students.length === 0) body += `<tr><td colspan="3" style="text-align:center;">No students found.</td></tr>`;
                else students.sort((a, b) => b.id - a.id).forEach(s => { body += `<tr>
                    <td><strong>${s.admissionNumber || 'N/A'}</strong></td>
                    <td>${s.name}</td>
                    <td><button class="action-button inline" onclick="showCertificateGenerationModal('${s.id}')"><i class="fas fa-certificate"></i> Generate</button></td>
                </tr>`; });
                table.innerHTML = head + body + `</tbody>`;
            }

            function showCertificateGenerationModal(studentId) {
                const student = findById('students', studentId);
                const formContent = `
                    <form id="certificate-gen-form">
                        <p>Generating certificate for <strong>${student.name}</strong>.</p>
                        <div class="form-group">
                            <label for="certificate-title">Certificate For</label>
                            <input type="text" id="certificate-title" value="Completing the ${student.className} Program" required>
                        </div>
                        <div class="form-group">
                            <label for="certificate-date">Issue Date</label>
                            <input type="date" id="certificate-date" value="${new Date().toISOString().slice(0,10)}" required>
                        </div>
                        <button type="submit" class="action-button">Preview Certificate</button>
                    </form>
                `;
                showModal('Generate Certificate', formContent);
                getEl('certificate-gen-form').onsubmit = (e) => {
                    e.preventDefault();
                    const certTitle = getEl('certificate-title').value;
                    const issueDate = getEl('certificate-date').value;
                    closeModal();
                    showCertificate(student, certTitle, issueDate);
                };
            }
            
            function showCertificate(student, certTitle, issueDate) {
                 const schoolInfo = state.data.siteContent;
                 const adminProfile = JSON.parse(localStorage.getItem('adminAccount') || '{}');
                 const modalId = `certificate-${student.id}`;
                 const content = `
                    <div class="printable-area" id="${modalId}">
                        <div class="certificate-container">
                            <div class="certificate-header">
                                <h1>Certificate of Achievement</h1>
                                <h2 style="text-transform: uppercase;">${schoolInfo.schoolName}</h2>
                            </div>
                            <div class="certificate-body">
                                <img src="${student.photo || `https://ui-avatars.com/api/?name=${student.name.replace(/\s/g, "+")}`}" alt="Student Photo" class="certificate-student-photo">
                                <p>This is to certify that</p>
                                <p class="student-name">${student.name}</p>
                                <p>has successfully completed the requirements for</p>
                                <p><strong class="class-name">${certTitle}</strong></p>
                                <p>on ${new Date(issueDate).toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' })}.</p>
                            </div>
                            <div class="certificate-footer">
                                <div class="signature-block">
                                    <div class="signature-line"></div>
                                    <p><strong>Date</strong></p>
                                </div>
                                <div class="signature-block">
                                     <div class="signature-line"></div>
                                    <p><strong>${adminProfile.name || 'Director'}</strong></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="no-print" style="margin-top: 20px; display: flex; gap: 15px;">
                        <button class="action-button" onclick="printContent('#${modalId}')"><i class="fas fa-print"></i> Print Certificate</button>
                        <button class="action-button secondary" onclick="downloadAsPdf('#${modalId}', 'Certificate-${student.name}.pdf')"><i class="fas fa-download"></i> Download PDF</button>
                    </div>
                `;
                showModal('Certificate Preview', content, '900px');
            }


            function renderNotesPage() { 
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="showNoteForm()"><i class="fas fa-plus"></i> Add Note</button>`;
                mainContent.innerHTML = renderHeader('Admin Personal Notes', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="table-container"><table id="notes-table"></table></div></div></div>`;
                renderNotesTable();
            }

            function renderNotesTable() {
                const table = getEl('notes-table');
                if(!table) return;
                const { adminNotes } = state.data;
                let html = `<thead><tr><th>Title</th><th>Content</th><th>Date</th><th>Actions</th></tr></thead><tbody>`;
                 if (!adminNotes || adminNotes.length === 0) html += `<tr><td colspan="4" style="text-align:center;">No personal notes found.</td></tr>`;
                else { adminNotes.sort((a,b) => b.id - a.id).forEach(n => { html += `<tr><td>${n.title}</td><td>${n.content.substring(0, 50)}...</td><td>${new Date(n.id).toLocaleDateString()}</td><td class="action-buttons"><button class="edit-btn" onclick="showNoteForm('${n.id}')" title="Edit"><i class="fas fa-edit"></i></button><button class="delete-btn" onclick="deleteItem('adminNotes', '${n.id}', 'Are you sure you want to delete this note?', renderNotesTable)" title="Delete"><i class="fas fa-trash"></i></button></td></tr>`; }); }
                html += '</tbody>'; table.innerHTML = html;
            }
            function showNoteForm(id = null) { 
                const note = id ? findById('adminNotes', id) : {}; 
                const title = id ? 'Edit Note' : 'Add New Note'; 
                const formContent = `<form id="note-form"><input type="hidden" id="note-id" value="${note.id || ''}"><div class="form-group"><label for="note-title">Title</label><input type="text" id="note-title" value="${note.title || ''}" required></div><div class="form-group"><label for="note-content">Content</label><textarea id="note-content" rows="5" required>${note.content || ''}</textarea></div><button type="submit" class="action-button">${id ? 'Save Changes' : 'Add Note'}</button></form>`; 
                showModal(title, formContent); 
                getEl('note-form').onsubmit = e => { 
                    e.preventDefault(); 
                    const noteData = { id: getEl('note-id').value || Date.now(), title: getEl('note-title').value, content: getEl('note-content').value }; 
                    updateOrAddItem('adminNotes', noteData); 
                    showToast(`Note ${id ? 'updated' : 'added'}!`, 'success'); 
                    closeModal(); 
                    renderNotesTable(); 
                }; 
            }
            
            // --- Task Manager (Kanban) ---
            function renderTasksPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Task Manager');
                mainContent.innerHTML += `
                    <div class="page active">
                        <div class="kanban-board">
                            <div class="kanban-column" id="task-col-todo">
                                <div class="kanban-header"><span>To Do</span> <span class="badge" id="count-todo">0</span></div>
                                <div class="kanban-tasks" ondrop="dropTask(event, 'todo')" ondragover="allowDrop(event)"></div>
                                <button class="kanban-add-btn" onclick="showTaskForm('todo')"><i class="fas fa-plus"></i> Add Task</button>
                            </div>
                            <div class="kanban-column" id="task-col-progress">
                                <div class="kanban-header"><span>In Progress</span> <span class="badge" id="count-progress">0</span></div>
                                <div class="kanban-tasks" ondrop="dropTask(event, 'progress')" ondragover="allowDrop(event)"></div>
                                <button class="kanban-add-btn" onclick="showTaskForm('progress')"><i class="fas fa-plus"></i> Add Task</button>
                            </div>
                            <div class="kanban-column" id="task-col-done">
                                <div class="kanban-header"><span>Done</span> <span class="badge" id="count-done">0</span></div>
                                <div class="kanban-tasks" ondrop="dropTask(event, 'done')" ondragover="allowDrop(event)"></div>
                                <button class="kanban-add-btn" onclick="showTaskForm('done')"><i class="fas fa-plus"></i> Add Task</button>
                            </div>
                        </div>
                    </div>`;
                renderTasks();
            }

            function renderTasks() {
                const tasks = state.data.tasks || [];
                ['todo', 'progress', 'done'].forEach(status => {
                    const col = getEl(`task-col-${status}`).querySelector('.kanban-tasks');
                    const countEl = getEl(`count-${status}`);
                    col.innerHTML = '';
                    const filteredTasks = tasks.filter(t => t.status === status);
                    countEl.textContent = filteredTasks.length;
                    
                    filteredTasks.forEach(t => {
                        const card = document.createElement('div');
                        card.className = 'kanban-task-card';
                        card.draggable = true;
                        card.ondragstart = (e) => dragTask(e, t.id);
                        card.innerHTML = `
                            <h4>${t.title}</h4>
                            <p>${t.description || ''}</p>
                            <div class="kanban-task-meta">
                                <span>${new Date(t.id).toLocaleDateString()}</span>
                                <i class="fas fa-trash" style="cursor:pointer; color:var(--error-color);" onclick="deleteItem('tasks', '${t.id}', 'Delete task?', renderTasks)"></i>
                            </div>
                        `;
                        card.onclick = (e) => { if(!e.target.classList.contains('fa-trash')) showTaskForm(status, t.id); };
                        col.appendChild(card);
                    });
                });
            }

            function showTaskForm(status, id = null) {
                const task = id ? findById('tasks', id) : {};
                const title = id ? 'Edit Task' : 'Add New Task';
                const formContent = `
                    <form id="task-form">
                        <input type="hidden" id="task-id" value="${task.id || ''}">
                        <div class="form-group"><label>Title</label><input type="text" id="task-title" value="${task.title || ''}" required></div>
                        <div class="form-group"><label>Description</label><textarea id="task-desc" rows="3">${task.description || ''}</textarea></div>
                        <div class="form-group"><label>Status</label>
                            <select id="task-status">
                                <option value="todo" ${status === 'todo' ? 'selected' : ''}>To Do</option>
                                <option value="progress" ${status === 'progress' ? 'selected' : ''}>In Progress</option>
                                <option value="done" ${status === 'done' ? 'selected' : ''}>Done</option>
                            </select>
                        </div>
                        <button type="submit" class="action-button">${id ? 'Save' : 'Add'}</button>
                    </form>`;
                showModal(title, formContent);
                getEl('task-form').onsubmit = e => {
                    e.preventDefault();
                    const taskData = {
                        id: getEl('task-id').value || Date.now(),
                        title: getEl('task-title').value,
                        description: getEl('task-desc').value,
                        status: getEl('task-status').value
                    };
                    updateOrAddItem('tasks', taskData);
                    closeModal();
                    renderTasks();
                };
            }

            window.allowDrop = (ev) => ev.preventDefault();
            window.dragTask = (ev, id) => ev.dataTransfer.setData("text", id);
            window.dropTask = (ev, status) => {
                ev.preventDefault();
                const id = ev.dataTransfer.getData("text");
                const task = findById('tasks', id);
                if(task && task.status !== status) {
                    task.status = status;
                    updateOrAddItem('tasks', task);
                    renderTasks();
                }
            };

            // --- Voice Assistant ---
            let recognition;
            function toggleVoiceRecognition() {
                if (!('webkitSpeechRecognition' in window)) {
                    showToast("Voice control not supported in this browser.", "error");
                    return;
                }
                const btn = getEl('voice-assist-btn');
                
                if (recognition && recognition.started) {
                    recognition.stop();
                    recognition.started = false;
                    btn.classList.remove('voice-active');
                    showToast("Voice Assistant Stopped", "info");
                    return;
                }

                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'en-US';
                recognition.interimResults = false;

                recognition.onstart = function() {
                    recognition.started = true;
                    btn.classList.add('voice-active');
                    showToast("Listening... Speak now", "info");
                };

                recognition.onend = function() {
                    recognition.started = false;
                    btn.classList.remove('voice-active');
                };

                recognition.onresult = function(event) {
                    const command = event.results[0][0].transcript.toLowerCase();
                    showToast(`Command: "${command}"`, 'success');
                    processVoiceCommand(command);
                };

                recognition.start();
            }

            function processVoiceCommand(cmd) {
                if (cmd.includes('home') || cmd.includes('dashboard')) navigate('home');
                else if (cmd.includes('student') && cmd.includes('list')) navigate('students');
                else if (cmd.includes('add student') || cmd.includes('admission')) showAdmissionForm();
                else if (cmd.includes('teacher')) navigate('teachers');
                else if (cmd.includes('attendance')) navigate('adminStudentAttendance');
                else if (cmd.includes('fee') || cmd.includes('payment')) navigate('feePaymentPortal');
                else if (cmd.includes('task') || cmd.includes('kanban')) navigate('tasks');
                else if (cmd.includes('setting')) navigate('settings', 'list', 'account');
                else if (cmd.includes('logout')) logout();
                else if (cmd.includes('calculator')) showCalculatorModal();
                else showToast("Command not recognized.", "error");
            }
            
            function renderGalleryPage() { 
                const mainContent = getEl('main-content'); 
                const actionsHtml = (state.loggedInUser?.role === 'admin') ? `<button class="action-button inline" onclick="showGalleryForm()"><i class="fas fa-plus"></i> Add Photo</button>` : ''; 
                mainContent.innerHTML = renderHeader('Photo Gallery', actionsHtml); 
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="gallery-grid" id="gallery-grid-container"></div></div></div>`; 
                renderGalleryGrid(); 
            }

            function renderGalleryGrid() { 
                const container = getEl('gallery-grid-container'); 
                if(!container) return; 
                const { gallery } = state.data; 
                if (!gallery || gallery.length === 0) { 
                    container.innerHTML = `<p>No photos in the gallery yet.</p>`; 
                    return; 
                } 
                container.innerHTML = gallery.sort((a,b) => b.id - a.id).map(item => `
                    <div class="gallery-item card">
                        <img src="${item.photo}" alt="${item.title}">
                        <div class="gallery-item-footer">
                            <span>${item.title}</span>
                            ${state.loggedInUser?.role === 'admin' ? `<button class="delete-btn" onclick="deleteItem('gallery', '${item.id}', 'Are you sure you want to delete this photo?', renderGalleryGrid)" title="Delete"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </div>`).join(''); 
            }

            function showGalleryForm() { 
                const title = 'Add Photo to Gallery'; 
                const formContent = `<form id="gallery-form"><div class="form-group"><label for="gallery-title">Photo Title</label><input type="text" id="gallery-title" required></div><div class="form-group"><label for="gallery-photo">Select Photo</label><input type="file" id="gallery-photo" accept="image/*" required></div><button type="submit" class="action-button">Add Photo</button></form>`; 
                showModal(title, formContent); 
                getEl('gallery-form').onsubmit = async e => { 
                    e.preventDefault(); 
                    const photoFile = getEl('gallery-photo').files[0]; 
                    if(!photoFile) return; 
                    const photoData = { id: Date.now(), title: getEl('gallery-title').value, photo: await fileToBase64(photoFile) }; 
                    updateOrAddItem('gallery', photoData); 
                    showToast('Photo added to gallery!', 'success'); 
                    closeModal(); 
                    renderGalleryGrid(); 
                }; 
            }
            
            function renderVideosPage() { 
                const mainContent = getEl('main-content'); 
                const actionsHtml = (state.loggedInUser?.role === 'admin') ? `<button class="action-button inline" onclick="showVideoForm()"><i class="fas fa-plus"></i> Add Video</button>` : ''; 
                mainContent.innerHTML = renderHeader('Video Gallery', actionsHtml); 
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="videos-grid" id="videos-grid-container"></div></div></div>`; 
                renderVideosGrid(); 
            }

            function renderVideosGrid() { 
                const container = getEl('videos-grid-container'); 
                if(!container) return; 
                const { videos } = state.data; 
                if (!videos || videos.length === 0) { 
                    container.innerHTML = `<p>No videos in the gallery yet.</p>`; 
                    return; 
                } 
                container.innerHTML = videos.sort((a,b) => b.id - a.id).map(item => `
                    <div class="video-item card">
                        <iframe src="${getYoutubeEmbedUrl(item.url)}" title="${item.title}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                        <div class="video-item-footer">
                            <span>${item.title}</span>
                             ${state.loggedInUser?.role === 'admin' ? `<button class="delete-btn" onclick="deleteItem('videos', '${item.id}', 'Are you sure you want to delete this video?', renderVideosGrid)" title="Delete"><i class="fas fa-trash"></i></button>`: ''}
                        </div>
                    </div>`).join(''); 
            }
            function showVideoForm() { 
                const title = 'Add Video to Gallery'; 
                const formContent = `<form id="video-form"><div class="form-group"><label for="video-title">Video Title</label><input type="text" id="video-title" required></div><div class="form-group"><label for="video-url">YouTube Video URL</label><input type="url" id="video-url" placeholder="https://www.youtube.com/watch?v=..." required></div><button type="submit" class="action-button">Add Video</button></form>`; 
                showModal(title, formContent); 
                getEl('video-form').onsubmit = e => { 
                    e.preventDefault(); 
                    const videoTitle = getEl('video-title').value; 
                    const videoUrl = getEl('video-url').value; 
                    if(videoUrl && videoTitle) { 
                        const videoData = { id: Date.now(), title: videoTitle, url: videoUrl }; 
                        updateOrAddItem('videos', videoData); 
                        showToast('Video added to gallery!', 'success'); 
                        closeModal(); 
                        renderVideosGrid(); 
                    } 
                }; 
            }
            
            function getYoutubeEmbedUrl(url) { 
                try { 
                    const urlObj = new URL(url); 
                    let videoId = urlObj.searchParams.get("v"); 
                    if (!videoId) { 
                        const pathParts = urlObj.pathname.split('/'); 
                        videoId = pathParts[pathParts.length - 1]; 
                    } 
                    return `https://www.youtube.com/embed/${videoId}`; 
                } catch (e) { 
                    console.error("Invalid YouTube URL:", url);
                    return '';
                } 
            }

            function setupAttendancePage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Student Attendance');
                mainContent.innerHTML += `
                    <div class="page active">
                        <div class="card">
                            <div class="card-header" style="flex-direction: column; align-items: flex-start; border-bottom: none; padding-bottom: 0;">
                                <h3>Student Attendance Management</h3>
                                <div class="view-switcher" style="margin-top: 15px;">
                                    <button id="mark-view-btn" class="action-button inline">Manual</button>
                                    <button id="report-view-btn" class="action-button inline">Monthly Report</button>
                                </div>
                            </div>
                            <div id="attendance-content" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;"></div>
                        </div>
                    </div>
                `;
                getEl('mark-view-btn').onclick = () => renderMarkAttendanceView('students');
                getEl('report-view-btn').onclick = () => renderAttendanceReportView('students');
                renderMarkAttendanceView('students');
            }

            function setActiveView(activeBtnId) {
                 [
                    'mark-view-btn', 'report-view-btn',
                    'teacher-mark-view-btn', 'teacher-report-view-btn',
                    'staff-mark-view-btn', 'staff-report-view-btn'
                 ].forEach(id => {
                    const btn = getEl(id);
                    if (btn) btn.classList.remove('active');
                 });
                 if (getEl(activeBtnId)) getEl(activeBtnId).classList.add('active');
            }

            function renderMarkAttendanceView(type = 'students') {
                if(html5QrCode && html5QrCode.isScanning) html5QrCode.stop();
                
                let activeBtnId;
                if(type === 'students') activeBtnId = 'mark-view-btn';
                else if (type === 'teachers') activeBtnId = 'teacher-mark-view-btn';
                else if (type === 'staff') activeBtnId = 'staff-mark-view-btn';
                setActiveView(activeBtnId);
                
                const contentArea = getEl('attendance-content');
                const today = new Date().toISOString().slice(0, 10);


                let filterHtml = '';
                if (type === 'students') {
                     const courseOptionsHTML = courseOptionsList.map(c => `<option value="${c}">${c}</option>`).join('');
                     filterHtml = `
                     <div class="form-grid">
                        <div class="form-group"><label for="attendance-class-filter">Filter by Course</label><select id="attendance-class-filter" onchange="renderAttendanceSheet('${type}')"><option value="">All Students</option>${courseOptionsHTML}</select></div>
                        <div class="form-group"><label for="attendance-semester-filter">Filter by Semester</label><select id="attendance-semester-filter" onchange="renderAttendanceSheet('${type}')"><option value="">All Semesters</option></select></div>
                     </div>`;
                }
                
                contentArea.innerHTML = `
                    <div class="form-group"><label for="attendance-date">Select Date</label><input type="date" id="attendance-date" value="${today}" onchange="renderAttendanceSheet('${type}')"></div>
                    ${filterHtml}
                    <div class="table-container"><table id="attendance-table"></table></div>
                    <button class="action-button" style="margin-top: 20px;" onclick="saveAttendance('${type}')">Save ${type.charAt(0).toUpperCase() + type.slice(1)} Attendance</button>
                `;
                if(type === 'students'){
                    getEl('attendance-class-filter').onchange = () => {
                        updateSemesterDropdown(getEl('attendance-class-filter').value, 'attendance-semester-filter', '');
                        renderAttendanceSheet('students');
                    }
                }
                
                renderAttendanceSheet(type);
            }
            
            function renderAttendanceReportView(type = 'students') {
                
                if (html5QrCode && html5QrCode.isScanning) html5QrCode.stop();
                
                let activeBtnId;
                if(type === 'students') activeBtnId = 'report-view-btn';
                else if (type === 'teachers') activeBtnId = 'teacher-report-view-btn';
                else if (type === 'staff') activeBtnId = 'staff-report-view-btn';
                setActiveView(activeBtnId);
                
                const contentArea = getEl('attendance-content');

                const now = new Date();
                const currentYear = now.getFullYear();

                const yearOptions = Array.from({ length: 5 }, (_, i) => currentYear - i)
                    .map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');
                
                const monthOptions = Array.from({ length: 12 }, (_, i) => {
                    const monthName = new Date(0, i).toLocaleString('en-US', { month: 'long' });
                    return `<option value="${i}" ${i === now.getMonth() ? 'selected' : ''}>${monthName}</option>`;
                }).join('');

                let classFilterHtml = '';
                if (type === 'students') {
                    const courseOptionsHTML = courseOptionsList.map(c => `<option value="${c}">${c}</option>`).join('');
                    classFilterHtml = `
                        <div class="form-group" style="margin-bottom: 0; flex-grow: 1;">
                            <label for="report-class-filter">Filter by Course</label>
                            <select id="report-class-filter" onchange="displayMonthlyAttendanceReport('${type}')"><option value="all">All Students</option>${courseOptionsHTML}</select>
                        </div>
                         <div class="form-group" style="margin-bottom: 0; flex-grow: 1;">
                            <label for="report-semester-filter">Filter by Semester</label>
                            <select id="report-semester-filter" onchange="displayMonthlyAttendanceReport('${type}')"><option value="all">All Semesters</option></select>
                        </div>
                        `;
                }
                const modalId = `attendance-report-printable-${type}`;

                contentArea.innerHTML = `
                    <div class="no-print" style="display:flex; flex-wrap: wrap; gap: 20px; align-items: flex-end; margin-bottom: 20px;">
                        <div class="form-group" style="margin-bottom: 0; flex-grow: 1;">
                            <label for="report-month-filter">Select Month</label>
                            <select id="report-month-filter" onchange="displayMonthlyAttendanceReport('${type}')">${monthOptions}</select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0; flex-grow: 1;">
                            <label for="report-year-filter">Select Year</label>
                            <select id="report-year-filter" onchange="displayMonthlyAttendanceReport('${type}')">${yearOptions}</select>
                        </div>
                        ${classFilterHtml}
                        <button class="action-button inline" onclick="printContent('#${modalId}')" style="flex-shrink: 0;"><i class="fas fa-print"></i> Print Report</button>
                        <button class="action-button secondary inline" onclick="downloadAsPdf('#${modalId}', 'Attendance-Report.pdf')"><i class="fas fa-download"></i> Download PDF</button>
                    </div>
                    <div id="${modalId}"></div>`;
                
                if(type === 'students'){
                    getEl('report-class-filter').onchange = () => {
                        updateSemesterDropdown(getEl('report-class-filter').value, 'report-semester-filter', 'all');
                        displayMonthlyAttendanceReport('students');
                    }
                }

                displayMonthlyAttendanceReport(type);
            }
            
            function displayMonthlyAttendanceReport(type = 'students', memberId = null, isReadonly = false) {
                let reportContainer;
                if(state.currentPage === 'studentAttendance') {
                    reportContainer = getEl(`student-attendance-printable-${memberId}`);
                } else {
                    reportContainer = getEl(`attendance-report-printable-${type}`);
                }
                
                if (!reportContainer) return;
                
                let month, year, classFilterEl, semFilterEl;
                if (state.currentPage === 'studentAttendance') {
                    month = parseInt(getEl('student-report-month-filter').value);
                    year = parseInt(getEl('student-report-year-filter').value);
                } else {
                    month = parseInt(getEl('report-month-filter').value);
                    year = parseInt(getEl('report-year-filter').value);
                    classFilterEl = getEl('report-class-filter');
                    semFilterEl = getEl('report-semester-filter');
                }
                
                const selectedClass = classFilterEl ? classFilterEl.value : 'all';
                const selectedSemester = semFilterEl ? semFilterEl.value : 'all';


                let memberList;
                if (memberId) {
                    memberList = [findById(type, memberId)];
                } else {
                    memberList = (state.data[type] || []);
                    if (type === 'students') {
                        if(selectedClass !== 'all') {
                            memberList = memberList.filter(s => s.className === selectedClass);
                        }
                        if(selectedSemester !== 'all') {
                             memberList = memberList.filter(s => s.currentSemester == selectedSemester);
                        }
                    }
                }
                
                if (memberList.length === 0 || (memberId && !memberList[0])) {
                    reportContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">No members found for this selection.</p>';
                    return;
                }
                
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const monthName = new Date(year, month).toLocaleString('default', { month: 'long' });

                let tableHtml = `<div class="printable-area attendance-report">
                                 <h3 style="text-align: center; margin-bottom: 20px; color: var(--text-color);">Attendance Report for ${monthName} ${year}</h3>
                                 <form id="attendance-edit-form">
                                 <div class="table-container"><table class="monthly-attendance-table"><thead><tr><th class="sticky-col">Name</th>`;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    tableHtml += `<th>${day}</th>`;
                }
                tableHtml += `<th>P</th><th>A</th><th>%</th></tr></thead><tbody>`;

                memberList.forEach(member => {
                    let presentCount = 0;
                    let absentCount = 0;
                    tableHtml += `<tr><td class="sticky-col">${member.name}</td>`;
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(year, month, day);
                        const dateString = date.toISOString().slice(0, 10);
                        const dayOfWeek = date.getDay();
                        
                        let attendanceSource;
                        if (type === 'students') attendanceSource = state.data.studentAttendance;
                        else if (type === 'teachers') attendanceSource = state.data.teacherAttendance;
                        else if (type === 'staff') attendanceSource = state.data.staffAttendance;

                        const attendanceStatus = (attendanceSource[dateString] && attendanceSource[dateString][member.id]) ? attendanceSource[dateString][member.id] : null;

                        let cellClass = '';
                        let cellContent = '-';

                        if (dayOfWeek === 0) { // Sunday
                            cellClass = 'weekend-cell';
                            cellContent = 'S';
                        } else {
                            if (isReadonly) {
                                if (attendanceStatus === 'present') {
                                    presentCount++;
                                    cellClass = 'present-cell';
                                    cellContent = 'P';
                                } else if (attendanceStatus === 'absent') {
                                    absentCount++;
                                    cellClass = 'absent-cell';
                                    cellContent = 'A';
                                } else {
                                    cellContent = '-';
                                }
                            } else {
                                cellContent = `
                                    <select name="attendance_${member.id}_${dateString}" class="attendance-select" style="background: transparent; border: none; color: var(--text-color); width: 40px; text-align: center; -moz-appearance: none; -webkit-appearance: none; appearance: none;">
                                        <option value="" ${!attendanceStatus ? 'selected' : ''}>-</option>
                                        <option value="present" ${attendanceStatus === 'present' ? 'selected' : ''} style="color: var(--success-color);">P</option>
                                        <option value="absent" ${attendanceStatus === 'absent' ? 'selected' : ''} style="color: var(--error-color);">A</option>
                                    </select>
                                `;
                                if (attendanceStatus === 'present') {
                                    presentCount++;
                                    cellClass = 'present-cell';
                                } else if (attendanceStatus === 'absent') {
                                    absentCount++;
                                    cellClass = 'absent-cell';
                                }
                            }
                        }
                        
                        tableHtml += `<td class="${cellClass}">${cellContent}</td>`;
                    }
                    
                    const totalMarkedDays = presentCount + absentCount;
                    const percentage = totalMarkedDays > 0 ? ((presentCount / totalMarkedDays) * 100).toFixed(0) : 0;

                    tableHtml += `<td class="present-cell">${presentCount}</td><td class="absent-cell">${absentCount}</td><td>${percentage}%</td></tr>`;
                });

                tableHtml += `</tbody></table></div>`;
                
                if (!isReadonly) {
                    tableHtml += `<button type="submit" class="action-button no-print" style="margin-top: 20px;">Save Changes</button>`;
                }

                tableHtml += `</form></div>`;
                reportContainer.innerHTML = tableHtml;

                const form = getEl('attendance-edit-form');
                if(form && !isReadonly) {
                    form.onsubmit = (e) => {
                        e.preventDefault();
                        const formData = new FormData(form);
                        let changesMade = false;
                        for(let [key, value] of formData.entries()) {
                             if (!key.startsWith('attendance_')) continue;
                            const [, memberId, dateString] = key.split('_');
                            
                            let attendanceKey;
                            if (type === 'students') attendanceKey = 'studentAttendance';
                            else if (type === 'teachers') attendanceKey = 'teacherAttendance';
                            else if (type === 'staff') attendanceKey = 'staffAttendance';
                            else continue;

                            if (!state.data[attendanceKey][dateString]) {
                                state.data[attendanceKey][dateString] = {};
                            }

                            const originalValue = state.data[attendanceKey][dateString][memberId];

                            if (value) {
                                if(originalValue !== value) {
                                    state.data[attendanceKey][dateString][memberId] = value;
                                    changesMade = true;
                                }
                            } else {
                                if(originalValue) {
                                    delete state.data[attendanceKey][dateString][memberId];
                                    changesMade = true;
                                }
                            }
                        }
                        if(changesMade){
                           saveData();
                           showToast('Attendance updated successfully!', 'success');
                           displayMonthlyAttendanceReport(type, memberId);
                        } else {
                           showToast('No changes to save.', 'info');
                        }
                    };
                }
            }

            function renderTeacherAttendancePage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Teacher Attendance');
                mainContent.innerHTML += `
                    <div class="page active">
                        <div class="card">
                            <div class="card-header" style="flex-direction: column; align-items: flex-start; border-bottom: none; padding-bottom: 0;">
                                <h3>Teacher Attendance Management</h3>
                                <div class="view-switcher" style="margin-top: 15px;">
                                    <button id="teacher-mark-view-btn" class="action-button inline">Manual</button>
                                    <button id="teacher-report-view-btn" class="action-button inline">Monthly Report</button>
                                </div>
                            </div>
                            <div id="attendance-content" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;"></div>
                        </div>
                    </div>`;
                getEl('teacher-mark-view-btn').onclick = () => renderMarkAttendanceView('teachers');
                getEl('teacher-report-view-btn').onclick = () => renderAttendanceReportView('teachers');
                renderMarkAttendanceView('teachers');
            }
            
            function renderStaffAttendancePage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Staff Attendance');
                mainContent.innerHTML += `
                    <div class="page active">
                        <div class="card">
                            <div class="card-header" style="flex-direction: column; align-items: flex-start; border-bottom: none; padding-bottom: 0;">
                                <h3>Staff Attendance Management</h3>
                                <div class="view-switcher" style="margin-top: 15px;">
                                    <button id="staff-mark-view-btn" class="action-button inline">Manual</button>
                                    <button id="staff-report-view-btn" class="action-button inline">Monthly Report</button>
                                </div>
                            </div>
                            <div id="attendance-content" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;"></div>
                        </div>
                    </div>`;
                getEl('staff-mark-view-btn').onclick = () => renderMarkAttendanceView('staff');
                getEl('staff-report-view-btn').onclick = () => renderAttendanceReportView('staff');
                renderMarkAttendanceView('staff');
            }

            function calculateAttendance(type, memberId) {
                let present = 0, absent = 0;
                let attendanceRecords;
                if (type === 'students') attendanceRecords = state.data.studentAttendance || {};
                else if (type === 'teachers') attendanceRecords = state.data.teacherAttendance || {};
                else if (type === 'staff') attendanceRecords = state.data.staffAttendance || {};
                else return { present: 0, absent: 0 };
                
                for (const date in attendanceRecords) {
                    if (attendanceRecords[date][memberId]) {
                        if (attendanceRecords[date][memberId] === 'present') present++;
                        else if (attendanceRecords[date][memberId] === 'absent') absent++;
                    }
                }
                return { present, absent };
            }

            function renderAttendanceSheet(type) { 
                const table = getEl('attendance-table'); 
                if(!table) return; 
                
                let membersToList = [];
                if (type === 'students') {
                    const classFilter = getEl('attendance-class-filter');
                    const semFilter = getEl('attendance-semester-filter');
                    const className = classFilter ? classFilter.value : '';
                    const semester = semFilter ? semFilter.value : '';
                    
                    membersToList = (state.data.students || []);
                    if(className) {
                        membersToList = membersToList.filter(s => s.className === className);
                    }
                    if(semester) {
                        membersToList = membersToList.filter(s => s.currentSemester == semester);
                    }

                } else {
                    membersToList = state.data[type] || [];
                }
                
                const date = getEl('attendance-date').value; 
                let attendanceData;
                if (type === 'students') attendanceData = (state.data.studentAttendance || {})[date] || {};
                else if (type === 'teachers') attendanceData = (state.data.teacherAttendance || {})[date] || {};
                else if (type === 'staff') attendanceData = (state.data.staffAttendance || {})[date] || {};

                let html = `<thead><tr><th>Member Name</th><th>Status</th></tr></thead><tbody>`; 
                if(membersToList.length === 0) {
                    html += `<tr><td colspan="2" style="text-align:center;">No members found for this course/semester.</td></tr>`; 
                } else { 
                    membersToList.forEach(s => { 
                        const status = attendanceData[s.id] || 'absent'; 
                        html += `<tr data-member-id="${s.id}">
                                    <td>${s.name}</td>
                                    <td>
                                        <label style="margin-right:15px;"><input type="radio" name="status_${s.id}" value="present" ${status === 'present' ? 'checked' : ''}> Present</label>
                                        <label><input type="radio" name="status_${s.id}" value="absent" ${status === 'absent' ? 'checked' : ''}> Absent</label>
                                    </td>
                                </tr>`; 
                    }); 
                } 
                html += `</tbody>`; 
                table.innerHTML = html; 
            }
            
            function saveAttendance(type) { 
                const date = getEl('attendance-date').value; 
                let attendanceDataKey;
                if (type === 'students') attendanceDataKey = 'studentAttendance';
                else if (type === 'teachers') attendanceDataKey = 'teacherAttendance';
                else if (type === 'staff') attendanceDataKey = 'staffAttendance';
                else return;

                if(!state.data[attendanceDataKey][date]) state.data[attendanceDataKey][date] = {}; 
                let count = 0; 
                getEl('attendance-table').querySelectorAll('tbody tr').forEach(row => { 
                    const memberId = row.getAttribute('data-member-id');
                    if (memberId) {
                       const statusInput = row.querySelector('input[type="radio"]:checked');
                       if (statusInput) {
                           state.data[attendanceDataKey][date][memberId] = statusInput.value; 
                           count++; 
                       }
                    }
                }); 
                if (count > 0) { 
                    saveData(); 
                    showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} attendance for ${date} saved!`, 'success'); 
                    if(state.currentPage === 'home') renderHomePage(); 
                } else { 
                    showToast(`No one to mark.`, 'info'); 
                } 
            }

            function showUnifiedScanner() {
                const modalContent = `
                    <div id="unified-scanner-container" style="text-align: center;">
                        <div id="qr-scanner-container" style="width: 100%; max-width: 400px; margin: 0 auto;"></div>
                        <div id="unified-scan-result" style="margin-top: 15px; font-size: 1.1rem; padding: 10px; border-radius: 6px;"></div>
                        <div id="last-scanned-info" class="card" style="margin-top: 20px; display: none; padding: 15px;">
                            <img id="last-scanned-photo" src="" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin: 0 auto 15px; border: 3px solid var(--primary-light);">
                            <h4 id="last-scanned-name" style="font-size: 1.2rem;"></h4>
                            <p id="last-scanned-id" style="color: var(--text-muted);"></p>
                        </div>
                    </div>
                `;
                showModal('Unified QR Attendance Scanner', modalContent, '500px');
                
                html5QrCode = new Html5Qrcode("qr-scanner-container");
                const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                    const resultEl = getEl('unified-scan-result');
                    const infoEl = getEl('last-scanned-info');
                    
                    const cleanDecodedText = decodedText.trim();
                    let member = null;
                    let memberType = '';
                    let attendanceKey = '';
                    let idField = '';

                    member = (state.data.students || []).find(s => s.admissionNumber === cleanDecodedText);
                    if (member) {
                        memberType = 'Student';
                        attendanceKey = 'studentAttendance';
                        idField = member.admissionNumber;
                    } else {
                        member = (state.data.teachers || []).find(t => t.employeeId === cleanDecodedText);
                        if (member) {
                            memberType = 'Teacher';
                            attendanceKey = 'teacherAttendance';
                            idField = member.employeeId;
                        } else {
                           member = (state.data.staff || []).find(s => s.employeeId === cleanDecodedText);
                           if (member) {
                                memberType = 'Staff';
                                attendanceKey = 'staffAttendance';
                                idField = member.employeeId;
                           }
                        }
                    }
                    
                    if (member) {
                        const today = new Date().toISOString().slice(0, 10);
                        if (!state.data[attendanceKey][today]) state.data[attendanceKey][today] = {};

                        if (state.data[attendanceKey][today][member.id] === 'present') {
                            resultEl.innerHTML = `<strong style="color: var(--warning-color);">Attendance already marked for ${member.name}.</strong>`;
                        } else {
                            state.data[attendanceKey][today][member.id] = 'present';
                            saveData(); 
                            resultEl.innerHTML = `<strong style="color: var(--success-color);">Success! Attendance marked for ${member.name} (${memberType}).</strong>`;
                            showToast(`Attendance marked for ${member.name}`, 'success');
                            if(state.currentPage === 'home') renderHomePage();
                        }
                        
                        getEl('last-scanned-photo').src = member.photo || `https://ui-avatars.com/api/?name=${member.name.replace(/\s/g, "+")}`;
                        getEl('last-scanned-name').textContent = member.name;
                        getEl('last-scanned-id').textContent = idField;
                        infoEl.style.display = 'block';

                    } else {
                        resultEl.innerHTML = `<strong style="color: var(--error-color);">Error! Invalid QR Code. Member not found.</strong>`;
                        infoEl.style.display = 'none';
                    }
                };
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                
                html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
                    .catch(err => {
                        console.error("QR Scanner Error:", err);
                        getEl('unified-scan-result').innerHTML = `<strong>Camera Error!</strong><br>Could not start camera. Check permissions.`;
                    });
            }

            function renderInquiriesPage() { 
                const mainContent = getEl('main-content'); 
                const userRole = state.loggedInUser?.role || 'guest';
                const actionsHtml = (userRole === 'admin' || userRole === 'guest') ? `<button class="action-button inline" onclick="showInquiryForm()"><i class="fas fa-plus"></i> Add Inquiry</button>`: '';
                mainContent.innerHTML = renderHeader('Inquiries', actionsHtml); 
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="table-container"><table id="inquiries-table"></table></div></div></div>`; 
                renderInquiriesTable(); 
            }

            function renderInquiriesTable() { 
                const table = getEl('inquiries-table'); 
                if (!table) return; 
                const { inquiries } = state.data; 
                const userRole = state.loggedInUser?.role || 'guest';
                let html = `<thead><tr><th>Name</th><th>Contact</th><th>Inquiry For</th><th>Status</th>`;
                if(userRole === 'admin') html += `<th>Actions</th>`;
                html += `</tr></thead><tbody>`;

                if (!inquiries || inquiries.length === 0) {
                    html += `<tr><td colspan="${userRole === 'admin' ? 5 : 4}" style="text-align:center;">No inquiries found.</td></tr>`;
                } else { 
                    inquiries.sort((a,b) => b.id - a.id).forEach(i => { 
                        html += `<tr>
                                    <td>${i.name}</td>
                                    <td>${i.contact}</td>
                                    <td>${i.inquiryFor}</td>
                                    <td>${i.status}</td>
                                    ${userRole === 'admin' ? `
                                    <td class="action-buttons">
                                        <button class="edit-btn" onclick="showInquiryForm('${i.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                        <button class="delete-btn" onclick="deleteItem('inquiries', '${i.id}', 'Are you sure you want to delete this inquiry?', renderInquiriesTable)" title="Delete"><i class="fas fa-trash"></i></button>
                                    </td>` : ''}
                                </tr>`; 
                    }); 
                } 
                html += '</tbody>'; table.innerHTML = html; 
            }

            function showInquiryForm(id = null) { 
                const inquiry = id ? findById('inquiries', id) : {}; 
                const title = id ? 'Edit Inquiry' : 'Add New Inquiry'; 
                const userRole = state.loggedInUser?.role || 'guest';
                
                const courseOptionsHTML = courseOptionsList
                    .map(c => `<option value="${c}" ${inquiry.className === c ? 'selected' : ''}>${c}</option>`).join('');

                const formContent = `<form id="inquiry-form">
                                        <input type="hidden" id="inquiry-id" value="${inquiry.id || ''}">
                                        <div class="form-grid">
                                            <div class="form-group"><label for="inquiry-name">Student's Name</label><input type="text" id="inquiry-name" value="${inquiry.name || ''}" required></div>
                                            <div class="form-group"><label for="inquiry-father-name">Father's Name</label><input type="text" id="inquiry-father-name" value="${inquiry.fatherName || ''}" required></div>
                                            <div class="form-group"><label for="inquiry-contact">Contact</label><input type="tel" id="inquiry-contact" value="${inquiry.contact || ''}" required></div>
                                            <div class="form-group"><label for="inquiry-email">Email</label><input type="email" id="inquiry-email" value="${inquiry.email || ''}"></div>
                                            <div class="form-group"><label for="inquiry-class">Course</label><select id="inquiry-class">${courseOptionsHTML}</select></div>
                                            <div class="form-group"><label for="inquiry-category">Category</label><select id="inquiry-category" required><option value="">Select Category</option><option value="General">General</option><option value="OBC">OBC</option><option value="SC">SC</option><option value="ST">ST</option></select></div>
                                        </div>
                                        <div class="form-group"><label for="inquiry-for">Inquiry Message (Optional)</label><textarea id="inquiry-for" rows="3">${inquiry.inquiryFor || ''}</textarea></div>
                                        ${userRole === 'admin' ? `
                                        <div class="form-group"><label for="inquiry-status">Status</label><select id="inquiry-status"><option value="New" ${inquiry.status === 'New' || !inquiry.status ? 'selected' : ''}>New</option><option value="Followed Up" ${inquiry.status === 'Followed Up' ? 'selected' : ''}>Followed Up</option><option value="Enrolled" ${inquiry.status === 'Enrolled' ? 'selected' : ''}>Enrolled</option><option value="Closed" ${inquiry.status === 'Closed' ? 'selected' : ''}>Closed</option></select></div>
                                        `: `
                                        <input type="hidden" id="inquiry-status-hidden" value="New">
                                        `}
                                        <button type="submit" class="action-button">${id ? 'Save Changes' : 'Submit Inquiry'}</button>
                                     </form>`; 
                showModal(title, formContent, '800px'); 
                getEl('inquiry-form').onsubmit = e => { 
                    e.preventDefault(); 
                    const statusEl = getEl('inquiry-status');
                    const status = statusEl ? statusEl.value : getEl('inquiry-status-hidden').value;

                    const inquiryData = { 
                        id: getEl('inquiry-id').value || Date.now(), 
                        name: getEl('inquiry-name').value,
                        fatherName: getEl('inquiry-father-name').value,
                        contact: getEl('inquiry-contact').value,
                        email: getEl('inquiry-email').value,
                        className: getEl('inquiry-class').value,
                        category: getEl('inquiry-category').value,
                        inquiryFor: getEl('inquiry-for').value, 
                        status: status
                    }; 

                    updateOrAddItem('inquiries', inquiryData); 
                    showToast(`Inquiry ${id ? 'updated' : 'submitted'}!`, 'success'); 
                    closeModal(); 
                    renderInquiriesTable();
                    if (state.currentPage === 'home') renderHomePage();
                }; 
            }
            
            function renderAccountSettingsPage() { 
                const mainContent = getEl('main-content');
                const adminProfile = state.loggedInUser;
                mainContent.innerHTML = renderHeader('User Account'); 
                mainContent.innerHTML += `<div class="page active">
                    <div class="card">
                        <div class="card-header"><h3>Profile Information</h3></div>
                        <form id="profile-settings-form">
                            <div class="form-group">
                                <label for="admin-name">Admin Name</label>
                                <input type="text" id="admin-name" value="${adminProfile.name || 'Admin'}">
                            </div>
                            <div class="form-group">
                                <label for="admin-photo-file">Admin Photo</label>
                                <input type="file" id="admin-photo-file" accept="image/*">
                                <input type="hidden" id="admin-photo-base64" value="${adminProfile.photo || ''}">
                                ${adminProfile.photo ? `<img src="${adminProfile.photo}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-top: 10px;">` : ''}
                            </div>
                            <button type="submit" class="action-button inline">Save Profile</button>
                        </form>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>Change Password</h3></div>
                        <form id="change-password-form">
                            <div class="form-group"><label for="current-password">Current Password</label><input type="password" id="current-password" required></div>
                            <div class="form-group"><label for="new-password">New Password</label><input type="password" id="new-password" minlength="4" required></div>
                            <div class="form-group"><label for="confirm-new-password">Confirm New Password</label><input type="password" id="confirm-new-password" required></div>
                            <button type="submit" class="action-button inline">Change Password</button>
                        </form>
                    </div>
                </div>`; 

                getEl('admin-photo-file').onchange = async (e) => { 
                    if (e.target.files[0]) {
                        getEl('admin-photo-base64').value = await fileToBase64(e.target.files[0]);
                    }
                }; 

                getEl('profile-settings-form').onsubmit = e => { 
                    e.preventDefault(); 
                    const currentAdmin = JSON.parse(localStorage.getItem('adminAccount'));
                    const newProfile = { 
                        ...currentAdmin,
                        name: getEl('admin-name').value, 
                        photo: getEl('admin-photo-base64').value 
                    }; 
                    localStorage.setItem('adminAccount', JSON.stringify(newProfile));
                    state.loggedInUser = {role: 'admin', ...newProfile};
                    localStorage.setItem('loggedInUser', JSON.stringify(state.loggedInUser));
                    showToast('Profile updated!', 'success'); 
                    renderSidebar(); 
                    renderAccountSettingsPage();
                };

                getEl('change-password-form').onsubmit = e => { 
                    e.preventDefault();
                    const currentAdmin = JSON.parse(localStorage.getItem('adminAccount')); 
                    const currentPass = getEl('current-password').value; 
                    const newPass = getEl('new-password').value; 
                    const confirmPass = getEl('confirm-new-password').value; 
                    if (btoa(currentPass) !== currentAdmin.password) { return showToast('Current password incorrect.', 'error'); } 
                    if (newPass.length < 4) { return showToast('New password must be at least 4 characters.', 'error'); } 
                    if (newPass !== confirmPass) { return showToast('New passwords do not match.', 'error'); } 
                    
                    const updatedAdmin = {...currentAdmin, password: btoa(newPass)};
                    localStorage.setItem('adminAccount', JSON.stringify(updatedAdmin));
                    state.loggedInUser = {role: 'admin', ...updatedAdmin};
                    localStorage.setItem('loggedInUser', JSON.stringify(state.loggedInUser));
                    showToast('Password changed successfully!', 'success');                 
                    e.target.reset(); 
                }; 
            }
            
            function renderAppearanceSettingsPage() { 
                const mainContent = getEl('main-content'); 
                const currentTheme = localStorage.getItem('theme') || 'dark'; 
                const currentWeight = localStorage.getItem('fontWeight') || 'normal'; 
                const currentAnimations = localStorage.getItem('animations3d') === 'true';

                const colorSwatchesHtml = Object.entries(config.accentColors).map(([name, colors]) => {
                    const isActive = (document.documentElement.style.getPropertyValue('--primary-color') === colors.primary);
                    return `<div class="color-swatch ${isActive ? 'active' : ''}" style="background-image: linear-gradient(45deg, ${colors.primary}, ${colors.light})" onclick="changeAccentColorByName('${name}')"></div>`;
                }).join('');

                mainContent.innerHTML = renderHeader('Appearance'); 
                mainContent.innerHTML += `<div class="page active">
                    <div class="card">
                        <div class="card-header"><h3>Theme Settings</h3></div>
                        <div class="form-group">
                            <label>Background Theme</label>
                            <select id="theme-select">
                                <option value="light" ${currentTheme === 'light' ? 'selected' : ''}>Light Mode</option>
                                <option value="dark" ${currentTheme === 'dark' ? 'selected' : ''}>Dark Mode</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Accent Color</label>
                            <div class="color-palette">${colorSwatchesHtml}</div>
                        </div>
                        <div class="form-group">
                            <label>3D Animations</label>
                            <div class="toggle-switch">
                                <span>Off</span>
                                <label class="switch">
                                  <input type="checkbox" id="animations-toggle" ${currentAnimations ? 'checked' : ''}>
                                  <span class="slider-round"></span>
                                </label>
                                <span>On</span>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>Font Weight</h3></div>
                        <p>Change the overall font weight.</p>
                        <div class="form-group" style="margin-top: 20px;">
                            <select id="font-weight-select">
                                <option value="light" ${currentWeight === 'light' ? 'selected' : ''}>Light</option>
                                <option value="normal" ${currentWeight === 'normal' ? 'selected' : ''}>Normal</option>
                                <option value="bold" ${currentWeight === 'bold' ? 'selected' : ''}>Bold</option>
                            </select>
                        </div>
                    </div>
                </div>`; 
                getEl('theme-select').onchange = (e) => changeTheme(e.target.value); 
                getEl('font-weight-select').onchange = changeFontWeight; 
                getEl('animations-toggle').onchange = (e) => toggleAnimations(e.target.checked);
            }
            
             function renderContentSettingsPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Site Content Management');
                const { siteContent } = state.data;

                const newsItemsHtml = (siteContent.latestNews || []).sort((a,b) => b.id-a.id).map(item => `
                    <div class="notice-item">
                        <h4>${item.title}</h4>
                        <p>${item.content.substring(0, 100)}...</p>
                        <div class="action-buttons no-print">
                            <button class="edit-btn" onclick="showNewsForm('${item.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="delete-btn" onclick="deleteNewsItem('${item.id}')" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`).join('') || '<p>No news items yet.</p>';

                mainContent.innerHTML += `<div class="page active">
                    <div class="card">
                        <div class="card-header"><h3>From the Director's Desk</h3></div>
                        <form id="principal-desk-form">
                            <div class="form-group">
                                <textarea id="principal-desk-content" rows="6" required>${siteContent.principalDesk || ''}</textarea>
                            </div>
                            <button type="submit" class="action-button inline">Save Changes</button>
                        </form>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>About Our College</h3></div>
                        <form id="about-school-form">
                            <div class="form-group">
                                <textarea id="about-school-content" rows="6" required>${siteContent.aboutSchool || ''}</textarea>
                            </div>
                            <button type="submit" class="action-button inline">Save Changes</button>
                        </form>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3>Latest News</h3>
                            <button class="action-button inline" onclick="showNewsForm()"><i class="fas fa-plus"></i> Add News</button>
                        </div>
                        <div id="news-items-list">${newsItemsHtml}</div>
                    </div>
                </div>`;
                
                getEl('principal-desk-form').onsubmit = e => {
                    e.preventDefault();
                    state.data.siteContent.principalDesk = getEl('principal-desk-content').value;
                    saveData();
                    showToast("Director's message updated!", 'success');
                };
                getEl('about-school-form').onsubmit = e => {
                    e.preventDefault();
                    state.data.siteContent.aboutSchool = getEl('about-school-content').value;
                    saveData();
                    showToast("About college content updated!", 'success');
                };
            }
            
            function renderSetTopperPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Set College Toppers');
                 mainContent.innerHTML += `<div class="page active">
                    <div class="card">
                        <div class="card-header"><h3>Set College Toppers Manually</h3></div>
                        <p>Manually select students to display as college toppers on the dashboard. If no students are selected, the system will automatically display the topper based on the latest exam marks.</p>
                        <div class="search-box-container" style="margin-top: 20px;">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="topper-lookup-input" oninput="lookupTopperStudent(this.value)" placeholder="Search student by name or admission no..." class="search-input">
                        </div>
                        <div id="topper-lookup-results"></div>
                        <hr style="border-color: var(--border-color); margin: 20px 0;">
                        <div id="current-toppers-display"></div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header"><h3>Upload Topper Photo</h3></div>
                        <p>Upload a specific photo to be shown in the "College Topper" section on the homepage. If no photo is uploaded, the student's own profile photo will be used.</p>
                        <form id="topper-photo-form" style="margin-top: 20px;">
                            <div class="form-group">
                                <label for="topper-photo-upload">Select Photo</label>
                                <input type="file" id="topper-photo-upload" accept="image/*">
                                <input type="hidden" id="topper-photo-base64" value="${state.data.siteContent.topperPhoto || ''}">
                            </div>
                            <div id="topper-photo-preview"></div>
                            <button type="submit" class="action-button inline">Save Topper Photo</button>
                             ${state.data.siteContent.topperPhoto ? `<button type="button" class="action-button secondary inline" onclick="removeTopperPhoto()">Remove Photo</button>` : ''}
                        </form>
                    </div>
                 </div>`;
                 displayCurrentManualToppers();
                 renderTopperPhotoPreview();

                getEl('topper-photo-upload').onchange = async (e) => { 
                    if (e.target.files[0]) {
                        getEl('topper-photo-base64').value = await fileToBase64(e.target.files[0]);
                        renderTopperPhotoPreview();
                    }
                };
                getEl('topper-photo-form').onsubmit = e => {
                    e.preventDefault();
                    state.data.siteContent.topperPhoto = getEl('topper-photo-base64').value;
                    saveData();
                    showToast('Topper photo updated!', 'success');
                    renderSetTopperPage();
                };
            }
            
             function renderTopperPhotoPreview() {
                const previewContainer = getEl('topper-photo-preview');
                const photoData = getEl('topper-photo-base64').value;
                if(photoData) {
                    previewContainer.innerHTML = `<img src="${photoData}" style="max-width: 150px; height: auto; border-radius: 8px; margin-bottom: 15px;">`;
                } else {
                    previewContainer.innerHTML = '';
                }
            }

            window.removeTopperPhoto = () => {
                state.data.siteContent.topperPhoto = '';
                saveData();
                showToast('Topper photo removed.', 'success');
                renderSetTopperPage();
            };

            function lookupTopperStudent(query) {
                const resultsContainer = getEl('topper-lookup-results');
                if (!resultsContainer) return;
                query = query.trim().toLowerCase();
                
                if (!query) {
                    resultsContainer.innerHTML = '';
                    return;
                }
                
                const existingTopperIds = state.data.siteContent.manualTopperStudentIds || [];
                const results = (state.data.students || []).filter(s => 
                        !existingTopperIds.includes(s.id) && 
                        ((s.name && s.name.toLowerCase().includes(query)) ||
                         (s.admissionNumber && s.admissionNumber.toLowerCase().includes(query)))
                    ).slice(0, 5);
                
                if (results.length === 0) {
                    resultsContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No students found or they are already in the topper list.</p>';
                } else {
                    resultsContainer.innerHTML = results.map(s => `
                        <div class="lookup-result-item">
                            <img src="${s.photo || `https://ui-avatars.com/api/?name=${s.name.replace(/\s/g, "+")}`}" alt="Photo">
                            <div style="flex-grow: 1;">
                                <strong>${s.name}</strong>
                                <p style="font-size: 0.9em; color: var(--text-muted);">${s.className || 'N/A'}</p>
                            </div>
                            <button class="action-button inline" onclick="addManualTopper('${s.id}')">Set as Topper</button>
                        </div>
                    `).join('');
                }
            }

            function addManualTopper(studentId) {
                if (!state.data.siteContent.manualTopperStudentIds.includes(studentId)) {
                    state.data.siteContent.manualTopperStudentIds.push(studentId);
                    saveData();
                    showToast("Student added to toppers list!", "success");
                    getEl('topper-lookup-input').value = '';
                    getEl('topper-lookup-results').innerHTML = '';
                    displayCurrentManualToppers();
                } else {
                     showToast("This student is already a topper.", "info");
                }
            }

            function removeManualTopper(studentId) {
                state.data.siteContent.manualTopperStudentIds = state.data.siteContent.manualTopperStudentIds.filter(id => id !== studentId);
                saveData();
                showToast("Topper removed from the manual list.", "info");
                displayCurrentManualToppers();
            }
            
            function displayCurrentManualToppers() {
                const container = getEl('current-toppers-display');
                if(!container) return;

                const topperIds = state.data.siteContent.manualTopperStudentIds;
                if(topperIds && topperIds.length > 0) {
                    let toppersHtml = '<h4>Current Manual Toppers:</h4>';
                    topperIds.forEach(topperId => {
                         const student = findById('students', topperId);
                         if(student) {
                             toppersHtml += `
                                <div class="lookup-result-item">
                                    <img src="${student.photo || `https://ui-avatars.com/api/?name=${student.name.replace(/\s/g, "+")}`}" alt="Photo">
                                    <div style="flex-grow: 1;">
                                        <strong>${student.name}</strong>
                                        <p style="font-size: 0.9em; color: var(--text-muted);">${student.className || 'N/A'}</p>
                                    </div>
                                    <button class="action-button secondary" onclick="removeManualTopper('${student.id}')">Remove</button>
                                </div>`;
                         }
                    });
                     container.innerHTML = toppersHtml;
                } else {
                     container.innerHTML = '<p style="color: var(--text-muted);">No manual toppers selected. Auto-selection is active.</p>';
                }
            }

            window.showNewsForm = (id = null) => {
                const newsItem = id ? (state.data.siteContent.latestNews || []).find(n => n.id == id) : {};
                const title = id ? 'Edit News Item' : 'Add New News Item';
                const formContent = `<form id="news-form">
                    <input type="hidden" id="news-id" value="${newsItem.id || ''}">
                    <div class="form-group"><label for="news-title">Title</label><input type="text" id="news-title" value="${newsItem.title || ''}" required></div>
                    <div class="form-group"><label for="news-content">Content</label><textarea id="news-content" rows="5" required>${newsItem.content || ''}</textarea></div>
                    <button type="submit" class="action-button">${id ? 'Save Changes' : 'Add News'}</button>
                </form>`;
                showModal(title, formContent);
                getEl('news-form').onsubmit = e => {
                    e.preventDefault();
                    const newsId = getEl('news-id').value || Date.now();
                    const newsData = { id: newsId, title: getEl('news-title').value, content: getEl('news-content').value };
                    
                    if (!state.data.siteContent.latestNews) state.data.siteContent.latestNews = [];
                    const index = state.data.siteContent.latestNews.findIndex(n => n.id == newsId);
                    if (index > -1) {
                        state.data.siteContent.latestNews[index] = newsData;
                    } else {
                        state.data.siteContent.latestNews.push(newsData);
                    }
                    saveData();
                    showToast(`News item ${id ? 'updated' : 'added'}!`, 'success');
                    closeModal();
                    renderContentSettingsPage();
                };
            };
            
            window.deleteNewsItem = (id) => {
                if(confirm('Are you sure you want to delete this news item?')) {
                    state.data.siteContent.latestNews = (state.data.siteContent.latestNews || []).filter(item => item.id != id);
                    saveData();
                    showToast('News item deleted.', 'success');
                    renderContentSettingsPage();
                }
            };


            function renderDataSettingsPage() { 
                const mainContent = getEl('main-content'); 
                mainContent.innerHTML = renderHeader('Data Management'); 
                mainContent.innerHTML += `<div class="page active"><div class="card"><div class="card-header"><h3>Export Data</h3></div><p>Download all application data as a single JSON file.</p><button id="export-data-btn" class="action-button inline" style="margin-top:15px;"><i class="fas fa-download"></i> Export Data</button></div><div class="card"><div class="card-header"><h3>Import Data</h3></div><p><strong>Warning:</strong> This will overwrite all current data.</p><input type="file" id="import-data-input" accept=".json" style="margin-top:15px;"><button id="import-data-btn" class="action-button inline"><i class="fas fa-upload"></i> Import Data</button></div><div class="card" style="border: 2px solid var(--error-color);"><div class="card-header"><h3>Reset Application</h3></div><p><strong>DANGER:</strong> This will delete everything.</p><button id="reset-app-btn" class="action-button inline" style="background: var(--error-color); margin-top:15px;"><i class="fas fa-bomb"></i> Reset All Data</button></div></div>`; 
                getEl('export-data-btn').onclick = () => { 
                    const dataStr = JSON.stringify(state.data); 
                    const dataBlob = new Blob([dataStr], {type: "application/json"}); 
                    const url = URL.createObjectURL(dataBlob); 
                    const a = document.createElement('a'); a.href = url; 
                    a.download = `sms-backup-${new Date().toISOString().slice(0,10)}.json`; 
                    a.click(); 
                    URL.revokeObjectURL(url); 
                    showToast('Data exported!', 'success'); 
                }; 
                getEl('import-data-btn').onclick = () => { 
                    const fileInput = getEl('import-data-input'); 
                    if (fileInput.files.length === 0) return showToast('Please select a backup file first.', 'info'); 
                    if (confirm('Are you sure you want to import data? This will overwrite all current data and cannot be undone.')) { 
                        const file = fileInput.files[0]; 
                        const reader = new FileReader(); 
                        reader.onload = e => { 
                            try { 
                                const importedData = JSON.parse(e.target.result); 
                                if(importedData.students) { 
                                    state.data = importedData; 
                                    saveData(); 
                                    showToast('Data imported successfully! The application will now reload.', 'success'); 
                                    setTimeout(() => location.reload(), 1500); 
                                } else { 
                                    showToast('Invalid backup file format.', 'error'); 
                                } 
                            } catch (err) { 
                                showToast('Error reading the backup file. It may be corrupted.', 'error'); 
                            } 
                        }; 
                        reader.readAsText(file); 
                    } 
                }; 
                getEl('reset-app-btn').onclick = () => { 
                    if(confirm('DANGER! This will permanently delete ALL data. This action cannot be undone. Are you absolutely sure?')) { 
                        if(prompt('To confirm this irreversible action, please type "DELETE" in the box below.') === 'DELETE') { 
                            localStorage.clear(); 
                            showToast('Application has been reset. Reloading now...', 'info'); 
                            setTimeout(() => location.reload(), 1500); 
                        } else { 
                            showToast('Reset cancelled.', 'info'); 
                        } 
                    } 
                }; 
            }
            
            function renderPromoteStudentsPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Promote Students');
                const courseOptionsHTML = courseOptionsList.map(c => `<option value="${c}">${c}</option>`).join('');
                mainContent.innerHTML += `
                    <div class="page active">
                        <div class="card">
                            <div class="card-header"><h3>Student Promotion Tool</h3></div>
                             <p>This tool promotes students to the next semester within the same course. You can also change a student's course from their profile page.</p>
                            <div class="form-group" style="margin-top:20px;">
                                <label for="promote-from-class">Select Course</label>
                                <select id="promote-from-class" onchange="renderPromotionStudentList()"><option value="">Select a course</option>${courseOptionsHTML}</select>
                            </div>
                                                        <div id="promotion-student-list" style="margin-top: 20px;"></div>
                        </div>
                    </div>`;
            }
            function renderPromotionStudentList() {
                const container = getEl('promotion-student-list');
                const courseName = getEl('promote-from-class').value;
                container.innerHTML = '';
                if (!courseName) return;

                const studentsInCourse = (state.data.students || []).filter(s => s.className === courseName);
                if (studentsInCourse.length === 0) {
                    container.innerHTML = '<p>No students found in this course.</p>';
                    return;
                }
                
                const maxSemesters = courseDetails[courseName].semesters;
                let semesterGroups = {};
                for(let i=1; i<=maxSemesters; i++){
                    semesterGroups[i] = [];
                }
                studentsInCourse.forEach(s => {
                    const sem = s.currentSemester || 1;
                    if(semesterGroups[sem]) {
                        semesterGroups[sem].push(s);
                    }
                });

                let listHtml = '';
                for(let sem=1; sem < maxSemesters; sem++) {
                    if(semesterGroups[sem].length > 0) {
                        listHtml += `
                        <div class="card">
                            <div class="card-header"><h4>Semester ${sem} Students</h4></div>
                            <div class="table-container">
                                <table>
                                    <thead><tr><th><input type="checkbox" onchange="toggleAllPromotionCheckboxes(this.checked, ${sem})"></th><th>Name</th><th>Admission No.</th></tr></thead>
                                    <tbody>
                                        ${semesterGroups[sem].map(s => `<tr><td><input type="checkbox" class="promotion-checkbox-sem-${sem}" value="${s.id}"></td><td>${s.name}</td><td>${s.admissionNumber}</td></tr>`).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <button class="action-button" style="margin-top: 20px;" onclick="handleStudentPromotion(${sem})">Promote Selected to Semester ${sem+1}</button>
                        </div>
                        `;
                    }
                }
                 if(semesterGroups[maxSemesters].length > 0) {
                     listHtml += `<div class="card"><div class="card-header"><h4>Semester ${maxSemesters} Students (Course Completed)</h4></div><p>These students have completed all semesters.</p></div>`
                 }

                container.innerHTML = listHtml || '<p>No students to promote in this course.</p>';
            }
            window.toggleAllPromotionCheckboxes = (checked, sem) => {
                document.querySelectorAll(`.promotion-checkbox-sem-${sem}`).forEach(cb => cb.checked = checked);
            }
            function handleStudentPromotion(fromSemester) {
                const toSemester = fromSemester + 1;
                
                const selectedStudentIds = Array.from(document.querySelectorAll(`.promotion-checkbox-sem-${fromSemester}:checked`)).map(cb => cb.value);
                if (selectedStudentIds.length === 0) {
                    return showToast('Please select at least one student to promote.', 'error');
                }
                
                let promotedCount = 0;
                selectedStudentIds.forEach(id => {
                    const student = findById('students', id);
                    if(student) {
                        student.currentSemester = toSemester;
                        updateOrAddItem('students', student);
                        promotedCount++;
                    }
                });
                saveData();
                
                if (promotedCount > 0) {
                    showToast(`${promotedCount} student(s) promoted to Semester ${toSemester} successfully!`, 'success');
                    renderPromotionStudentList();
                }
            }

            function renderMarksheetManagerPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Grade Sheet Manager');

                const examOptions = (state.data.examMasters || []).sort((a,b) => b.id - a.id).map(ex => `<option value="${ex.id}">${ex.name}</option>`).join('');
                const courseOptionsHTML = courseOptionsList.map(c => `<option value="${c}">${c}</option>`).join('');

                mainContent.innerHTML += `<div class="page active"><div class="card">
                    <div class="card-header"><h3>Enter Student Grades</h3></div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="marks-exam-select">Select Exam</label>
                            <select id="marks-exam-select" onchange="renderMarksEntryTable()">
                                <option value="">Select Exam</option>${examOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="marks-class-select">Select Course</label>
                            <select id="marks-class-select" onchange="renderMarksEntryTable()">
                                <option value="">Select Course</option>${courseOptionsHTML}
                            </select>
                        </div>
                    </div>
                    <form id="marks-entry-form"><div id="marks-entry-table-container"></div></form>
                </div></div>`;
            }

            function renderMarksEntryTable() {
                const container = getEl('marks-entry-table-container');
                const examMasterId = getEl('marks-exam-select').value;
                const courseName = getEl('marks-class-select').value;

                container.innerHTML = '';
                if (!examMasterId || !courseName) {
                    container.innerHTML = '<p style="text-align:center; color:var(--text-muted); margin-top:20px;">Please select an exam and a course to enter grades.</p>';
                    return;
                }
                
                const studentsInCourse = (state.data.students || []).filter(s => s.className === courseName);
                const subjectsForCourse = (state.data.examSchedules || []).filter(sch => sch.examMasterId === examMasterId && sch.className === courseName);

                if (studentsInCourse.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color:var(--error-color); margin-top:20px;">No students found in the selected course.</p>';
                    return;
                }
                if (subjectsForCourse.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color:var(--error-color); margin-top:20px;">No subjects scheduled for this course in the selected exam.</p>';
                    return;
                }
                
                const gradeOptions = ['O', 'A+', 'A', 'B+', 'B', 'C', 'P', 'F', 'Ab'].map(g => `<option value="${g}">${g}</option>`).join('');

                let tableHtml = `<div class="table-container" style="margin-top:20px;"><table id="marks-table"><thead>
                                <tr>
                                    <th>Student Name</th>`;
                subjectsForCourse.forEach(sub => {
                    tableHtml += `<th>${sub.subject}<br><small>(${sub.paperCode})</small></th>`;
                });
                tableHtml += `<th>Co-Curricular (Grade)</th>`; // New column
                tableHtml += `</tr></thead><tbody>`;

                const marksForExam = state.data.marks[examMasterId] || {};
                const coCurricularData = state.data.coCurricular || [];

                studentsInCourse.sort((a,b) => a.rollNumber.localeCompare(b.rollNumber)).forEach(student => {
                    const studentMarks = marksForExam[student.id] || [];
                    const studentCoCurricular = coCurricularData.find(cc => cc.studentId === student.id && cc.examMasterId === examMasterId) || {};

                    tableHtml += `<tr><td>${student.name}<br><small>Roll: ${student.rollNumber}</small></td>`;
                    subjectsForCourse.forEach(subject => {
                        const mark = studentMarks.find(m => m.paperCode === subject.paperCode) || {};
                        tableHtml += `
                            <td>
                                <select class="mark-input" data-student-id="${student.id}" data-paper-code="${subject.paperCode}" style="width: 80px;">
                                    <option value="" ${!mark.grade ? 'selected' : ''}>-</option>
                                    ${['O', 'A+', 'A', 'B+', 'B', 'C', 'P', 'F', 'Ab'].map(g => `<option value="${g}" ${mark.grade === g ? 'selected' : ''}>${g}</option>`).join('')}
                                </select>
                            </td>
                        `;
                    });
                    
                    tableHtml += `<td><input type="text" class="co-curricular-input" data-student-id="${student.id}" value="${studentCoCurricular.grade || ''}" placeholder="e.g., B" style="width: 80px;"></td>`;

                    tableHtml += `</tr>`;
                });

                tableHtml += `</tbody></table></div><button type="submit" class="action-button" style="margin-top:20px;">Save All Grades</button>`;
                container.innerHTML = tableHtml;
                
                getEl('marks-entry-form').onsubmit = handleSaveMarks;
            }

            function handleSaveMarks(e) {
                e.preventDefault();
                const examMasterId = getEl('marks-exam-select').value;
                const courseName = getEl('marks-class-select').value;
                if (!examMasterId || !courseName) return;

                if (!state.data.marks[examMasterId]) {
                    state.data.marks[examMasterId] = {};
                }
                
                const allMarkInputs = document.querySelectorAll('.mark-input');
                const allCoCurricularInputs = document.querySelectorAll('.co-curricular-input');
                const marksByStudent = {};
                const subjectsForCourse = (state.data.examSchedules || []).filter(sch => sch.examMasterId === examMasterId && sch.className === courseName);

                allMarkInputs.forEach(input => {
                    const { studentId, paperCode } = input.dataset;
                    const grade = input.value;
                    const subjectInfo = subjectsForCourse.find(s => s.paperCode === paperCode);

                    if (grade && subjectInfo) {
                        if (!marksByStudent[studentId]) marksByStudent[studentId] = [];
                        
                        marksByStudent[studentId].push({
                            paperCode: paperCode,
                            subject: subjectInfo.subject,
                            credits: subjectInfo.credits,
                            grade: grade
                        });
                    }
                });
                
                for (const studentId in marksByStudent) {
                    state.data.marks[examMasterId][studentId] = marksByStudent[studentId];
                }

                allCoCurricularInputs.forEach(input => {
                    const studentId = input.dataset.studentId;
                    const grade = input.value.trim();
                    const existingIndex = (state.data.coCurricular || []).findIndex(cc => cc.studentId === studentId && cc.examMasterId === examMasterId);
                    
                    if (grade) {
                        const coCurricularEntry = {
                            studentId,
                            examMasterId,
                            paperCode: 'CC-2',
                            subject: 'FIRST AID AND HEALTH',
                            grade,
                        };
                        if (existingIndex > -1) {
                            state.data.coCurricular[existingIndex] = coCurricularEntry;
                        } else {
                            state.data.coCurricular.push(coCurricularEntry);
                        }
                    } else if (existingIndex > -1) {
                        state.data.coCurricular.splice(existingIndex, 1);
                    }
                });
                
                saveData();
                showToast('Grades saved successfully!', 'success');
            }
            
            function renderHomeworkPage() {
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="showHomeworkForm()"><i class="fas fa-plus"></i> Add Homework</button>`;
                mainContent.innerHTML = renderHeader('Homework Management', actionsHtml);

                const courseOptionsHTML = courseOptionsList.map(c => `<option value="${c}">${c}</option>`).join('');

                mainContent.innerHTML += `<div class="page active">
                    <div class="card">
                         <div class="form-grid">
                            <div class="form-group">
                                <label for="homework-class-filter">Filter by Course</label>
                                <select id="homework-class-filter" onchange="renderHomeworkTable()">
                                    <option value="all">Show All</option>
                                    ${courseOptionsHTML}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="homework-semester-filter">Filter by Semester</label>
                                <select id="homework-semester-filter" onchange="renderHomeworkTable()">
                                    <option value="all">All Semesters</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container"><table id="homework-table"></table></div>
                    </div>
                </div>`;
                
                getEl('homework-class-filter').onchange = () => {
                    updateSemesterDropdown(getEl('homework-class-filter').value, 'homework-semester-filter', 'all');
                    renderHomeworkTable();
                };

                renderHomeworkTable();
            }

            function renderHomeworkTable() {
                const table = getEl('homework-table');
                if (!table) return;

                const selectedClass = getEl('homework-class-filter').value;
                const selectedSemester = getEl('homework-semester-filter').value;

                let homeworkList = state.data.homework || [];

                if (selectedClass !== 'all') {
                    homeworkList = homeworkList.filter(h => h.className === selectedClass);
                }
                if (selectedSemester !== 'all') {
                    homeworkList = homeworkList.filter(h => h.semester == selectedSemester);
                }

                let html = `<thead><tr><th>Course</th><th>Semester</th><th>Subject</th><th>Title</th><th>Due Date</th><th>Actions</th></tr></thead><tbody>`;
                if (homeworkList.length === 0) {
                    html += `<tr><td colspan="6" style="text-align:center;">No homework found.</td></tr>`;
                } else {
                    homeworkList.sort((a, b) => new Date(b.dueDate) - new Date(a.dueDate)).forEach(h => {
                        html += `<tr>
                            <td>${h.className}</td>
                            <td>${h.semester}</td>
                            <td>${h.subject}</td>
                            <td>${h.title}</td>
                            <td>${new Date(h.dueDate).toLocaleDateString()}</td>
                            <td class="action-buttons">
                                <button class="edit-btn" onclick="showHomeworkForm('${h.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn" onclick="deleteItem('homework', '${h.id}', 'Delete this homework?', renderHomeworkTable)" title="Delete"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    });
                }
                html += `</tbody>`;
                table.innerHTML = html;
            }

                        function showHomeworkForm(id = null) {
                const homework = id ? findById('homework', id) : {};
                const title = id ? 'Edit Homework' : 'Add New Homework';

                const courseOptionsHTML = courseOptionsList.map(c => `<option value="${c}" ${homework.className === c ? 'selected' : ''}>${c}</option>`).join('');
                
                let semesterOptionsHTML = '';
                if(homework.className && courseDetails[homework.className]) {
                     for(let i=1; i<=courseDetails[homework.className].semesters; i++) {
                        semesterOptionsHTML += `<option value="${i}" ${homework.semester == i ? 'selected' : ''}>Semester ${i}</option>`;
                    }
                }

                const formContent = `<form id="homework-form">
                    <input type="hidden" id="homework-id" value="${homework.id || ''}">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="homework-class">Course</label>
                            <select id="homework-class" required onchange="updateSemesterDropdown(this.value, 'homework-semester')">${courseOptionsHTML}</select>
                        </div>
                        <div class="form-group">
                            <label for="homework-semester">Semester</label>
                            <select id="homework-semester" required>${semesterOptionsHTML}</select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="homework-subject">Subject</label>
                        <input type="text" id="homework-subject" value="${homework.subject || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="homework-title">Title</label>
                        <input type="text" id="homework-title" value="${homework.title || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="homework-description">Description</label>
                        <textarea id="homework-description" rows="4" required>${homework.description || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="homework-due-date">Due Date</label>
                        <input type="date" id="homework-due-date" value="${homework.dueDate || new Date().toISOString().slice(0, 10)}" required>
                    </div>
                    <button type="submit" class="action-button">${id ? 'Save Changes' : 'Add Homework'}</button>
                </form>`;
                showModal(title, formContent);
                getEl('homework-form').onsubmit = (e) => {
                    e.preventDefault();
                    const homeworkData = {
                        id: getEl('homework-id').value || Date.now().toString(),
                        className: getEl('homework-class').value,
                        semester: parseInt(getEl('homework-semester').value),
                        subject: getEl('homework-subject').value,
                        title: getEl('homework-title').value,
                        description: getEl('homework-description').value,
                        dueDate: getEl('homework-due-date').value,
                    };
                    updateOrAddItem('homework', homeworkData);
                    showToast(`Homework ${id ? 'updated' : 'added'}!`, 'success');
                    closeModal();
                    renderHomeworkTable();
                };
            }
            
            function renderStudentHomeworkView() {
                const user = state.loggedInUser;
                const student = user.role === 'parent' ? findById('students', user.studentId) : user;
                if (!student) return;

                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('My Homework');

                const homeworkList = (state.data.homework || [])
                    .filter(h => h.className === student.className && h.semester === student.currentSemester)
                    .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

                let homeworkHtml = '';
                if (homeworkList.length === 0) {
                    homeworkHtml = '<div class="card"><p>No homework assigned for your current semester yet.</p></div>';
                } else {
                    homeworkHtml = homeworkList.map(h => `
                        <div class="card">
                            <div class="card-header">
                                <h3>${h.title}</h3>
                                <span style="color: var(--text-muted);">Due: ${new Date(h.dueDate).toLocaleDateString()}</span>
                            </div>
                            <p><strong>Subject:</strong> ${h.subject}</p>
                            <p style="margin-top: 10px; white-space: pre-wrap;">${h.description}</p>
                        </div>
                    `).join('');
                }

                mainContent.innerHTML += `<div class="page active">${homeworkHtml}</div>`;
            }

            function renderPublicProfileSearchPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Find Profile');

                mainContent.innerHTML += `<div class="page active"><div class="card">
                        <div class="card-header"><h3>Find Member Profile</h3></div>
                        <p>Enter the ID and Date of Birth to view the profile of a student, teacher, or staff member.</p>
                        <form id="find-public-profile-form" style="margin-top:20px;">
                             <div class="form-group">
                                <label for="profile-type">Select Member Type</label>
                                <select id="profile-type" required>
                                    <option value="student">Student</option>
                                    <option value="teacher">Teacher</option>
                                    <option value="staff">Staff</option>
                                </select>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="profile-id-number">Roll No / Employee ID</label>
                                    <input type="text" id="profile-id-number" placeholder="Enter ID" required>
                                </div>
                                <div class="form-group">
                                    <label for="profile-dob">Date of Birth</label>
                                    <input type="date" id="profile-dob" placeholder="YYYY-MM-DD" required>
                                </div>
                            </div>
                            <button type="submit" class="action-button inline">Find Profile</button>
                        </form>
                        <div id="public-profile-display-area" style="margin-top:30px;"></div>
                    </div></div>`;

                getEl('find-public-profile-form').onsubmit = (e) => {
                    e.preventDefault();
                    handleFindPublicProfile();
                };
            }
            
            function handleFindPublicProfile() {
                const memberType = getEl('profile-type').value;
                const idNumber = getEl('profile-id-number').value.trim().toLowerCase();
                const dob = getEl('profile-dob').value;
                const resultArea = getEl('public-profile-display-area');
                resultArea.innerHTML = '';

                let member = null;
                if (memberType === 'student') {
                    member = (state.data.students || []).find(s => s.rollNumber && s.rollNumber.toLowerCase() === idNumber && s.dob === dob);
                } else if (memberType === 'teacher') {
                    member = (state.data.teachers || []).find(t => t.employeeId && t.employeeId.toLowerCase() === idNumber && t.dob === dob);
                } else if (memberType === 'staff') {
                    member = (state.data.staff || []).find(s => s.employeeId && s.employeeId.toLowerCase() === idNumber && s.dob === dob);
                }

                if (member) {
                    resultArea.innerHTML = getPublicProfileHtml(member, memberType);
                } else {
                    resultArea.innerHTML = `<p class="form-feedback error">No member found with these details. Please check the ID and Date of Birth.</p>`;
                }
            }

            function getPublicProfileHtml(member, type) {
                const signatureDoc = (member.documents || []).find(doc => doc.name && doc.name.toLowerCase().includes('signature'));
                let detailsHtml = '';

                if (type === 'student') {
                    detailsHtml = `
                        <li><i class="fas fa-id-card"></i> Adm No: ${member.admissionNumber || 'N/A'}</li>
                        <li><i class="fas fa-hashtag"></i> Roll No: ${member.rollNumber || 'N/A'}</li>
                        <li><i class="fas fa-school"></i> ${member.className} (Semester ${member.currentSemester || 1})</li>
                        <li><i class="fas fa-user-tie"></i> Father: ${member.fatherName || 'N/A'}</li>
                    `;
                } else {
                    detailsHtml = `
                        <li><i class="fas fa-id-card"></i> Employee ID: ${member.employeeId || 'N/A'}</li>
                        <li><i class="fas fa-briefcase"></i> Role: ${member.role || 'N/A'}</li>
                        <li><i class="fas fa-phone"></i> Contact: ${member.contact || 'N/A'}</li>
                    `;
                }

                return `
                    <div class="card profile-card" style="max-width: 500px; margin: auto;">
                        <img class="profile-photo" src="${member.photo || `https://ui-avatars.com/api/?name=${member.name.replace(/\s/g, "+")}`}" alt="Photo">
                        ${signatureDoc ? `<img src="${signatureDoc.data}" alt="Signature" style="display:block; margin: -10px auto 15px; height: 40px; max-width: 150px; object-fit: contain;">` : ''}
                        <h2 style="text-align: center;">${member.name}</h2>
                        <ul class="profile-details">${detailsHtml}</ul>
                    </div>`;
            }

            function renderSchoolInfoSettingsPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('College Information');
                const schoolInfo = state.data.siteContent;

                mainContent.innerHTML += `<div class="page active">
                    <div class="card">
                        <div class="card-header"><h3>College Information (Fixed)</h3></div>
                        <p>This information is fixed and cannot be edited from this panel.</p>
                         <div class="detail-list" style="margin-top:20px;">
                            <li><span>College Name</span><strong>${schoolInfo.schoolName}</strong></li>
                            <li><span>Address</span><strong>${schoolInfo.schoolAddress}</strong></li>
                            <li><span>Contact</span><strong>${schoolInfo.schoolContact}</strong></li>
                            <li><span>Email</span><strong>${schoolInfo.schoolEmail}</strong></li>
                            <li><span>Founded</span><strong>${schoolInfo.schoolFounded}</strong></li>
                        </div>
                    </div>
                     <div class="card">
                        <div class="card-header"><h3>Update Other Information</h3></div>
                        <form id="school-info-form" style="margin-top:20px;">
                            <div class="form-group">
                                <label for="school-upi">UPI ID (for Fee Payment QR)</label>
                                <input type="text" id="school-upi" value="${schoolInfo.schoolUpiId || ''}" placeholder="your-upi-id@okhdfcbank">
                            </div>
                            <button type="submit" class="action-button inline">Save Changes</button>
                        </form>
                    </div>
                </div>`;

                getEl('school-info-form').onsubmit = e => {
                    e.preventDefault();
                    state.data.siteContent.schoolUpiId = getEl('school-upi').value;
                    saveData();
                    showToast("Other information updated successfully!", "success");
                    renderUI(); 
                };
            }
            
            function renderManageLinksPage() {
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="showLinkForm()"><i class="fas fa-plus"></i> Add Link</button>`;
                mainContent.innerHTML = renderHeader('Manage External Links', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card"><div id="links-list"></div></div></div>`;
                renderLinksList();
            }

            function renderLinksList() {
                const container = getEl('links-list');
                if(!container) return;
                const links = state.data.externalLinks || [];
                if(links.length === 0) {
                    container.innerHTML = '<p>No external links added yet.</p>';
                    return;
                }
                let html = '<ul class="detail-list">';
                links.forEach(link => {
                    html += `<li><span><strong>${link.title}</strong><br><small>${link.url}</small></span>
                    <div class="action-buttons"><button class="edit-btn" onclick="showLinkForm('${link.id}')"><i class="fas fa-edit"></i></button><button class="delete-btn" onclick="deleteItem('externalLinks', '${link.id}', 'Delete this link?', renderLinksList)"><i class="fas fa-trash"></i></button></div>
                    </li>`;
                });
                html += '</ul>';
                container.innerHTML = html;
            }

            function showLinkForm(id=null){
                 const link = id ? findById('externalLinks', id) : {};
                 const title = id ? 'Edit Link' : 'Add New Link';
                 const formContent = `<form id="link-form">
                    <input type="hidden" id="link-id" value="${link.id || ''}">
                    <div class="form-group"><label for="link-title">Link Title</label><input type="text" id="link-title" value="${link.title || ''}" required></div>
                    <div class="form-group"><label for="link-url">URL</label><input type="url" id="link-url" value="${link.url || ''}" required></div>
                    <button type="submit" class="action-button">${id ? 'Save Changes' : 'Add Link'}</button>
                 </form>`;
                 showModal(title, formContent);
                 getEl('link-form').onsubmit = e => {
                    e.preventDefault();
                    const linkData = {
                        id: getEl('link-id').value || Date.now().toString(),
                        title: getEl('link-title').value,
                        url: getEl('link-url').value
                    };
                    updateOrAddItem('externalLinks', linkData);
                    showToast('Link saved!', 'success');
                    closeModal();
                    renderLinksList();
                    renderSidebar();
                 };
            }

            function renderSchoolPhotosSettingsPage() {
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="showSchoolPhotoForm()"><i class="fas fa-plus"></i> Add Photo</button>`;
                mainContent.innerHTML = renderHeader('Manage College Photos', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card"><div id="school-photos-list" class="school-photos-container"></div></div></div>`;
                renderSchoolPhotosList();
            }

            function renderSchoolPhotosList() {
                const container = getEl('school-photos-list');
                if (!container) return;
                const photos = state.data.schoolPhotos || [];
                if (photos.length === 0) {
                    container.innerHTML = `<p style="text-align:center; color: var(--text-muted);">No college photos uploaded yet. Click 'Add Photo' to start.</p>`;
                    return;
                }
                container.innerHTML = photos.map(photo => `
                    <div class="school-photo-item card">
                        <img src="${photo.image}" alt="${photo.title}">
                        <div class="gallery-item-footer">
                            <span>${photo.title}</span>
                            <button class="delete-btn" onclick="deleteItem('schoolPhotos', '${photo.id}', 'Delete this photo?', renderSchoolPhotosList)" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `).join('');
            }

            function showSchoolPhotoForm() {
                const title = 'Add College Photo';
                const formContent = `<form id="school-photo-form">
                        <div class="form-group"><label for="school-photo-title">Photo Title</label><input type="text" id="school-photo-title" required></div>
                        <div class="form-group"><label for="school-photo-image">Select Image</label><input type="file" id="school-photo-image" accept="image/*" required></div>
                        <button type="submit" class="action-button">Upload Photo</button>
                    </form>`;
                showModal(title, formContent);
                getEl('school-photo-form').onsubmit = async e => {
                    e.preventDefault();
                    const imageFile = getEl('school-photo-image').files[0];
                    if (!imageFile) return;
                    const photoData = {
                        id: Date.now().toString(),
                        title: getEl('school-photo-title').value,
                        image: await fileToBase64(imageFile)
                    };
                    updateOrAddItem('schoolPhotos', photoData);
                    showToast('College photo added!', 'success');
                    closeModal();
                    renderSchoolPhotosList();
                };
            }

            function renderPlacementSettingsPage() {
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="showPlacementForm()"><i class="fas fa-plus"></i> Add Company</button>`;
                mainContent.innerHTML = renderHeader('Manage Placement Logos', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card"><div id="placements-list" class="placements-grid"></div></div></div>`;
                renderPlacementsList();
            }
            
            function renderPlacementsList() {
                const container = getEl('placements-list');
                if (!container) return;
                const placements = state.data.placements || [];
                if (placements.length === 0) {
                    container.innerHTML = `<p style="text-align:center; color: var(--text-muted);">No placement logos added yet.</p>`;
                    return;
                }
                container.innerHTML = placements.map(item => `
                    <div class="placement-item card">
                        <img src="${item.logo}" alt="${item.name}">
                        <div class="item-footer">
                            <span>${item.name}</span>
                            <button class="delete-btn" onclick="deleteItem('placements', '${item.id}', 'Delete this company logo?', renderPlacementsList)" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `).join('');
            }

            function showPlacementForm() {
                const title = 'Add Placement Company';
                const formContent = `<form id="placement-form">
                        <div class="form-group"><label for="placement-name">Company Name</label><input type="text" id="placement-name" required></div>
                        <div class="form-group"><label for="placement-logo">Select Logo</label><input type="file" id="placement-logo" accept="image/*" required></div>
                        <button type="submit" class="action-button">Upload Logo</button>
                    </form>`;
                showModal(title, formContent);
                getEl('placement-form').onsubmit = async e => {
                    e.preventDefault();
                    const logoFile = getEl('placement-logo').files[0];
                    if (!logoFile) return;
                    const placementData = {
                        id: "pl" + Date.now().toString(),
                        name: getEl('placement-name').value,
                        logo: await fileToBase64(logoFile)
                    };
                    updateOrAddItem('placements', placementData);
                    showToast('Placement logo added!', 'success');
                    closeModal();
                    renderPlacementsList();
                };
            }


            function renderUploadResultPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Upload Student Result');
                
                const courseOptionsHTML = courseOptionsList.map(c => `<option value="${c}">${c}</option>`).join('');

                mainContent.innerHTML += `<div class="page active">
                    <div class="card">
                        <div class="card-header"><h3>Select Course to Upload Results</h3></div>
                        <div class="form-group">
                            <label for="upload-result-class-select">Select Course</label>
                            <select id="upload-result-class-select">
                                <option value="">-- Select a Course --</option>
                                ${courseOptionsHTML}
                            </select>
                        </div>
                    </div>
                    <div id="result-upload-form-container"></div>
                </div>`;
                
                getEl('upload-result-class-select').onchange = (e) => showResultUploadFormForClass(e.target.value);
            }
            
            function showResultUploadFormForClass(courseName) {
                const container = getEl('result-upload-form-container');
                if(!courseName) {
                    container.innerHTML = '';
                    return;
                }
                
                const examOptions = (state.data.examMasters || []).sort((a,b) => b.id - a.id).map(ex => `<option value="${ex.id}">${ex.name}</option>`).join('');
                
                container.innerHTML = `<div class="card">
                     <form id="result-upload-form">
                        <h4>Uploading Results for: <strong>${courseName}</strong></h4>
                        <div class="form-group" style="margin-top: 20px;">
                            <label for="result-upload-exam">Select Exam</label>
                            <select id="result-upload-exam" required><option value="">--Select an Exam--</option>${examOptions}</select>
                        </div>
                        <div id="result-upload-subjects-container"></div>
                        <button type="submit" class="action-button" style="margin-top:20px; display: none;">Save All Grades</button>
                    </form>
                </div>`;
                
                getEl('result-upload-exam').onchange = () => {
                    renderResultSubjectsForClass(courseName);
                };
                
                getEl('result-upload-form').onsubmit = (e) => {
                    e.preventDefault();
                    handleSaveUploadedResultForClass(courseName);
                };
            }
            
            function renderResultSubjectsForClass(courseName) {
                const container = getEl('result-upload-subjects-container');
                const examMasterId = getEl('result-upload-exam').value;
                 if (!examMasterId) {
                    container.innerHTML = '';
                    getEl('result-upload-form').querySelector('button[type="submit"]').style.display = 'none';
                    return;
                }
                
                const studentsInCourse = (state.data.students || []).filter(s => s.className === courseName);
                const subjectsForCourse = (state.data.examSchedules || []).filter(sch => sch.examMasterId === examMasterId && sch.className === courseName);

                if(studentsInCourse.length === 0) {
                    container.innerHTML = '<p class="form-feedback error">No students found in this course.</p>';
                    getEl('result-upload-form').querySelector('button[type="submit"]').style.display = 'none';
                    return;
                }
                 if(subjectsForCourse.length === 0) {
                    container.innerHTML = '<p class="form-feedback error">No subjects are scheduled for this course in the selected exam. Please add subjects in the Exams section first.</p>';
                    getEl('result-upload-form').querySelector('button[type="submit"]').style.display = 'none';
                    return;
                }
                
                getEl('result-upload-form').querySelector('button[type="submit"]').style.display = 'block';
                
                let tableHtml = `<div class="table-container" style="margin-top:20px;"><table id="result-upload-marks-table"><thead>
                                <tr>
                                    <th class="sticky-col">Student Name</th>`;
                subjectsForCourse.forEach(sub => {
                    tableHtml += `<th>${sub.subject}<br><small>(${sub.paperCode})</small></th>`;
                });
                tableHtml += `<th>Co-Curricular Grade</th>`;
                tableHtml += `</tr></thead><tbody>`;

                const marksForExam = state.data.marks[examMasterId] || {};
                const coCurricularDataForExam = state.data.coCurricular || [];

                studentsInCourse.sort((a,b) => a.rollNumber.localeCompare(b.rollNumber)).forEach(student => {
                    const studentMarks = marksForExam[student.id] || [];
                    const coCurricularMark = coCurricularDataForExam.find(c => c.studentId === student.id && c.examMasterId === examMasterId) || {};
                    tableHtml += `<tr><td class="sticky-col">${student.name}<br><small>Roll: ${student.rollNumber}</small></td>`;
                    subjectsForCourse.forEach(subject => {
                        const mark = studentMarks.find(m => m.paperCode === subject.paperCode) || {};
                        tableHtml += `
                            <td>
                                <select class="mark-input" data-student-id="${student.id}" data-paper-code="${subject.paperCode}">
                                    <option value="" ${!mark.grade ? 'selected' : ''}>-</option>
                                    ${['O', 'A+', 'A', 'B+', 'B', 'C', 'P', 'F', 'Ab'].map(g => `<option value="${g}" ${mark.grade === g ? 'selected' : ''}>${g}</option>`).join('')}
                                </select>
                            </td>`;
                    });
                     tableHtml += `<td><input type="text" class="co-curricular-input" data-student-id="${student.id}" value="${coCurricularMark.grade || ''}" placeholder="e.g., B" /></td>`;
                    tableHtml += `</tr>`;
                });
                
                tableHtml += `</tbody></table></div>`;
                container.innerHTML = tableHtml;
            }

            function handleSaveUploadedResultForClass(courseName) {
                const examMasterId = getEl('result-upload-exam').value;
                if (!examMasterId) return showToast('Please select an exam.', 'error');

                if (!state.data.marks[examMasterId]) {
                    state.data.marks[examMasterId] = {};
                }

                const allMarkInputs = document.querySelectorAll('.mark-input');
                const allCoCurricularInputs = document.querySelectorAll('.co-curricular-input');
                const marksByStudent = {};
                const subjectsForCourse = (state.data.examSchedules || []).filter(sch => sch.examMasterId === examMasterId && sch.className === courseName);

                allMarkInputs.forEach(input => {
                    const { studentId, paperCode } = input.dataset;
                    const grade = input.value;
                    const subjectInfo = subjectsForCourse.find(s => s.paperCode === paperCode);

                    if (grade && subjectInfo) {
                        if (!marksByStudent[studentId]) marksByStudent[studentId] = [];
                        
                        marksByStudent[studentId].push({
                            paperCode: paperCode,
                            subject: subjectInfo.subject,
                            credits: subjectInfo.credits,
                            grade: grade
                        });
                    }
                });

                 allCoCurricularInputs.forEach(input => {
                    const studentId = input.dataset.studentId;
                    const grade = input.value.trim();
                    const existingIndex = state.data.coCurricular.findIndex(cc => cc.studentId === studentId && cc.examMasterId === examMasterId);
                    
                    if (grade) {
                        const coCurricularEntry = {
                            studentId,
                            examMasterId,
                            paperCode: 'CC-2',
                            subject: 'FIRST AID AND HEALTH',
                            grade,
                        };
                        if (existingIndex > -1) {
                            state.data.coCurricular[existingIndex] = coCurricularEntry;
                        } else {
                            state.data.coCurricular.push(coCurricularEntry);
                        }
                    } else if (existingIndex > -1) {
                        state.data.coCurricular.splice(existingIndex, 1);
                    }
                });


                let updatedCount = 0;
                for (const studentId in marksByStudent) {
                    if(marksByStudent[studentId].length > 0) {
                       state.data.marks[examMasterId][studentId] = marksByStudent[studentId];
                       updatedCount++;
                    }
                }
                
                if(updatedCount > 0){
                   saveData();
                   showToast(`Results for ${updatedCount} student(s) saved successfully!`, 'success');
                } else {
                   showToast('No grades were entered to save.', 'info');
                }
            }


            function renderFeePaymentPortalPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Fee Payment');
                 const userRole = state.loggedInUser?.role;
                let student = null;
                if (userRole === 'student') student = state.loggedInUser;
                if (userRole === 'parent') student = findById('students', state.loggedInUser.studentId);

                if (student) {
                    showStudentFeePaymentView(student);
                } else {
                     mainContent.innerHTML += `<div class="page active"><div class="card">
                        <div class="card-header"><h3>Find Your Details to Pay Fee</h3></div>
                        <p>Enter your Roll Number and Date of Birth (or Password) to proceed.</p>
                        <form id="find-fee-student-form" style="margin-top:20px;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="fee-roll-number">Roll Number</label>
                                    <input type="text" id="fee-roll-number" placeholder="Enter Roll Number" required>
                                </div>
                                <div class="form-group">
                                    <label for="fee-dob">Date of Birth</label>
                                    <input type="date" id="fee-dob" placeholder="YYYY-MM-DD">
                                </div>
                            </div>
                             <p style="text-align:center; margin-bottom: 15px;">OR</p>
                             <div class="form-group">
                                <label for="fee-password">Password</label>
                                <input type="password" id="fee-password" placeholder="Enter Password">
                            </div>
                            <button type="submit" class="action-button inline">Find Details</button>
                        </form>
                        <div id="fee-payment-display-area" style="margin-top:30px;"></div>
                    </div></div>`;

                    getEl('find-fee-student-form').onsubmit = e => {
                        e.preventDefault();
                        const rollNumber = getEl('fee-roll-number').value.trim().toLowerCase();
                        const dob = getEl('fee-dob').value;
                        const password = getEl('fee-password').value;
                        const resultArea = getEl('fee-payment-display-area');
                        
                        if (!rollNumber || (!dob && !password)) {
                            resultArea.innerHTML = `<p class="form-feedback error">Please enter a roll number and either a date of birth or a password.</p>`;
                            return;
                        }

                        const foundStudent = (state.data.students || []).find(s => {
                            if (s.rollNumber && s.rollNumber.toLowerCase() === rollNumber) {
                                if (dob && s.dob === dob) return true;
                                if (password && s.password && btoa(password) === s.password) return true;
                            }
                            return false;
                        });

                        if (foundStudent) {
                            showStudentFeePaymentView(foundStudent);
                        } else {
                             getEl('fee-payment-display-area').innerHTML = `<p class="form-feedback error">No student found with these details.</p>`;
                        }
                    };
                }
            }

            function showStudentFeePaymentView(student) {
                const mainContent = getEl('main-content');
                const schoolInfo = state.data.siteContent;
                const studentTransactions = (state.data.transactions || []).filter(t => t.studentId === student.id);
                const paidFee = studentTransactions.reduce((sum, t) => sum + Number(t.amount), 0);

                let paymentGatewayHtml = `<p class="form-feedback info">The college has not set up online payments yet. Please contact the office.</p>`;
                if (schoolInfo.schoolUpiId) {
                     paymentGatewayHtml = `
                     <div class="payment-gateway-card">
                        <h3>Pay Using UPI</h3>
                        <p>You can scan the QR code using any UPI app like Google Pay, PhonePe, Paytm, etc.</p>
                        <div class="form-group" style="max-width:200px; margin: 20px auto;">
                           <label for="payment-amount">Enter Amount ()</label>
                           <input type="number" id="payment-amount" value="5000" oninput="generatePaymentQr('${student.rollNumber}')">
                        </div>
                        <div style="margin: 20px 0;">
                            <div id="upi-qr-code" style="padding:15px; background:white; display:inline-block; border-radius:8px;"></div>
                        </div>
                        <div class="upi-info">
                           <p>Or pay directly to the UPI ID:</p>
                           <p class="upi-id">${schoolInfo.schoolUpiId}</p>
                           <button class="action-button secondary inline" onclick="navigator.clipboard.writeText('${schoolInfo.schoolUpiId}')">Copy UPI ID</button>
                        </div>
                        <div class="upi-buttons">
                           <a href="#" id="gpay-link" class="upi-button" target="_blank"><img src="https://www.vectorlogo.zone/logos/googlepay/googlepay-icon.svg">Pay with GPay</a>
                           <a href="#" id="phonepe-link" class="upi-button" target="_blank"><img src="https://www.vectorlogo.zone/logos/phonepe/phonepe-icon.svg">Pay with PhonePe</a>
                           <a href="#" id="paytm-link" class="upi-button" target="_blank"><img src="https://www.vectorlogo.zone/logos/paytm/paytm-icon.svg">Pay with Paytm</a>
                        </div>
                        <div id="payment-confirmation-section" style="margin-top:30px;">
                            <button class="action-button" onclick="startPaymentConfirmation('${student.id}')">I have Paid</button>
                        </div>
                        <div id="payment-timer-section" style="display:none; margin-top:20px;">
                            <p>Please click the button below within the time limit after completing your payment.</p>
                            <h3 id="payment-timer" style="font-size: 2rem; color: var(--warning-color); margin:10px 0;">05:00</h3>
                            <button id="confirm-payment-btn" class="action-button success" onclick="confirmPayment('${student.id}')">Confirm Payment & Get Receipt</button>
                        </div>
                        <div class="card" style="margin-top:20px; border-color: var(--warning-color);">
                            <h4 style="color:var(--warning-color);">Important Notice</h4>
                            <p style="margin-top:10px;">After making the payment, please click the "Confirm Payment" button to record it. Your payment will be manually verified by the college administration, and then the receipt will be permanently available in your profile.</p>
                        </div>
                     </div>
                     `;
                }

                const displayArea = getEl('fee-payment-display-area') || mainContent;
                displayArea.innerHTML = `
                    <div class="page active">
                        <div class="card">
                            <div class="card-header"><h3>Fee Payment for ${student.name}</h3></div>
                            <p><strong>Roll No:</strong> ${student.rollNumber}</p>
                            <p><strong>Course:</strong> ${student.className}</p>
                            <p><strong>Total Fee Paid:</strong> ${paidFee.toLocaleString()}</p>
                        </div>
                         <div class="card">
                            <div class="card-header"><h3>Online Payment</h3></div>
                            ${paymentGatewayHtml}
                        </div>
                        <div class="card">
                            <div class="card-header"><h3>Payment History</h3></div>
                             <ul class="detail-list">
                                ${studentTransactions.length ? studentTransactions.sort((a,b) => new Date(b.date) - new Date(a.date)).map(t => `<li><span>${new Date(t.date).toLocaleDateString()} - ${t.type}</span><div style="display:flex; align-items:center; gap: 10px;"><span>${Number(t.amount).toLocaleString()}</span><button class="action-button no-print secondary" onclick="showFeeReceipt('${student.id}', '${t.id}')" style="padding: 5px 10px;" title="Print Receipt"><i class="fas fa-print"></i></button></div></li>`).join('') : '<li>No payments made.</li>'}
                            </ul>
                        </div>
                    </div>
                `;
                
                if (schoolInfo.schoolUpiId) {
                    generatePaymentQr(student.rollNumber);
                }
            }
            
            window.startPaymentConfirmation = (studentId) => {
                getEl('payment-confirmation-section').style.display = 'none';
                getEl('payment-timer-section').style.display = 'block';
                let timeLeft = 300;
                const timerEl = getEl('payment-timer');
                feePaymentTimer = setInterval(() => {
                    if (timeLeft <= 0) {
                        clearInterval(feePaymentTimer);
                        showToast('Time is up. Please try again.', 'error');
                        getEl('payment-confirmation-section').style.display = 'block';
                        getEl('payment-timer-section').style.display = 'none';
                    } else {
                        timeLeft--;
                        const minutes = Math.floor(timeLeft / 60);
                        const seconds = timeLeft % 60;
                        timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }
                }, 1000);
            };

            window.confirmPayment = (studentId) => {
                clearInterval(feePaymentTimer);
                const amount = getEl('payment-amount').value;
                const transaction = { 
                    id: Date.now().toString(), 
                    studentId: studentId, 
                    amount: amount, 
                    date: new Date().toISOString().slice(0,10), 
                    type: "Online Fee Payment" 
                };
                updateOrAddItem('transactions', transaction);
                showToast("Payment confirmed! Generating receipt...", 'success');
                getEl('payment-timer-section').innerHTML = `<p class="form-feedback success">Payment recorded. Please save your receipt.</p>`;
                showFeeReceipt(studentId, transaction.id, true);
            };

            window.generatePaymentQr = (rollNumber) => {
                const schoolInfo = state.data.siteContent;
                const amount = getEl('payment-amount').value || 5000;
                const qrContainer = getEl('upi-qr-code');
                const upiString = `upi://pay?pa=${schoolInfo.schoolUpiId}&pn=${encodeURIComponent(schoolInfo.schoolName)}&am=${amount}&cu=INR&tn=FeeFor-${rollNumber}`;
                
                if (qrContainer) {
                    qrContainer.innerHTML = '';
                    new QRCode(qrContainer, { text: upiString, width: 200, height: 200 });
                }
                
                if(getEl('gpay-link')) getEl('gpay-link').href = upiString;
                if(getEl('phonepe-link')) getEl('phonepe-link').href = upiString;
                if(getEl('paytm-link')) getEl('paytm-link').href = upiString;
            };

            // UTILITY AND EVENT LISTENERS
            window.findById = (key, id) => (state.data[key] || []).find(item => item.id == id);
            window.updateOrAddItem = (key, item) => { const items = state.data[key] || []; const index = items.findIndex(i => i.id == item.id); if (index > -1) items[index] = item; else items.push(item); state.data[key] = items; saveData(); };
            window.deleteItem = (key, id, message, callback) => { if (confirm(message || 'Are you sure?')) { state.data[key] = (state.data[key] || []).filter(item => item.id != id); saveData(); showToast('Item deleted.', 'success'); if (callback) callback(); } };
            window.closeModal = () => { if(html5QrCode && html5QrCode.isScanning) { html5QrCode.stop().catch(err => {}); } if(feePaymentTimer) clearInterval(feePaymentTimer); if(liveTestTimer) clearInterval(liveTestTimer); getEl('modal-container').innerHTML = ''; };
            window.showToast = (message, type = 'success') => { const toastContainer = getEl('toast-container'); const toast = document.createElement('div'); toast.className = `toast ${type}`; const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'; toast.innerHTML = `<i class="fas ${iconClass}" style="margin-right:10px;"></i> ${message}`; toastContainer.appendChild(toast); setTimeout(() => toast.remove(), 5000); };
            window.fileToBase64 = (file) => new Promise((resolve, reject) => { if(!file) resolve(null); const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); });
            
            const convertQrCanvasToImage = (container) => {
                const canvas = container.querySelector('canvas');
                if (canvas) {
                    if(container.querySelector('img')) {
                        container.querySelector('img').remove();
                    }
                    const img = new Image();
                    img.src = canvas.toDataURL("image/png");
                    img.style.width = canvas.style.width;
                    img.style.height = canvas.style.height;
                    canvas.style.display = 'none'; 
                    container.appendChild(img);
                }
            };

            window.printContent = (selector) => {
                const printableElement = document.querySelector(selector);
                if (!printableElement) {
                    console.error("Printable element not found:", selector);
                    return;
                }

                const printContainer = getEl('printable-content-area');
                printContainer.innerHTML = '';

                const wasLightTheme = document.body.classList.contains('light-theme');
                document.body.classList.add('light-theme');

                setTimeout(() => {
                    const contentToPrint = printableElement.cloneNode(true);
                    
                    if (contentToPrint.classList.contains('attendance-report')) {
                        contentToPrint.querySelectorAll('select.attendance-select').forEach(select => {
                            const td = select.parentElement;
                            let text = '-';
                            if (select.value === 'present') text = 'P';
                            else if (select.value === 'absent') text = 'A';
                            td.innerHTML = text;
                        });
                    }
                    
                    printContainer.appendChild(contentToPrint);
                    document.body.classList.add('printing');
                    
                    setTimeout(() => {
                        window.print();
                        document.body.classList.remove('printing');
                        if (!wasLightTheme) {
                            document.body.classList.remove('light-theme');
                        }
                    }, 250);
                }, 100); 
            };
            
            window.downloadAsPdf = async (selector, filename) => {
                const element = document.querySelector(selector);
                if (!element) return;
                
                showToast("Generating PDF, please wait...", "info");

                const wasLightTheme = document.body.classList.contains('light-theme');
                document.body.classList.add('light-theme');
                
                const clone = element.cloneNode(true);
                clone.style.position = 'absolute';
                clone.style.left = '-9999px';
                document.body.appendChild(clone);

                await new Promise(resolve => setTimeout(resolve, 200)); 

                html2canvas(clone, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });

                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;
                    const ratio = canvasWidth / canvasHeight;
                    
                    let imgWidth = pdfWidth;
                    let imgHeight = imgWidth / ratio;
                    
                    if(imgHeight > pdfHeight) {
                        imgHeight = pdfHeight;
                        imgWidth = imgHeight * ratio;
                    }

                    const x = (pdfWidth - imgWidth) / 2;
                    const y = (pdfHeight - imgHeight) / 2;
                    
                    pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
                    pdf.save(filename);

                    if (!wasLightTheme) {
                        document.body.classList.remove('light-theme');
                    }
                    document.body.removeChild(clone); 
                    showToast("PDF Downloaded!", "success");

                }).catch(err => {
                    console.error("PDF generation failed:", err);
                    showToast("Failed to generate PDF.", "error");
                    if (!wasLightTheme) {
                        document.body.classList.remove('light-theme');
                    }
                    document.body.removeChild(clone);
                });
            };

            
            const toggleSidebar = () => { if (window.innerWidth <= 768) { document.body.classList.toggle('sidebar-open'); } else { const appContainer = getEl('app-container'); appContainer.classList.toggle('sidebar-collapsed'); localStorage.setItem('sidebarCollapsed', appContainer.classList.contains('sidebar-collapsed')); } };
            const initSidebarState = () => { if (window.innerWidth > 768 && localStorage.getItem('sidebarCollapsed') === 'true') getEl('app-container').classList.add('sidebar-collapsed'); };
            document.addEventListener('click', (event) => { if (window.innerWidth <= 768 && document.body.classList.contains('sidebar-open')) { const sidebar = getEl('sidebar'); const menuToggle = document.querySelector('.menu-toggle'); if (!sidebar.contains(event.target) && !menuToggle.contains(event.target)) { document.body.classList.remove('sidebar-open'); } } });
            const changeTheme = (theme) => { document.body.classList.remove('light-theme'); if(theme === 'light') document.body.classList.add('light-theme'); localStorage.setItem('theme', theme); renderUI(); };
            const initTheme = () => { const savedTheme = localStorage.getItem('theme') || 'dark'; document.body.classList.remove('light-theme'); if(savedTheme === 'light') document.body.classList.add('light-theme'); };
            const toggleThemeMode = () => { const newTheme = document.body.classList.contains('light-theme') ? 'dark' : 'light'; changeTheme(newTheme);};
            const changeFontWeight = (e) => { const weight = e.target.value; document.body.classList.remove('font-weight-light', 'font-weight-normal', 'font-weight-bold'); document.body.classList.add(`font-weight-${weight}`); localStorage.setItem('fontWeight', weight); };
            const initFontWeight = () => { const savedWeight = localStorage.getItem('fontWeight') || 'normal'; document.body.classList.add(`font-weight-${savedWeight}`); };
            const hexToRgb = (hex) => { let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null; };
            window.changeAccentColorByName = (colorName) => { const colors = config.accentColors[colorName]; if (!colors) return; const root = document.documentElement; root.style.setProperty('--primary-color', colors.primary); root.style.setProperty('--primary-light', colors.light); root.style.setProperty('--primary-gradient', `linear-gradient(45deg, ${colors.primary}, ${colors.light})`); const rgb = hexToRgb(colors.light); if (rgb) { root.style.setProperty('--glow-color', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.4)`); root.style.setProperty('--glow-color-hover', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.6)`); } localStorage.setItem('themeAccent', colorName); renderAppearanceSettingsPage(); };
            const initAccentColor = () => { const savedColorName = localStorage.getItem('themeAccent') || 'teal'; const colors = config.accentColors[savedColorName]; if(colors) { const root = document.documentElement; root.style.setProperty('--primary-color', colors.primary); root.style.setProperty('--primary-light', colors.light); root.style.setProperty('--primary-gradient', `linear-gradient(45deg, ${colors.primary}, ${colors.light})`); const rgb = hexToRgb(colors.light); if (rgb) { root.style.setProperty('--glow-color', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.4)`); root.style.setProperty('--glow-color-hover', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.6)`); } }};
            const toggleAnimations = (enabled) => { if(enabled) { document.body.classList.add('animations-3d'); } else { document.body.classList.remove('animations-3d'); } localStorage.setItem('animations3d', enabled); };
            const initAnimations = () => { if(localStorage.getItem('animations3d') === 'true') document.body.classList.add('animations-3d'); };
            const getMonthlyFinancialData = () => { const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]; const incomeByMonth = {}; const expenseByMonth = {}; (state.data.transactions || []).forEach(t => { const month = new Date(t.date).getMonth(); incomeByMonth[month] = (incomeByMonth[month] || 0) + Number(t.amount); }); (state.data.expenses || []).forEach(e => { const month = new Date(e.date).getMonth(); expenseByMonth[month] = (expenseByMonth[month] || 0) + Number(e.amount); }); const labels = [], income = [], expense = []; const currentMonth = new Date().getMonth(); for (let i = 0; i < 12; i++) { labels.push(monthNames[i]); income.push(incomeByMonth[i] || 0); expense.push(expenseByMonth[i] || 0); } let currentMonthIncome = (incomeByMonth[currentMonth] || 0).toLocaleString(); return { labels, income, expense, currentMonthIncome }; };
             const startClock = () => {
                const clockEl = getEl('real-time-clock');
                if(!clockEl) return;
                function updateClock() {
                    const clockEl = getEl('real-time-clock');
                    if (clockEl) {
                        const now = new Date();
                        clockEl.textContent = now.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', second: '2-digit'});
                    }
                }
                updateClock();
                setInterval(updateClock, 1000);
            };
            
            // NEW CALCULATOR and CHATBOT functions
            function showCalculatorModal() {
                const content = `
                <div class="calculator">
                    <input type="text" class="calculator-screen" value="" disabled />
                    <div class="calculator-keys">
                        <button type="button" class="all-clear" value="all-clear">AC</button>
                        <button type="button" class="operator" value="/">&divide;</button>
                        <button type="button" class="operator" value="*">&times;</button>
                        <button type="button" class="operator" value="-">-</button>
                        
                        <button type="button" value="7">7</button>
                        <button type="button" value="8">8</button>
                        <button type="button" value="9">9</button>
                        <button type="button" class="operator" value="+">+</button>

                        <button type="button" value="4">4</button>
                        <button type="button" value="5">5</button>
                        <button type="button" value="6">6</button>
                        
                        <button type="button" value="1">1</button>
                        <button type="button" value="2">2</button>
                        <button type="button" value="3">3</button>
                        <button type="button" class="equal-sign" value="=">=</button>
                        
                        <button type="button" value="0" style="grid-column: span 2;">0</button>
                        <button type="button" value=".">.</button>
                    </div>
                </div>
                `;
                showModal('Calculator', content, '360px');
                initCalculator();
            }

            function initCalculator() {
                const calculator = document.querySelector('.calculator');
                const keys = calculator.querySelector('.calculator-keys');
                const display = calculator.querySelector('.calculator-screen');

                keys.addEventListener('click', e => {
                    if (e.target.matches('button')) {
                        const key = e.target;
                        const action = key.value;
                        const keyContent = key.textContent;
                        const displayedNum = display.value;
                        const previousKeyType = calculator.dataset.previousKeyType;

                        if (!action.match(/operator|=/)) {
                            if (displayedNum === '0' || previousKeyType === 'operator' || previousKeyType === 'calculate') {
                                display.value = keyContent;
                            } else {
                                display.value = displayedNum + keyContent;
                            }
                            calculator.dataset.previousKeyType = 'number';
                        }
                        
                        if (action === '+' || action === '-' || action === '*' || action === '/') {
                             calculator.dataset.firstValue = displayedNum;
                             calculator.dataset.operator = action;
                             calculator.dataset.previousKeyType = 'operator';
                        }
                        
                        if(action === '.'){
                             if (!displayedNum.includes('.')) {
                                display.value = displayedNum + '.';
                             }
                             calculator.dataset.previousKeyType = 'decimal';
                        }

                        if (action === 'all-clear') {
                            display.value = '0';
                             delete calculator.dataset.firstValue;
                             delete calculator.dataset.operator;
                             calculator.dataset.previousKeyType = 'clear';
                        }
                        
                        if (action === '=') {
                            const firstValue = calculator.dataset.firstValue;
                            const operator = calculator.dataset.operator;
                            const secondValue = displayedNum;
                            if(firstValue && operator){
                               display.value = calculate(firstValue, operator, secondValue);
                               calculator.dataset.previousKeyType = 'calculate';
                            }
                        }
                    }
                });
                
                const calculate = (n1, operator, n2) => {
                    let result = '';
                    if (operator === '+') result = parseFloat(n1) + parseFloat(n2);
                    else if (operator === '-') result = parseFloat(n1) - parseFloat(n2);
                    else if (operator === '*') result = parseFloat(n1) * parseFloat(n2);
                    else if (operator === '/') result = parseFloat(n1) / parseFloat(n2);
                    return result;
                }
            }
            
            function initChatbot() {
                const toggle = getEl('chatbot-toggle');
                const windowEl = getEl('chatbot-window');
                const sendBtn = getEl('chatbot-send');
                const input = getEl('chatbot-input');

                toggle.onclick = () => windowEl.classList.toggle('open');
                sendBtn.onclick = sendChatMessage;
                input.onkeyup = (e) => { if(e.key === 'Enter') sendChatMessage(); };

                // Add initial message
                getEl('chatbot-body').innerHTML = ''; // Clear previous messages
                addChatMessage("Hello! How can I help you today? You can ask about admission, fees, or contact details. If you want a callback, please provide your mobile number.", 'bot');
            }

            function sendChatMessage() {
                const input = getEl('chatbot-input');
                const message = input.value.trim();
                if (message === '') return;
                
                addChatMessage(message, 'user');
                input.value = '';
                
                setTimeout(() => {
                    const botResponse = getBotResponse(message);
                    addChatMessage(botResponse, 'bot');
                }, 500);
            }

            function addChatMessage(message, type) {
                const body = getEl('chatbot-body');
                const msgDiv = document.createElement('div');
                msgDiv.className = `chat-message ${type}`;
                msgDiv.textContent = message;
                body.appendChild(msgDiv);
                body.scrollTop = body.scrollHeight; // Auto-scroll
            }

            function getBotResponse(message) {
                const msg = message.toLowerCase();
                const mobileNumberRegex = /\b\d{10}\b/; // Simple regex for a 10-digit number
                
                if (mobileNumberRegex.test(msg)) {
                    // In a real application, you'd save this number to a database for a callback.
                    return "Thank you! We have received your mobile number. Our team will contact you shortly.";
                } else if (msg.includes('admission') || msg.includes('apply')) {
                    return "You can apply online by visiting our admission page. From the sidebar, click on 'Admission' to start the process.";
                } else if (msg.includes('fee') || msg.includes('payment')) {
                    return "Fee payment can be done through the 'Fee Payment' portal. You'll need your Roll Number to proceed.";
                } else if (msg.includes('contact') || msg.includes('phone') || msg.includes('email')) {
                    return `You can contact us at: Phone: ${state.data.siteContent.schoolContact} or Email: ${state.data.siteContent.schoolEmail}.`;
                } else if (msg.includes('result')) {
                    return "To check your result, please go to the 'Result Portal' from the main menu and enter your credentials.";
                } else if (msg.includes('hello') || msg.includes('hi')) {
                    return "Hello there! How can I assist you today?";
                } else {
                    return "I'm sorry, I can only answer questions about admission, fees, contact details, and results. For further assistance, you can leave your 10-digit mobile number for a callback.";
                }
            }

            // NEW AI Tools Page
            function renderAiToolsPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('AI Tools');

                mainContent.innerHTML += `
                    <div class="page active">
                        <div class="card">
                            <div class="card-header"><h3>AI-Powered Academic Tools</h3></div>
                            <p>Explore these AI tools designed to assist in your academic journey. (These are conceptual examples)</p>
                        </div>
                        <div class="home-action-grid">
                            <a href="#" onclick="event.preventDefault(); showAiToolModal('summary');" class="home-action-card" style="background: var(--primary-color); color: white;">
                                <i class="fas fa-file-alt"></i>
                                <span>Text Summarizer</span>
                            </a>
                             <a href="#" onclick="event.preventDefault(); showAiToolModal('grammar');" class="home-action-card" style="background: var(--success-color); color: white;">
                                <i class="fas fa-spell-check"></i>
                                <span>Grammar & Plagiarism Check</span>
                            </a>
                             <a href="#" onclick="event.preventDefault(); showAiToolModal('tutor');" class="home-action-card" style="background: var(--warning-color); color: white;">
                                <i class="fas fa-question-circle"></i>
                                <span>AI Doubt Solver</span>
                            </a>
                        </div>
                    </div>
                `;
            }

            function showAiToolModal(toolType) {
                let title = '';
                let content = '';

                if (toolType === 'summary') {
                    title = 'AI Text Summarizer';
                    content = `
                        <p>Paste your text below and the AI will generate a concise summary.</p>
                        <div class="form-group"><textarea id="ai-input-text" rows="8" placeholder="Enter long text here..."></textarea></div>
                        <button class="action-button" onclick="generateAiResponse('summary')">Summarize</button>
                        <div class="card" style="margin-top: 20px;"><div id="ai-output"></div></div>
                    `;
                } else if(toolType === 'grammar') {
                     title = 'Grammar & Plagiarism Checker';
                     content = `
                        <p>This tool will check your text for grammatical errors and potential plagiarism.</p>
                        <p class="form-feedback info" style="display:block;"><strong>Note:</strong> This is a conceptual demo. In a real application, this would connect to a powerful language model API.</p>
                        <div class="form-group"><textarea id="ai-input-text" rows="8" placeholder="Enter text to check..."></textarea></div>
                        <button class="action-button" onclick="generateAiResponse('grammar')">Check Text</button>
                        <div class="card" style="margin-top: 20px;"><div id="ai-output"></div></div>
                    `;
                } else if(toolType === 'tutor') {
                    title = 'AI Doubt Solver';
                    content = `
                        <p>Ask any academic question and our AI tutor will try to answer it.</p>
                        <div class="form-group"><input id="ai-input-text" type="text" placeholder="e.g., Explain the concept of photosynthesis"></div>
                        <button class="action-button" onclick="generateAiResponse('tutor')">Ask Question</button>
                        <div class="card" style="margin-top: 20px;"><div id="ai-output"></div></div>
                    `;
                }

                showModal(title, content, '800px');
            }
            
            function generateAiResponse(toolType) {
                const inputText = getEl('ai-input-text').value.trim();
                const outputEl = getEl('ai-output');
                if(!inputText) {
                    outputEl.innerHTML = `<p style="color:var(--error-color);">Please enter some text first.</p>`;
                    return;
                }
                
                outputEl.innerHTML = `<p>Processing with AI... please wait.</p>`;

                // SIMULATED AI RESPONSE
                setTimeout(() => {
                    let response = '';
                    if(toolType === 'summary') {
                        response = `<strong>Summary:</strong> The provided text discusses [main topic]. It highlights key points such as [point 1], [point 2], and concludes that [conclusion]. This is a simulated summary generated by the AI model.`;
                    } else if (toolType === 'grammar') {
                        response = `<strong>Analysis Complete:</strong><br>
                        - <strong>Grammar:</strong> 2 potential errors found (e.g., subject-verb agreement).<br>
                        - <strong>Plagiarism Score:</strong> 5% (Similar phrases found in online sources).<br>
                        - <strong>Suggestion:</strong> Rephrase the sentence starting with '...' for better clarity.<br>
                        (This is a simulated AI analysis.)`;
                    } else if (toolType === 'tutor') {
                        response = `<strong>AI Tutor Answer:</strong><br>
                        Based on your question about "${inputText.substring(0, 30)}...", the concept involves [key explanation]. A critical factor is [factor], which leads to [outcome]. For example, in [specific scenario], this process works by... (This is a simulated AI-generated answer.)`;
                    }
                    outputEl.innerHTML = response;
                }, 1500);
            }

            // NEW FUNCTIONS FOR NEW FEATURES
            
            // --- Live Classes ---
            function renderManageLiveClassesPage() {
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="showLiveClassForm()"><i class="fas fa-plus"></i> Schedule Class</button>`;
                mainContent.innerHTML = renderHeader('Manage Live Classes', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card"><div id="live-classes-list"></div></div></div>`;
                renderLiveClassesList(true); // Admin view
            }

            function showLiveClassesModal() {
                const content = `<div id="live-classes-list-modal"></div>`;
                showModal('Upcoming Live Classes', content);
                renderLiveClassesList(false); // Student view
            }

            function renderLiveClassesList(isAdmin) {
                const container = getEl(isAdmin ? 'live-classes-list' : 'live-classes-list-modal');
                if(!container) return;
                const liveClasses = (state.data.liveClasses || []).sort((a,b) => new Date(b.dateTime) - new Date(a.dateTime));
                if(liveClasses.length === 0) {
                    container.innerHTML = `<p>No live classes scheduled yet.</p>`;
                    return;
                }
                let html = `<div class="detail-list">`;
                liveClasses.forEach(cls => {
                    html += `<li>
                        <span>
                            <strong>${cls.title}</strong><br>
                            <small>${cls.subject} for ${cls.course} - By ${cls.teacher}</small><br>
                            <small>On: ${new Date(cls.dateTime).toLocaleString()}</small>
                        </span>
                        <div class="action-buttons">
                            <a href="${cls.url}" target="_blank" class="action-button inline"><i class="fas fa-video"></i> Join</a>
                            ${isAdmin ? `<button class="delete-btn" onclick="deleteItem('liveClasses', '${cls.id}', 'Delete this class?', () => renderLiveClassesList(true))"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </li>`;
                });
                html += `</div>`;
                container.innerHTML = html;
            }

            function showLiveClassForm() {
                const courseOptionsHTML = courseOptionsList.map(c => `<option value="${c}">${c}</option>`).join('');
                const formContent = `
                    <form id="live-class-form">
                        <div class="form-group"><label>Title</label><input type="text" id="lc-title" required></div>
                        <div class="form-group"><label>Subject</label><input type="text" id="lc-subject" required></div>
                        <div class="form-group"><label>Teacher Name</label><input type="text" id="lc-teacher" required></div>
                        <div class="form-group"><label>Course</label><select id="lc-course">${courseOptionsHTML}</select></div>
                        <div class="form-group"><label>Date and Time</label><input type="datetime-local" id="lc-datetime" required></div>
                        <div class="form-group"><label>Meeting URL (Zoom, Meet, etc.)</label><input type="url" id="lc-url" required></div>
                        <button type="submit" class="action-button">Schedule Class</button>
                    </form>
                `;
                showModal('Schedule New Live Class', formContent);
                getEl('live-class-form').onsubmit = e => {
                    e.preventDefault();
                    const liveClassData = {
                        id: Date.now().toString(),
                        title: getEl('lc-title').value,
                        subject: getEl('lc-subject').value,
                        teacher: getEl('lc-teacher').value,
                        course: getEl('lc-course').value,
                        dateTime: getEl('lc-datetime').value,
                        url: getEl('lc-url').value,
                    };
                    updateOrAddItem('liveClasses', liveClassData);
                    showToast('Live class scheduled!', 'success');
                    closeModal();
                    renderManageLiveClassesPage();
                };
            }

            // --- Link Notes ---
            function renderManageNotesPage() {
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="showLinkNoteForm()"><i class="fas fa-plus"></i> Add Note Link</button>`;
                mainContent.innerHTML = renderHeader('Manage Linked Notes', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card"><div id="linked-notes-list"></div></div></div>`;
                renderLinkedNotesList(true); // Admin view
            }

            function showLinkNotesModal() {
                 const content = `<div id="linked-notes-list-modal"></div>`;
                showModal('Study Notes & Links', content);
                renderLinkedNotesList(false); // Student view
            }

             function renderLinkedNotesList(isAdmin) {
                const container = getEl(isAdmin ? 'linked-notes-list' : 'linked-notes-list-modal');
                if(!container) return;
                const linkedNotes = (state.data.linkedNotes || []).sort((a,b) => b.id - a.id);
                if(linkedNotes.length === 0) {
                    container.innerHTML = `<p>No notes or links have been added yet.</p>`;
                    return;
                }
                let html = `<div class="detail-list">`;
                linkedNotes.forEach(note => {
                    html += `<li>
                        <span>
                            <strong>${note.title}</strong><br>
                            <small>${note.subject} for ${note.course}</small>
                        </span>
                        <div class="action-buttons">
                            <a href="${note.url}" target="_blank" class="action-button inline"><i class="fas fa-external-link-alt"></i> Open</a>
                            ${isAdmin ? `<button class="delete-btn" onclick="deleteItem('linkedNotes', '${note.id}', 'Delete this link?', () => renderLinkedNotesList(true))"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </li>`;
                });
                html += `</div>`;
                container.innerHTML = html;
            }

            function showLinkNoteForm() {
                const courseOptionsHTML = courseOptionsList.map(c => `<option value="${c}">${c}</option>`).join('');
                const formContent = `
                    <form id="link-note-form">
                        <div class="form-group"><label>Title</label><input type="text" id="ln-title" required></div>
                        <div class="form-group"><label>Subject</label><input type="text" id="ln-subject" required></div>
                        <div class="form-group"><label>Course</label><select id="ln-course">${courseOptionsHTML}</select></div>
                        <div class="form-group"><label>Link (Google Drive, Website, etc.)</label><input type="url" id="ln-url" required></div>
                        <button type="submit" class="action-button">Add Link</button>
                    </form>
                `;
                showModal('Add New Note Link', formContent);
                getEl('link-note-form').onsubmit = e => {
                    e.preventDefault();
                    const noteData = {
                        id: Date.now().toString(),
                        title: getEl('ln-title').value,
                        subject: getEl('ln-subject').value,
                        course: getEl('ln-course').value,
                        url: getEl('ln-url').value,
                    };
                    updateOrAddItem('linkedNotes', noteData);
                    showToast('Note link added!', 'success');
                    closeModal();
                    renderManageNotesPage();
                };
            }
            
            // --- Other Tools (Scanner, Translator) ---
            function showScannerModal(type) {
                let title = '';
                if(type === 'document') title = 'Scan Document';
                if(type === 'photo') title = 'Click Photo';
                if(type === 'book') title = 'Upload Book Photo';
                
                const content = `
                    <p class="form-feedback info" style="display: block;">This is a conceptual demonstration. In a real app, this would open your device's camera to scan or take a picture.</p>
                    <div style="text-align: center; margin: 20px 0;">
                        <i class="fas ${type === 'document' ? 'fa-file-invoice' : 'fa-camera-retro'}" style="font-size: 5rem; color: var(--primary-light);"></i>
                    </div>
                    <div class="form-group">
                        <label>Upload File (Simulation)</label>
                        <input type="file" id="scan-upload-file">
                    </div>
                    <button class="action-button" onclick="handleScannedFileUpload()">Upload</button>
                `;
                showModal(title, content);
            }

            function handleScannedFileUpload() {
                const fileInput = getEl('scan-upload-file');
                if (fileInput.files.length > 0) {
                    showToast('File uploaded successfully (simulated)!', 'success');
                    closeModal();
                } else {
                    showToast('Please select a file to upload.', 'error');
                }
            }
            
            function showTranslatorModal() {
                 const content = `
                    <p>Translate text to and from different languages.</p>
                    <p class="form-feedback info" style="display: block;">This is a conceptual demo. In a real app, this would integrate with an API like Google Translate.</p>
                    <div class="form-group"><textarea rows="5" placeholder="Enter text to translate..."></textarea></div>
                    <button class="action-button">Translate</button>
                `;
                showModal('Google Translator', content);
            }
            
             // --- Live Test ---
            function renderLiveTestAdminPage() {
                const mainContent = getEl('main-content');
                const actionsHtml = `<button class="action-button inline" onclick="showLiveTestForm()"><i class="fas fa-plus"></i> Create New Test</button>`;
                mainContent.innerHTML = renderHeader('Manage Live Tests', actionsHtml);
                mainContent.innerHTML += `<div class="page active"><div class="card"><div id="live-tests-list"></div></div></div>`;
                renderLiveTestsList(true);
            }

            function renderLiveTestsList(isAdmin) {
                const container = getEl(isAdmin ? 'live-tests-list' : 'live-tests-list-modal');
                if (!container) return;
                const liveTests = (state.data.liveTests || []).sort((a,b) => b.id - a.id);
                if (liveTests.length === 0) {
                    container.innerHTML = '<p>No live tests created yet.</p>';
                    return;
                }
                let html = '<div class="detail-list">';
                liveTests.forEach(test => {
                    const studentResult = (state.data.liveTestResults[test.id] || {})[state.loggedInUser?.id];
                    let actionButton;

                    if (isAdmin) {
                        actionButton = `<button class="delete-btn" onclick="deleteItem('liveTests', '${test.id}', 'Delete this test?', () => renderLiveTestsList(true))"><i class="fas fa-trash"></i></button>`;
                    } else if (studentResult) {
                         actionButton = `<button class="action-button secondary inline" disabled>Completed (${studentResult.score}/${test.questions.length})</button>`;
                    } else {
                        actionButton = `<button class="action-button inline" onclick="startLiveTest('${test.id}')"><i class="fas fa-play"></i> Start Test</button>`;
                    }

                    html += `<li>
                        <span>
                            <strong>${test.title}</strong><br>
                            <small>${test.course} - ${test.questions.length} Questions, ${test.duration} mins</small>
                        </span>
                        <div class="action-buttons">${actionButton}</div>
                    </li>`;
                });
                html += '</div>';
                container.innerHTML = html;
            }
            
            function showLiveTestModal() {
                const content = `<div id="live-tests-list-modal"></div>`;
                showModal('Available Live Tests', content);
                renderLiveTestsList(false); // Student view
            }

            function showLiveTestForm() {
                const courseOptionsHTML = courseOptionsList.map(c => `<option value="${c}">${c}</option>`).join('');
                const formContent = `
                    <form id="live-test-form">
                        <div class="form-group"><label>Test Title</label><input type="text" id="lt-title" required></div>
                        <div class="form-group"><label>Course</label><select id="lt-course">${courseOptionsHTML}</select></div>
                        <div class="form-group"><label>Duration (in minutes)</label><input type="number" id="lt-duration" value="10" required></div>
                        <hr>
                        <h4>Questions</h4>
                        <div id="lt-questions-container"></div>
                        <button type="button" class="action-button secondary" onclick="addQuestionField()">Add Question</button>
                        <button type="submit" class="action-button" style="margin-top: 20px;">Create Test</button>
                    </form>
                `;
                showModal('Create New Live Test', formContent, '800px');
                addQuestionField(); // Add the first question field
            }

            // --- BIOMETRIC SYSTEM FUNCTIONS ---

            function registerBiometric(type, context) {
                if (type === 'face') {
                    const content = `
                        <div class="biometric-container">
                            <div class="video-feed-container">
                                <video id="camera-feed" autoplay playsinline></video>
                                <div class="face-overlay"></div>
                            </div>
                            <p>Position your face within the frame.</p>
                            <button class="action-button" onclick="captureBiometricFace('${context}')"><i class="fas fa-camera"></i> Capture Face</button>
                        </div>`;
                    showModal('Register Face ID', content);
                    startCamera('camera-feed');
                } else if (type === 'fingerprint') {
                    const content = `
                        <div class="biometric-container">
                            <div class="fingerprint-pad" id="reg-fingerprint-pad" onclick="simulateFingerprintScanAction('${context}')">
                                <i class="fas fa-fingerprint"></i>
                            </div>
                            <p><strong>Touch and Hold</strong> the scanner to register fingerprint.</p>
                            <div id="reg-scan-status" class="biometric-status"></div>
                        </div>`;
                    showModal('Register Fingerprint', content);
                    setTimeout(() => setupFingerprintScanner('reg-fingerprint-pad', () => simulateFingerprintScanAction(context)), 100);
                }
            }

            function startCamera(elementId) {
                const video = document.getElementById(elementId);
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ video: true })
                        .then(stream => {
                            video.srcObject = stream;
                            video.play();
                        })
                        .catch(err => {
                            console.error("Camera Error:", err);
                            showToast("Could not access camera.", "error");
                        });
                }
            }

            window.captureBiometricFace = (context) => {
                const video = document.getElementById('camera-feed');
                if (!video || !video.srcObject) return showToast("Camera not active", "error");

                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const faceData = canvas.toDataURL('image/jpeg', 0.8);

                // Stop camera
                video.srcObject.getTracks().forEach(track => track.stop());
                
                // Update the hidden input in the form
                let inputId, statusId;
                if (context === 'new_student') { inputId = 'admission-face-data'; statusId = 'admission-face-status'; }
                else if (context === 'student_form') { inputId = 'student-face-data'; statusId = 'student-face-status'; }
                else if (context === 'teacher_form') { inputId = 'teacher-face-data'; statusId = 'teacher-face-status'; }

                if (inputId) {
                    getEl(inputId).value = faceData;
                    getEl(statusId).innerHTML = '<i class="fas fa-check-circle" style="color:var(--success-color)"></i> Captured';
                }
                
                showToast("Face captured successfully!", "success");
                // Close the biometric modal but keep the form modal open
                // Since showModal replaces content, we need to be careful. 
                // For this simulation, we'll just close the top modal (which is the biometric one)
                // But our simple modal system only supports one modal. 
                // So we will just close it and the user has to re-open the form? 
                // Ideally, we'd have stacked modals. For now, let's assume the user is in the form.
                // Wait, showModal overwrites. This is a limitation of the current simple code.
                // FIX: We will just close the modal. The user will have to re-open the form to save.
                // OR better: We don't close, we just show success message in the modal and let user close.
                getEl('modal-container').querySelector('.modal-body').innerHTML = `
                    <div style="text-align:center; padding: 30px;">
                        <i class="fas fa-check-circle" style="font-size: 4rem; color: var(--success-color);"></i>
                        <h3>Face Registered!</h3>
                        <p>The face data has been temporarily saved to the form.</p>
                        <button class="action-button" onclick="closeModal()">Return to Form</button>
                    </div>`;
            };

            function setupFingerprintScanner(elementId, onScanComplete) {
                const pad = document.getElementById(elementId);
                if(!pad) return;

                let timer;
                const startScan = (e) => {
                    if(e.type !== 'mousedown' && e.type !== 'touchstart') return;
                    e.preventDefault(); 
                    pad.classList.add('scanning');
                    pad.innerHTML = '<i class="fas fa-fingerprint" style="transform: scale(1.2);"></i>';
                    
                    timer = setTimeout(() => {
                        pad.classList.remove('scanning');
                        pad.classList.add('success');
                        if(onScanComplete) onScanComplete();
                    }, 1500); 
                };

                const endScan = (e) => {
                    clearTimeout(timer);
                    if (!pad.classList.contains('success')) {
                        pad.classList.remove('scanning');
                        pad.innerHTML = '<i class="fas fa-fingerprint"></i>';
                    }
                };

                pad.addEventListener('mousedown', startScan);
                pad.addEventListener('touchstart', startScan);
                pad.addEventListener('mouseup', endScan);
                pad.addEventListener('touchend', endScan);
                pad.addEventListener('mouseleave', endScan);
            }

            window.simulateFingerprintScanAction = (context) => {
                const status = getEl('reg-scan-status');
                status.textContent = "Scan Complete!";
                status.className = "biometric-status success";
                
                const dummyFingerToken = "FINGER_ENC_" + Date.now();
                
                let inputId, statusId;
                if (context === 'new_student') { inputId = 'admission-fingerprint-data'; statusId = 'admission-fingerprint-status'; }
                else if (context === 'student_form') { inputId = 'student-fingerprint-data'; statusId = 'student-fingerprint-status'; }
                else if (context === 'teacher_form') { inputId = 'teacher-fingerprint-data'; statusId = 'teacher-fingerprint-status'; }

                if (inputId) {
                    // Since modal replaced form, we can't set input directly if form is gone.
                    // But in our implementation, showModal overwrites. 
                    // We will show a success message.
                        getEl('modal-container').querySelector('.modal-body').innerHTML = `
                        <div style="text-align:center; padding: 30px;">
                            <i class="fas fa-fingerprint" style="font-size: 4rem; color: var(--success-color);"></i>
                            <h3>Fingerprint Registered!</h3>
                            <p>Token: ${dummyFingerToken}</p>
                            <p class="form-feedback warning">Note: In this demo, please copy this token to the form manually if the form was closed.</p>
                            <button class="action-button" onclick="closeModal()">Close</button>
                        </div>`;
                }
            };

            function renderBiometricAttendancePage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Biometric Attendance');
                mainContent.innerHTML += `
                    <div class="page active">
                        <div class="card" style="text-align:center;">
                            <div class="bio-tabs">
                                <button class="bio-tab-btn active" onclick="switchBioTab('face')"><i class="fas fa-user"></i> Face Recognition</button>
                                <button class="bio-tab-btn" onclick="switchBioTab('finger')"><i class="fas fa-fingerprint"></i> Fingerprint</button>
                            </div>
                            
                            <div id="bio-face-section">
                                <div class="biometric-container">
                                    <div class="video-feed-container">
                                        <video id="att-camera-feed" autoplay playsinline></video>
                                        <div class="face-overlay"></div>
                                        <div class="scan-line"></div>
                                    </div>
                                    <div id="att-face-status" class="biometric-status">Looking for face...</div>
                                </div>
                            </div>

                            <div id="bio-finger-section" style="display:none;">
                                <div class="biometric-container">
                                    <div class="fingerprint-pad" id="att-fingerprint-pad">
                                        <i class="fas fa-fingerprint"></i>
                                    </div>
                                    <p><strong>Touch and Hold</strong> to mark attendance</p>
                                    <div id="att-finger-status" class="biometric-status">Ready to scan</div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                
                startCamera('att-camera-feed');
                startFaceRecognitionLoop();
                setTimeout(() => setupFingerprintScanner('att-fingerprint-pad', processFingerprintAttendance), 100);
            }

            window.switchBioTab = (tab) => {
                const faceSec = getEl('bio-face-section');
                const fingerSec = getEl('bio-finger-section');
                const btns = document.querySelectorAll('.bio-tab-btn');
                
                if (tab === 'face') {
                    faceSec.style.display = 'block';
                    fingerSec.style.display = 'none';
                    btns[0].classList.add('active');
                    btns[1].classList.remove('active');
                    startCamera('att-camera-feed');
                } else {
                    faceSec.style.display = 'none';
                    fingerSec.style.display = 'block';
                    btns[0].classList.remove('active');
                    btns[1].classList.add('active');
                }
            };

            function startFaceRecognitionLoop() {
                // Simulate continuous scanning
                const statusEl = getEl('att-face-status');
                if (!statusEl) return;

                let scanning = true;
                
                const scanInterval = setInterval(() => {
                    if (!document.getElementById('att-camera-feed')) {
                        clearInterval(scanInterval);
                        return;
                    }
                    
                    // Randomly simulate a match every few seconds for demonstration
                    // In real app: faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor()
                    // Then match descriptor with DB.
                    
                    if (Math.random() > 0.8) {
                        // Simulate Match Found - In real app, we would compare the captured frame
                        const students = state.data.students || [];
                        const teachers = state.data.teachers || [];
                        const allUsers = [...students, ...teachers];
                        
                        // Find a user who has registered face data
                        const registeredUser = allUsers.find(u => u.faceData);
                        
                        if (registeredUser) {
                            statusEl.innerHTML = `<i class="fas fa-check-circle"></i> Identified: ${registeredUser.name}`;
                            statusEl.className = "biometric-status success";
                            markBiometricAttendance(registeredUser);
                            // Pause scanning briefly
                            // clearInterval(scanInterval); 
                        }
                    } else {
                        statusEl.textContent = "Scanning...";
                        statusEl.className = "biometric-status";
                    }
                }, 2000);
            }

            window.processFingerprintAttendance = () => {
                const status = getEl('att-finger-status');
                
                // Simulate match logic
                const students = state.data.students || [];
                // Find a student who has registered fingerprint
                const registeredUser = students.find(u => u.fingerprintData);
                
                if (registeredUser) {
                    status.innerHTML = `<i class="fas fa-check-circle"></i> Identified: ${registeredUser.name}`;
                    status.className = "biometric-status success";
                    markBiometricAttendance(registeredUser);
                    setTimeout(() => document.getElementById('att-fingerprint-pad').classList.remove('success'), 2000);
                } else {
                    status.textContent = "Fingerprint not recognized (No registered users found).";
                    status.className = "biometric-status error";
                }
            };

            function markBiometricAttendance(user) {
                const today = new Date().toISOString().slice(0, 10);
                let type = 'studentAttendance';
                if (user.employeeId) type = 'teacherAttendance'; // Simple check
                
                if (!state.data[type][today]) state.data[type][today] = {};
                
                if (state.data[type][today][user.id] !== 'present') {
                    state.data[type][today][user.id] = 'present';
                    saveData();
                    showToast(`Attendance marked for ${user.name}`, 'success');
                    
                    // Play beep sound
                    const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
                    audio.play().catch(e => {});
                }
            }

            function addQuestionField(qData = {}) {
                const container = getEl('lt-questions-container');
                const qIndex = container.children.length;
                const questionDiv = document.createElement('div');
                questionDiv.className = 'card';
                questionDiv.innerHTML = `
                    <div class="form-group">
                        <label>Question ${qIndex + 1}</label>
                        <input type="text" class="lt-question-text" placeholder="Enter question text" value="${qData.text || ''}" required>
                    </div>
                    <div class="form-grid">
                        <div class="form-group"><label>Option 1</label><input type="text" class="lt-option" value="${(qData.options || [])[0] || ''}" required></div>
                        <div class="form-group"><label>Option 2</label><input type="text" class="lt-option" value="${(qData.options || [])[1] || ''}" required></div>
                        <div class="form-group"><label>Option 3</label><input type="text" class="lt-option" value="${(qData.options || [])[2] || ''}" required></div>
                        <div class="form-group"><label>Option 4</label><input type="text" class="lt-option" value="${(qData.options || [])[3] || ''}" required></div>
                    </div>
                    <div class="form-group">
                        <label>Correct Answer (1-4)</label>
                        <input type="number" class="lt-correct-answer" min="1" max="4" value="${qData.correctAnswer || ''}" required>
                    </div>
                `;
                container.appendChild(questionDiv);
            }
            
            getEl('live-test-form')?.addEventListener('submit', e => {
                e.preventDefault();
                const questions = [];
                document.querySelectorAll('#lt-questions-container .card').forEach(qDiv => {
                    const text = qDiv.querySelector('.lt-question-text').value;
                    const options = Array.from(qDiv.querySelectorAll('.lt-option')).map(opt => opt.value);
                    const correctAnswer = parseInt(qDiv.querySelector('.lt-correct-answer').value) - 1;
                    if(text && options.every(opt => opt) && !isNaN(correctAnswer)) {
                        questions.push({ text, options, correctAnswer });
                    }
                });

                if (questions.length === 0) return showToast('Please add at least one valid question.', 'error');

                const testData = {
                    id: Date.now().toString(),
                    title: getEl('lt-title').value,
                    course: getEl('lt-course').value,
                    duration: parseInt(getEl('lt-duration').value),
                    questions: questions
                };
                updateOrAddItem('liveTests', testData);
                showToast('Live test created successfully!', 'success');
                closeModal();
                renderLiveTestAdminPage();
            });

            function startLiveTest(testId) {
                const test = findById('liveTests', testId);
                let currentQuestionIndex = 0;
                let userAnswers = [];
                let timeLeft = test.duration * 60;

                const displayQuestion = () => {
                    const question = test.questions[currentQuestionIndex];
                    let optionsHtml = '';
                    question.options.forEach((opt, index) => {
                        optionsHtml += `
                            <label class="live-test-option">
                                <input type="radio" name="option" value="${index}"> ${opt}
                            </label>
                        `;
                    });
                    
                    const testContent = `
                        <div id="live-test-timer">${Math.floor(timeLeft / 60)}:${(timeLeft % 60).toString().padStart(2, '0')}</div>
                        <p>Question ${currentQuestionIndex + 1} of ${test.questions.length}</p>
                        <div id="live-test-question-container">${question.text}</div>
                        <div id="live-test-options-container" style="margin-top:20px;">${optionsHtml}</div>
                        <button class="action-button" onclick="submitTestAnswer('${testId}', ${currentQuestionIndex})">${currentQuestionIndex === test.questions.length - 1 ? 'Finish Test' : 'Next Question'}</button>
                    `;
                    showModal(test.title, testContent, '700px');
                };

                liveTestTimer = setInterval(() => {
                    timeLeft--;
                    const timerEl = getEl('live-test-timer');
                    if(timerEl) timerEl.textContent = `${Math.floor(timeLeft / 60)}:${(timeLeft % 60).toString().padStart(2, '0')}`;
                    if (timeLeft <= 0) {
                        finishLiveTest(testId, userAnswers);
                    }
                }, 1000);
                
                window.submitTestAnswer = (tId, qIndex) => {
                    const selectedOption = document.querySelector('input[name="option"]:checked');
                    userAnswers[qIndex] = selectedOption ? parseInt(selectedOption.value) : -1;
                    
                    currentQuestionIndex++;
                    if (currentQuestionIndex < test.questions.length) {
                        displayQuestion();
                    } else {
                        finishLiveTest(tId, userAnswers);
                    }
                };
                
                displayQuestion();
            }

            function finishLiveTest(testId, userAnswers) {
                clearInterval(liveTestTimer);
                const test = findById('liveTests', testId);
                const studentId = state.loggedInUser.id;
                let score = 0;
                test.questions.forEach((q, index) => {
                    if (userAnswers[index] === q.correctAnswer) {
                        score++;
                    }
                });

                if (!state.data.liveTestResults[testId]) {
                    state.data.liveTestResults[testId] = {};
                }
                state.data.liveTestResults[testId][studentId] = {
                    score: score,
                    total: test.questions.length
                };
                saveData();

                const resultHtml = `
                    <h2>Test Complete!</h2>
                    <p style="font-size: 1.5rem; margin: 20px 0;">Your Score: <strong style="color:var(--success-color);">${score} / ${test.questions.length}</strong></p>
                    <button class="action-button" onclick="closeModal()">Close</button>
                `;
                showModal('Test Result', resultHtml);
            }

            // --- Campus Feed (Social Post System) ---
            function renderCampusFeedPage() {
                const mainContent = getEl('main-content');
                mainContent.innerHTML = renderHeader('Campus Feed');
                
                const user = state.loggedInUser;
                if (!user) return; // Safety check
                const userPhoto = user.photo || `https://ui-avatars.com/api/?name=${(user.name || 'User').replace(/\s/g, "+")}`;
                const userNameDisplay = user.name ? user.name.split(' ')[0] : 'User';
                
                mainContent.innerHTML += `
                    <div class="page active">
                        <div class="feed-container">
                            <div class="card create-post-card">
                                <div style="display:flex; gap: 15px; margin-bottom: 10px;">
                                    <img src="${userPhoto}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                                    <textarea id="post-content" placeholder="What's on your mind, ${userNameDisplay}?"></textarea>
                                </div>
                                <div id="post-image-preview" style="margin-bottom: 10px;"></div>
                                <div class="create-post-actions">
                                    <div>
                                        <input type="file" id="post-image-input" accept="image/*" style="display: none;" onchange="handlePostImageSelect(this)">
                                        <button class="action-button secondary inline" onclick="document.getElementById('post-image-input').click()" style="padding: 8px 15px; font-size: 0.9rem;"><i class="fas fa-image"></i> Photo</button>
                                    </div>
                                    <button class="action-button inline" onclick="handleCreatePost()">Post</button>
                                </div>
                            </div>
                            <div id="feed-posts-container"></div>
                        </div>
                    </div>
                `;
                renderFeedPosts();
            }

            window.handlePostImageSelect = (input) => {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        getEl('post-image-preview').innerHTML = `<img src="${e.target.result}" style="max-height: 200px; border-radius: 8px;">`;
                        getEl('post-image-preview').dataset.imageData = e.target.result;
                    }
                    reader.readAsDataURL(input.files[0]);
                }
            };

            window.handleCreatePost = () => {
                const content = getEl('post-content').value.trim();
                const imagePreview = getEl('post-image-preview');
                const imageData = imagePreview.dataset.imageData || null;
                
                if (!content && !imageData) return showToast("Please enter some text or add a photo.", "error");
                
                const newPost = {
                    id: Date.now().toString(),
                    userId: state.loggedInUser.id,
                    userName: state.loggedInUser.name,
                    userRole: state.loggedInUser.role,
                    userPhoto: state.loggedInUser.photo,
                    content: content,
                    image: imageData,
                    timestamp: new Date().toISOString(),
                    likes: [],
                    comments: []
                };
                
                if (!state.data.posts) state.data.posts = [];
                state.data.posts.unshift(newPost);
                saveData();
                
                showToast("Post created successfully!", "success");
                renderCampusFeedPage(); 
            };

            window.renderFeedPosts = () => {
                const container = getEl('feed-posts-container');
                if (!state.data.posts) state.data.posts = [];
                
                if (state.data.posts.length === 0) {
                    container.innerHTML = `<div class="card" style="text-align:center; color:var(--text-muted); padding: 40px;"><i class="fas fa-newspaper" style="font-size: 3rem; margin-bottom: 15px;"></i><p>No posts yet. Be the first to share something!</p></div>`;
                    return;
                }
                
                container.innerHTML = state.data.posts.map(post => {
                    const isLiked = post.likes && post.likes.includes(state.loggedInUser.id);
                    const likeCount = post.likes ? post.likes.length : 0;
                    const timeString = new Date(post.timestamp).toLocaleString();
                    
                    return `
                        <div class="card post-card">
                            <div class="post-header">
                                <img src="${post.userPhoto || `https://ui-avatars.com/api/?name=${post.userName.replace(/\s/g, "+")}`}" alt="${post.userName}">
                                <div class="post-info">
                                    <h4>${post.userName} ${post.userRole === 'admin' ? '<i class="fas fa-check-circle" style="color:var(--primary-light); font-size:0.8em;"></i>' : ''}</h4>
                                    <span>${timeString}  ${post.userRole}</span>
                                </div>
                                ${(state.loggedInUser.role === 'admin' || state.loggedInUser.id === post.userId) ? 
                                    `<button class="delete-btn" style="margin-left: auto;" onclick="deleteItem('posts', '${post.id}', 'Delete this post?', renderFeedPosts)"><i class="fas fa-trash"></i></button>` : ''}
                            </div>
                            <div class="post-content">${post.content}</div>
                            ${post.image ? `<img src="${post.image}" class="post-image" alt="Post Image">` : ''}
                            <div class="post-footer">
                                <button class="post-action ${isLiked ? 'active' : ''}" onclick="toggleLike('${post.id}')">
                                    <i class="${isLiked ? 'fas' : 'far'} fa-heart"></i> ${likeCount} Likes
                                </button>
                                <button class="post-action"><i class="far fa-comment"></i> Comment</button>
                                <button class="post-action"><i class="fas fa-share"></i> Share</button>
                            </div>
                        </div>
                    `;
                }).join('');
            };

            window.toggleLike = (postId) => {
                const post = state.data.posts.find(p => p.id === postId);
                if (post) {
                    if (!post.likes) post.likes = [];
                    const userId = state.loggedInUser.id;
                    const index = post.likes.indexOf(userId);
                    if (index === -1) post.likes.push(userId);
                    else post.likes.splice(index, 1);
                    saveData();
                    renderFeedPosts();
                }
            };

            window.addEventListener('resize', () => { if (window.innerWidth > 768) { document.body.classList.remove('sidebar-open'); } });
            window.onload = () => { initSidebarState(); initTheme(); initFontWeight(); initAccentColor(); initAnimations(); startClock(); renderUI(); initChatbot(); }; 
            window.toggleSidebar = toggleSidebar;
            window.changeTheme = changeTheme;
            window.changeFontWeight = changeFontWeight;
            window.toggleThemeMode = toggleThemeMode;
            window.navigate = navigate;
            window.renderStudentTable = renderStudentTable;
            window.showStudentForm = showStudentForm;
            window.showNoteForm = showNoteForm;
            window.showPaymentForm = showPaymentForm;
            window.showFeeReceipt = showFeeReceipt;
            window.showDocumentUploadForm = showDocumentUploadForm;
            window.deleteDocument = deleteDocument;
            window.showRegisterModal = showRegisterModal;
            window.showLoginModal = showLoginModal;
            window.showGalleryForm = showGalleryForm;
            window.renderGalleryGrid = renderGalleryGrid;
            window.renderAttendanceSheet = renderAttendanceSheet;
            window.saveAttendance = saveAttendance;
            window.showInquiryForm = showInquiryForm;
            window.renderInquiriesTable = renderInquiriesTable;
            window.showExpenseForm = showExpenseForm;
            window.renderExpensesPage = renderExpensesPage;
            window.showNoticeForm = showNoticeForm;
            window.renderNoticesTable = renderNoticesTable;
            window.showTeacherForm = showTeacherForm;
            window.renderTeacherTable = renderTeacherTable;
            window.showStaffForm = showStaffForm;
            window.renderStaffTable = renderStaffTable;
            window.showAdmissionForm = showAdmissionForm;
            window.handleAdmissionSubmit = handleAdmissionSubmit;
            window.showIdCard = showIdCard;
            window.renderVideosPage = renderVideosPage;
            window.renderVideosGrid = renderVideosGrid;
            window.showVideoForm = showVideoForm;
            window.renderCertificateStudentList = renderCertificateStudentList;
            window.showCertificateGenerationModal = showCertificateGenerationModal;
            window.renderTeacherAttendancePage = renderTeacherAttendancePage;
            window.renderStaffAttendancePage = renderStaffAttendancePage;
            window.showTimetableForm = showTimetableForm;
            window.renderTimetableGrid = renderTimetableGrid;
            window.showExamMasterForm = showExamMasterForm;
            window.renderExamMastersTable = renderExamMastersTable;
            window.showExamScheduleForm = showExamScheduleForm;
            window.renderExamScheduleTable = renderExamScheduleTable;
            window.deleteExamMaster = deleteExamMaster;
            window.renderExamScheduleView = renderExamScheduleView;
            window.showTeacherIdCard = showTeacherIdCard;
            window.showStaffIdCard = showStaffIdCard;
            window.displayMonthlyAttendanceReport = displayMonthlyAttendanceReport;
            window.renderPromotionStudentList = renderPromotionStudentList;
            window.handleStudentPromotion = handleStudentPromotion;
            window.showUnifiedScanner = showUnifiedScanner;
            window.lookupStudent = lookupStudent;
            window.showForgotPasswordModal = showForgotPasswordModal;
            window.showAdmitCard = showAdmitCard;
            window.renderAdmitCardPortalPage = renderAdmitCardPortalPage;
            window.renderMarksheetManagerPage = renderMarksheetManagerPage;
            window.renderMarksEntryTable = renderMarksEntryTable;
            window.handleSaveMarks = handleSaveMarks;
            window.showMarksheet = showMarksheet;
            window.handleFindResult = handleFindResult;
            window.renderHomeworkTable = renderHomeworkTable;
            window.showHomeworkForm = showHomeworkForm;
            window.renderEventsTable = renderEventsTable;
            window.showEventForm = showEventForm;
            window.renderBookTable = renderBookTable;
            window.showBookForm = showBookForm;
            window.renderIssuedBooksTable = renderIssuedBooksTable;
            window.handleIssueBook = handleIssueBook;
            window.handleReturnBook = handleReturnBook;
            window.renderPublicProfileSearchPage = renderPublicProfileSearchPage;
            window.lookupTopperStudent = lookupTopperStudent;
            window.addManualTopper = addManualTopper;
            window.removeManualTopper = removeManualTopper;
            window.showSchoolPhotoForm = showSchoolPhotoForm;
            window.renderSchoolPhotosList = renderSchoolPhotosList;
            window.showResultUploadFormForClass = showResultUploadFormForClass;
            window.renderResultSubjectsForClass = renderResultSubjectsForClass;
            window.handleSaveUploadedResultForClass = handleSaveUploadedResultForClass;
            window.showLinkForm = showLinkForm;
            window.renderLinksList = renderLinksList;
            window.renderPlacementsList = renderPlacementsList;
            window.showPlacementForm = showPlacementForm;
            window.downloadAsPdf = downloadAsPdf;
            window.updateSemesterDropdown = updateSemesterDropdown;
            window.showAiToolModal = showAiToolModal;
            window.generateAiResponse = generateAiResponse;
            // NEW: Exposing new functions to window object
            window.showLiveClassesModal = showLiveClassesModal;
            window.showLinkNotesModal = showLinkNotesModal;
            window.showLiveTestModal = showLiveTestModal;
            window.showScannerModal = showScannerModal;
            window.showTranslatorModal = showTranslatorModal;
            window.handleScannedFileUpload = handleScannedFileUpload;
            window.addQuestionField = addQuestionField;
            window.startLiveTest = startLiveTest;
            
            checkAuth();
        });
           
    </script>
</body>
</html>